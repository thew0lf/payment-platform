# AVNZ Payment Platform - API Deployment Pipeline
# Triggers: push to main, manual dispatch
# Flow: Test â†’ Build â†’ Migrate â†’ Deploy â†’ Verify
#
# OIDC Authentication: Uses GitHub OIDC to assume AWS IAM role
# No static credentials needed - secure, short-lived tokens

name: Deploy API

on:
  push:
    branches: [main]
    paths:
      - 'apps/api/**'
      - 'prisma/**'
      - '.github/workflows/deploy-api.yml'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (use for hotfixes)'
        required: false
        default: 'false'
        type: boolean
      skip_migration:
        description: 'Skip database migration'
        required: false
        default: 'false'
        type: boolean

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: avnz-payment-api
  ECS_CLUSTER: avnz-payment-cluster
  ECS_SERVICE: avnz-api
  ECS_TASK_DEFINITION: avnz-api

# Required for OIDC token generation
permissions:
  id-token: write
  contents: read

jobs:
  # ============================================
  # Job 1: Run Tests
  # ============================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_tests != 'true' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: apps/api/package-lock.json

      - name: Install dependencies
        working-directory: apps/api
        run: npm ci

      - name: Generate Prisma Client
        working-directory: apps/api
        run: npx prisma generate

      - name: Run linting
        working-directory: apps/api
        run: npm run lint --if-present

      - name: Run type check
        working-directory: apps/api
        run: npx tsc --noEmit

  # ============================================
  # Job 1.5: Validate Migrations
  # ============================================
  validate-migrations:
    name: Validate Migrations
    runs-on: ubuntu-latest
    needs: [test]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: apps/api/package-lock.json

      - name: Install dependencies
        working-directory: apps/api
        run: npm ci

      - name: Generate Prisma Client
        working-directory: apps/api
        run: npx prisma generate

      - name: Validate Prisma Schema
        working-directory: apps/api
        env:
          # Dummy URL for schema validation (doesn't actually connect)
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy
        run: npx prisma validate

      - name: Check Migration Files
        working-directory: apps/api
        run: |
          echo "### Migration Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count local migrations
          MIGRATION_COUNT=$(ls -1 prisma/migrations 2>/dev/null | grep -v migration_lock.toml | wc -l | tr -d ' ')
          echo "**Local migrations:** $MIGRATION_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # List migrations
          echo "**Migration files:**" >> $GITHUB_STEP_SUMMARY
          ls -1 prisma/migrations | grep -v migration_lock.toml | while read dir; do
            echo "- \`$dir\`" >> $GITHUB_STEP_SUMMARY
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Migrations validated successfully" >> $GITHUB_STEP_SUMMARY

      - name: Check for Orphan SQL Files
        working-directory: apps/api
        run: |
          # Check for .sql files outside migrations directory
          ORPHAN_FILES=$(find prisma -name "*.sql" -not -path "*/migrations/*" 2>/dev/null | wc -l | tr -d ' ')

          if [ "$ORPHAN_FILES" -gt 0 ]; then
            echo "âŒ ERROR: Found orphan SQL files outside prisma/migrations/"
            find prisma -name "*.sql" -not -path "*/migrations/*"
            exit 1
          fi

          echo "âœ… No orphan SQL files found"

  # ============================================
  # Job 2: Build and Push Docker Image
  # ============================================
  build:
    name: Build & Push
    runs-on: ubuntu-latest
    needs: [test, validate-migrations]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped') && (needs.validate-migrations.result == 'success')
    outputs:
      image: ${{ steps.build-image.outputs.image }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::211125754104:role/github-actions-deploy
          role-session-name: github-actions-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push image
        id: build-image
        uses: docker/build-push-action@v5
        with:
          context: apps/api
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Output image URI
        run: |
          echo "image=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}" >> $GITHUB_OUTPUT

  # ============================================
  # Job 3: Run Database Migration
  # ============================================
  migrate:
    name: Run Migration
    runs-on: ubuntu-latest
    needs: [build]
    if: ${{ github.event.inputs.skip_migration != 'true' }}

    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::211125754104:role/github-actions-deploy
          role-session-name: github-actions-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get VPC Configuration
        id: vpc-config
        run: |
          VPC_CONFIG=$(aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --query 'services[0].networkConfiguration.awsvpcConfiguration' \
            --output json)

          SUBNET=$(echo $VPC_CONFIG | jq -r '.subnets[0]')
          SG=$(echo $VPC_CONFIG | jq -r '.securityGroups[0]')

          echo "subnet=$SUBNET" >> $GITHUB_OUTPUT
          echo "security_group=$SG" >> $GITHUB_OUTPUT

      - name: Create Database Backup
        id: backup
        run: |
          # Get the current timestamp for backup identification
          BACKUP_TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          echo "timestamp=$BACKUP_TIMESTAMP" >> $GITHUB_OUTPUT

          # Create RDS snapshot before migration
          echo "Creating database snapshot: avnz-pre-deploy-$BACKUP_TIMESTAMP"
          aws rds create-db-snapshot \
            --db-instance-identifier avnz-postgres \
            --db-snapshot-identifier "avnz-pre-deploy-$BACKUP_TIMESTAMP" \
            --tags Key=CreatedBy,Value=GitHubActions Key=Commit,Value=${{ github.sha }} || {
              echo "Warning: Failed to create snapshot (may already exist or RDS not accessible)"
              echo "Continuing with migration..."
            }

          echo "Backup initiated successfully"

      - name: Run Migration Task
        id: run-migration
        run: |
          # Clean up partial migration state from previous failed runs, then deploy all migrations
          # Root cause: migration files were not committed to git, so Docker image was missing them
          # Now that they're committed, we just need to clean up the mess from failed attempts
          cat > /tmp/migration-overrides.json <<'OVERRIDES'
          {
            "containerOverrides": [{
              "name": "api",
              "command": ["sh", "-c", "set -ex && echo Resolving failed fallback_url migration as applied && npx prisma migrate resolve --applied 20260203100000_add_affiliate_fallback_url --schema=prisma/schema.prisma 2>/dev/null || true && echo Deploying remaining migrations && npx prisma migrate deploy --schema=prisma/schema.prisma && echo Migration completed"]
            }]
          }
          OVERRIDES

          TASK_ARN=$(aws ecs run-task \
            --cluster ${{ env.ECS_CLUSTER }} \
            --task-definition ${{ env.ECS_TASK_DEFINITION }} \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=[${{ steps.vpc-config.outputs.subnet }}],securityGroups=[${{ steps.vpc-config.outputs.security_group }}],assignPublicIp=ENABLED}" \
            --overrides file:///tmp/migration-overrides.json \
            --query 'tasks[0].taskArn' \
            --output text)

          echo "task_arn=$TASK_ARN" >> $GITHUB_OUTPUT
          echo "Migration task started: $TASK_ARN"

      - name: Wait for Migration
        run: |
          echo "Waiting for migration task to complete..."
          aws ecs wait tasks-stopped \
            --cluster ${{ env.ECS_CLUSTER }} \
            --tasks ${{ steps.run-migration.outputs.task_arn }}

      - name: Check Migration Status
        run: |
          TASK_ID=$(echo ${{ steps.run-migration.outputs.task_arn }} | cut -d'/' -f3)

          # Get detailed task information
          echo "=== Task Details ==="
          TASK_INFO=$(aws ecs describe-tasks \
            --cluster ${{ env.ECS_CLUSTER }} \
            --tasks ${{ steps.run-migration.outputs.task_arn }} \
            --output json)

          echo "$TASK_INFO" | jq '.tasks[0] | {stoppedReason, stopCode, containers: [.containers[] | {name, exitCode, reason}]}'

          EXIT_CODE=$(echo "$TASK_INFO" | jq -r '.tasks[0].containers[0].exitCode // "null"')
          STOPPED_REASON=$(echo "$TASK_INFO" | jq -r '.tasks[0].stoppedReason // "Unknown"')

          echo "Exit code: $EXIT_CODE"
          echo "Stopped reason: $STOPPED_REASON"

          # Try to get logs (multiple log stream name formats)
          echo ""
          echo "=== Container Logs ==="
          for LOG_STREAM in "ecs/api/$TASK_ID" "api/api/$TASK_ID" "avnz-api/api/$TASK_ID"; do
            echo "Trying log stream: $LOG_STREAM"
            aws logs get-log-events \
              --log-group-name /ecs/avnz-api \
              --log-stream-name "$LOG_STREAM" \
              --limit 100 \
              --query 'events[*].message' \
              --output text 2>/dev/null && break || true
          done

          if [ "$EXIT_CODE" != "0" ] && [ "$EXIT_CODE" != "null" ]; then
            echo ""
            echo "âŒ Migration failed with exit code: $EXIT_CODE"
            echo "Stopped reason: $STOPPED_REASON"
            exit 1
          fi

          echo ""
          echo "âœ… Migration completed successfully!"

      - name: Get Seed Admin Password
        id: get-seed-password
        run: |
          SEED_PASSWORD=$(aws secretsmanager get-secret-value \
            --secret-id payment-platform/seed-admin-password \
            --query 'SecretString' --output text)
          echo "::add-mask::$SEED_PASSWORD"
          echo "password=$SEED_PASSWORD" >> $GITHUB_OUTPUT

      - name: Run Production Seed
        id: run-seed
        run: |
          echo "Running production seed (email templates, RBAC, integrations, etc.)..."
          TASK_ARN=$(aws ecs run-task \
            --cluster ${{ env.ECS_CLUSTER }} \
            --task-definition ${{ env.ECS_TASK_DEFINITION }} \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=[${{ steps.vpc-config.outputs.subnet }}],securityGroups=[${{ steps.vpc-config.outputs.security_group }}],assignPublicIp=ENABLED}" \
            --overrides '{
              "containerOverrides": [{
                "name": "api",
                "command": ["sh", "-c", "SEED_ENV=production INTEGRATION_DEFAULTS_SECRET_NAME=payment-platform/integration-defaults SEED_ADMIN_PASSWORD=$SEED_ADMIN_PASSWORD npx prisma db seed"],
                "environment": [
                  {"name": "AWS_REGION", "value": "us-east-1"},
                  {"name": "SEED_ADMIN_PASSWORD", "value": "${{ steps.get-seed-password.outputs.password }}"}
                ]
              }]
            }' \
            --query 'tasks[0].taskArn' \
            --output text)

          echo "task_arn=$TASK_ARN" >> $GITHUB_OUTPUT
          echo "Seed task started: $TASK_ARN"

      - name: Wait for Seed
        run: |
          echo "Waiting for seed task to complete..."
          aws ecs wait tasks-stopped \
            --cluster ${{ env.ECS_CLUSTER }} \
            --tasks ${{ steps.run-seed.outputs.task_arn }}

      - name: Check Seed Status
        run: |
          EXIT_CODE=$(aws ecs describe-tasks \
            --cluster ${{ env.ECS_CLUSTER }} \
            --tasks ${{ steps.run-seed.outputs.task_arn }} \
            --query 'tasks[0].containers[0].exitCode' \
            --output text)

          if [ "$EXIT_CODE" != "0" ]; then
            echo "::error::Seed failed with exit code: $EXIT_CODE"

            # Get logs for debugging
            TASK_ID=$(echo ${{ steps.run-seed.outputs.task_arn }} | cut -d'/' -f3)
            echo "=== Seed Task Logs ==="
            aws logs get-log-events \
              --log-group-name /ecs/avnz-api \
              --log-stream-name ecs/api/$TASK_ID \
              --limit 50 || true

            exit 1
          fi

          echo "Seed completed successfully!"

      - name: Verify Seed Data
        run: |
          echo "Verifying seed data was applied..."

          # Run a verification task to check required data exists
          VERIFY_ARN=$(aws ecs run-task \
            --cluster ${{ env.ECS_CLUSTER }} \
            --task-definition ${{ env.ECS_TASK_DEFINITION }} \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=[${{ steps.vpc-config.outputs.subnet }}],securityGroups=[${{ steps.vpc-config.outputs.security_group }}],assignPublicIp=ENABLED}" \
            --overrides '{
              "containerOverrides": [{
                "name": "api",
                "command": ["sh", "-c", "npx prisma db execute --stdin <<SQL\nSELECT COUNT(*) as org_count FROM organizations;\nSQL"]
              }]
            }' \
            --query 'tasks[0].taskArn' \
            --output text)

          aws ecs wait tasks-stopped --cluster ${{ env.ECS_CLUSTER }} --tasks $VERIFY_ARN

          VERIFY_EXIT=$(aws ecs describe-tasks \
            --cluster ${{ env.ECS_CLUSTER }} \
            --tasks $VERIFY_ARN \
            --query 'tasks[0].containers[0].exitCode' \
            --output text)

          if [ "$VERIFY_EXIT" != "0" ]; then
            echo "::error::Seed verification failed - required data missing!"
            echo "Please check that the seed script ran correctly"
            exit 1
          fi

          echo "Seed data verified successfully!"

  # ============================================
  # Job 4: Deploy to ECS
  # ============================================
  deploy:
    name: Deploy to ECS
    runs-on: ubuntu-latest
    needs: [build, migrate]
    if: always() && needs.build.result == 'success' && (needs.migrate.result == 'success' || needs.migrate.result == 'skipped')

    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::211125754104:role/github-actions-deploy
          role-session-name: github-actions-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update ECS Service
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_SERVICE }} \
            --force-new-deployment \
            --query 'service.{status:status,runningCount:runningCount,pendingCount:pendingCount}'

      - name: Wait for Deployment
        run: |
          echo "Waiting for ECS service to stabilize..."
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }}
          echo "Deployment complete!"

  # ============================================
  # Job 5: Verify Deployment
  # ============================================
  verify:
    name: Verify Health
    runs-on: ubuntu-latest
    needs: [deploy]

    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::211125754104:role/github-actions-deploy
          role-session-name: github-actions-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get ALB DNS
        id: alb
        run: |
          ALB_DNS=$(aws elbv2 describe-load-balancers \
            --names avnz-api-alb \
            --query 'LoadBalancers[0].DNSName' \
            --output text 2>/dev/null || echo "avnz-api-alb-776896238.us-east-1.elb.amazonaws.com")
          echo "dns=$ALB_DNS" >> $GITHUB_OUTPUT

      - name: Health Check
        run: |
          echo "Checking API health..."
          # Use HTTPS via the custom domain (ALB redirects HTTP to HTTPS)
          API_URL="https://api.avnz.io/health"
          for i in {1..10}; do
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL" || echo "000")

            if [ "$RESPONSE" = "200" ]; then
              echo "Health check passed! (attempt $i)"
              exit 0
            fi

            echo "Health check attempt $i failed (HTTP $RESPONSE), retrying in 10s..."
            sleep 10
          done

          echo "Health check failed after 10 attempts"
          exit 1

      - name: Notify Success
        if: success()
        run: |
          echo "ðŸš€ Deployment successful!"
          echo "API is live at: https://api.avnz.io"
