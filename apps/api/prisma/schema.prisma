// Payment Platform - Prisma Schema
// Multi-tenant hierarchical payment orchestration platform
// SOC2, PCI-DSS, ISO 27001 Compliant Design

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// HIERARCHY MODELS
// Organization → Client → Company → Department → Team → User
// =============================================================================

model Organization {
  id       String  @id @default(cuid())
  name     String
  slug     String  @unique
  domain   String? @unique
  logo     String?
  settings Json    @default("{}")

  // Billing
  billingEmail  String?
  billingPlan   BillingPlan   @default(STARTER)
  billingStatus BillingStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  clients              Client[]
  users                User[]                @relation("OrganizationUsers")
  apiKeys              ApiKey[]
  platformIntegrations PlatformIntegration[]
  vendors              Vendor[]

  @@map("organizations")
}

model Client {
  id             String  @id @default(cuid())
  organizationId String
  name           String
  slug           String
  code           String? @unique // 4-char alphanumeric code (e.g., "ACME")
  contactName    String?
  contactEmail   String?
  contactPhone   String?
  settings       Json    @default("{}")

  // Client plan/status
  plan   ClientPlan   @default(BASIC)
  status EntityStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  companies    Company[]
  users        User[]              @relation("ClientUsers")
  integrations ClientIntegration[]

  // Soft delete fields
  deletedAt DateTime?
  deletedBy String?
  cascadeId String?

  @@unique([organizationId, slug])
  @@index([deletedAt])
  @@map("clients")
}

model Company {
  id       String  @id @default(cuid())
  clientId String
  name     String
  slug     String
  code     String? @unique // 4-char alphanumeric code (e.g., "BREW") - globally unique
  domain   String?
  logo     String?
  timezone String  @default("UTC")
  currency String  @default("USD")
  settings Json    @default("{}")

  // Payment configuration
  paymentConfig Json @default("{}")

  // Status
  status EntityStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  client           Client            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  departments      Department[]
  users            User[]            @relation("CompanyUsers")
  paymentProviders PaymentProvider[]
  subscriptions    Subscription[]
  transactions     Transaction[]
  customers        Customer[]
  products         Product[]
  orders           Order[]

  // Momentum Intelligence Relations
  customerIntents   CustomerIntent[]
  interventions     Intervention[]
  saveAttempts      SaveAttempt[]
  voiceCalls        VoiceCall[]
  generatedContents GeneratedContent[]
  upsellOffers      UpsellOffer[]
  saveFlowConfig    SaveFlowConfig?
  voiceScripts      VoiceScript[]
  momentumAnalytics MomentumAnalytics[]
  upsellConfig      UpsellConfig?

  // Feature 10: Enhanced Products
  categories         Category[]
  tags               Tag[]
  variantOptions     VariantOption[]
  collections        Collection[]
  bundles            Bundle[]
  inventoryLocations InventoryLocation[]
  marketingVideos    MarketingVideo[]
  videoTemplates     MarketingVideoTemplate[]

  // Feature 03: Vendor System
  vendorConnections VendorClientConnection[]

  // Customer Service Relations
  refunds        Refund[]
  refundSettings RefundSettings?
  customerTags   CustomerTag[]

  // Product Reviews
  productReviews     ProductReview[]
  productReviewStats ProductReviewStats[]
  reviewConfig       ReviewConfig?

  // Landing Pages
  landingPages     LandingPage[]
  abTests          ABTest[]
  landingPopups    LandingPagePopup[]
  dynamicTextRules DynamicTextRule[]
  conversionGoals  ConversionGoal[]

  // Soft delete fields
  deletedAt DateTime?
  deletedBy String?
  cascadeId String?

  @@unique([clientId, slug])
  @@index([deletedAt])
  @@map("companies")
}

model Department {
  id          String  @id @default(cuid())
  companyId   String
  name        String
  slug        String
  description String?
  settings    Json    @default("{}")

  // Status
  status EntityStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  teams   Team[]
  users   User[]  @relation("DepartmentUsers")

  // Soft delete fields
  deletedAt DateTime?
  deletedBy String?
  cascadeId String?

  @@unique([companyId, slug])
  @@index([deletedAt])
  @@map("departments")
}

model Team {
  id           String  @id @default(cuid())
  departmentId String
  name         String
  slug         String
  description  String?
  settings     Json    @default("{}")

  // Team lead
  teamLeadId String?

  // Status
  status EntityStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  department Department   @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  teamLead   User?        @relation("TeamLead", fields: [teamLeadId], references: [id])
  members    TeamMember[]

  @@unique([departmentId, slug])
  @@map("teams")
}

// =============================================================================
// USER & ACCESS CONTROL
// =============================================================================

model User {
  id           String  @id @default(cuid())
  email        String  @unique
  passwordHash String?
  firstName    String?
  lastName     String?
  avatar       String?
  phone        String?

  // Auth
  auth0Id       String?   @unique
  emailVerified Boolean   @default(false)
  lastLoginAt   DateTime?

  // Primary scope (where user was created)
  scopeType ScopeType
  scopeId   String

  // Global role
  role UserRole @default(USER)

  // Status
  status UserStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Direct relations to hierarchy levels
  organization   Organization? @relation("OrganizationUsers", fields: [organizationId], references: [id])
  organizationId String?

  client   Client? @relation("ClientUsers", fields: [clientId], references: [id])
  clientId String?

  company   Company? @relation("CompanyUsers", fields: [companyId], references: [id])
  companyId String?

  department   Department? @relation("DepartmentUsers", fields: [departmentId], references: [id])
  departmentId String?

  // Team memberships (many-to-many)
  teamMemberships TeamMember[]
  teamsLed        Team[]       @relation("TeamLead")

  // Activity
  auditLogs    AuditLog[]
  deletionLogs DeletionLog[] @relation("UserDeletions")

  // Feature 10: Enhanced Products
  inventoryAdjustments InventoryAdjustment[]
  marketingVideos      MarketingVideo[]

  // Soft delete tracking
  deletedCategories Category[] @relation("CategoryDeletedBy")

  // Feature 02: RBAC Relations
  roleAssignments  UserRoleAssignment[]
  permissionGrants PermissionGrant[]
  sessions         UserSession[]

  // Customer Service Relations
  customerNotes    CustomerNote[]
  refundsRequested Refund[]       @relation("RefundRequester")
  refundsApproved  Refund[]       @relation("RefundApprover")
  refundsRejected  Refund[]       @relation("RefundRejecter")

  // Soft delete fields
  deletedAt DateTime?
  deletedBy String?
  cascadeId String?

  @@index([deletedAt])
  @@map("users")
}

model TeamMember {
  id     String   @id @default(cuid())
  teamId String
  userId String
  role   TeamRole @default(MEMBER)

  // Timestamps
  joinedAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@map("team_members")
}

// =============================================================================
// CUSTOMER & ADDRESS MODELS
// =============================================================================

model Customer {
  id        String @id @default(cuid())
  companyId String

  // Customer info
  email     String
  firstName String?
  lastName  String?
  phone     String?

  // Metadata
  metadata Json @default("{}")

  // Status
  status CustomerStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company         Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  addresses       Address[]
  billingAccounts BillingAccount[]
  paymentVaults   PaymentVault[]
  subscriptions   Subscription[]
  transactions    Transaction[]
  orders          Order[]

  // Momentum Intelligence Relations
  customerIntents CustomerIntent[]
  interventions   Intervention[]
  saveAttempts    SaveAttempt[]
  voiceCalls      VoiceCall[]
  upsellOffers    UpsellOffer[]

  // Feature 10C: Marketing Videos
  marketingVideos MarketingVideo[]

  // Customer Service Relations
  notes   CustomerNote[]
  refunds Refund[]

  // Product Reviews
  productReviews ProductReview[]
  reviewVotes    ReviewVote[]

  // Soft delete fields
  deletedAt DateTime?
  deletedBy String?
  cascadeId String?

  @@unique([companyId, email, deletedAt])
  @@index([companyId, email])
  @@index([deletedAt])
  @@map("customers")
}

model Address {
  id         String @id @default(cuid())
  customerId String

  // Address type
  type      AddressType @default(BOTH)
  label     String? // "Home", "Office", "Warehouse"
  isDefault Boolean     @default(false)

  // Contact
  firstName String
  lastName  String
  company   String?
  phone     String?

  // Address fields
  street1    String
  street2    String?
  city       String
  state      String
  postalCode String
  country    String  @default("US")

  // Delivery
  deliveryInstructions String?

  // Validation
  isValidated        Boolean   @default(false)
  validatedAt        DateTime?
  validationResponse Json?

  // Status
  status EntityStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Soft delete fields (CustomerAddress)
  deletedAt DateTime?
  deletedBy String?
  cascadeId String?

  @@index([customerId, type])
  @@index([deletedAt])
  @@map("addresses")
}

// =============================================================================
// PAYMENT VAULT & BILLING (PCI-DSS COMPLIANT)
// =============================================================================

model PaymentVault {
  id         String @id @default(cuid())
  customerId String

  // Payment method type
  type PaymentMethodType

  // Gateway reference (never store raw card data)
  gatewayCustomerId String? // Customer ID at payment gateway
  gatewayPaymentId  String? // Payment method ID at gateway

  // ===========================================
  // ENCRYPTED SENSITIVE DATA (AES-256-GCM)
  // ===========================================
  // All sensitive data stored in encrypted JSON blob
  // Contains: full card number, CVV token, full account numbers,
  // check routing/account, check images, etc.
  encryptedData  String  // Encrypted JSON with sensitive payment details
  keyVersion     Int     @default(1) // For key rotation
  encryptionAlgo String  @default("AES-256-GCM") // Encryption algorithm used

  // For CHECK payments, encryptedData contains:
  // - routingNumber: Full 9-digit ABA routing number
  // - accountNumber: Full bank account number
  // - checkNumber: Check number
  // - checkImageFront: Base64 or S3 reference to front image
  // - checkImageBack: Base64 or S3 reference to back image
  // - micrLine: Full MICR line data

  // ===========================================
  // DISPLAY DATA ONLY (Safe to store unencrypted)
  // ===========================================
  last4       String  // Last 4 digits of card/account
  bin         String? // First 6 digits (BIN) - identifies issuer, not cardholder
  brand       String? // VISA, MASTERCARD, AMEX, etc. (for cards)
  expMonth    Int?    // Card expiry month
  expYear     Int?    // Card expiry year
  bankName    String? // Bank name (for ACH/CHECK)
  accountType String? // checking, savings
  funding     String? // credit, debit, prepaid (for cards)

  // Check-specific display fields (non-sensitive)
  checkNumberLast4 String? // Last 4 of check number
  routingLast4     String? // Last 4 of routing number

  // Fingerprint for duplicate detection
  fingerprint String?

  // Billing address (reference for AVS)
  billingAddressSnapshot Json?

  // Status
  isDefault Boolean @default(false)
  isActive  Boolean @default(true)

  // Compliance
  consentRecordedAt DateTime?
  consentIp         String?

  // Usage tracking
  lastUsedAt DateTime?
  usageCount Int       @default(0)

  // Expiration
  expiresAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  customer        Customer         @relation(fields: [customerId], references: [id], onDelete: Cascade)
  billingAccounts BillingAccount[]
  transactions    Transaction[]
  subscriptions   Subscription[]

  @@index([customerId, isActive])
  @@index([fingerprint])
  @@map("payment_vaults")
}

model BillingAccount {
  id         String @id @default(cuid())
  customerId String

  // Display name
  name String? // "Primary Card", "Business Account"

  // Default payment method
  paymentVaultId String?

  // Billing address (current, updatable)
  billingAddress Json

  // Auto-pay settings
  autoPayEnabled Boolean @default(true)
  autoPayDay     Int? // Day of month for auto-pay

  // Status
  isDefault Boolean      @default(false)
  status    EntityStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  customer     Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  paymentVault PaymentVault? @relation(fields: [paymentVaultId], references: [id])
  orders       Order[]

  @@index([customerId])
  @@map("billing_accounts")
}

// =============================================================================
// PRODUCT CATALOG (COFFEE)
// =============================================================================

model Product {
  id        String @id @default(cuid())
  companyId String

  // Product identification
  sku         String
  name        String
  slug        String
  description String?

  // Category
  category    ProductCategory
  subcategory String?

  // Coffee-specific attributes
  roastLevel  RoastLevel?
  origin      String? // "Ethiopia", "Colombia", "Brazil Blend"
  flavorNotes String[] // ["chocolate", "citrus", "nutty"]
  process     String? // "washed", "natural", "honey"
  altitude    String? // "1800-2200m"
  varietal    String? // "Bourbon", "Typica", "Gesha"

  // Sizing
  weight     Decimal? @db.Decimal(10, 2)
  weightUnit String   @default("oz") // oz, g, lb, kg

  // Pricing
  price          Decimal  @db.Decimal(10, 2)
  compareAtPrice Decimal? @db.Decimal(10, 2)
  costPrice      Decimal? @db.Decimal(10, 2) // For margin tracking
  currency       String   @default("USD")

  // Subscription settings
  isSubscribable       Boolean  @default(true)
  subscriptionDiscount Decimal? @db.Decimal(5, 2) // Percentage

  // Inventory
  trackInventory    Boolean @default(true)
  stockQuantity     Int     @default(0)
  lowStockThreshold Int     @default(10)

  // Status
  status    ProductStatus @default(ACTIVE)
  isVisible Boolean       @default(true)

  // SEO/Display
  images          Json    @default("[]") // Array of image URLs
  metaTitle       String?
  metaDescription String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // AI Generated Content
  aiGeneratedDescription Boolean   @default(false)
  aiGeneratedAt          DateTime?

  // Flexible Attributes (JSON)
  attributes Json? // Custom key-value attributes

  // Relations
  company    Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]

  // Feature 10: Categories, Tags, Media
  categoryAssignments ProductCategoryAssignment[]
  tags                ProductTag[]
  media               ProductMedia[]
  priceRules          ProductPriceRule[]

  // Feature 10B: Variants, Collections, Bundles, Inventory
  variants        ProductVariant[]
  collectionItems CollectionProduct[]
  bundle          Bundle?
  bundleItems     BundleItem[]
  inventoryLevels InventoryLevel[]

  // Feature 10C: Marketing Videos
  marketingVideos MarketingVideo[]

  // Feature 03: Vendor System
  vendorProductSyncs VendorProductSync[]

  // Product Reviews
  reviews     ProductReview[]
  reviewStats ProductReviewStats?

  // Soft delete fields
  deletedAt DateTime?
  deletedBy String?
  cascadeId String?

  @@unique([companyId, sku, deletedAt])
  @@unique([companyId, slug, deletedAt])
  @@index([companyId, status])
  @@index([companyId, status, trackInventory])
  @@index([deletedAt])
  @@map("products")
}

// =============================================================================
// ORDER SYSTEM (IMMUTABLE HISTORICAL RECORDS)
// =============================================================================

model Order {
  id               String  @id @default(cuid())
  companyId        String
  customerId       String
  subscriptionId   String?
  billingAccountId String?

  // Order identification
  orderNumber String  @unique
  externalId  String? // External system reference

  // Order type
  type OrderType @default(ONE_TIME)

  // Status
  status OrderStatus @default(PENDING)

  // ===========================================
  // ADDRESS SNAPSHOTS (Immutable after lock)
  // ===========================================

  // Shipping address - copied at order, editable until locked
  shippingSnapshot  Json
  shippingAddressId String? // Reference to original address

  // Billing address - copied at order, editable until locked
  billingSnapshot  Json
  billingAddressId String? // Reference to original address

  // Address lock mechanism
  addressLockedAt DateTime? // null = editable, set = frozen
  addressLockedBy String? // "system", "fulfillment", userId

  // ===========================================
  // ORDER TOTALS
  // ===========================================

  subtotal       Decimal @db.Decimal(10, 2)
  discountAmount Decimal @default(0) @db.Decimal(10, 2)
  discountCode   String?
  shippingAmount Decimal @default(0) @db.Decimal(10, 2)
  taxAmount      Decimal @default(0) @db.Decimal(10, 2)
  total          Decimal @db.Decimal(10, 2)
  currency       String  @default("USD")

  // ===========================================
  // PAYMENT
  // ===========================================

  paymentStatus   PaymentStatus @default(PENDING)
  paidAt          DateTime?
  paymentMethod   String? // Display: "VISA ending 4242" or "Check #1234"
  paymentVaultId  String? // Reference to PaymentVault for sensitive data

  // Display-only payment snapshot (NO SENSITIVE DATA)
  // All sensitive info (full numbers, images) stored in PaymentVault
  paymentSnapshot Json?   // { type, brand, last4, bin, expMonth, expYear, funding, bankName, checkNumberLast4 }

  // ===========================================
  // FULFILLMENT TRACKING
  // ===========================================

  fulfillmentStatus FulfillmentStatus @default(UNFULFILLED)
  fulfilledAt       DateTime?

  // Customer notes
  customerNotes String?
  internalNotes String?

  // Metadata
  metadata Json @default("{}")

  // Continuity tracking
  continuitySessionId String?
  frictionLevel       String?
  momentumScore       Int?

  // ===========================================
  // TIMESTAMPS
  // ===========================================

  orderedAt    DateTime  @default(now()) // When customer placed order
  confirmedAt  DateTime? // When payment confirmed
  canceledAt   DateTime?
  cancelReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company        Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer       Customer        @relation(fields: [customerId], references: [id])
  subscription   Subscription?   @relation(fields: [subscriptionId], references: [id])
  billingAccount BillingAccount? @relation(fields: [billingAccountId], references: [id])
  items          OrderItem[]
  shipments      Shipment[]
  transactions   Transaction[]

  // Feature 03: Vendor System
  vendorOrders VendorOrder[]

  // Refunds
  refunds Refund[]

  // Product Reviews (for verified purchase tracking)
  productReviews ProductReview[]

  // Soft delete fields
  deletedAt DateTime?
  deletedBy String?
  cascadeId String?

  @@index([companyId, orderedAt])
  @@index([companyId, status, fulfillmentStatus])
  @@index([customerId])
  @@index([status])
  @@index([orderNumber])
  @@index([deletedAt])
  @@map("orders")
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  productId String? // Nullable for deleted products

  // ===========================================
  // PRODUCT SNAPSHOT (Immutable)
  // Captures product state at time of order
  // ===========================================

  sku         String
  name        String
  description String?

  // Product attributes snapshot
  productSnapshot Json // Full product data at order time

  // Quantity & Pricing
  quantity       Int
  unitPrice      Decimal @db.Decimal(10, 2)
  discountAmount Decimal @default(0) @db.Decimal(10, 2)
  taxAmount      Decimal @default(0) @db.Decimal(10, 2)
  totalPrice     Decimal @db.Decimal(10, 2)

  // Fulfillment
  fulfilledQuantity Int               @default(0)
  fulfillmentStatus FulfillmentStatus @default(UNFULFILLED)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  order   Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@map("order_items")
}

// =============================================================================
// SHIPPING & FULFILLMENT
// =============================================================================

model Shipment {
  id      String @id @default(cuid())
  orderId String

  // Shipment identification
  shipmentNumber String @unique

  // Carrier & Tracking
  carrier        ShippingCarrier
  carrierService String? // "Priority Mail", "Ground", "2-Day"
  trackingNumber String?
  trackingUrl    String?

  // Shipping method used
  shippingMethod ShippingMethod @default(GROUND)

  // Package details
  weight        Decimal? @db.Decimal(10, 2)
  weightUnit    String   @default("oz")
  length        Decimal? @db.Decimal(10, 2)
  width         Decimal? @db.Decimal(10, 2)
  height        Decimal? @db.Decimal(10, 2)
  dimensionUnit String   @default("in")

  // Cost
  shippingCost    Decimal? @db.Decimal(10, 2)
  insuranceAmount Decimal? @db.Decimal(10, 2)

  // Labels
  shippingLabelUrl String?
  returnLabelUrl   String?

  // Address snapshot (from order at time of shipment)
  shippingAddressSnapshot Json

  // Status
  status ShipmentStatus @default(PENDING)

  // Estimated dates
  estimatedShipDate     DateTime?
  estimatedDeliveryDate DateTime?

  // Actual dates
  shippedAt   DateTime?
  deliveredAt DateTime?

  // Signature
  signatureRequired Boolean @default(false)
  signedBy          String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  order  Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  events ShipmentEvent[]

  @@index([orderId])
  @@index([trackingNumber])
  @@map("shipments")
}

model ShipmentEvent {
  id         String @id @default(cuid())
  shipmentId String

  // Event details
  status      ShipmentEventType
  description String
  location    String?

  // Raw carrier data
  carrierCode    String?
  carrierMessage String?
  carrierData    Json?

  // When it happened
  occurredAt DateTime

  // Timestamps
  createdAt DateTime @default(now())

  // Relations
  shipment Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  @@index([shipmentId, occurredAt])
  @@map("shipment_events")
}

// =============================================================================
// PAYMENT PROVIDER & TRANSACTIONS
// =============================================================================

model PaymentProvider {
  id        String              @id @default(cuid())
  companyId String
  name      String
  type      PaymentProviderType

  // Credentials (encrypted at application level)
  encryptedCredentials String
  keyVersion           Int    @default(1)

  // Configuration
  isDefault   Boolean @default(false)
  isActive    Boolean @default(true)
  priority    Int     @default(0)
  environment String  @default("sandbox") // sandbox, production

  // Supported features
  supportsRefunds   Boolean @default(true)
  supportsVoid      Boolean @default(true)
  supportsRecurring Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company       Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  transactions  Transaction[]
  subscriptions Subscription[]

  @@map("payment_providers")
}

model Subscription {
  id         String @id @default(cuid())
  companyId  String
  customerId String

  // Plan details
  planName   String
  planAmount Decimal         @db.Decimal(10, 2)
  currency   String          @default("USD")
  interval   BillingInterval

  // Billing cycle
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  nextBillingDate    DateTime?

  // Trial
  trialStart DateTime?
  trialEnd   DateTime?

  // Shipping preference for subscription orders
  shippingAddressId   String?
  shippingPreferences Json    @default("{}")

  // Payment method for recurring billing (token-based providers only)
  paymentVaultId    String?
  paymentProviderId String? // Which provider to charge

  // Status
  status       SubscriptionStatus @default(ACTIVE)
  canceledAt   DateTime?
  cancelReason String?

  // Pause functionality
  pausedAt      DateTime?
  pauseResumeAt DateTime?

  // Metadata
  metadata Json @default("{}")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company         Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer        Customer         @relation(fields: [customerId], references: [id], onDelete: Cascade)
  paymentVault    PaymentVault?    @relation(fields: [paymentVaultId], references: [id])
  paymentProvider PaymentProvider? @relation(fields: [paymentProviderId], references: [id])
  transactions    Transaction[]
  orders          Order[]
  rebillAttempts  SubscriptionRebill[]

  // Soft delete fields
  deletedAt DateTime?
  deletedBy String?
  cascadeId String?

  // Indexes for query performance with large datasets
  @@index([companyId, status])
  @@index([companyId, interval])
  @@index([companyId, nextBillingDate])
  @@index([customerId])
  @@index([createdAt(sort: Desc), id])  // For cursor-based pagination
  @@index([deletedAt])
  @@map("subscriptions")
}

// Tracks rebill attempts for subscriptions with stored payment methods
model SubscriptionRebill {
  id             String @id @default(cuid())
  subscriptionId String
  transactionId  String? // Links to successful transaction

  // Billing period this rebill covers
  billingPeriodStart DateTime
  billingPeriodEnd   DateTime

  // Amount charged
  amount   Decimal @db.Decimal(10, 2)
  currency String  @default("USD")

  // Attempt tracking
  attemptNumber Int      @default(1) // 1st, 2nd, 3rd retry, etc.
  status        RebillStatus @default(PENDING)

  // Results
  failureReason   String?
  failureCode     String?
  providerResponse Json?

  // Dunning schedule
  nextRetryAt     DateTime? // When to retry if failed
  retriesRemaining Int       @default(3)

  // Timestamps
  scheduledAt DateTime  // When rebill was scheduled
  processedAt DateTime? // When processing completed
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  transaction  Transaction? @relation(fields: [transactionId], references: [id])

  @@index([subscriptionId, status])
  @@index([status, scheduledAt])
  @@index([nextRetryAt])
  @@map("subscription_rebills")
}

model Transaction {
  id                String  @id @default(cuid())
  companyId         String
  customerId        String?
  subscriptionId    String?
  orderId           String?
  paymentProviderId String?
  paymentVaultId    String?

  // Transaction reference
  transactionNumber String @unique

  // Transaction details
  type        TransactionType
  amount      Decimal         @db.Decimal(10, 2)
  currency    String          @default("USD")
  description String?

  // Provider response
  providerTransactionId String?
  providerResponse      Json?

  // Status
  status        TransactionStatus @default(PENDING)
  failureReason String?
  failureCode   String?

  // Refund tracking
  refundedAmount      Decimal? @db.Decimal(10, 2)
  parentTransactionId String? // For refunds, links to original charge

  // Risk & Fraud
  riskScore Int?
  riskFlags String[]

  // AVS/CVV results
  avsResult String?
  cvvResult String?

  // Continuity tracking
  continuitySessionId String?
  frictionLevel       String?
  momentumScore       Int?

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  processedAt DateTime?

  // Relations
  company         Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer        Customer?        @relation(fields: [customerId], references: [id])
  subscription    Subscription?    @relation(fields: [subscriptionId], references: [id])
  order           Order?           @relation(fields: [orderId], references: [id])
  paymentProvider PaymentProvider? @relation(fields: [paymentProviderId], references: [id])
  paymentVault    PaymentVault?    @relation(fields: [paymentVaultId], references: [id])
  rebillAttempts  SubscriptionRebill[]

  @@index([companyId, createdAt])
  @@index([companyId, status, createdAt])
  @@index([customerId])
  @@index([orderId])
  @@index([status])
  @@map("transactions")
}

// =============================================================================
// MERCHANT ACCOUNTS
// =============================================================================

model MerchantAccount {
  id        String @id @default(cuid())
  companyId String

  // Friendly naming
  name        String
  description String?
  color       String?
  icon        String?
  tags        String[] @default([])

  // Provider configuration
  providerType    String
  merchantId      String
  descriptor      String?
  descriptorPhone String?
  credentials     Json
  environment     String  @default("sandbox")

  // Status
  status          String    @default("pending")
  statusReason    String?
  statusChangedAt DateTime?

  // Transaction limits
  minTransactionAmount    Int  @default(50)
  maxTransactionAmount    Int  @default(10000000)
  dailyTransactionLimit   Int?
  dailyVolumeLimit        Int?
  weeklyTransactionLimit  Int?
  weeklyVolumeLimit       Int?
  monthlyTransactionLimit Int?
  monthlyVolumeLimit      Int?
  yearlyTransactionLimit  Int?
  yearlyVolumeLimit       Int?
  velocityWindow          Int?
  velocityMaxTransactions Int?
  velocityMaxAmount       Int?

  // Current usage
  todayTransactionCount Int       @default(0)
  todayVolume           Int       @default(0)
  todaySuccessCount     Int       @default(0)
  todayFailureCount     Int       @default(0)
  weekTransactionCount  Int       @default(0)
  weekVolume            Int       @default(0)
  monthTransactionCount Int       @default(0)
  monthVolume           Int       @default(0)
  yearTransactionCount  Int       @default(0)
  yearVolume            Int       @default(0)
  lastTransactionAt     DateTime?
  usageResetAt          DateTime  @default(now())

  // Fees & restrictions (JSON)
  fees         Json?
  restrictions Json?

  // Routing
  priority     Int     @default(100)
  weight       Int     @default(100)
  isDefault    Boolean @default(false)
  isBackupOnly Boolean @default(false)

  // Health
  healthStatus     String    @default("healthy")
  successRate      Float     @default(100)
  avgLatencyMs     Float     @default(0)
  lastHealthCheck  DateTime?
  lastErrorCode    String?
  lastErrorMessage String?
  lastErrorAt      DateTime?
  uptimePercent    Float     @default(100)

  // Financial
  reserveBalance   Int?
  availableBalance Int?

  // Metadata
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  // Integration relation
  clientIntegration ClientIntegration?

  // Soft delete fields
  deletedAt DateTime?
  deletedBy String?
  cascadeId String?

  @@unique([companyId, name, deletedAt])
  @@index([companyId])
  @@index([providerType])
  @@index([status])
  @@index([deletedAt])
  @@map("merchant_accounts")
}

// =============================================================================
// ACCOUNT POOLS (Load Balancing & Failover)
// =============================================================================

model AccountPool {
  id        String @id @default(cuid())
  companyId String

  // Friendly naming
  name        String
  description String?
  color       String?
  icon        String?
  tags        String[] @default([])

  // Members (stored as JSON array of PoolMembership)
  accounts Json @default("[]")

  // Load balancing strategy
  balancingStrategy String @default("WEIGHTED")

  // Configuration (stored as JSON)
  failover      Json // FailoverConfig
  healthRouting Json // HealthRoutingConfig
  limitRouting  Json // LimitRoutingConfig
  stickySession Json? // StickySessionConfig (optional)

  // Status
  status String @default("active")

  // Round-robin state
  lastAccountIndex Int @default(0)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  @@unique([companyId, name])
  @@index([companyId])
  @@index([status])
  @@map("account_pools")
}

// =============================================================================
// ROUTING RULES (Gateway Rule Engine)
// =============================================================================

model RoutingRule {
  id        String @id @default(cuid())
  companyId String

  // Friendly naming
  name        String
  description String?
  color       String?
  tags        String[] @default([])

  // Status
  status   String @default("INACTIVE")
  priority Int    @default(100)

  // Conditions & Actions (JSON)
  conditions Json
  actions    Json

  // Fallback
  fallbackAction  String?
  fallbackPoolId  String?
  fallbackMessage String?

  // A/B Testing
  testingEnabled       Boolean   @default(false)
  testingTrafficPct    Float?
  testingControlPoolId String?
  testingTestPoolId    String?
  testingStartDate     DateTime?
  testingEndDate       DateTime?
  testingMetrics       String[]  @default([])

  // Scheduling
  activateAt        DateTime?
  deactivateAt      DateTime?
  timezone          String?
  recurringSchedule String?

  // Analytics
  matchCount          Int       @default(0)
  lastMatchedAt       DateTime?
  avgProcessingTimeMs Float     @default(0)

  // Metadata
  version   Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  // Soft delete fields
  deletedAt DateTime?
  deletedBy String?
  cascadeId String?

  @@unique([companyId, name, deletedAt])
  @@index([companyId])
  @@index([status])
  @@index([priority])
  @@index([deletedAt])
  @@map("routing_rules")
}

model RoutingDecision {
  id            String @id @default(cuid())
  companyId     String
  transactionId String

  // Decision
  primaryAccountId   String?
  primaryAccountName String?
  fallbackAccountIds String[] @default([])
  blocked            Boolean  @default(false)
  blockReason        String?
  flaggedForReview   Boolean  @default(false)
  reviewReason       String?
  require3ds         Boolean  @default(false)

  // Amounts
  surchargeAmount Int @default(0)
  discountAmount  Int @default(0)
  originalAmount  Int
  finalAmount     Int

  // Applied rules
  appliedRuleIds   String[] @default([])
  appliedRuleNames String[] @default([])

  // Performance
  evaluationTimeMs  Int
  conditionsChecked Int
  rulesEvaluated    Int

  // Context
  contextSnapshot Json?

  createdAt DateTime @default(now())

  @@index([companyId])
  @@index([transactionId])
  @@index([createdAt])
  @@map("routing_decisions")
}

// =============================================================================
// BILLING & USAGE TRACKING
// =============================================================================

model PricingPlan {
  id String @id @default(cuid())

  // Plan identification
  name        String  @unique
  displayName String
  description String?

  // Billing
  billingInterval String @default("MONTHLY")
  baseCost        Int    @default(0)
  currency        String @default("USD")

  // Included allowances (JSON)
  included Json // { transactions: number, volume: number, apiCalls: number, ... }

  // Overage pricing (JSON)
  overage Json // { transactionPrice: number, volumePercent: number, ... }

  // Features (JSON)
  features Json @default("[]")

  // Limits (JSON)
  limits Json? // { maxCompanies: number, maxUsers: number, ... }

  // Status
  status    String  @default("active")
  isDefault Boolean @default(false)

  // Metadata
  sortOrder Int      @default(0)
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  subscriptions ClientSubscription[]

  @@index([status])
  @@map("pricing_plans")
}

model ClientSubscription {
  id       String @id @default(cuid())
  clientId String @unique
  planId   String

  // Status
  status          String    @default("active")
  statusReason    String?
  statusChangedAt DateTime?

  // Billing cycle
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  nextBillingDate    DateTime?
  billingAnchorDay   Int       @default(1)

  // Trial
  trialStart DateTime?
  trialEnd   DateTime?

  // Cancellation
  canceledAt        DateTime?
  cancelReason      String?
  cancelAtPeriodEnd Boolean   @default(false)

  // Pause
  pausedAt      DateTime?
  pauseResumeAt DateTime?
  pauseReason   String?

  // Discount
  discountPercent   Float?
  discountReason    String?
  discountExpiresAt DateTime?

  // Stripe integration
  stripeCustomerId     String?
  stripeSubscriptionId String?

  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  plan         PricingPlan   @relation(fields: [planId], references: [id])
  usagePeriods UsagePeriod[]
  invoices     Invoice[]

  @@index([planId])
  @@index([status])
  @@map("client_subscriptions")
}

model UsagePeriod {
  id             String @id @default(cuid())
  subscriptionId String
  clientId       String

  // Period dates
  periodStart DateTime
  periodEnd   DateTime

  // Transaction metrics
  transactionCount  Int    @default(0)
  transactionVolume BigInt @default(0)
  transactionCost   Int    @default(0)

  // Volume cost
  volumeCost Int @default(0)

  // API usage
  apiCallCount Int @default(0)
  apiCallCost  Int @default(0)

  // Resource usage
  companiesUsed Int @default(0)
  usersUsed     Int @default(0)
  storageUsedMb Int @default(0)

  // Costs
  baseCost    Int @default(0)
  overageCost Int @default(0)
  totalCost   Int @default(0)

  // Status
  status String @default("active")

  // Metadata
  closedAt  DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  subscription   ClientSubscription   @relation(fields: [subscriptionId], references: [id])
  companyRecords CompanyUsageRecord[]
  usageEvents    UsageEvent[]
  invoices       Invoice[]

  @@index([subscriptionId])
  @@index([clientId])
  @@index([status])
  @@index([periodStart, periodEnd])
  @@map("usage_periods")
}

model CompanyUsageRecord {
  id            String @id @default(cuid())
  usagePeriodId String
  companyId     String

  // Metrics
  transactionCount  Int    @default(0)
  transactionVolume BigInt @default(0)
  apiCallCount      Int    @default(0)

  // Calculated costs (allocated share)
  allocatedCost Int @default(0)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  usagePeriod UsagePeriod @relation(fields: [usagePeriodId], references: [id], onDelete: Cascade)

  @@unique([usagePeriodId, companyId])
  @@index([companyId])
  @@map("company_usage_records")
}

model UsageEvent {
  id            String  @id @default(cuid())
  usagePeriodId String
  companyId     String?

  // Event details
  eventType String
  quantity  Int    @default(1)
  unitCost  Int    @default(0)
  totalCost Int    @default(0)

  // Reference
  referenceType String?
  referenceId   String?

  // Metadata
  metadata   Json?
  occurredAt DateTime @default(now())
  createdAt  DateTime @default(now())

  // Relations
  usagePeriod UsagePeriod @relation(fields: [usagePeriodId], references: [id], onDelete: Cascade)

  @@index([usagePeriodId])
  @@index([companyId])
  @@index([eventType])
  @@index([occurredAt])
  @@map("usage_events")
}

model Invoice {
  id             String  @id @default(cuid())
  clientId       String
  subscriptionId String
  usagePeriodId  String?

  // Invoice number
  invoiceNumber String @unique

  // Period
  periodStart DateTime
  periodEnd   DateTime

  // Amounts (in cents)
  subtotal   Int
  discount   Int @default(0)
  tax        Int @default(0)
  total      Int
  amountPaid Int @default(0)
  amountDue  Int

  // Currency
  currency String @default("USD")

  // Line items (JSON array)
  lineItems Json @default("[]")

  // Status
  status String @default("draft")

  // Dates
  dueDate  DateTime
  paidAt   DateTime?
  voidedAt DateTime?
  sentAt   DateTime?

  // Stripe
  stripeInvoiceId       String?
  stripePaymentIntentId String?

  // Payment
  paymentMethod String?

  // PDF
  pdfUrl String?

  // Notes
  notes String?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  subscription ClientSubscription @relation(fields: [subscriptionId], references: [id])
  usagePeriod  UsagePeriod?       @relation(fields: [usagePeriodId], references: [id])

  @@index([clientId])
  @@index([subscriptionId])
  @@index([status])
  @@index([dueDate])
  @@map("invoices")
}

// =============================================================================
// SYSTEM MODELS
// =============================================================================

model ApiKey {
  id             String @id @default(cuid())
  organizationId String
  name           String
  keyHash        String @unique
  keyPrefix      String // First 8 chars for identification

  // Permissions
  scopes String[] @default([])

  // Usage
  lastUsedAt DateTime?
  expiresAt  DateTime?

  // Status
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("api_keys")
}

model AuditLog {
  id     String  @id @default(cuid())
  userId String?

  // What happened
  action   String
  entity   String
  entityId String?

  // Context
  scopeType ScopeType?
  scopeId   String?

  // Details
  changes   Json?
  metadata  Json?
  ipAddress String?
  userAgent String?

  // Data classification (for compliance)
  dataClassification DataClassification?

  // Timestamp
  createdAt DateTime @default(now())

  // Relations
  user User? @relation(fields: [userId], references: [id])

  @@index([entity, entityId])
  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@map("audit_logs")
}

// =============================================================================
// ENUMS
// =============================================================================

// Hierarchy & Access
enum BillingPlan {
  STARTER
  PROFESSIONAL
  ENTERPRISE
  CUSTOM
}

enum BillingStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  SUSPENDED
}

enum ClientPlan {
  BASIC
  STANDARD
  PREMIUM
  ENTERPRISE
}

enum EntityStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  DELETED
}

enum ScopeType {
  ORGANIZATION
  CLIENT
  COMPANY
  DEPARTMENT
  TEAM
  // Vendor hierarchy (parallel to Client)
  VENDOR
  VENDOR_COMPANY
  VENDOR_DEPARTMENT
  VENDOR_TEAM
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  USER
  VIEWER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

enum TeamRole {
  LEAD
  MEMBER
  VIEWER
}

// Customer & Address
enum CustomerStatus {
  ACTIVE
  INACTIVE
  BLOCKED
}

enum AddressType {
  SHIPPING
  BILLING
  BOTH
}

// Payment
enum PaymentProviderType {
  PAYFLOW
  NMI
  AUTHORIZE_NET
  STRIPE
  BRAINTREE
  SQUARE
  CUSTOM
}

enum PaymentMethodType {
  CARD
  ACH
  CHECK
  WIRE
  WALLET_APPLE
  WALLET_GOOGLE
  PAYPAL
  AFFIRM
  KLARNA
  CASH
  INVOICE
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  PAID
  PARTIALLY_REFUNDED
  REFUNDED
  FAILED
  VOIDED
}

enum TransactionType {
  CHARGE
  REFUND
  VOID
  CHARGEBACK
  ADJUSTMENT
  AUTHORIZATION
  CAPTURE
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  VOIDED
  DISPUTED
}

// Subscription
enum BillingInterval {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELED
  PAST_DUE
  TRIALING
  EXPIRED
}

enum RebillStatus {
  PENDING    // Scheduled but not yet processed
  PROCESSING // Currently being processed
  SUCCESS    // Payment succeeded
  FAILED     // Payment failed, may retry
  EXHAUSTED  // All retries exhausted
  SKIPPED    // Skipped (e.g., subscription paused)
}

// Product
enum ProductCategory {
  COFFEE
  EQUIPMENT
  MERCHANDISE
  GIFT_CARD
  SUBSCRIPTION_BOX
}

enum ProductStatus {
  ACTIVE
  DRAFT
  ARCHIVED
  OUT_OF_STOCK
}

enum RoastLevel {
  LIGHT
  MEDIUM_LIGHT
  MEDIUM
  MEDIUM_DARK
  DARK
}

// Order
enum OrderType {
  ONE_TIME
  SUBSCRIPTION
  GIFT
  REPLACEMENT
  SAMPLE
}

enum OrderStatus {
  PENDING // Created, awaiting payment
  CONFIRMED // Payment received
  PROCESSING // Being prepared (address locked)
  PARTIALLY_SHIPPED // Some items shipped
  SHIPPED // All items shipped
  DELIVERED // Customer received
  COMPLETED // Finalized
  CANCELED // Canceled by customer/system
  REFUNDED // Fully refunded
}

enum FulfillmentStatus {
  UNFULFILLED
  PARTIALLY_FULFILLED
  FULFILLED
  RETURNED
}

// Shipping
enum ShippingCarrier {
  USPS
  UPS
  FEDEX
  DHL
  AMAZON
  LOCAL_DELIVERY
  PICKUP
  OTHER
}

enum ShippingMethod {
  GROUND
  EXPRESS
  OVERNIGHT
  TWO_DAY
  SAME_DAY
  PICKUP
  FREE
}

enum ShipmentStatus {
  PENDING // Label not created
  LABEL_CREATED // Label printed, not shipped
  IN_TRANSIT // With carrier
  OUT_FOR_DELIVERY // On truck for delivery
  DELIVERED // Delivered
  FAILED // Delivery failed
  RETURNED // Returned to sender
  EXCEPTION // Problem occurred
}

enum ShipmentEventType {
  LABEL_CREATED
  PICKED_UP
  IN_TRANSIT
  ARRIVED_AT_FACILITY
  DEPARTED_FACILITY
  OUT_FOR_DELIVERY
  DELIVERY_ATTEMPTED
  DELIVERED
  EXCEPTION
  RETURNED_TO_SENDER
}

// Compliance
enum DataClassification {
  PUBLIC
  INTERNAL
  CONFIDENTIAL
  PII
  PCI
  PHI
}

// =============================================================================
// MOMENTUM INTELLIGENCE™ MODELS
// AI-Powered Behavioral Commerce Platform
// =============================================================================

model CustomerIntent {
  id         String @id @default(cuid())
  companyId  String
  customerId String

  // Risk Assessment
  churnScore Float          @default(0)
  churnRisk  ChurnRiskLevel @default(LOW)
  confidence Float          @default(0)

  // Contributing Signals
  signals        Json // Array of detected signals
  primaryFactors String[]

  // Recommended Action
  recommendedAction InterventionType?
  urgency           InterventionUrgency @default(MONITORING)

  // Timestamps
  calculatedAt DateTime @default(now())
  expiresAt    DateTime

  // Relations
  company       Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer      Customer       @relation(fields: [customerId], references: [id], onDelete: Cascade)
  interventions Intervention[]

  @@index([companyId, customerId])
  @@index([churnRisk, urgency])
  @@map("customer_intents")
}

model Intervention {
  id         String  @id @default(cuid())
  companyId  String
  customerId String
  intentId   String?

  // Intervention Details
  type    InterventionType
  channel DeliveryChannel
  stage   String? // For multi-stage flows

  // Content
  templateId String?
  content    Json? // Generated/customized content
  offers     Json? // Any offers presented

  // Execution
  status      InterventionStatus @default(PENDING)
  scheduledAt DateTime?
  executedAt  DateTime?

  // Outcome
  outcome        InterventionOutcome?
  outcomeDetails Json?
  revenueImpact  Float? // Positive = saved, Negative = lost

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company   Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer  Customer        @relation(fields: [customerId], references: [id], onDelete: Cascade)
  intent    CustomerIntent? @relation(fields: [intentId], references: [id])
  voiceCall VoiceCall?

  @@index([companyId, customerId])
  @@index([status, scheduledAt])
  @@index([type, outcome])
  @@map("interventions")
}

model SaveAttempt {
  id         String @id @default(cuid())
  companyId  String
  customerId String

  // Flow Tracking
  flowConfigId String
  startedAt    DateTime  @default(now())
  completedAt  DateTime?

  // Stage Progress
  currentStage Int  @default(1)
  stageHistory Json // Array of stage entries with timestamps

  // Diagnosis
  cancellationReason String?
  reasonCategory     String?

  // Outcome
  outcome       SaveOutcome?
  savedBy       String? // Which stage/offer saved them
  offerAccepted Json?

  // Attribution
  revenuePreserved Float? // LTV that was saved

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company  Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([companyId, customerId])
  @@index([outcome, savedBy])
  @@map("save_attempts")
}

model VoiceCall {
  id             String  @id @default(cuid())
  companyId      String
  customerId     String
  interventionId String? @unique

  // Twilio Details
  twilioCallSid String        @unique
  direction     CallDirection
  fromNumber    String
  toNumber      String

  // Timing
  initiatedAt DateTime  @default(now())
  answeredAt  DateTime?
  endedAt     DateTime?
  duration    Int? // Seconds

  // AI Processing
  scriptId            String
  transcriptRaw       String? @db.Text
  transcriptProcessed Json? // Structured transcript with intents

  // Sentiment & Intent
  overallSentiment Sentiment?
  detectedIntents  String[]
  keyMoments       Json? // Important moments in call

  // Outcome
  status         VoiceCallStatus @default(INITIATED)
  outcome        CallOutcome?
  outcomeDetails Json?

  // Offers & Actions
  offersPresented Json?
  offerAccepted   Json?
  actionsTaken    Json? // Pause, discount, escalate, etc.

  // Escalation
  escalatedToHuman Boolean @default(false)
  escalationReason String?
  humanAgentId     String?

  // Quality
  qualityScore Float? // 0-100
  qualityNotes String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company      Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer     Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  intervention Intervention? @relation(fields: [interventionId], references: [id])

  @@index([companyId, customerId])
  @@index([twilioCallSid])
  @@index([status, outcome])
  @@map("voice_calls")
}

model UpsellOffer {
  id         String @id @default(cuid())
  companyId  String
  customerId String

  // Offer Details
  type      UpsellType
  moment    UpsellMoment
  productId String?

  // Presentation
  contentId String? // Link to GeneratedContent
  position  String // Where shown in flow

  // Offer Terms
  originalPrice Float?
  offerPrice    Float?
  discount      Float?
  validUntil    DateTime?

  // Behavioral Config
  triggerUsed String? // Which trigger presented this

  // Outcome
  presented   Boolean   @default(false)
  presentedAt DateTime?
  accepted    Boolean?
  acceptedAt  DateTime?
  revenue     Float? // If accepted

  // Attribution
  attributionWindow Int? // Hours

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company  Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([companyId, customerId])
  @@index([type, moment, accepted])
  @@map("upsell_offers")
}

model UpsellConfig {
  id        String @id @default(cuid())
  companyId String @unique

  enabled           Boolean @default(true)
  aiRecommendations Boolean @default(true)

  // Frequency limits (JSON)
  globalLimits Json // { maxPresentationsPerDay, maxPresentationsPerWeek, cooldownAfterDecline, cooldownAfterAccept }

  // Channel settings (JSON)
  channelDefaults Json @default("{}") // Per-channel configuration

  // AI settings (JSON)
  aiSettings Json // { minConfidence, minRelevanceScore, maxRecommendations, optimizeFor }

  // Behavioral triggers (JSON)
  triggerSettings Json // { enabledTriggers, triggerConfigs }

  // A/B testing (JSON)
  abTesting Json @default("{\"enabled\": false, \"defaultTrafficSplit\": 50}")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("upsell_configs")
}

model SaveFlowConfig {
  id        String @id @default(cuid())
  companyId String @unique

  enabled Boolean @default(true)

  // Stage Configurations (JSON for flexibility)
  patternInterrupt       Json
  diagnosisSurvey        Json
  branchingInterventions Json
  nuclearOffer           Json
  lossVisualization      Json
  exitSurvey             Json
  winback                Json

  // Voice AI Settings
  voiceAIEnabled Boolean @default(false)
  voiceAIConfig  Json?

  // A/B Testing
  activeExperiments Json?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("save_flow_configs")
}

model VoiceScript {
  id        String @id @default(cuid())
  companyId String

  // Script Details
  name        String
  type        VoiceScriptType
  description String?

  // Script Content (JSON for flexibility)
  opening            Json // greeting, patternInterrupt, acknowledgment
  diagnosis          Json // primaryQuestion, followUpQuestions, sentimentResponses
  interventions      Json // condition-based responses with offers
  objectionHandling  Json // objection-response pairs
  closing            Json // acceptOffer, declineOffer, escalateToHuman, scheduleCallback
  behavioralTriggers Json // stage-based trigger configuration

  // Status
  isActive  Boolean @default(true)
  isDefault Boolean @default(false)

  // Performance
  usageCount      Int    @default(0)
  avgSaveRate     Float?
  avgCallDuration Float?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, name])
  @@index([companyId, type])
  @@map("voice_scripts")
}

model BehavioralTrigger {
  id String @id @default(cuid())

  // Trigger Details
  name        String  @unique
  displayName String
  description String?
  category    String // e.g., "urgency", "social_proof", "loss_aversion"

  // Implementation Guide (JSON)
  implementation Json // pricing, headlines, visuals guidance
  examples       String[]

  // Usage Stats
  usageCount       Int    @default(0)
  avgEffectiveness Float?

  // Status
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@map("behavioral_triggers")
}

model MomentumAnalytics {
  id          String   @id @default(cuid())
  companyId   String
  periodStart DateTime
  periodEnd   DateTime

  // Save Metrics
  totalSaveAttempts Int   @default(0)
  successfulSaves   Int   @default(0)
  saveRate          Float @default(0)
  revenuePreserved  Float @default(0)

  // Stage Performance (JSON)
  stageMetrics Json // Performance by stage

  // Channel Performance
  emailSaves Int @default(0)
  smsSaves   Int @default(0)
  voiceSaves Int @default(0)
  inAppSaves Int @default(0)

  // Voice AI Metrics
  totalCalls      Int   @default(0)
  avgCallDuration Float @default(0)
  voiceSaveRate   Float @default(0)

  // Content Performance
  contentGenerated     Int   @default(0)
  topPerformingContent Json?

  // Upsell Metrics
  upsellsPresented Int   @default(0)
  upsellsAccepted  Int   @default(0)
  upsellRevenue    Float @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, periodStart, periodEnd])
  @@index([companyId])
  @@index([periodStart, periodEnd])
  @@map("momentum_analytics")
}

// =============================================================================
// MOMENTUM INTELLIGENCE ENUMS
// =============================================================================

enum ChurnRiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum InterventionType {
  SAVE_FLOW
  PROACTIVE_OUTREACH
  PAYMENT_RECOVERY
  WINBACK
  UPSELL
  SERVICE_RECOVERY
}

enum InterventionUrgency {
  IMMEDIATE
  WITHIN_24H
  WITHIN_7D
  MONITORING
}

enum InterventionStatus {
  PENDING
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED
}

enum InterventionOutcome {
  SAVED
  OFFER_ACCEPTED
  DOWNGRADED
  PAUSED
  CANCELLED
  NO_RESPONSE
  ESCALATED
}

enum DeliveryChannel {
  EMAIL
  SMS
  VOICE
  IN_APP
  WEBHOOK
}

enum SaveOutcome {
  SAVED_STAGE_1
  SAVED_STAGE_2
  SAVED_STAGE_3
  SAVED_STAGE_4
  SAVED_STAGE_5
  SAVED_VOICE
  CANCELLED
  PAUSED
  DOWNGRADED
}

enum CallDirection {
  INBOUND
  OUTBOUND
}

enum VoiceCallStatus {
  INITIATED
  RINGING
  IN_PROGRESS
  COMPLETED
  FAILED
  BUSY
  NO_ANSWER
}

enum CallOutcome {
  SAVED
  OFFER_ACCEPTED
  DECLINED
  ESCALATED_TO_HUMAN
  CALLBACK_SCHEDULED
  DISCONNECTED
}

enum Sentiment {
  POSITIVE
  NEUTRAL
  NEGATIVE
  ANGRY
}

enum ContentType {
  EMAIL_SEQUENCE
  SMS_MESSAGE
  VOICE_SCRIPT
  AD_COPY
  LANDING_PAGE
  IN_APP_MODAL
  PUSH_NOTIFICATION
}

enum ContentStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  ACTIVE
  ARCHIVED
}

enum UpsellType {
  SHIPPING_PROTECTION
  TIER_UPGRADE
  FREQUENCY_UPGRADE
  ADD_ON
  GIFT_SUBSCRIPTION
  ANNUAL_PLAN
}

enum UpsellMoment {
  CHECKOUT
  POST_PURCHASE
  DAY_7
  DAY_14
  DAY_30
  MONTH_2
  MONTH_3
  SAVE_FLOW
  WINBACK
}

enum VoiceScriptType {
  INBOUND_SAVE
  OUTBOUND_SAVE
  WINBACK
  UPSELL
}

// =============================================================================
// MOMENTUM INTELLIGENCE - INTENT DETECTION (Enhanced)
// =============================================================================

model IntentDetection {
  id         String  @id @default(cuid())
  companyId  String
  customerId String
  sessionId  String?

  // Primary intent
  primaryIntent     String
  primaryConfidence Float

  // Secondary intents (JSON array)
  secondaryIntents Json @default("[]")

  // Cancel-specific
  cancelReason           String?
  cancelReasonConfidence Float?

  // Sentiment
  sentiment      String
  sentimentScore Float

  // Urgency
  urgency String

  // Source
  source     String
  sourceData Json?

  // Timestamps
  detectedAt DateTime @default(now())
  createdAt  DateTime @default(now())

  @@index([companyId])
  @@index([customerId])
  @@index([primaryIntent])
  @@index([detectedAt])
  @@map("intent_detections")
}

model ChurnSignal {
  id         String   @id @default(cuid())
  customerId String
  signalType String
  weight     Float
  value      String
  confidence Float    @default(0.8)
  decayDays  Int
  detectedAt DateTime @default(now())
  expiresAt  DateTime
  metadata   Json?

  @@index([customerId])
  @@index([signalType])
  @@index([expiresAt])
  @@map("churn_signals")
}

model ChurnRiskScore {
  id                 String    @id @default(cuid())
  customerId         String    @unique
  companyId          String
  score              Float
  riskLevel          String
  signalBreakdown    Json
  trend              String
  trendDelta         Float
  predictedChurnDate DateTime?
  recommendedActions String[]  @default([])
  calculatedAt       DateTime  @default(now())
  nextCalculationAt  DateTime

  @@index([companyId])
  @@index([riskLevel])
  @@index([score])
  @@map("churn_risk_scores")
}

model CustomerEngagementMetrics {
  id         String @id @default(cuid())
  customerId String @unique
  companyId  String

  // Login/Activity
  lastLoginAt         DateTime?
  loginFrequency      Float     @default(0)
  loginFrequencyTrend Float     @default(0)

  // Feature usage
  featuresUsed      String[] @default([])
  featureUsageScore Float    @default(0)

  // Order metrics
  totalOrders         Int   @default(0)
  ordersLast30Days    Int   @default(0)
  ordersLast90Days    Int   @default(0)
  orderFrequencyTrend Float @default(0)

  // Skip behavior
  totalSkips      Int   @default(0)
  skipsLast30Days Int   @default(0)
  skipRate        Float @default(0)

  // Support
  supportTicketsTotal      Int   @default(0)
  supportTicketsLast30Days Int   @default(0)
  avgTicketResolutionHours Float @default(0)

  // Feedback
  lastNpsScore          Int?
  lastNpsDate           DateTime?
  lastFeedbackSentiment String?

  // Scores
  engagementScore Float @default(50)
  healthScore     Float @default(50)

  calculatedAt DateTime @default(now())

  @@index([companyId])
  @@index([engagementScore])
  @@index([healthScore])
  @@map("customer_engagement_metrics")
}

// =============================================================================
// CUSTOMER SERVICE MANAGEMENT
// Two-Tier AI Customer Service System (AI Rep + AI Manager + Human)
// =============================================================================

model CSSession {
  id         String @id @default(cuid())
  companyId  String
  customerId String

  // Session Details
  channel     String // voice, chat, email, sms
  currentTier CSTier          @default(AI_REP)
  status      CSSessionStatus @default(ACTIVE)

  // Issue
  issueCategory String?
  issueSummary  String?

  // Sentiment Tracking
  customerSentiment String @default("NEUTRAL")
  sentimentHistory  Json   @default("[]")

  // Escalation
  escalationHistory Json @default("[]")

  // Context
  context Json @default("{}")

  // Resolution
  resolutionType       String?
  resolutionSummary    String?
  resolutionActions    Json?
  customerSatisfaction Int?
  followUpRequired     Boolean   @default(false)
  followUpDate         DateTime?

  // Timestamps
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  resolvedAt DateTime?

  // Relations
  messages CSMessage[]
  refunds  Refund[]
  rmas     RMA[]

  @@index([companyId])
  @@index([customerId])
  @@index([status])
  @@index([currentTier])
  @@map("cs_sessions")
}

model CSMessage {
  id        String  @id @default(cuid())
  sessionId String
  role      String // customer, ai_rep, ai_manager, human_agent, system
  content   String  @db.Text
  sentiment String?
  metadata  Json?

  // Timestamps
  createdAt DateTime @default(now())

  // Relations
  session CSSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@map("cs_messages")
}

model CSConfig {
  id        String @id @default(cuid())
  companyId String @unique

  enabled Boolean @default(true)

  // Tier configurations (JSON)
  aiRepConfig      Json
  aiManagerConfig  Json
  humanAgentConfig Json

  // Irate customer protocol
  irateProtocol Json

  // Channel configurations
  channelConfigs Json

  // Business hours
  businessHours Json

  // Response templates
  responseTemplates Json @default("[]")

  // Integrations
  integrations Json @default("{}")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("cs_configs")
}

// =============================================================================
// REFUND MANAGEMENT
// =============================================================================

model Refund {
  id          String  @id @default(cuid())
  companyId   String
  customerId  String
  orderId     String
  rmaId       String?
  csSessionId String?

  // Refund Details
  type          RefundType   @default(MANUAL)
  status        RefundStatus @default(PENDING)
  reason        RefundReason
  reasonDetails String?

  // Amount
  requestedAmount Decimal  @db.Decimal(10, 2)
  approvedAmount  Decimal? @db.Decimal(10, 2)
  currency        String   @default("USD")
  amountBreakdown Json?

  // Method
  method RefundMethod @default(ORIGINAL_PAYMENT)

  // Approval
  approvalLevel    String
  approvedBy       String?
  approvedAt       DateTime?
  rejectedBy       String?
  rejectedAt       DateTime?
  rejectionReason  String?
  autoApprovalRule String?

  // Processing
  paymentProcessor       String?
  processorTransactionId String?
  processedAt            DateTime?
  failureReason          String?
  retryCount             Int       @default(0)

  // Metadata
  initiatedBy    String // customer, ai_rep, ai_manager, human_agent, system
  channel        String?
  customerImpact String?
  fraudScore     Float?
  tags           String[] @default([])

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  // Relations
  company         Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer        Customer   @relation(fields: [customerId], references: [id])
  order           Order      @relation(fields: [orderId], references: [id])
  csSession       CSSession? @relation(fields: [csSessionId], references: [id])
  requestedByUser User?      @relation("RefundRequester", fields: [initiatedBy], references: [id])
  approvedByUser  User?      @relation("RefundApprover", fields: [approvedBy], references: [id])
  rejectedByUser  User?      @relation("RefundRejecter", fields: [rejectedBy], references: [id])

  @@index([companyId])
  @@index([customerId])
  @@index([orderId])
  @@index([status])
  @@index([type])
  @@map("refunds")
}

model RefundPolicy {
  id        String @id @default(cuid())
  companyId String @unique

  enabled Boolean @default(true)

  // Rules (JSON)
  generalRules        Json
  autoApprovalRules   Json @default("[]")
  tierLimits          Json
  reasonSpecificRules Json @default("[]")

  // Notifications
  notifications Json

  // Fraud prevention
  fraudPrevention Json

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("refund_policies")
}

// =============================================================================
// RMA (RETURN MERCHANDISE AUTHORIZATION)
// =============================================================================

model RMA {
  id          String  @id @default(cuid())
  rmaNumber   String  @unique
  companyId   String
  customerId  String
  orderId     String
  csSessionId String?

  // RMA Details
  type          RMAType      @default(RETURN)
  status        RMAStatus    @default(REQUESTED)
  reason        ReturnReason
  reasonDetails String?

  // Items
  items Json // Array of RMAItem

  // Shipping
  labelType      String // prepaid, customer_paid, pickup
  carrier        String?
  trackingNumber String?
  trackingUrl    String?
  labelUrl       String?
  labelSentAt    DateTime?
  shippedAt      DateTime?
  deliveredAt    DateTime?
  returnAddress  Json

  // Inspection
  inspectionStatus String?
  inspectionResult String?
  inspectionNotes  String?
  inspectionPhotos String[]  @default([])
  inspectedAt      DateTime?
  inspectedBy      String?

  // Resolution
  resolutionType   String @default("refund")
  resolutionStatus String @default("pending")
  resolutionData   Json?

  // Timeline
  timeline Json @default("[]")

  // Metadata
  initiatedBy   String
  channel       String?
  priority      String   @default("normal")
  tags          String[] @default([])
  internalNotes String?

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  expiresAt   DateTime
  completedAt DateTime?

  // Relations
  csSession CSSession? @relation(fields: [csSessionId], references: [id])

  @@index([companyId])
  @@index([customerId])
  @@index([orderId])
  @@index([status])
  @@index([rmaNumber])
  @@map("rmas")
}

model RMAPolicy {
  id        String @id @default(cuid())
  companyId String @unique

  enabled Boolean @default(true)

  // Rules (JSON)
  generalRules     Json
  returnReasons    Json @default("[]")
  shippingConfig   Json
  inspectionConfig Json
  resolutionConfig Json

  // Notifications
  notifications Json

  // Automation
  automation Json

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("rma_policies")
}

// =============================================================================
// TERMS & CONDITIONS
// =============================================================================

model TermsDocument {
  id        String @id @default(cuid())
  companyId String

  // Document Details
  type    TermsType
  title   String
  version String
  status  TermsStatus @default(DRAFT_TERMS)

  // Content
  fullText      String  @db.Text
  htmlFormatted String? @db.Text
  sections      Json    @default("[]")
  language      String  @default("en")
  translations  Json?

  // Readability
  readabilityScore  Int @default(0)
  wordCount         Int @default(0)
  estimatedReadTime Int @default(0)

  // Metadata
  author         String?
  lastModifiedBy String?
  reviewedBy     String?
  approvedBy     String?
  approvedAt     DateTime?
  generatedBy    String? // human, ai, hybrid
  aiModel        String?
  tags           String[]  @default([])
  internalNotes  String?
  externalUrl    String?

  // Compliance
  complianceFrameworks   String[] @default([])
  jurisdictions          String[] @default([])
  complianceRequirements Json     @default("[]")

  // History
  history Json @default("[]")

  // Dates
  effectiveDate  DateTime?
  expirationDate DateTime?

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  // Relations
  summaries   TermsSummary[]
  acceptances TermsAcceptance[]

  @@index([companyId])
  @@index([type])
  @@index([status])
  @@map("terms_documents")
}

model TermsSummary {
  id              String @id @default(cuid())
  termsDocumentId String

  // Summary Details
  format String // bullet_points, faq, plain_language, key_points, comparison
  level  String // simple, standard, technical, legal

  content         String @db.Text
  keyPoints       Json?
  faqs            Json?
  importantDates  Json?
  userRights      Json?
  userObligations Json?

  language String @default("en")

  // Timestamps
  createdAt DateTime @default(now())

  // Relations
  termsDocument TermsDocument @relation(fields: [termsDocumentId], references: [id], onDelete: Cascade)

  @@index([termsDocumentId])
  @@map("terms_summaries")
}

model TermsAcceptance {
  id              String  @id @default(cuid())
  termsDocumentId String
  termsVersion    String
  customerId      String
  userId          String?

  // Acceptance Details
  acceptanceMethod String // checkbox, click, signature, verbal, implicit

  // Context
  ipAddress  String?
  userAgent  String?
  location   String?
  deviceType String?
  channel    String?

  // Withdrawal
  withdrawnAt      DateTime?
  withdrawalReason String?

  // Timestamps
  acceptedAt DateTime @default(now())

  // Relations
  termsDocument TermsDocument @relation(fields: [termsDocumentId], references: [id])

  @@index([termsDocumentId])
  @@index([customerId])
  @@index([acceptedAt])
  @@map("terms_acceptances")
}

model TermsAnalytics {
  id              String @id @default(cuid())
  termsDocumentId String

  // Views
  totalViews    Int   @default(0)
  uniqueViews   Int   @default(0)
  avgTimeOnPage Float @default(0)

  // Acceptances
  totalAcceptances Int   @default(0)
  acceptanceRate   Float @default(0)

  // Section engagement
  sectionViews Json @default("{}")

  // Search
  searchQueries Json @default("[]")

  // FAQ clicks
  faqClicks Json @default("{}")

  // Period
  periodStart DateTime
  periodEnd   DateTime

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([termsDocumentId, periodStart, periodEnd])
  @@index([termsDocumentId])
  @@map("terms_analytics")
}

// =============================================================================
// CUSTOMER SERVICE ENUMS
// =============================================================================

enum CSTier {
  AI_REP
  AI_MANAGER
  HUMAN_AGENT
}

enum CSSessionStatus {
  ACTIVE
  WAITING_CUSTOMER
  ESCALATED
  RESOLVED
  ABANDONED
}

// =============================================================================
// REFUND ENUMS
// =============================================================================

enum RefundStatus {
  PENDING
  APPROVED
  PROCESSING
  COMPLETED
  REJECTED
  CANCELLED
  FAILED
}

enum RefundType {
  AUTO
  MANUAL
  FULL
  PARTIAL
  BULK
  MANAGER_OVERRIDE
}

enum RefundReason {
  PRODUCT_DEFECT
  DAMAGED_ITEM
  WRONG_ITEM
  NOT_AS_DESCRIBED
  SHIPPING_DAMAGE
  SHIPPING_ISSUE
  NEVER_RECEIVED
  DUPLICATE_CHARGE
  DUPLICATE_ORDER
  SUBSCRIPTION_CANCELLATION
  CUSTOMER_REQUEST
  SERVICE_ISSUE
  QUALITY_ISSUE
  LATE_DELIVERY
  PRICE_MATCH
  GOODWILL
  FRAUD
  OTHER
  OTHER_REASON
}

enum RefundMethod {
  ORIGINAL_PAYMENT
  STORE_CREDIT
  GIFT_CARD
  CHECK_PAYMENT
  BANK_TRANSFER
}

// =============================================================================
// RMA ENUMS
// =============================================================================

enum RMAStatus {
  REQUESTED
  RMA_APPROVED
  LABEL_SENT
  RMA_IN_TRANSIT
  RECEIVED
  INSPECTING
  INSPECTION_COMPLETE
  PROCESSING_REFUND
  RMA_COMPLETED
  RMA_REJECTED
  RMA_CANCELLED
  RMA_EXPIRED
}

enum RMAType {
  RETURN
  EXCHANGE
  WARRANTY
  REPAIR
  RECALL
}

enum ReturnReason {
  DEFECTIVE
  WRONG_SIZE
  WRONG_COLOR
  WRONG_ITEM_RECEIVED
  NOT_AS_DESCRIBED_RETURN
  DAMAGED_IN_SHIPPING
  ARRIVED_LATE
  NO_LONGER_NEEDED
  BETTER_PRICE_FOUND
  QUALITY_NOT_EXPECTED
  ACCIDENTAL_ORDER
  WARRANTY_CLAIM
  RECALL_RETURN
  OTHER_RETURN_REASON
}

// =============================================================================
// TERMS ENUMS
// =============================================================================

enum TermsType {
  TERMS_OF_SERVICE
  PRIVACY_POLICY
  REFUND_POLICY_DOC
  SHIPPING_POLICY
  SUBSCRIPTION_TERMS
  COOKIE_POLICY
  ACCEPTABLE_USE
  DATA_PROCESSING
  SLA
  CUSTOM_TERMS
}

enum TermsStatus {
  DRAFT_TERMS
  PENDING_REVIEW
  TERMS_APPROVED
  TERMS_ACTIVE
  TERMS_ARCHIVED
  SUPERSEDED
}

// =============================================================================
// OAUTH & INTEGRATION AUTH ENUMS
// =============================================================================

enum AuthType {
  API_KEY // Traditional API key authentication
  OAUTH2 // OAuth 2.0 authorization code flow
  OAUTH2_CLIENT // OAuth 2.0 client credentials flow
  BASIC_AUTH // Basic HTTP authentication
  CUSTOM // Custom authentication (webhook-based, etc.)
}

enum OAuthTokenStatus {
  ACTIVE // Token is valid and can be used
  EXPIRED // Token has expired, needs refresh
  REFRESH_FAILED // Refresh attempt failed
  REVOKED // Token was revoked by user or provider
  INVALID // Token is invalid (e.g., changed permissions)
}

enum OAuthFlowType {
  PLATFORM // Platform-level integration (org admin connecting)
  CLIENT // Client-level integration (client connecting their own)
}

// =============================================================================
// CONTENT GENERATION
// =============================================================================

model ContentTemplate {
  id        String @id @default(cuid())
  companyId String

  name        String
  description String?
  type        String
  purpose     String
  status      String  @default("DRAFT")

  subject   String?
  preheader String?
  body      String
  bodyHtml  String?

  variables Json @default("[]")

  aiGenerated Boolean @default(false)
  aiProvider  String?
  aiPrompt    String?

  triggersApplied String[] @default([])
  triggerConfig   Json?

  personalizationLevel String @default("basic")
  dynamicSections      Json?

  usageCount     Int    @default(0)
  conversionRate Float?
  openRate       Float?
  clickRate      Float?

  version           Int     @default(1)
  previousVersionId String?

  createdBy   String
  publishedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([type])
  @@index([purpose])
  @@index([status])
  @@map("content_templates")
}

model GeneratedContent {
  id         String  @id @default(cuid())
  companyId  String
  templateId String?

  type     String
  purpose  String
  provider String

  prompt       String
  systemPrompt String?

  subject  String?
  body     String
  bodyHtml String?

  variations          Json?
  selectedVariationId String?

  customerId      String?
  customerContext Json?

  triggersApplied     String[] @default([])
  triggerApplications Json?

  qualityScore     Float?
  readabilityScore Float?
  sentimentScore   Float?

  tokensUsed       Int    @default(0)
  generationTimeMs Int    @default(0)
  cost             Float?

  status      String    @default("GENERATED")
  reviewedBy  String?
  reviewedAt  DateTime?
  reviewNotes String?

  createdAt DateTime @default(now())

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([type])
  @@index([purpose])
  @@index([status])
  @@map("generated_contents")
}

model ContentGenerationConfig {
  id        String @id @default(cuid())
  companyId String @unique

  providers       Json
  claude          Json
  ollama          Json
  quality         Json
  triggers        Json
  brandVoice      Json
  personalization Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("content_generation_configs")
}

// =============================================================================
// DELIVERY ORCHESTRATION
// =============================================================================

model DeliveryMessage {
  id         String @id @default(cuid())
  companyId  String
  customerId String

  recipientEmail        String?
  recipientPhone        String?
  recipientDeviceTokens String[] @default([])

  channel  String
  priority String @default("NORMAL")

  templateId String?
  contentId  String?
  subject    String?
  body       String
  bodyHtml   String?

  category String
  tags     String[] @default([])

  scheduleType      String    @default("IMMEDIATE")
  scheduledFor      DateTime?
  optimalSendWindow Json?

  status        String @default("PENDING")
  statusHistory Json   @default("[]")

  providerMessageId String?
  sentAt            DateTime?
  deliveredAt       DateTime?
  openedAt          DateTime?
  clickedAt         DateTime?
  convertedAt       DateTime?
  failedAt          DateTime?
  failureReason     String?

  opensCount   Int      @default(0)
  clicksCount  Int      @default(0)
  clickedLinks String[] @default([])

  variantId    String?
  experimentId String?

  automationId     String?
  automationStepId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([customerId])
  @@index([status])
  @@index([scheduledFor])
  @@map("delivery_messages")
}

model DeliveryRetry {
  id               String    @id @default(cuid())
  messageId        String
  retriesRemaining Int
  lastRetryAt      DateTime?
  nextRetryAt      DateTime

  @@index([messageId])
  @@index([nextRetryAt])
  @@map("delivery_retries")
}

model CustomerPreference {
  id             String    @id @default(cuid())
  customerId     String
  channel        String
  unsubscribed   Boolean   @default(false)
  unsubscribedAt DateTime?

  @@unique([customerId, channel])
  @@map("customer_preferences")
}

model DeliveryConfig {
  id        String @id @default(cuid())
  companyId String @unique

  channelPriority String[]
  defaultChannel  String

  sendTimeOptimization Json
  globalRateLimits     Json

  honorUnsubscribes Boolean @default(true)
  doubleOptIn       Boolean @default(false)

  trackOpens       Boolean @default(true)
  trackClicks      Boolean @default(true)
  trackConversions Boolean @default(true)

  retrySettings Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("delivery_configs")
}

model Automation {
  id        String @id @default(cuid())
  companyId String

  name        String
  description String?
  category    String
  status      String  @default("DRAFT")

  trigger Json
  steps   Json

  settings Json

  enrollmentCount Int    @default(0)
  completionCount Int    @default(0)
  conversionCount Int    @default(0)
  conversionRate  Float?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  activatedAt DateTime?

  enrollments AutomationEnrollment[]

  @@index([companyId])
  @@index([status])
  @@map("automations")
}

model AutomationEnrollment {
  id           String @id @default(cuid())
  automationId String
  customerId   String

  status String @default("ACTIVE")

  currentStepId        String?
  currentStepStartedAt DateTime?

  stepsCompleted String[] @default([])
  messagesSent   String[] @default([])

  triggerData Json?

  enrolledAt  DateTime  @default(now())
  completedAt DateTime?
  exitedAt    DateTime?
  exitReason  String?

  convertedAt     DateTime?
  conversionValue Decimal?  @db.Decimal(10, 2)

  automation Automation @relation(fields: [automationId], references: [id])

  @@index([automationId])
  @@index([customerId])
  @@index([status])
  @@map("automation_enrollments")
}

// =============================================================================
// ANALYTICS & REPORTING
// =============================================================================

model AnalyticsReport {
  id        String @id @default(cuid())
  companyId String

  name        String
  description String?

  metrics       Json // Array of MetricCategory
  customMetrics Json? // Custom metric definitions

  filters  Json // Date range, segments, products, channels
  schedule Json? // Frequency, day, time, timezone
  delivery Json // Format, recipients, options

  isActive Boolean @default(true)

  lastGeneratedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([isActive])
  @@map("analytics_reports")
}

model AnalyticsSnapshot {
  id        String @id @default(cuid())
  companyId String

  snapshotDate DateTime
  granularity  String // hour, day, week, month

  // Churn metrics
  churnRate        Float   @default(0)
  churnedCustomers Int     @default(0)
  churnedRevenue   Decimal @default(0) @db.Decimal(10, 2)

  // Save flow metrics
  saveAttempts    Int     @default(0)
  successfulSaves Int     @default(0)
  saveRate        Float   @default(0)
  revenueSaved    Decimal @default(0) @db.Decimal(10, 2)

  // Voice metrics
  totalCalls      Int   @default(0)
  avgCallDuration Float @default(0)
  callSaveRate    Float @default(0)

  // Delivery metrics
  messagesSent      Int   @default(0)
  messagesDelivered Int   @default(0)
  deliveryRate      Float @default(0)
  openRate          Float @default(0)
  clickRate         Float @default(0)

  // Upsell metrics
  upsellsPresented     Int     @default(0)
  upsellsConverted     Int     @default(0)
  upsellConversionRate Float   @default(0)
  upsellRevenue        Decimal @default(0) @db.Decimal(10, 2)

  // Revenue metrics
  totalRevenue        Decimal @default(0) @db.Decimal(10, 2)
  recurringRevenue    Decimal @default(0) @db.Decimal(10, 2)
  netRevenueRetention Float   @default(0)

  // Active customers
  activeSubscriptions Int @default(0)
  atRiskCustomers     Int @default(0)

  createdAt DateTime @default(now())

  @@unique([companyId, snapshotDate, granularity])
  @@index([companyId])
  @@index([snapshotDate])
  @@map("analytics_snapshots")
}

model DashboardAlert {
  id        String @id @default(cuid())
  companyId String

  type     String // warning, critical, info, success
  category String // churn, save_flow, delivery, upsell, revenue, engagement
  title    String
  message  String

  metric       String?
  threshold    Float?
  currentValue Float?
  actionUrl    String?

  acknowledgedAt DateTime?
  acknowledgedBy String?

  dismissedAt DateTime?
  dismissedBy String?

  createdAt DateTime @default(now())

  @@index([companyId])
  @@index([type])
  @@index([category])
  @@index([createdAt])
  @@map("dashboard_alerts")
}

// =============================================================================
// INTEGRATIONS FRAMEWORK
// =============================================================================

model IntegrationDefinition {
  id                 String   @id @default(cuid())
  provider           String   @unique
  category           String
  name               String
  description        String
  logoUrl            String?
  documentationUrl   String?
  isOrgOnly          Boolean  @default(false)
  isClientAllowed    Boolean  @default(true)
  isPlatformOffered  Boolean  @default(false)
  credentialSchema   Json
  settingsSchema     Json     @default("{}")
  requiredCompliance String[] @default([])
  status             String   @default("active")

  // OAuth Configuration
  authType    AuthType @default(API_KEY)
  oauthConfig Json? // OAuth-specific config: authorizationUrl, tokenUrl, scopes, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("integration_definitions")
}

// OAuth Token Storage for OAuth-based integrations
model OAuthToken {
  id String @id @default(cuid())

  // Ownership - can be platform-level or client-level
  platformIntegrationId String?
  clientIntegrationId   String?

  // Token data (encrypted)
  accessToken  String  @db.Text
  refreshToken String? @db.Text
  tokenType    String  @default("Bearer")

  // Expiration tracking
  expiresAt        DateTime?
  refreshExpiresAt DateTime?

  // Scopes granted
  scopes String[] @default([])

  // Provider-specific data
  providerUserId    String? // User ID at the OAuth provider
  providerAccountId String? // Account ID if different from user
  providerData      Json? // Additional provider-specific metadata

  // Encryption
  keyVersion Int @default(1)

  // Status
  status          OAuthTokenStatus @default(ACTIVE)
  lastRefreshedAt DateTime?
  lastUsedAt      DateTime?
  errorMessage    String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([platformIntegrationId])
  @@index([clientIntegrationId])
  @@index([status])
  @@index([expiresAt])
  @@map("oauth_tokens")
}

// OAuth State for CSRF protection during authorization flow
model OAuthState {
  id    String @id @default(cuid())
  state String @unique

  // Context for the OAuth flow
  provider       String
  organizationId String?
  clientId       String?
  userId         String

  // Flow type
  flowType OAuthFlowType @default(PLATFORM)

  // Redirect after completion
  redirectUrl String?

  // Additional context
  metadata Json?

  // Expiration (short-lived)
  expiresAt DateTime

  // Status
  usedAt DateTime?

  createdAt DateTime @default(now())

  @@index([state])
  @@index([expiresAt])
  @@map("oauth_states")
}

model PlatformIntegration {
  id                  String    @id @default(cuid())
  organizationId      String
  provider            String
  category            String
  name                String
  description         String?
  credentials         Json
  settings            Json      @default("{}")
  environment         String    @default("SANDBOX")
  isSharedWithClients Boolean   @default(false)
  clientPricing       Json?
  status              String    @default("PENDING")
  lastTestedAt        DateTime?
  lastTestResult      String?
  errorMessage        String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  createdBy           String
  updatedBy           String?

  organization       Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  clientIntegrations ClientIntegration[]

  @@unique([organizationId, provider])
  @@index([organizationId])
  @@map("platform_integrations")
}

model ClientIntegration {
  id                    String    @id @default(cuid())
  clientId              String
  provider              String
  category              String
  name                  String
  description           String?
  mode                  String    @default("OWN")
  credentials           Json?
  platformIntegrationId String?
  settings              Json      @default("{}")
  environment           String    @default("SANDBOX")
  usageThisMonth        Json?
  isDefault             Boolean   @default(false)
  priority              Int       @default(0)
  status                String    @default("PENDING")
  isVerified            Boolean   @default(false)
  verifiedAt            DateTime?
  verifiedBy            String?
  lastTestedAt          DateTime?
  lastTestResult        String?
  errorMessage          String?
  merchantAccountId     String?   @unique
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  createdBy             String
  updatedBy             String?

  client              Client               @relation(fields: [clientId], references: [id], onDelete: Cascade)
  platformIntegration PlatformIntegration? @relation(fields: [platformIntegrationId], references: [id])
  merchantAccount     MerchantAccount?     @relation(fields: [merchantAccountId], references: [id])

  @@unique([clientId, provider, name])
  @@index([clientId])
  @@map("client_integrations")
}

// =============================================================================
// SOFT DELETE & DELETION AUDIT LOG
// Enterprise soft delete system with cascade tracking and retention management
// =============================================================================

model DeletionLog {
  id String @id @default(cuid())

  // Entity identification
  entityType String // Model name: Client, Company, Customer, etc.
  entityId   String // ID of the deleted entity
  entityName String? // Friendly name for display

  // Company context (for access control)
  companyId String?

  // Who deleted
  deletedBy String // User ID who initiated deletion
  deletedAt DateTime @default(now())
  reason    String? // Optional deletion reason

  // Cascade tracking
  cascadeId    String? // Groups related cascade deletions
  cascadedFrom String? // Parent entity ID if cascade-deleted

  // Entity snapshot (for potential restoration)
  snapshot Json? // Full entity data at deletion time

  // Retention management
  expiresAt DateTime // When permanent purge is allowed

  // Restoration tracking
  restoredAt DateTime?
  restoredBy String?

  // Permanent deletion tracking
  purgedAt    DateTime?
  purgeReason String? // RETENTION_EXPIRED, GDPR_REQUEST, ADMIN_REQUEST

  // Relations
  deletedByUser User? @relation("UserDeletions", fields: [deletedBy], references: [id])

  @@index([entityType, entityId])
  @@index([companyId])
  @@index([cascadeId])
  @@index([deletedAt])
  @@index([restoredAt])
  @@index([expiresAt])
  @@map("deletion_logs")
}

// =============================================================================
// WEBHOOK NOTIFICATIONS
// =============================================================================

model Webhook {
  id        String @id @default(cuid())
  companyId String

  // Webhook details
  name   String
  url    String
  events String[] @default([])

  // Authentication
  secret  String?
  headers Json?   @default("{}")

  // Status
  isActive        Boolean   @default(true)
  lastTriggeredAt DateTime?
  lastStatus      String?
  failureCount    Int       @default(0)

  // Soft delete
  deletedAt DateTime?
  deletedBy String?
  cascadeId String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, name, deletedAt])
  @@index([companyId])
  @@index([deletedAt])
  @@map("webhooks")
}

// =============================================================================
// FEATURE 10: ENHANCED PRODUCTS SYSTEM
// Categories, Tags, Media, Price Rules
// =============================================================================

model Category {
  id        String  @id @default(cuid())
  companyId String
  parentId  String?

  name        String
  slug        String
  description String?
  imageUrl    String?

  // Hierarchy
  level Int    @default(0)
  path  String // Materialized path: "root/parent/child"

  // Display
  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  // SEO
  metaTitle       String?
  metaDescription String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Soft Delete
  deletedAt DateTime?
  deletedBy String?
  cascadeId String?

  // Relations
  company       Company                     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  parent        Category?                   @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children      Category[]                  @relation("CategoryHierarchy")
  products      ProductCategoryAssignment[]
  deletedByUser User?                       @relation("CategoryDeletedBy", fields: [deletedBy], references: [id])

  @@unique([companyId, slug, deletedAt])
  @@unique([companyId, parentId, name, deletedAt])
  @@index([companyId, parentId])
  @@index([companyId, isActive])
  @@index([path])
  @@index([deletedAt])
  @@map("categories")
}

model ProductCategoryAssignment {
  id         String  @id @default(cuid())
  productId  String
  categoryId String
  isPrimary  Boolean @default(false)
  sortOrder  Int     @default(0)

  createdAt DateTime @default(now())

  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([productId, categoryId])
  @@index([categoryId])
  @@map("product_categories")
}

model Tag {
  id        String @id @default(cuid())
  companyId String

  name  String
  slug  String
  color String? // Hex color for UI

  createdAt DateTime @default(now())

  company  Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  products ProductTag[]

  @@unique([companyId, slug])
  @@index([companyId])
  @@map("tags")
}

model ProductTag {
  id        String @id @default(cuid())
  productId String
  tagId     String

  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([productId, tagId])
  @@index([tagId])
  @@map("product_tags")
}

model ProductMedia {
  id        String  @id @default(cuid())
  productId String
  variantId String? // Optional: variant-specific media

  type         MediaType
  url          String
  thumbnailUrl String?

  // Metadata
  filename String
  mimeType String
  size     Int // Bytes
  width    Int?
  height   Int?
  duration Int? // Seconds (for video)

  // Display
  altText   String?
  caption   String?
  sortOrder Int     @default(0)
  isPrimary Boolean @default(false)

  // AI Generation Info
  generatedBy        String? // 'RUNWAY', 'CLOUDINARY', etc.
  generationMetadata Json? // Task ID, settings used, etc.

  // Storage Info
  storageProvider String  @default("S3")
  storageKey      String // S3 key or path
  cdnUrl          String? // CloudFront URL

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@index([productId, type, sortOrder])
  @@index([variantId])
  @@map("product_media")
}

model ProductPriceRule {
  id        String @id @default(cuid())
  productId String

  name String
  type PriceRuleType

  // Conditions
  minQuantity     Int?
  maxQuantity     Int?
  customerGroupId String?
  startDate       DateTime?
  endDate         DateTime?

  // Adjustment
  adjustmentType  AdjustmentType
  adjustmentValue Decimal        @db.Decimal(10, 2)

  // Priority (higher wins)
  priority Int     @default(0)
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId, isActive])
  @@index([startDate, endDate])
  @@map("product_price_rules")
}

// =============================================================================
// FEATURE 10B: EXTENDED PRODUCTS
// Variants, Collections, Bundles, Inventory
// =============================================================================

model ProductVariant {
  id        String @id @default(cuid())
  productId String

  name    String // e.g., "Large / Red"
  sku     String
  barcode String?

  // Variant Options
  options Json // { "Size": "Large", "Color": "Red" }

  // Pricing (overrides product if set)
  price          Decimal? @db.Decimal(10, 2)
  compareAtPrice Decimal? @db.Decimal(10, 2)
  costPrice      Decimal? @db.Decimal(10, 2)

  // Physical (overrides product if set)
  weight Decimal? @db.Decimal(10, 3)

  // Inventory
  trackInventory    Boolean @default(true)
  inventoryQuantity Int     @default(0)
  lowStockThreshold Int?

  // Status
  isActive  Boolean @default(true)
  sortOrder Int     @default(0)

  // Soft Delete
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product         Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  media           ProductMedia[]
  inventoryLevels InventoryLevel[]
  bundleItems     BundleItem[]

  @@unique([productId, sku])
  @@index([productId, isActive, deletedAt])
  @@index([sku])
  @@map("product_variants")
}

model VariantOption {
  id        String @id @default(cuid())
  companyId String

  name        String // e.g., "Size", "Color"
  displayName String
  sortOrder   Int    @default(0)

  createdAt DateTime @default(now())

  company Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  values  VariantOptionValue[]

  @@unique([companyId, name])
  @@map("variant_options")
}

model VariantOptionValue {
  id       String @id @default(cuid())
  optionId String

  value        String // e.g., "Small", "Medium", "Large"
  displayValue String?
  colorCode    String? // Hex for color swatches
  imageUrl     String? // Image for visual options
  sortOrder    Int     @default(0)

  createdAt DateTime @default(now())

  option VariantOption @relation(fields: [optionId], references: [id], onDelete: Cascade)

  @@unique([optionId, value])
  @@map("variant_option_values")
}

model Collection {
  id        String @id @default(cuid())
  companyId String

  name        String
  slug        String
  description String?

  // Display
  imageUrl  String?
  bannerUrl String?

  // Type
  type CollectionType @default(MANUAL)

  // Auto-collection rules (if type = AUTOMATIC)
  rules Json? // { conditions: [...], match: 'all' | 'any' }

  // Publishing
  isActive    Boolean   @default(true)
  publishedAt DateTime?

  // SEO
  metaTitle       String?
  metaDescription String?

  // Display Order
  sortOrder Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company  Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  products CollectionProduct[]

  @@unique([companyId, slug])
  @@index([companyId, isActive])
  @@map("collections")
}

model CollectionProduct {
  id           String @id @default(cuid())
  collectionId String
  productId    String
  sortOrder    Int    @default(0)

  createdAt DateTime @default(now())

  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  product    Product    @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([collectionId, productId])
  @@index([productId])
  @@map("collection_products")
}

model Bundle {
  id        String @id @default(cuid())
  companyId String
  productId String @unique // Bundle IS a product

  // Bundle Settings
  type     BundleType @default(FIXED)
  minItems Int? // For MIX_AND_MATCH
  maxItems Int?

  // Pricing
  pricingStrategy BundlePricing   @default(FIXED)
  discountType    AdjustmentType?
  discountValue   Decimal?        @db.Decimal(10, 2)

  // Status
  isActive  Boolean   @default(true)
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  product Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  items   BundleItem[]

  @@index([companyId])
  @@map("bundles")
}

model BundleItem {
  id        String  @id @default(cuid())
  bundleId  String
  productId String
  variantId String?

  quantity   Int     @default(1)
  isRequired Boolean @default(true)
  sortOrder  Int     @default(0)

  // Override pricing for this item in bundle
  priceOverride Decimal? @db.Decimal(10, 2)

  createdAt DateTime @default(now())

  bundle  Bundle          @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@unique([bundleId, productId, variantId])
  @@map("bundle_items")
}

model InventoryLocation {
  id        String @id @default(cuid())
  companyId String

  name String
  code String
  type LocationType @default(WAREHOUSE)

  // Address
  address1   String?
  address2   String?
  city       String?
  state      String?
  postalCode String?
  country    String?

  isActive  Boolean @default(true)
  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company         Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  inventoryLevels InventoryLevel[]

  @@unique([companyId, code])
  @@map("inventory_locations")
}

model InventoryLevel {
  id         String  @id @default(cuid())
  locationId String
  productId  String?
  variantId  String?

  // Quantities
  onHand    Int @default(0)
  committed Int @default(0) // Reserved for orders
  incoming  Int @default(0) // Expected from POs
  available Int @default(0) // Computed: onHand - committed

  // Thresholds
  reorderPoint    Int?
  reorderQuantity Int?

  updatedAt DateTime @updatedAt

  location    InventoryLocation     @relation(fields: [locationId], references: [id], onDelete: Cascade)
  product     Product?              @relation(fields: [productId], references: [id])
  variant     ProductVariant?       @relation(fields: [variantId], references: [id])
  adjustments InventoryAdjustment[]

  @@unique([locationId, productId, variantId])
  @@index([productId])
  @@index([variantId])
  @@map("inventory_levels")
}

model InventoryAdjustment {
  id               String @id @default(cuid())
  inventoryLevelId String

  type             AdjustmentReason
  quantity         Int // Positive or negative
  previousQuantity Int
  newQuantity      Int

  reason        String?
  referenceType String? // 'ORDER', 'TRANSFER', 'COUNT'
  referenceId   String?

  createdAt   DateTime @default(now())
  createdById String

  inventoryLevel InventoryLevel @relation(fields: [inventoryLevelId], references: [id], onDelete: Cascade)
  createdBy      User           @relation(fields: [createdById], references: [id])

  @@index([inventoryLevelId, createdAt])
  @@index([referenceType, referenceId])
  @@map("inventory_adjustments")
}

// =============================================================================
// FEATURE 10C: AI MARKETING VIDEOS
// =============================================================================

model MarketingVideo {
  id        String  @id @default(cuid())
  companyId String
  productId String?

  // Video Info
  name   String
  type   MarketingVideoType
  status VideoGenerationStatus @default(PENDING)

  // Template & Style
  templateId String?
  style      Json? // Colors, fonts, mood

  // Content
  script        String?
  voiceoverText String?
  callToAction  String?

  // Final Output
  outputUrl    String?
  thumbnailUrl String?
  duration     Int? // Seconds

  // Generation Tracking
  generationStartedAt   DateTime?
  generationCompletedAt DateTime?
  generationError       String?
  creditsUsed           Decimal?  @db.Decimal(10, 2)

  // Momentum Intelligence Link (for retention videos)
  customerId     String?
  interventionId String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String

  company   Company                 @relation(fields: [companyId], references: [id], onDelete: Cascade)
  product   Product?                @relation(fields: [productId], references: [id])
  template  MarketingVideoTemplate? @relation(fields: [templateId], references: [id])
  customer  Customer?               @relation(fields: [customerId], references: [id])
  createdBy User                    @relation(fields: [createdById], references: [id])
  scenes    MarketingVideoScene[]
  variants  MarketingVideoVariant[]

  @@index([companyId, status])
  @@index([productId])
  @@index([customerId])
  @@map("marketing_videos")
}

model MarketingVideoScene {
  id      String @id @default(cuid())
  videoId String

  sceneNumber Int
  duration    Int // Seconds

  // Visual
  mediaType        SceneMediaType
  mediaUrl         String?
  mediaGeneratedBy String? // 'RUNWAY', 'STATIC', etc.

  // Text Overlay
  textOverlay  String?
  textPosition String? // 'top', 'center', 'bottom'
  textStyle    Json?

  // Transition
  transitionIn  String? // 'fade', 'slide', etc.
  transitionOut String?

  createdAt DateTime @default(now())

  video MarketingVideo @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([videoId, sceneNumber])
  @@map("marketing_video_scenes")
}

model MarketingVideoVariant {
  id      String @id @default(cuid())
  videoId String

  platform    VideoPlatform
  aspectRatio String // '9:16', '1:1', '16:9'

  outputUrl    String?
  thumbnailUrl String?

  // Platform-specific metadata
  metadata Json?

  createdAt DateTime @default(now())

  video MarketingVideo @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([videoId, platform])
  @@map("marketing_video_variants")
}

model MarketingVideoTemplate {
  id        String  @id @default(cuid())
  companyId String? // Null = system template

  name        String
  description String?
  type        MarketingVideoType

  // Template Structure
  sceneCount      Int
  defaultDuration Int // Total seconds
  structure       Json // Scene definitions

  // Style Defaults
  defaultStyle Json?

  // Script Template
  scriptTemplate String?

  isActive Boolean @default(true)
  isSystem Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company?         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  videos  MarketingVideo[]

  @@index([type, isActive])
  @@map("marketing_video_templates")
}

// =============================================================================
// FEATURE 10/10B/10C ENUMS
// =============================================================================

enum MediaType {
  IMAGE
  VIDEO
  MODEL_3D
  DOCUMENT
}

enum PriceRuleType {
  QUANTITY_BREAK // Buy more, save more
  CUSTOMER_GROUP // Special pricing for group
  TIME_BASED // Sale pricing
  SUBSCRIPTION // Recurring order discount
}

enum AdjustmentType {
  FIXED_AMOUNT // -$5.00
  PERCENTAGE // -10%
  FIXED_PRICE // Set to $19.99
}

enum CollectionType {
  MANUAL // Manually curated
  AUTOMATIC // Rules-based auto-population
}

enum BundleType {
  FIXED // Specific products, fixed quantities
  MIX_AND_MATCH // Customer chooses from allowed products
  SUBSCRIPTION_BOX // Curated monthly box
}

enum BundlePricing {
  FIXED // Set bundle price
  CALCULATED // Sum of items with optional discount
  TIERED // Price varies by selection
}

enum LocationType {
  WAREHOUSE
  STORE
  DROPSHIP
  VIRTUAL
}

enum AdjustmentReason {
  RECEIVED // Stock received
  SOLD // Sold to customer
  RETURNED // Customer return
  DAMAGED // Damaged/written off
  LOST // Lost/shrinkage
  FOUND // Found during count
  TRANSFERRED // Moved between locations
  COUNT_ADJUSTMENT // Physical count correction
  OTHER
}

enum MarketingVideoType {
  PRODUCT_SHOWCASE // Standard product video
  PRODUCT_LAUNCH // New product announcement
  SALE_PROMO // Sale/discount promotion
  TESTIMONIAL // Customer testimonial style
  TUTORIAL // How-to/explainer
  BRAND_STORY // Brand narrative
  RETENTION_WINBACK // Personalized win-back
  RETENTION_ANNIVERSARY // Customer milestone
  RETENTION_REMINDER // Subscription reminder
  SOCIAL_AD // Generic social ad
}

enum VideoGenerationStatus {
  PENDING
  GENERATING_SCRIPT
  GENERATING_MEDIA
  GENERATING_VOICE
  COMPOSING
  EXPORTING
  COMPLETED
  FAILED
}

enum SceneMediaType {
  PRODUCT_IMAGE
  AI_GENERATED_VIDEO
  STOCK_VIDEO
  SOLID_COLOR
  GRADIENT
}

enum VideoPlatform {
  TIKTOK
  INSTAGRAM_REELS
  INSTAGRAM_STORIES
  INSTAGRAM_FEED
  FACEBOOK_REELS
  FACEBOOK_FEED
  YOUTUBE_SHORTS
  YOUTUBE
  TWITTER
  LINKEDIN
}

// =============================================================================
// FEATURE 02: DYNAMIC RBAC SYSTEM
// Role-Based Access Control with Permission Ceiling Pattern
// =============================================================================

model Permission {
  id          String  @id @default(cuid())
  code        String  @unique // e.g., "transactions:read", "users:write"
  name        String // Human-readable name
  description String?
  category    String // Grouping: "transactions", "users", "settings"

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  rolePermissions  RolePermission[]
  permissionGrants PermissionGrant[]

  @@index([category])
  @@map("permissions")
}

model Role {
  id          String  @id @default(cuid())
  name        String // e.g., "Company Admin", "Billing Manager"
  slug        String // e.g., "company_admin", "billing_manager"
  description String?
  color       String? // For UI display

  // Scope - where this role can be assigned
  scopeType ScopeType // ORGANIZATION, CLIENT, COMPANY, etc.
  scopeId   String? // Optional: limit to specific org/client/company

  // Role properties
  isSystem  Boolean @default(false) // Built-in roles (cannot be deleted)
  isDefault Boolean @default(false) // Auto-assigned to new users at this scope
  priority  Int     @default(100) // Lower = more important (for display)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Soft delete
  deletedAt DateTime?
  deletedBy String?

  // Relations
  permissions         RolePermission[]
  userRoleAssignments UserRoleAssignment[]

  @@unique([scopeType, scopeId, slug])
  @@index([scopeType, scopeId])
  @@index([deletedAt])
  @@map("roles")
}

model RolePermission {
  id           String @id @default(cuid())
  roleId       String
  permissionId String

  // Constraints
  constraints Json? // Optional: limit permission scope (e.g., {"resourceId": "..."})

  // Timestamps
  createdAt DateTime @default(now())

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model UserRoleAssignment {
  id     String @id @default(cuid())
  userId String
  roleId String

  // Scope where this role applies
  scopeType ScopeType
  scopeId   String

  // Assignment metadata
  assignedBy String?
  assignedAt DateTime  @default(now())
  expiresAt  DateTime? // Optional: temporary role assignment

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId, scopeType, scopeId])
  @@index([userId])
  @@index([roleId])
  @@index([scopeType, scopeId])
  @@map("user_role_assignments")
}

model PermissionGrant {
  id           String @id @default(cuid())
  userId       String
  permissionId String

  // Scope where this permission applies
  scopeType ScopeType
  scopeId   String

  // Grant type
  grantType PermissionGrantType @default(ALLOW) // ALLOW or DENY

  // Grant metadata
  grantedBy String?
  grantedAt DateTime  @default(now())
  expiresAt DateTime?
  reason    String? // Why was this granted/denied

  // Constraints
  constraints Json? // Optional scope limitations

  // Relations
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId, scopeType, scopeId])
  @@index([userId])
  @@index([scopeType, scopeId])
  @@map("permission_grants")
}

model UserSession {
  id     String @id @default(cuid())
  userId String

  // Session info
  sessionToken String  @unique
  userAgent    String?
  ipAddress    String?
  deviceInfo   Json?

  // Location
  city    String?
  country String?

  // Status
  isActive     Boolean  @default(true)
  lastActiveAt DateTime @default(now())

  // Timestamps
  createdAt    DateTime  @default(now())
  expiresAt    DateTime
  revokedAt    DateTime?
  revokedBy    String?
  revokeReason String?

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionToken])
  @@index([isActive, expiresAt])
  @@map("user_sessions")
}

// RBAC Enums
enum PermissionGrantType {
  ALLOW
  DENY
}

// =============================================================================
// VENDOR SYSTEM (Feature 03)
// Parallel to Client hierarchy: Organization → Vendor → VendorCompany
// =============================================================================

enum VendorStatus {
  PENDING_VERIFICATION
  VERIFIED
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum VendorTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum VendorType {
  SUPPLIER
  DROPSHIPPER
  WHITE_LABEL
  AFFILIATE
  CUSTOMER_SERVICE_CENTER
}

enum ConnectionStatus {
  PENDING
  ACTIVE
  SUSPENDED
  TERMINATED
}

enum ProductSyncMode {
  MANUAL
  AUTOMATIC
  WEBHOOK
}

enum ProductSyncStatus {
  PENDING
  SYNCING
  COMPLETED
  FAILED
}

// Vendor - Parallel to Client under Organization
model Vendor {
  id             String  @id @default(cuid())
  organizationId String
  name           String
  slug           String
  code           String? @unique // 4-char alphanumeric code (e.g., "ACFL")

  // Contact
  contactName  String?
  contactEmail String?
  contactPhone String?

  // Business Info
  businessName String?
  taxId        String?
  website      String?
  logo         String?
  description  String? @db.Text

  // Status & Classification
  status     VendorStatus @default(PENDING_VERIFICATION)
  tier       VendorTier   @default(BRONZE)
  vendorType VendorType   @default(SUPPLIER)
  isVerified Boolean      @default(false)
  verifiedAt DateTime?

  // Performance Metrics (denormalized for quick access)
  averageRating   Float? @default(0)
  totalOrders     Int    @default(0)
  completionRate  Float? @default(100)
  averageShipDays Float?

  // Settings
  settings Json @default("{}")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization      Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  vendorCompanies   VendorCompany[]
  clientConnections VendorClientConnection[]

  // Soft delete fields
  deletedAt DateTime?
  deletedBy String?
  cascadeId String?

  @@unique([organizationId, slug])
  @@index([status])
  @@index([tier])
  @@index([vendorType])
  @@index([deletedAt])
  @@map("vendors")
}

// VendorCompany - Parallel to Company under Client
model VendorCompany {
  id       String  @id @default(cuid())
  vendorId String
  name     String
  slug     String
  code     String? @unique // 4-char alphanumeric code (e.g., "ACOF")

  // Business Info
  domain   String?
  logo     String?
  timezone String  @default("UTC")
  currency String  @default("USD")

  // Location
  address    String?
  city       String?
  state      String?
  country    String  @default("US")
  postalCode String?

  // Capabilities
  capabilities      String[] // e.g., ["white_label", "dropship", "wholesale"]
  productCategories String[] // Categories this vendor company specializes in

  // Status
  status EntityStatus @default(ACTIVE)

  // Settings
  settings Json @default("{}")

  // Lead times
  defaultLeadTimeDays Int @default(3)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  vendor            Vendor                   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  clientConnections VendorClientConnection[]
  products          VendorProduct[]
  orders            VendorOrder[]

  // Soft delete fields
  deletedAt DateTime?
  deletedBy String?
  cascadeId String?

  @@unique([vendorId, slug])
  @@index([status])
  @@index([deletedAt])
  @@map("vendor_companies")
}

// VendorClientConnection - Bridge between Company and VendorCompany
model VendorClientConnection {
  id              String @id @default(cuid())
  vendorId        String
  vendorCompanyId String
  companyId       String // The client's company that is connected

  // Status
  status ConnectionStatus @default(PENDING)

  // Connection settings
  customPricing Json? // Company-specific pricing overrides
  terms         Json? // Agreement terms
  creditLimit   Float?
  paymentTerms  String? // e.g., "NET30", "NET60"

  // Product sync settings
  syncMode        ProductSyncMode @default(MANUAL)
  lastSyncAt      DateTime?
  autoSyncEnabled Boolean         @default(false)

  // Performance tracking per connection
  totalOrders  Int   @default(0)
  totalRevenue Float @default(0)

  // Timestamps
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  approvedAt DateTime?
  approvedBy String?

  // Relations
  vendor         Vendor              @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  vendorCompany  VendorCompany       @relation(fields: [vendorCompanyId], references: [id], onDelete: Cascade)
  company        Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  syncedProducts VendorProductSync[]
  orders         VendorOrder[]

  @@unique([vendorCompanyId, companyId])
  @@index([status])
  @@index([vendorId])
  @@index([vendorCompanyId])
  @@index([companyId])
  @@map("vendor_client_connections")
}

// VendorProduct - Products offered by vendor companies
model VendorProduct {
  id              String @id @default(cuid())
  vendorCompanyId String

  // Product info
  sku         String
  name        String
  description String? @db.Text

  // Pricing
  wholesalePrice Float // Price to clients
  retailPrice    Float? // Suggested retail price
  currency       String @default("USD")

  // Inventory
  stockQuantity     Int @default(0)
  lowStockThreshold Int @default(10)

  // Product details
  weight     Float?
  dimensions Json? // { length, width, height, unit }
  images     String[]
  categories String[]

  // Lead time
  leadTimeDays Int?

  // Status
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  vendorCompany  VendorCompany       @relation(fields: [vendorCompanyId], references: [id], onDelete: Cascade)
  syncedProducts VendorProductSync[]
  orderItems     VendorOrderItem[]

  @@unique([vendorCompanyId, sku])
  @@index([isActive])
  @@map("vendor_products")
}

// VendorProductSync - Tracks which vendor products are synced to which company
model VendorProductSync {
  id               String  @id @default(cuid())
  connectionId     String
  vendorProductId  String
  companyProductId String? // Link to the company's product if synced

  // Sync status
  status     ProductSyncStatus @default(PENDING)
  lastSyncAt DateTime?
  syncError  String?

  // Price override for this connection
  customPrice Float?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  connection     VendorClientConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  vendorProduct  VendorProduct          @relation(fields: [vendorProductId], references: [id], onDelete: Cascade)
  companyProduct Product?               @relation(fields: [companyProductId], references: [id], onDelete: SetNull)

  @@unique([connectionId, vendorProductId])
  @@index([status])
  @@map("vendor_product_syncs")
}

// VendorOrder - Orders placed with vendors
model VendorOrder {
  id              String @id @default(cuid())
  connectionId    String
  vendorCompanyId String
  orderNumber     String @unique

  // Source order (if created from a customer order)
  sourceOrderId String?

  // Status
  status OrderStatus @default(PENDING)

  // Totals
  subtotal     Float
  shippingCost Float  @default(0)
  tax          Float  @default(0)
  total        Float
  currency     String @default("USD")

  // Shipping
  shippingAddress Json?
  shippingMethod  String?
  trackingNumber  String?
  carrier         ShippingCarrier?

  // Dates
  expectedDeliveryAt DateTime?
  shippedAt          DateTime?
  deliveredAt        DateTime?

  // Notes
  notes       String? @db.Text
  vendorNotes String? @db.Text

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  connection    VendorClientConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  vendorCompany VendorCompany          @relation(fields: [vendorCompanyId], references: [id], onDelete: Cascade)
  sourceOrder   Order?                 @relation(fields: [sourceOrderId], references: [id], onDelete: SetNull)
  items         VendorOrderItem[]

  @@index([status])
  @@index([vendorCompanyId])
  @@index([sourceOrderId])
  @@map("vendor_orders")
}

// VendorOrderItem - Line items in vendor orders
model VendorOrderItem {
  id              String @id @default(cuid())
  vendorOrderId   String
  vendorProductId String

  // Item details
  sku        String
  name       String
  quantity   Int
  unitPrice  Float
  totalPrice Float

  // Fulfillment
  quantityFulfilled Int @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  vendorOrder   VendorOrder   @relation(fields: [vendorOrderId], references: [id], onDelete: Cascade)
  vendorProduct VendorProduct @relation(fields: [vendorProductId], references: [id], onDelete: Cascade)

  @@index([vendorOrderId])
  @@map("vendor_order_items")
}

// MarketplaceReview - Reviews for vendor products in the marketplace
model MarketplaceReview {
  id              String @id @default(cuid())
  vendorId        String
  vendorCompanyId String
  companyId       String // The Company (client's company) writing the review

  // Review content
  rating  Int // 1-5 stars
  title   String?
  content String? @db.Text

  // Verification
  isVerified       Boolean @default(false)
  verifiedPurchase Boolean @default(false)

  // Moderation
  isApproved  Boolean   @default(true)
  moderatedAt DateTime?
  moderatedBy String?

  // Helpful votes
  helpfulCount Int @default(0)

  // Response from vendor
  vendorResponse String?   @db.Text
  respondedAt    DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([vendorId])
  @@index([vendorCompanyId])
  @@index([companyId])
  @@index([rating])
  @@map("marketplace_reviews")
}

// =============================================================================
// CUSTOMER NOTES & TAGS
// =============================================================================

enum NoteType {
  INTERNAL
  CUSTOMER_SERVICE
  SYSTEM
}

model CustomerNote {
  id         String   @id @default(cuid())
  customerId String
  userId     String?
  content    String   @db.Text
  type       NoteType @default(INTERNAL)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  user     User?    @relation(fields: [userId], references: [id])

  @@index([customerId])
  @@map("customer_notes")
}

model CustomerTag {
  id          String   @id @default(cuid())
  companyId   String
  name        String
  color       String   @default("#3B82F6")
  description String?
  createdAt   DateTime @default(now())

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, name])
  @@map("customer_tags")
}

// =============================================================================
// REFUND SETTINGS (per company/client)
// =============================================================================

model RefundSettings {
  id        String @id @default(cuid())
  companyId String @unique

  // Auto-approval settings
  autoApprovalEnabled   Boolean @default(false)
  autoApprovalMaxAmount Decimal @default(100.00) @db.Decimal(10, 2)
  autoApprovalMaxDays   Int     @default(30) // Days since order

  // Restrictions
  requireReason       Boolean @default(true)
  requireApproval     Boolean @default(true)
  allowPartialRefunds Boolean @default(true)

  // Notifications
  notifyOnRequest    Boolean @default(true)
  notifyOnApproval   Boolean @default(true)
  notifyOnCompletion Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("refund_settings")
}

// =============================================================================
// PRODUCT REVIEWS & RATINGS (Customer Review Plugin - Yotpo-style)
// =============================================================================

enum ReviewStatus {
  PENDING     // Awaiting moderation
  APPROVED    // Published and visible
  REJECTED    // Rejected by moderator
  FLAGGED     // Flagged for review
}

enum ReviewSource {
  WEBSITE     // Submitted via website widget
  EMAIL       // Submitted via email request
  API         // Submitted via API
  IMPORT      // Imported from external source
}

model ProductReview {
  id         String @id @default(cuid())
  companyId  String
  productId  String
  customerId String?
  orderId    String? // Link to verified purchase

  // Review Content
  rating      Int // 1-5 stars
  title       String?
  content     String?  @db.Text
  pros        String[] // What they liked
  cons        String[] // What they didn't like

  // Reviewer Info (for non-logged-in reviews)
  reviewerName  String?
  reviewerEmail String?

  // Verification
  isVerifiedPurchase Boolean @default(false)
  purchaseDate       DateTime?

  // Moderation
  status       ReviewStatus @default(PENDING)
  moderatedAt  DateTime?
  moderatedBy  String?
  moderationNotes String?
  rejectReason String?

  // AI Analysis
  sentimentScore Float?  // -1 to 1
  keyPhrases     String[]
  aiSummary      String?

  // Engagement
  helpfulCount   Int @default(0)
  unhelpfulCount Int @default(0)
  reportCount    Int @default(0)

  // Merchant Response
  merchantResponse   String?   @db.Text
  merchantRespondedAt DateTime?
  merchantRespondedBy String?

  // Source Tracking
  source    ReviewSource @default(WEBSITE)
  sourceId  String?      // External review ID if imported
  ipAddress String?
  userAgent String?

  // Featured/Pinned
  isFeatured Boolean @default(false)
  isPinned   Boolean @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Soft delete
  deletedAt DateTime?
  deletedBy String?

  // Relations
  company  Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  product  Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  customer Customer?        @relation(fields: [customerId], references: [id], onDelete: SetNull)
  order    Order?           @relation(fields: [orderId], references: [id], onDelete: SetNull)
  media    ReviewMedia[]
  votes    ReviewVote[]

  @@unique([orderId, productId]) // One review per product per order
  @@index([companyId])
  @@index([productId])
  @@index([customerId])
  @@index([status])
  @@index([rating])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("product_reviews")
}

model ReviewMedia {
  id       String @id @default(cuid())
  reviewId String

  // Media Details
  type     String // image, video
  url      String
  filename String?
  mimeType String?
  size     Int?   // bytes

  // Processing
  thumbnailUrl String?
  isProcessed  Boolean @default(false)
  processedAt  DateTime?

  // Moderation
  isApproved Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())

  // Relations
  review ProductReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@index([reviewId])
  @@map("review_media")
}

model ReviewVote {
  id         String @id @default(cuid())
  reviewId   String
  customerId String?
  ipAddress  String?

  // Vote
  isHelpful Boolean // true = helpful, false = not helpful

  // Timestamps
  createdAt DateTime @default(now())

  // Relations
  review   ProductReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  customer Customer?     @relation(fields: [customerId], references: [id], onDelete: SetNull)

  @@unique([reviewId, customerId])
  @@unique([reviewId, ipAddress])
  @@index([reviewId])
  @@map("review_votes")
}

model ReviewConfig {
  id        String @id @default(cuid())
  companyId String @unique

  enabled Boolean @default(true)

  // Moderation Settings
  autoApprove           Boolean @default(false) // Auto-approve reviews
  requireVerifiedPurchase Boolean @default(false)
  minRatingForAutoApprove Int?   // Only auto-approve if rating >= this
  moderationKeywords    String[] // Keywords that trigger manual review

  // Display Settings
  showVerifiedBadge     Boolean @default(true)
  showReviewerName      Boolean @default(true)
  showReviewDate        Boolean @default(true)
  allowAnonymous        Boolean @default(true)
  sortDefault           String  @default("newest") // newest, oldest, highest, lowest, helpful

  // Content Settings
  minReviewLength       Int     @default(0)
  maxReviewLength       Int     @default(5000)
  allowMedia            Boolean @default(true)
  maxMediaPerReview     Int     @default(5)
  allowProsAndCons      Boolean @default(true)

  // Email Settings
  sendReviewRequest     Boolean @default(true)
  reviewRequestDelay    Int     @default(7) // Days after delivery
  sendResponseNotification Boolean @default(true)

  // Widget Settings
  widgetTheme           String  @default("light") // light, dark, auto
  widgetPosition        String  @default("bottom") // bottom, side, modal
  widgetPrimaryColor    String  @default("#3B82F6")
  widgetCustomCss       String? @db.Text

  // SEO Settings
  enableRichSnippets    Boolean @default(true)
  schemaType            String  @default("Product") // Product, LocalBusiness

  // Incentive Settings
  incentiveEnabled      Boolean @default(false)
  incentiveType         String? // discount, points, entry
  incentiveValue        String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("review_configs")
}

// Product Review Statistics (Denormalized for performance)
model ProductReviewStats {
  id        String @id @default(cuid())
  companyId String
  productId String @unique

  // Aggregate Stats
  totalReviews     Int   @default(0)
  approvedReviews  Int   @default(0)
  averageRating    Float @default(0)

  // Rating Distribution
  rating1Count Int @default(0)
  rating2Count Int @default(0)
  rating3Count Int @default(0)
  rating4Count Int @default(0)
  rating5Count Int @default(0)

  // Verified Stats
  verifiedReviews  Int   @default(0)
  verifiedAvgRating Float @default(0)

  // Top Keywords (JSON array)
  topKeywords Json @default("[]")

  // Timestamps
  updatedAt DateTime @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("product_review_stats")
}

// =============================================================================
// LANDING PAGE BUILDER
// =============================================================================

model LandingPage {
  id        String @id @default(cuid())
  companyId String

  // Identity & Routing
  name      String // "Main Site", "Holiday Promo 2024"
  slug      String // Internal reference
  subdomain String? @unique // "coffee-explorer" → coffee-explorer.avnz.io

  // Theme & Design
  theme       LandingPageTheme @default(STARTER)
  colorScheme Json             @default("{}") // { primary, secondary, accent, background, text }
  typography  Json             @default("{}") // { headingFont, bodyFont, scale }

  // Global Settings
  favicon   String?
  ogImage   String?
  customCss String? @db.Text
  customJs  String? @db.Text

  // SEO
  metaTitle       String?
  metaDescription String?
  keywords        String[]

  // Analytics
  googleAnalyticsId String?
  facebookPixelId   String?

  // Hosting Configuration
  hostingType LandingPageHosting @default(PLATFORM) // PLATFORM = our AWS, CLIENT = their AWS

  // Platform-hosted settings (when hostingType = PLATFORM)
  platformDistributionId String? // CloudFront distribution ID
  platformUrl            String? // https://coffee-explorer.avnz.io
  platformS3Path         String? // landing-pages/company-id/page-slug/

  // Client-hosted settings (when hostingType = CLIENT)
  clientBucketName    String?
  clientDistributionId String?
  clientUrl           String?

  // Status & Publishing
  status      LandingPageStatus @default(DRAFT)
  publishedAt DateTime?
  publishedBy String?
  lastDeployedAt DateTime?

  // Versioning
  version Int @default(1)

  // Billing & Usage Tracking
  billingEnabled Boolean @default(true)
  monthlyFee     Int     @default(0) // Base fee in cents (e.g., 999 = $9.99/mo)

  // Usage Metrics (updated on each request/deploy)
  totalPageViews   BigInt   @default(0)
  totalBandwidthMb BigInt   @default(0) // MB transferred
  totalDeploys     Int      @default(0)
  lastPageViewAt   DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company  Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sections LandingPageSection[]
  domains  LandingPageDomain[]
  usage    LandingPageUsage[]
  abTests  ABTest[]
  popups   LandingPagePopup[]
  dynamicTextRules DynamicTextRule[]
  conversionGoals  ConversionGoal[]

  @@unique([companyId, slug])
  @@index([subdomain])
  @@index([status])
  @@map("landing_pages")
}

model LandingPageSection {
  id            String @id @default(cuid())
  landingPageId String

  // Section Identity
  type SectionType
  name String? // Custom override name: "Our Story"

  // Positioning
  order   Int
  enabled Boolean @default(true)

  // Content (type-specific JSON - see SectionContent types)
  content Json

  // Styling Overrides
  styles Json? // { backgroundColor, textColor, padding, animation }

  // Responsive Visibility
  hideOnMobile  Boolean @default(false)
  hideOnDesktop Boolean @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  landingPage LandingPage @relation(fields: [landingPageId], references: [id], onDelete: Cascade)

  @@index([landingPageId, order])
  @@map("landing_page_sections")
}

model LandingPageDomain {
  id            String @id @default(cuid())
  landingPageId String

  domain    String  @unique // "www.coffeeexplorer.com"
  isPrimary Boolean @default(false)

  // SSL Status (ACM certificate)
  sslStatus    DomainSslStatus @default(PENDING)
  sslCertArn   String? // ACM certificate ARN
  sslExpiresAt DateTime?

  // DNS Verification
  verificationToken  String?
  verificationRecord String? // CNAME record value
  verifiedAt         DateTime?

  // CloudFront Distribution (if using custom domain)
  distributionId String?
  distributionArn String?

  // Billing for custom domains
  monthlyFee Int @default(0) // Additional fee for custom domain hosting (cents)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  landingPage LandingPage @relation(fields: [landingPageId], references: [id], onDelete: Cascade)

  @@map("landing_page_domains")
}

// Usage tracking for billing - records monthly usage per landing page
model LandingPageUsage {
  id            String @id @default(cuid())
  landingPageId String
  companyId     String

  // Billing Period
  periodStart DateTime
  periodEnd   DateTime

  // Usage Metrics
  pageViews      BigInt @default(0)
  uniqueVisitors BigInt @default(0)
  bandwidthMb    BigInt @default(0) // MB transferred
  deployCount    Int    @default(0)

  // Calculated Costs (in cents)
  baseFee        Int @default(0) // Monthly base fee
  bandwidthFee   Int @default(0) // Overage charges
  customDomainFee Int @default(0) // Custom domain fee
  totalFee       Int @default(0) // Total for period

  // Status
  invoiced   Boolean   @default(false)
  invoicedAt DateTime?
  invoiceId  String? // Link to billing invoice

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  landingPage LandingPage @relation(fields: [landingPageId], references: [id], onDelete: Cascade)

  @@unique([landingPageId, periodStart])
  @@index([companyId, periodStart])
  @@map("landing_page_usage")
}

// Service fee configuration (organization-level pricing)
model LandingPagePricing {
  id             String @id @default(cuid())
  organizationId String @unique

  // Base Pricing (in cents)
  monthlyBaseFee       Int @default(999)  // $9.99/mo per page
  customDomainFee      Int @default(499)  // $4.99/mo per custom domain

  // Included Allowances
  includedPageViews    Int @default(10000)  // Views per month
  includedBandwidthMb  Int @default(1000)   // MB per month
  includedDeploys      Int @default(50)     // Deploys per month

  // Overage Pricing (in cents per unit)
  overageViewsPer1000  Int @default(50)   // $0.50 per 1000 views over limit
  overageBandwidthPerGb Int @default(100) // $1.00 per GB over limit

  // Free Tier
  freePagesAllowed     Int @default(1)  // First page free
  freeTrialDays        Int @default(14) // Trial period

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("landing_page_pricing")
}

// ═══════════════════════════════════════════════════════════════
// AI USAGE TRACKING - For billing AI content generation
// ═══════════════════════════════════════════════════════════════

model AIUsage {
  id        String @id @default(cuid())
  companyId String
  userId    String

  // Request Details
  feature      AIFeature // What feature was used
  operation    String    // Specific operation (generate_headline, rewrite_section, etc.)
  modelId      String    // AI model used (e.g., anthropic.claude-3-sonnet)

  // Token Usage (for billing)
  inputTokens  Int
  outputTokens Int
  totalTokens  Int

  // Cost Calculation (in cents)
  inputCost    Int      // Cost for input tokens
  outputCost   Int      // Cost for output tokens
  totalCost    Int      // Total cost in cents

  // Request Context
  landingPageId String?
  metadata      Json?   // Additional context (section type, prompt length, etc.)

  // Status
  status    AIUsageStatus @default(SUCCESS)
  errorMsg  String?

  // Timestamps
  createdAt DateTime @default(now())

  @@index([companyId, createdAt])
  @@index([userId, createdAt])
  @@index([feature, createdAt])
  @@map("ai_usage")
}

// Monthly AI usage summary for billing
model AIUsageSummary {
  id        String @id @default(cuid())
  companyId String

  // Billing Period
  periodStart DateTime
  periodEnd   DateTime

  // Aggregated Usage
  totalRequests    Int @default(0)
  totalInputTokens  Int @default(0)
  totalOutputTokens Int @default(0)
  totalTokens      Int @default(0)

  // Costs (in cents)
  totalCost Int @default(0)

  // Usage by Feature
  usageByFeature Json @default("{}") // { LANDING_PAGE_CONTENT: { requests: 10, tokens: 5000, cost: 100 } }

  // Billing Status
  invoiced   Boolean   @default(false)
  invoicedAt DateTime?
  invoiceId  String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, periodStart])
  @@index([companyId, periodStart])
  @@map("ai_usage_summary")
}

// AI pricing configuration (organization-level)
model AIPricing {
  id             String @id @default(cuid())
  organizationId String @unique

  // Token pricing (per 1000 tokens, in cents)
  inputTokenPrice  Int @default(3)   // $0.03 per 1K input tokens
  outputTokenPrice Int @default(15)  // $0.15 per 1K output tokens

  // Monthly allowances (included in base plan)
  monthlyTokenAllowance Int @default(100000) // 100K tokens/month included

  // Overage pricing (per 1000 tokens, in cents)
  overageInputPrice  Int @default(4)  // $0.04 per 1K input tokens after allowance
  overageOutputPrice Int @default(20) // $0.20 per 1K output tokens after allowance

  // Feature flags
  aiEnabled Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("ai_pricing")
}

enum AIFeature {
  LANDING_PAGE_CONTENT    // Generate/rewrite landing page text
  LANDING_PAGE_SECTION    // Generate entire section content
  AB_TEST_VARIANTS        // Generate A/B test copy variants
  PRODUCT_DESCRIPTION     // Product descriptions
  SEO_OPTIMIZATION        // Meta tags, keywords
  IMAGE_ALT_TEXT          // Alt text generation
}

enum AIUsageStatus {
  SUCCESS
  FAILED
  RATE_LIMITED
}

enum LandingPageTheme {
  STARTER       // Clean minimal (default)
  ARTISAN       // Warm, handcrafted (coffee, bakery)
  VELOCITY      // Modern tech (SaaS)
  LUXE          // Elegant premium (fashion, jewelry)
  WELLNESS      // Calm, clean (health, spa)
  FOODIE        // Vibrant (restaurant, delivery)
  PROFESSIONAL  // Corporate (agency, B2B)
  CREATOR       // Personal brand (courses)
  MARKETPLACE   // E-commerce focused
}

enum SectionType {
  // Navigation
  HEADER
  FOOTER

  // Hero Variants
  HERO_CENTERED
  HERO_SPLIT
  HERO_VIDEO
  HERO_CAROUSEL

  // Content
  FEATURES_GRID
  FEATURES_LIST
  FEATURES_ICONS
  ABOUT_STORY
  ABOUT_TEAM
  ABOUT_TIMELINE

  // Social Proof
  TESTIMONIALS_CARDS
  TESTIMONIALS_CAROUSEL
  TESTIMONIALS_WALL
  LOGOS_STRIP
  STATS_COUNTER

  // Commerce
  PRICING_TABLE
  PRICING_COMPARISON
  PRODUCTS_GRID
  PRODUCTS_CAROUSEL

  // Engagement
  CTA_BANNER
  CTA_SPLIT
  NEWSLETTER
  CONTACT_FORM
  FAQ_ACCORDION
  FAQ_GRID

  // Media
  GALLERY_GRID
  GALLERY_MASONRY
  VIDEO_EMBED

  // Custom
  HTML_BLOCK
  SPACER
  DIVIDER
}

enum LandingPageStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum LandingPageHosting {
  PLATFORM // Hosted on our AWS (subdomain.avnz.io)
  CLIENT   // Hosted on client's AWS
}

enum DomainSslStatus {
  PENDING     // Certificate requested
  VALIDATING  // DNS validation in progress
  ACTIVE      // Certificate active
  FAILED      // Validation failed
  EXPIRED     // Certificate expired
}

// ═══════════════════════════════════════════════════════════════
// A/B TESTING - Variant Management & Traffic Splitting
// ═══════════════════════════════════════════════════════════════

enum ABTestStatus {
  DRAFT     // Not yet running
  RUNNING   // Actively splitting traffic
  PAUSED    // Temporarily stopped
  COMPLETED // Test finished, winner declared
  ARCHIVED  // Historical record
}

model ABTest {
  id            String @id @default(cuid())
  landingPageId String
  companyId     String

  // Test Configuration
  name        String // "Summer CTA Test"
  description String?
  status      ABTestStatus @default(DRAFT)

  // Traffic Allocation
  trafficPercentage Int @default(100) // % of total traffic to include in test (0-100)

  // Scheduling
  startedAt   DateTime?
  endedAt     DateTime?
  scheduledStart DateTime?
  scheduledEnd   DateTime?

  // Statistical Settings
  confidenceLevel   Int @default(95)      // 90, 95, 99
  minimumSampleSize Int @default(100)     // Minimum visitors per variant
  primaryMetric     String @default("conversions") // What to optimize

  // Results
  winnerId            String? // Variant ID that won
  winnerDeclaredAt    DateTime?
  statisticalSignificance Float? // 0.0 - 1.0

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  // Relations
  landingPage LandingPage @relation(fields: [landingPageId], references: [id], onDelete: Cascade)
  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  variants    ABTestVariant[]

  @@index([landingPageId])
  @@index([companyId])
  @@index([status])
  @@map("ab_tests")
}

model ABTestVariant {
  id       String @id @default(cuid())
  testId   String

  // Variant Identity
  name     String    // "Control", "Variant A", "Variant B"
  isControl Boolean  @default(false)

  // Traffic Weight
  weight   Int @default(50) // % traffic allocation (all variants must sum to 100)

  // Content Changes (JSON patches to apply to base page)
  changes Json // { sectionId: string, field: string, value: any }[]

  // Metrics (updated in real-time)
  visitors    BigInt @default(0)
  conversions BigInt @default(0)
  conversionRate Float @default(0)
  bounceRate     Float @default(0)
  avgTimeOnPage  Float @default(0) // seconds

  // Revenue tracking (optional)
  totalRevenue   BigInt @default(0) // cents
  avgOrderValue  Float  @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  test ABTest @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@index([testId])
  @@map("ab_test_variants")
}

// Visitor assignment tracking (which variant did they see?)
model ABTestAssignment {
  id        String @id @default(cuid())
  testId    String
  variantId String
  visitorId String // Anonymous visitor cookie/fingerprint

  // Assignment details
  assignedAt DateTime @default(now())
  converted  Boolean  @default(false)
  convertedAt DateTime?

  // Attribution
  revenue    BigInt? // If conversion had revenue (cents)

  @@unique([testId, visitorId])
  @@index([variantId])
  @@map("ab_test_assignments")
}

// ═══════════════════════════════════════════════════════════════
// POPUPS & STICKY BARS - Engagement Overlays
// ═══════════════════════════════════════════════════════════════

enum PopupType {
  MODAL        // Center overlay
  SLIDE_IN     // Corner slide-in
  FULLSCREEN   // Full page takeover
  STICKY_BAR   // Top/bottom persistent bar
  BANNER       // Dismissable notification bar
}

enum PopupTrigger {
  IMMEDIATE       // Show on page load
  TIME_DELAY      // After X seconds
  SCROLL_PERCENT  // After scrolling X%
  EXIT_INTENT     // Mouse leaves viewport
  CLICK           // Click on element
  INACTIVITY      // No activity for X seconds
}

enum PopupStatus {
  DRAFT
  ACTIVE
  PAUSED
  SCHEDULED
  ARCHIVED
}

model LandingPagePopup {
  id            String @id @default(cuid())
  landingPageId String
  companyId     String

  // Identity
  name   String
  type   PopupType @default(MODAL)
  status PopupStatus @default(DRAFT)

  // Trigger Configuration
  trigger       PopupTrigger @default(TIME_DELAY)
  triggerValue  Int?         // Seconds for TIME_DELAY, % for SCROLL_PERCENT
  triggerSelector String?    // CSS selector for CLICK trigger

  // Display Settings
  position  String @default("center") // center, top, bottom, top-left, top-right, bottom-left, bottom-right
  animation String @default("fade")   // fade, slide, bounce, zoom
  overlay   Boolean @default(true)    // Show dark overlay behind
  overlayClose Boolean @default(true) // Click overlay to close

  // Content (similar to section content)
  content Json // { headline, body, ctaText, ctaUrl, image, formFields }
  styles  Json? // { backgroundColor, textColor, width, borderRadius }

  // Scheduling
  startDate DateTime?
  endDate   DateTime?

  // Frequency & Targeting
  showOnce      Boolean @default(false)  // Only show once per visitor
  showEveryDays Int?                      // Re-show after X days
  showOnMobile  Boolean @default(true)
  showOnDesktop Boolean @default(true)

  // Page targeting
  showOnAllPages Boolean @default(true)
  targetPages    String[] // Specific page paths if not all

  // Metrics
  impressions BigInt @default(0)
  closes      BigInt @default(0)
  conversions BigInt @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  // Relations
  landingPage LandingPage @relation(fields: [landingPageId], references: [id], onDelete: Cascade)
  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([landingPageId])
  @@index([companyId])
  @@index([status])
  @@map("landing_page_popups")
}

// ═══════════════════════════════════════════════════════════════
// DYNAMIC TEXT REPLACEMENT - URL Parameter-based Content Swapping
// ═══════════════════════════════════════════════════════════════

model DynamicTextRule {
  id            String @id @default(cuid())
  landingPageId String
  companyId     String

  // Rule Configuration
  name        String  // "City Personalization"
  enabled     Boolean @default(true)

  // URL Parameter to watch
  parameterName String // e.g., "city", "utm_campaign", "keyword"

  // Default value if parameter not present
  defaultValue String

  // Replacement targets (CSS selectors or section IDs)
  targets Json // [{ selector: ".hero-headline", field: "text" }, { sectionId: "xxx", field: "headline" }]

  // Optional: Predefined mappings for specific values
  valueMappings Json? // { "new-york": "New York City", "la": "Los Angeles" }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  landingPage LandingPage @relation(fields: [landingPageId], references: [id], onDelete: Cascade)
  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([landingPageId])
  @@index([companyId])
  @@map("dynamic_text_rules")
}

// ═══════════════════════════════════════════════════════════════
// CONVERSION TRACKING - Goal & Event Management
// ═══════════════════════════════════════════════════════════════

enum ConversionGoalType {
  FORM_SUBMIT   // Form submission
  BUTTON_CLICK  // CTA button click
  LINK_CLICK    // External link click
  PAGE_VISIT    // Visit to thank you page
  SCROLL_DEPTH  // Scroll to specific %
  TIME_ON_PAGE  // Time threshold reached
  CUSTOM        // Custom JS event
}

model ConversionGoal {
  id            String @id @default(cuid())
  landingPageId String
  companyId     String

  // Goal Configuration
  name        String
  type        ConversionGoalType
  isPrimary   Boolean @default(false) // Main goal for A/B test winner selection

  // Type-specific config
  selector    String?  // CSS selector for clicks
  targetUrl   String?  // URL for PAGE_VISIT
  threshold   Int?     // % for SCROLL_DEPTH, seconds for TIME_ON_PAGE
  eventName   String?  // Custom event name

  // Optional: Revenue value (for ROI calculations)
  revenueValue Int? // Fixed value in cents (e.g., lead worth $50)

  // Metrics
  totalConversions BigInt @default(0)
  totalRevenue     BigInt @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  landingPage LandingPage @relation(fields: [landingPageId], references: [id], onDelete: Cascade)
  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  events      ConversionEvent[]

  @@index([landingPageId])
  @@index([companyId])
  @@map("conversion_goals")
}

model ConversionEvent {
  id        String @id @default(cuid())
  goalId    String
  visitorId String

  // Event details
  occurredAt DateTime @default(now())
  pageUrl    String?
  referrer   String?

  // Attribution
  utmSource   String?
  utmMedium   String?
  utmCampaign String?

  // Optional: Revenue
  revenue Int?

  // Relations
  goal ConversionGoal @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@index([goalId])
  @@index([visitorId])
  @@index([occurredAt])
  @@map("conversion_events")
}
