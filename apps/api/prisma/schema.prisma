// Payment Platform - Prisma Schema
// Multi-tenant hierarchical payment orchestration platform
// SOC2, PCI-DSS, ISO 27001 Compliant Design

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// HIERARCHY MODELS
// Organization → Client → Company → Department → Team → User
// =============================================================================

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  domain    String?  @unique
  logo      String?
  settings  Json     @default("{}")

  // Billing
  billingEmail    String?
  billingPlan     BillingPlan @default(STARTER)
  billingStatus   BillingStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  clients   Client[]
  users     User[]   @relation("OrganizationUsers")
  apiKeys   ApiKey[]
  platformIntegrations PlatformIntegration[]

  @@map("organizations")
}

model Client {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  slug           String
  contactName    String?
  contactEmail   String?
  contactPhone   String?
  settings       Json     @default("{}")

  // Client plan/status
  plan          ClientPlan   @default(BASIC)
  status        EntityStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  companies    Company[]
  users        User[]       @relation("ClientUsers")
  integrations ClientIntegration[]

  @@unique([organizationId, slug])
  @@map("clients")
}

model Company {
  id            String   @id @default(cuid())
  clientId      String
  name          String
  slug          String
  domain        String?
  logo          String?
  timezone      String   @default("UTC")
  currency      String   @default("USD")
  settings      Json     @default("{}")

  // Payment configuration
  paymentConfig Json     @default("{}")

  // Status
  status        EntityStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  client             Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  departments        Department[]
  users              User[]              @relation("CompanyUsers")
  paymentProviders   PaymentProvider[]
  subscriptions      Subscription[]
  transactions       Transaction[]
  customers          Customer[]
  products           Product[]
  orders             Order[]

  // Momentum Intelligence Relations
  customerIntents    CustomerIntent[]
  interventions      Intervention[]
  saveAttempts       SaveAttempt[]
  voiceCalls         VoiceCall[]
  generatedContents  GeneratedContent[]
  upsellOffers       UpsellOffer[]
  saveFlowConfig     SaveFlowConfig?
  voiceScripts       VoiceScript[]
  momentumAnalytics  MomentumAnalytics[]
  upsellConfig       UpsellConfig?

  @@unique([clientId, slug])
  @@map("companies")
}

model Department {
  id        String   @id @default(cuid())
  companyId String
  name      String
  slug      String
  description String?
  settings  Json     @default("{}")

  // Status
  status    EntityStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  teams     Team[]
  users     User[]   @relation("DepartmentUsers")

  @@unique([companyId, slug])
  @@map("departments")
}

model Team {
  id           String   @id @default(cuid())
  departmentId String
  name         String
  slug         String
  description  String?
  settings     Json     @default("{}")

  // Team lead
  teamLeadId   String?

  // Status
  status       EntityStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  department  Department   @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  teamLead    User?        @relation("TeamLead", fields: [teamLeadId], references: [id])
  members     TeamMember[]

  @@unique([departmentId, slug])
  @@map("teams")
}

// =============================================================================
// USER & ACCESS CONTROL
// =============================================================================

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String?
  firstName     String?
  lastName      String?
  avatar        String?
  phone         String?

  // Auth
  auth0Id       String?  @unique
  emailVerified Boolean  @default(false)
  lastLoginAt   DateTime?

  // Primary scope (where user was created)
  scopeType     ScopeType
  scopeId       String

  // Global role
  role          UserRole @default(USER)

  // Status
  status        UserStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Direct relations to hierarchy levels
  organization   Organization? @relation("OrganizationUsers", fields: [organizationId], references: [id])
  organizationId String?

  client         Client?       @relation("ClientUsers", fields: [clientId], references: [id])
  clientId       String?

  company        Company?      @relation("CompanyUsers", fields: [companyId], references: [id])
  companyId      String?

  department     Department?   @relation("DepartmentUsers", fields: [departmentId], references: [id])
  departmentId   String?

  // Team memberships (many-to-many)
  teamMemberships TeamMember[]
  teamsLed        Team[]       @relation("TeamLead")

  // Activity
  auditLogs      AuditLog[]

  @@map("users")
}

model TeamMember {
  id       String   @id @default(cuid())
  teamId   String
  userId   String
  role     TeamRole @default(MEMBER)

  // Timestamps
  joinedAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@map("team_members")
}

// =============================================================================
// CUSTOMER & ADDRESS MODELS
// =============================================================================

model Customer {
  id        String   @id @default(cuid())
  companyId String

  // Customer info
  email       String
  firstName   String?
  lastName    String?
  phone       String?

  // Metadata
  metadata    Json   @default("{}")

  // Status
  status      CustomerStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company         Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  addresses       Address[]
  billingAccounts BillingAccount[]
  paymentVaults   PaymentVault[]
  subscriptions   Subscription[]
  transactions    Transaction[]
  orders          Order[]

  // Momentum Intelligence Relations
  customerIntents CustomerIntent[]
  interventions   Intervention[]
  saveAttempts    SaveAttempt[]
  voiceCalls      VoiceCall[]
  upsellOffers    UpsellOffer[]

  @@unique([companyId, email])
  @@map("customers")
}

model Address {
  id         String   @id @default(cuid())
  customerId String

  // Address type
  type       AddressType @default(BOTH)
  label      String?     // "Home", "Office", "Warehouse"
  isDefault  Boolean     @default(false)

  // Contact
  firstName  String
  lastName   String
  company    String?
  phone      String?

  // Address fields
  street1    String
  street2    String?
  city       String
  state      String
  postalCode String
  country    String   @default("US")

  // Delivery
  deliveryInstructions String?

  // Validation
  isValidated  Boolean   @default(false)
  validatedAt  DateTime?
  validationResponse Json?

  // Status
  status     EntityStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId, type])
  @@map("addresses")
}

// =============================================================================
// PAYMENT VAULT & BILLING (PCI-DSS COMPLIANT)
// =============================================================================

model PaymentVault {
  id         String   @id @default(cuid())
  customerId String

  // Payment method type
  type       PaymentMethodType

  // Gateway reference (never store raw card data)
  gatewayCustomerId String?  // Customer ID at payment gateway
  gatewayPaymentId  String?  // Payment method ID at gateway

  // Encrypted token (AES-256-GCM)
  // Contains gateway token, encrypted at application level
  encryptedToken    String
  keyVersion        Int      @default(1)  // For key rotation

  // Display data only (safe to store)
  last4             String   // Last 4 digits
  brand             String?  // VISA, MASTERCARD, AMEX, etc.
  expMonth          Int?     // Card expiry month
  expYear           Int?     // Card expiry year
  bankName          String?  // For ACH
  accountType       String?  // checking, savings

  // Fingerprint for duplicate detection
  fingerprint       String?

  // Billing address (reference for AVS)
  billingAddressSnapshot Json?

  // Status
  isDefault         Boolean  @default(false)
  isActive          Boolean  @default(true)

  // Compliance
  consentRecordedAt DateTime?
  consentIp         String?

  // Usage tracking
  lastUsedAt        DateTime?
  usageCount        Int      @default(0)

  // Expiration
  expiresAt         DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  customer        Customer         @relation(fields: [customerId], references: [id], onDelete: Cascade)
  billingAccounts BillingAccount[]
  transactions    Transaction[]

  @@index([customerId, isActive])
  @@index([fingerprint])
  @@map("payment_vaults")
}

model BillingAccount {
  id         String   @id @default(cuid())
  customerId String

  // Display name
  name       String?  // "Primary Card", "Business Account"

  // Default payment method
  paymentVaultId String?

  // Billing address (current, updatable)
  billingAddress Json

  // Auto-pay settings
  autoPayEnabled  Boolean @default(true)
  autoPayDay      Int?    // Day of month for auto-pay

  // Status
  isDefault       Boolean @default(false)
  status          EntityStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  customer     Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  paymentVault PaymentVault? @relation(fields: [paymentVaultId], references: [id])
  orders       Order[]

  @@index([customerId])
  @@map("billing_accounts")
}

// =============================================================================
// PRODUCT CATALOG (COFFEE)
// =============================================================================

model Product {
  id          String   @id @default(cuid())
  companyId   String

  // Product identification
  sku         String
  name        String
  slug        String
  description String?

  // Category
  category    ProductCategory
  subcategory String?

  // Coffee-specific attributes
  roastLevel    RoastLevel?
  origin        String?       // "Ethiopia", "Colombia", "Brazil Blend"
  flavorNotes   String[]      // ["chocolate", "citrus", "nutty"]
  process       String?       // "washed", "natural", "honey"
  altitude      String?       // "1800-2200m"
  varietal      String?       // "Bourbon", "Typica", "Gesha"

  // Sizing
  weight        Decimal?  @db.Decimal(10, 2)
  weightUnit    String    @default("oz")  // oz, g, lb, kg

  // Pricing
  price           Decimal  @db.Decimal(10, 2)
  compareAtPrice  Decimal? @db.Decimal(10, 2)
  costPrice       Decimal? @db.Decimal(10, 2)  // For margin tracking
  currency        String   @default("USD")

  // Subscription settings
  isSubscribable      Boolean @default(true)
  subscriptionDiscount Decimal? @db.Decimal(5, 2)  // Percentage

  // Inventory
  trackInventory  Boolean @default(true)
  stockQuantity   Int     @default(0)
  lowStockThreshold Int   @default(10)

  // Status
  status          ProductStatus @default(ACTIVE)
  isVisible       Boolean       @default(true)

  // SEO/Display
  images          Json    @default("[]")  // Array of image URLs
  metaTitle       String?
  metaDescription String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company    Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]

  @@unique([companyId, sku])
  @@unique([companyId, slug])
  @@index([companyId, category])
  @@map("products")
}

// =============================================================================
// ORDER SYSTEM (IMMUTABLE HISTORICAL RECORDS)
// =============================================================================

model Order {
  id              String   @id @default(cuid())
  companyId       String
  customerId      String
  subscriptionId  String?
  billingAccountId String?

  // Order identification
  orderNumber     String   @unique
  externalId      String?  // External system reference

  // Order type
  type            OrderType @default(ONE_TIME)

  // Status
  status          OrderStatus @default(PENDING)

  // ===========================================
  // ADDRESS SNAPSHOTS (Immutable after lock)
  // ===========================================

  // Shipping address - copied at order, editable until locked
  shippingSnapshot    Json
  shippingAddressId   String?  // Reference to original address

  // Billing address - copied at order, editable until locked
  billingSnapshot     Json
  billingAddressId    String?  // Reference to original address

  // Address lock mechanism
  addressLockedAt     DateTime?  // null = editable, set = frozen
  addressLockedBy     String?    // "system", "fulfillment", userId

  // ===========================================
  // ORDER TOTALS
  // ===========================================

  subtotal        Decimal  @db.Decimal(10, 2)
  discountAmount  Decimal  @db.Decimal(10, 2) @default(0)
  discountCode    String?
  shippingAmount  Decimal  @db.Decimal(10, 2) @default(0)
  taxAmount       Decimal  @db.Decimal(10, 2) @default(0)
  total           Decimal  @db.Decimal(10, 2)
  currency        String   @default("USD")

  // ===========================================
  // PAYMENT
  // ===========================================

  paymentStatus   PaymentStatus @default(PENDING)
  paidAt          DateTime?
  paymentMethod   String?       // Snapshot: "VISA ending 4242"

  // ===========================================
  // FULFILLMENT TRACKING
  // ===========================================

  fulfillmentStatus FulfillmentStatus @default(UNFULFILLED)
  fulfilledAt       DateTime?

  // Customer notes
  customerNotes   String?
  internalNotes   String?

  // Metadata
  metadata        Json @default("{}")

  // Continuity tracking
  continuitySessionId String?
  frictionLevel       String?
  momentumScore       Int?

  // ===========================================
  // TIMESTAMPS
  // ===========================================

  orderedAt       DateTime @default(now())  // When customer placed order
  confirmedAt     DateTime?                 // When payment confirmed
  canceledAt      DateTime?
  cancelReason    String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  company         Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer        Customer        @relation(fields: [customerId], references: [id])
  subscription    Subscription?   @relation(fields: [subscriptionId], references: [id])
  billingAccount  BillingAccount? @relation(fields: [billingAccountId], references: [id])
  items           OrderItem[]
  shipments       Shipment[]
  transactions    Transaction[]

  @@index([companyId, orderedAt])
  @@index([customerId])
  @@index([status])
  @@index([orderNumber])
  @@map("orders")
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  productId String?  // Nullable for deleted products

  // ===========================================
  // PRODUCT SNAPSHOT (Immutable)
  // Captures product state at time of order
  // ===========================================

  sku           String
  name          String
  description   String?

  // Product attributes snapshot
  productSnapshot Json    // Full product data at order time

  // Quantity & Pricing
  quantity      Int
  unitPrice     Decimal  @db.Decimal(10, 2)
  discountAmount Decimal @db.Decimal(10, 2) @default(0)
  taxAmount     Decimal  @db.Decimal(10, 2) @default(0)
  totalPrice    Decimal  @db.Decimal(10, 2)

  // Fulfillment
  fulfilledQuantity Int @default(0)
  fulfillmentStatus FulfillmentStatus @default(UNFULFILLED)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  order   Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@map("order_items")
}

// =============================================================================
// SHIPPING & FULFILLMENT
// =============================================================================

model Shipment {
  id        String   @id @default(cuid())
  orderId   String

  // Shipment identification
  shipmentNumber String @unique

  // Carrier & Tracking
  carrier         ShippingCarrier
  carrierService  String?         // "Priority Mail", "Ground", "2-Day"
  trackingNumber  String?
  trackingUrl     String?

  // Shipping method used
  shippingMethod  ShippingMethod @default(GROUND)

  // Package details
  weight          Decimal?  @db.Decimal(10, 2)
  weightUnit      String    @default("oz")
  length          Decimal?  @db.Decimal(10, 2)
  width           Decimal?  @db.Decimal(10, 2)
  height          Decimal?  @db.Decimal(10, 2)
  dimensionUnit   String    @default("in")

  // Cost
  shippingCost    Decimal?  @db.Decimal(10, 2)
  insuranceAmount Decimal?  @db.Decimal(10, 2)

  // Labels
  shippingLabelUrl  String?
  returnLabelUrl    String?

  // Address snapshot (from order at time of shipment)
  shippingAddressSnapshot Json

  // Status
  status          ShipmentStatus @default(PENDING)

  // Estimated dates
  estimatedShipDate     DateTime?
  estimatedDeliveryDate DateTime?

  // Actual dates
  shippedAt       DateTime?
  deliveredAt     DateTime?

  // Signature
  signatureRequired Boolean @default(false)
  signedBy          String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  order  Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  events ShipmentEvent[]

  @@index([orderId])
  @@index([trackingNumber])
  @@map("shipments")
}

model ShipmentEvent {
  id         String   @id @default(cuid())
  shipmentId String

  // Event details
  status      ShipmentEventType
  description String
  location    String?

  // Raw carrier data
  carrierCode     String?
  carrierMessage  String?
  carrierData     Json?

  // When it happened
  occurredAt DateTime

  // Timestamps
  createdAt DateTime @default(now())

  // Relations
  shipment Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  @@index([shipmentId, occurredAt])
  @@map("shipment_events")
}

// =============================================================================
// PAYMENT PROVIDER & TRANSACTIONS
// =============================================================================

model PaymentProvider {
  id        String   @id @default(cuid())
  companyId String
  name      String
  type      PaymentProviderType

  // Credentials (encrypted at application level)
  encryptedCredentials String
  keyVersion           Int     @default(1)

  // Configuration
  isDefault    Boolean @default(false)
  isActive     Boolean @default(true)
  priority     Int     @default(0)
  environment  String  @default("sandbox")  // sandbox, production

  // Supported features
  supportsRefunds     Boolean @default(true)
  supportsVoid        Boolean @default(true)
  supportsRecurring   Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company      Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@map("payment_providers")
}

model Subscription {
  id         String   @id @default(cuid())
  companyId  String
  customerId String

  // Plan details
  planName    String
  planAmount  Decimal  @db.Decimal(10, 2)
  currency    String   @default("USD")
  interval    BillingInterval

  // Billing cycle
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  nextBillingDate    DateTime?

  // Trial
  trialStart DateTime?
  trialEnd   DateTime?

  // Shipping preference for subscription orders
  shippingAddressId String?
  shippingPreferences Json @default("{}")

  // Status
  status     SubscriptionStatus @default(ACTIVE)
  canceledAt DateTime?
  cancelReason String?

  // Pause functionality
  pausedAt     DateTime?
  pauseResumeAt DateTime?

  // Metadata
  metadata   Json @default("{}")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company      Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer     Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  transactions Transaction[]
  orders       Order[]

  @@map("subscriptions")
}

model Transaction {
  id                String   @id @default(cuid())
  companyId         String
  customerId        String?
  subscriptionId    String?
  orderId           String?
  paymentProviderId String?
  paymentVaultId    String?

  // Transaction reference
  transactionNumber String   @unique

  // Transaction details
  type             TransactionType
  amount           Decimal  @db.Decimal(10, 2)
  currency         String   @default("USD")
  description      String?

  // Provider response
  providerTransactionId String?
  providerResponse      Json?

  // Status
  status           TransactionStatus @default(PENDING)
  failureReason    String?
  failureCode      String?

  // Refund tracking
  refundedAmount   Decimal? @db.Decimal(10, 2)
  parentTransactionId String?  // For refunds, links to original charge

  // Risk & Fraud
  riskScore        Int?
  riskFlags        String[]

  // AVS/CVV results
  avsResult        String?
  cvvResult        String?

  // Continuity tracking
  continuitySessionId String?
  frictionLevel       String?
  momentumScore       Int?

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  processedAt DateTime?

  // Relations
  company         Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer        Customer?        @relation(fields: [customerId], references: [id])
  subscription    Subscription?    @relation(fields: [subscriptionId], references: [id])
  order           Order?           @relation(fields: [orderId], references: [id])
  paymentProvider PaymentProvider? @relation(fields: [paymentProviderId], references: [id])
  paymentVault    PaymentVault?    @relation(fields: [paymentVaultId], references: [id])

  @@index([companyId, createdAt])
  @@index([customerId])
  @@index([orderId])
  @@index([status])
  @@map("transactions")
}

// =============================================================================
// MERCHANT ACCOUNTS
// =============================================================================

model MerchantAccount {
  id                    String    @id @default(cuid())
  companyId             String

  // Friendly naming
  name                  String
  description           String?
  color                 String?
  icon                  String?
  tags                  String[]  @default([])

  // Provider configuration
  providerType          String
  merchantId            String
  descriptor            String?
  descriptorPhone       String?
  credentials           Json
  environment           String    @default("sandbox")

  // Status
  status                String    @default("pending")
  statusReason          String?
  statusChangedAt       DateTime?

  // Transaction limits
  minTransactionAmount  Int       @default(50)
  maxTransactionAmount  Int       @default(10000000)
  dailyTransactionLimit Int?
  dailyVolumeLimit      Int?
  weeklyTransactionLimit Int?
  weeklyVolumeLimit     Int?
  monthlyTransactionLimit Int?
  monthlyVolumeLimit    Int?
  yearlyTransactionLimit Int?
  yearlyVolumeLimit     Int?
  velocityWindow        Int?
  velocityMaxTransactions Int?
  velocityMaxAmount     Int?

  // Current usage
  todayTransactionCount Int       @default(0)
  todayVolume           Int       @default(0)
  todaySuccessCount     Int       @default(0)
  todayFailureCount     Int       @default(0)
  weekTransactionCount  Int       @default(0)
  weekVolume            Int       @default(0)
  monthTransactionCount Int       @default(0)
  monthVolume           Int       @default(0)
  yearTransactionCount  Int       @default(0)
  yearVolume            Int       @default(0)
  lastTransactionAt     DateTime?
  usageResetAt          DateTime  @default(now())

  // Fees & restrictions (JSON)
  fees                  Json?
  restrictions          Json?

  // Routing
  priority              Int       @default(100)
  weight                Int       @default(100)
  isDefault             Boolean   @default(false)
  isBackupOnly          Boolean   @default(false)

  // Health
  healthStatus          String    @default("healthy")
  successRate           Float     @default(100)
  avgLatencyMs          Float     @default(0)
  lastHealthCheck       DateTime?
  lastErrorCode         String?
  lastErrorMessage      String?
  lastErrorAt           DateTime?
  uptimePercent         Float     @default(100)

  // Financial
  reserveBalance        Int?
  availableBalance      Int?

  // Metadata
  notes                 String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  createdBy             String?

  // Integration relation
  clientIntegration     ClientIntegration?

  @@unique([companyId, name])
  @@index([companyId])
  @@index([providerType])
  @@index([status])
  @@map("merchant_accounts")
}

// =============================================================================
// ACCOUNT POOLS (Load Balancing & Failover)
// =============================================================================

model AccountPool {
  id                    String    @id @default(cuid())
  companyId             String

  // Friendly naming
  name                  String
  description           String?
  color                 String?
  icon                  String?
  tags                  String[]  @default([])

  // Members (stored as JSON array of PoolMembership)
  accounts              Json      @default("[]")

  // Load balancing strategy
  balancingStrategy     String    @default("WEIGHTED")

  // Configuration (stored as JSON)
  failover              Json      // FailoverConfig
  healthRouting         Json      // HealthRoutingConfig
  limitRouting          Json      // LimitRoutingConfig
  stickySession         Json?     // StickySessionConfig (optional)

  // Status
  status                String    @default("active")

  // Round-robin state
  lastAccountIndex      Int       @default(0)

  // Metadata
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  createdBy             String?

  @@unique([companyId, name])
  @@index([companyId])
  @@index([status])
  @@map("account_pools")
}

// =============================================================================
// ROUTING RULES (Gateway Rule Engine)
// =============================================================================

model RoutingRule {
  id                    String    @id @default(cuid())
  companyId             String

  // Friendly naming
  name                  String
  description           String?
  color                 String?
  tags                  String[]  @default([])

  // Status
  status                String    @default("INACTIVE")
  priority              Int       @default(100)

  // Conditions & Actions (JSON)
  conditions            Json
  actions               Json

  // Fallback
  fallbackAction        String?
  fallbackPoolId        String?
  fallbackMessage       String?

  // A/B Testing
  testingEnabled        Boolean   @default(false)
  testingTrafficPct     Float?
  testingControlPoolId  String?
  testingTestPoolId     String?
  testingStartDate      DateTime?
  testingEndDate        DateTime?
  testingMetrics        String[]  @default([])

  // Scheduling
  activateAt            DateTime?
  deactivateAt          DateTime?
  timezone              String?
  recurringSchedule     String?

  // Analytics
  matchCount            Int       @default(0)
  lastMatchedAt         DateTime?
  avgProcessingTimeMs   Float     @default(0)

  // Metadata
  version               Int       @default(1)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  createdBy             String?

  @@unique([companyId, name])
  @@index([companyId])
  @@index([status])
  @@index([priority])
  @@map("routing_rules")
}

model RoutingDecision {
  id                    String    @id @default(cuid())
  companyId             String
  transactionId         String

  // Decision
  primaryAccountId      String?
  primaryAccountName    String?
  fallbackAccountIds    String[]  @default([])
  blocked               Boolean   @default(false)
  blockReason           String?
  flaggedForReview      Boolean   @default(false)
  reviewReason          String?
  require3ds            Boolean   @default(false)

  // Amounts
  surchargeAmount       Int       @default(0)
  discountAmount        Int       @default(0)
  originalAmount        Int
  finalAmount           Int

  // Applied rules
  appliedRuleIds        String[]  @default([])
  appliedRuleNames      String[]  @default([])

  // Performance
  evaluationTimeMs      Int
  conditionsChecked     Int
  rulesEvaluated        Int

  // Context
  contextSnapshot       Json?

  createdAt             DateTime  @default(now())

  @@index([companyId])
  @@index([transactionId])
  @@index([createdAt])
  @@map("routing_decisions")
}

// =============================================================================
// BILLING & USAGE TRACKING
// =============================================================================

model PricingPlan {
  id                    String    @id @default(cuid())

  // Plan identification
  name                  String    @unique
  displayName           String
  description           String?

  // Billing
  billingInterval       String    @default("MONTHLY")
  baseCost              Int       @default(0)
  currency              String    @default("USD")

  // Included allowances (JSON)
  included              Json      // { transactions: number, volume: number, apiCalls: number, ... }

  // Overage pricing (JSON)
  overage               Json      // { transactionPrice: number, volumePercent: number, ... }

  // Features (JSON)
  features              Json      @default("[]")

  // Limits (JSON)
  limits                Json?     // { maxCompanies: number, maxUsers: number, ... }

  // Status
  status                String    @default("active")
  isDefault             Boolean   @default(false)

  // Metadata
  sortOrder             Int       @default(0)
  metadata              Json?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  subscriptions         ClientSubscription[]

  @@index([status])
  @@map("pricing_plans")
}

model ClientSubscription {
  id                    String    @id @default(cuid())
  clientId              String    @unique
  planId                String

  // Status
  status                String    @default("active")
  statusReason          String?
  statusChangedAt       DateTime?

  // Billing cycle
  currentPeriodStart    DateTime
  currentPeriodEnd      DateTime
  nextBillingDate       DateTime?
  billingAnchorDay      Int       @default(1)

  // Trial
  trialStart            DateTime?
  trialEnd              DateTime?

  // Cancellation
  canceledAt            DateTime?
  cancelReason          String?
  cancelAtPeriodEnd     Boolean   @default(false)

  // Pause
  pausedAt              DateTime?
  pauseResumeAt         DateTime?
  pauseReason           String?

  // Discount
  discountPercent       Float?
  discountReason        String?
  discountExpiresAt     DateTime?

  // Stripe integration
  stripeCustomerId      String?
  stripeSubscriptionId  String?

  // Metadata
  metadata              Json?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  plan                  PricingPlan     @relation(fields: [planId], references: [id])
  usagePeriods          UsagePeriod[]
  invoices              Invoice[]

  @@index([planId])
  @@index([status])
  @@map("client_subscriptions")
}

model UsagePeriod {
  id                    String    @id @default(cuid())
  subscriptionId        String
  clientId              String

  // Period dates
  periodStart           DateTime
  periodEnd             DateTime

  // Transaction metrics
  transactionCount      Int       @default(0)
  transactionVolume     BigInt    @default(0)
  transactionCost       Int       @default(0)

  // Volume cost
  volumeCost            Int       @default(0)

  // API usage
  apiCallCount          Int       @default(0)
  apiCallCost           Int       @default(0)

  // Resource usage
  companiesUsed         Int       @default(0)
  usersUsed             Int       @default(0)
  storageUsedMb         Int       @default(0)

  // Costs
  baseCost              Int       @default(0)
  overageCost           Int       @default(0)
  totalCost             Int       @default(0)

  // Status
  status                String    @default("active")

  // Metadata
  closedAt              DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  subscription          ClientSubscription @relation(fields: [subscriptionId], references: [id])
  companyRecords        CompanyUsageRecord[]
  usageEvents           UsageEvent[]
  invoices              Invoice[]

  @@index([subscriptionId])
  @@index([clientId])
  @@index([status])
  @@index([periodStart, periodEnd])
  @@map("usage_periods")
}

model CompanyUsageRecord {
  id                    String    @id @default(cuid())
  usagePeriodId         String
  companyId             String

  // Metrics
  transactionCount      Int       @default(0)
  transactionVolume     BigInt    @default(0)
  apiCallCount          Int       @default(0)

  // Calculated costs (allocated share)
  allocatedCost         Int       @default(0)

  // Metadata
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  usagePeriod           UsagePeriod @relation(fields: [usagePeriodId], references: [id], onDelete: Cascade)

  @@unique([usagePeriodId, companyId])
  @@index([companyId])
  @@map("company_usage_records")
}

model UsageEvent {
  id                    String    @id @default(cuid())
  usagePeriodId         String
  companyId             String?

  // Event details
  eventType             String
  quantity              Int       @default(1)
  unitCost              Int       @default(0)
  totalCost             Int       @default(0)

  // Reference
  referenceType         String?
  referenceId           String?

  // Metadata
  metadata              Json?
  occurredAt            DateTime  @default(now())
  createdAt             DateTime  @default(now())

  // Relations
  usagePeriod           UsagePeriod @relation(fields: [usagePeriodId], references: [id], onDelete: Cascade)

  @@index([usagePeriodId])
  @@index([companyId])
  @@index([eventType])
  @@index([occurredAt])
  @@map("usage_events")
}

model Invoice {
  id                    String    @id @default(cuid())
  clientId              String
  subscriptionId        String
  usagePeriodId         String?

  // Invoice number
  invoiceNumber         String    @unique

  // Period
  periodStart           DateTime
  periodEnd             DateTime

  // Amounts (in cents)
  subtotal              Int
  discount              Int       @default(0)
  tax                   Int       @default(0)
  total                 Int
  amountPaid            Int       @default(0)
  amountDue             Int

  // Currency
  currency              String    @default("USD")

  // Line items (JSON array)
  lineItems             Json      @default("[]")

  // Status
  status                String    @default("draft")

  // Dates
  dueDate               DateTime
  paidAt                DateTime?
  voidedAt              DateTime?
  sentAt                DateTime?

  // Stripe
  stripeInvoiceId       String?
  stripePaymentIntentId String?

  // Payment
  paymentMethod         String?

  // PDF
  pdfUrl                String?

  // Notes
  notes                 String?

  // Metadata
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  subscription          ClientSubscription @relation(fields: [subscriptionId], references: [id])
  usagePeriod           UsagePeriod?       @relation(fields: [usagePeriodId], references: [id])

  @@index([clientId])
  @@index([subscriptionId])
  @@index([status])
  @@index([dueDate])
  @@map("invoices")
}

// =============================================================================
// SYSTEM MODELS
// =============================================================================

model ApiKey {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  keyHash        String   @unique
  keyPrefix      String   // First 8 chars for identification

  // Permissions
  scopes         String[] @default([])

  // Usage
  lastUsedAt     DateTime?
  expiresAt      DateTime?

  // Status
  isActive       Boolean  @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("api_keys")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?

  // What happened
  action    String
  entity    String
  entityId  String?

  // Context
  scopeType ScopeType?
  scopeId   String?

  // Details
  changes   Json?
  metadata  Json?
  ipAddress String?
  userAgent String?

  // Data classification (for compliance)
  dataClassification DataClassification?

  // Timestamp
  createdAt DateTime @default(now())

  // Relations
  user User? @relation(fields: [userId], references: [id])

  @@index([entity, entityId])
  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@map("audit_logs")
}

// =============================================================================
// ENUMS
// =============================================================================

// Hierarchy & Access
enum BillingPlan {
  STARTER
  PROFESSIONAL
  ENTERPRISE
  CUSTOM
}

enum BillingStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  SUSPENDED
}

enum ClientPlan {
  BASIC
  STANDARD
  PREMIUM
  ENTERPRISE
}

enum EntityStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  DELETED
}

enum ScopeType {
  ORGANIZATION
  CLIENT
  COMPANY
  DEPARTMENT
  TEAM
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  USER
  VIEWER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

enum TeamRole {
  LEAD
  MEMBER
  VIEWER
}

// Customer & Address
enum CustomerStatus {
  ACTIVE
  INACTIVE
  BLOCKED
}

enum AddressType {
  SHIPPING
  BILLING
  BOTH
}

// Payment
enum PaymentProviderType {
  PAYFLOW
  NMI
  AUTHORIZE_NET
  STRIPE
  BRAINTREE
  SQUARE
  CUSTOM
}

enum PaymentMethodType {
  CARD
  ACH
  WALLET_APPLE
  WALLET_GOOGLE
  PAYPAL
  AFFIRM
  KLARNA
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  PAID
  PARTIALLY_REFUNDED
  REFUNDED
  FAILED
  VOIDED
}

enum TransactionType {
  CHARGE
  REFUND
  VOID
  CHARGEBACK
  ADJUSTMENT
  AUTHORIZATION
  CAPTURE
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  VOIDED
  DISPUTED
}

// Subscription
enum BillingInterval {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELED
  PAST_DUE
  TRIALING
  EXPIRED
}

// Product
enum ProductCategory {
  COFFEE
  EQUIPMENT
  MERCHANDISE
  GIFT_CARD
  SUBSCRIPTION_BOX
}

enum ProductStatus {
  ACTIVE
  DRAFT
  ARCHIVED
  OUT_OF_STOCK
}

enum RoastLevel {
  LIGHT
  MEDIUM_LIGHT
  MEDIUM
  MEDIUM_DARK
  DARK
}

// Order
enum OrderType {
  ONE_TIME
  SUBSCRIPTION
  GIFT
  REPLACEMENT
  SAMPLE
}

enum OrderStatus {
  PENDING           // Created, awaiting payment
  CONFIRMED         // Payment received
  PROCESSING        // Being prepared (address locked)
  PARTIALLY_SHIPPED // Some items shipped
  SHIPPED           // All items shipped
  DELIVERED         // Customer received
  COMPLETED         // Finalized
  CANCELED          // Canceled by customer/system
  REFUNDED          // Fully refunded
}

enum FulfillmentStatus {
  UNFULFILLED
  PARTIALLY_FULFILLED
  FULFILLED
  RETURNED
}

// Shipping
enum ShippingCarrier {
  USPS
  UPS
  FEDEX
  DHL
  AMAZON
  LOCAL_DELIVERY
  PICKUP
  OTHER
}

enum ShippingMethod {
  GROUND
  EXPRESS
  OVERNIGHT
  TWO_DAY
  SAME_DAY
  PICKUP
  FREE
}

enum ShipmentStatus {
  PENDING           // Label not created
  LABEL_CREATED     // Label printed, not shipped
  IN_TRANSIT        // With carrier
  OUT_FOR_DELIVERY  // On truck for delivery
  DELIVERED         // Delivered
  FAILED            // Delivery failed
  RETURNED          // Returned to sender
  EXCEPTION         // Problem occurred
}

enum ShipmentEventType {
  LABEL_CREATED
  PICKED_UP
  IN_TRANSIT
  ARRIVED_AT_FACILITY
  DEPARTED_FACILITY
  OUT_FOR_DELIVERY
  DELIVERY_ATTEMPTED
  DELIVERED
  EXCEPTION
  RETURNED_TO_SENDER
}

// Compliance
enum DataClassification {
  PUBLIC
  INTERNAL
  CONFIDENTIAL
  PII
  PCI
  PHI
}

// =============================================================================
// MOMENTUM INTELLIGENCE™ MODELS
// AI-Powered Behavioral Commerce Platform
// =============================================================================

model CustomerIntent {
  id                String   @id @default(cuid())
  companyId         String
  customerId        String

  // Risk Assessment
  churnScore        Float    @default(0)
  churnRisk         ChurnRiskLevel @default(LOW)
  confidence        Float    @default(0)

  // Contributing Signals
  signals           Json     // Array of detected signals
  primaryFactors    String[]

  // Recommended Action
  recommendedAction InterventionType?
  urgency           InterventionUrgency @default(MONITORING)

  // Timestamps
  calculatedAt      DateTime @default(now())
  expiresAt         DateTime

  // Relations
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer          Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  interventions     Intervention[]

  @@index([companyId, customerId])
  @@index([churnRisk, urgency])
  @@map("customer_intents")
}

model Intervention {
  id                String   @id @default(cuid())
  companyId         String
  customerId        String
  intentId          String?

  // Intervention Details
  type              InterventionType
  channel           DeliveryChannel
  stage             String?          // For multi-stage flows

  // Content
  templateId        String?
  content           Json?            // Generated/customized content
  offers            Json?            // Any offers presented

  // Execution
  status            InterventionStatus @default(PENDING)
  scheduledAt       DateTime?
  executedAt        DateTime?

  // Outcome
  outcome           InterventionOutcome?
  outcomeDetails    Json?
  revenueImpact     Float?           // Positive = saved, Negative = lost

  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer          Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  intent            CustomerIntent? @relation(fields: [intentId], references: [id])
  voiceCall         VoiceCall?

  @@index([companyId, customerId])
  @@index([status, scheduledAt])
  @@index([type, outcome])
  @@map("interventions")
}

model SaveAttempt {
  id                String   @id @default(cuid())
  companyId         String
  customerId        String

  // Flow Tracking
  flowConfigId      String
  startedAt         DateTime @default(now())
  completedAt       DateTime?

  // Stage Progress
  currentStage      Int      @default(1)
  stageHistory      Json     // Array of stage entries with timestamps

  // Diagnosis
  cancellationReason String?
  reasonCategory    String?

  // Outcome
  outcome           SaveOutcome?
  savedBy           String?          // Which stage/offer saved them
  offerAccepted     Json?

  // Attribution
  revenuePreserved  Float?           // LTV that was saved

  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer          Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([companyId, customerId])
  @@index([outcome, savedBy])
  @@map("save_attempts")
}

model VoiceCall {
  id                String   @id @default(cuid())
  companyId         String
  customerId        String
  interventionId    String?  @unique

  // Twilio Details
  twilioCallSid     String   @unique
  direction         CallDirection
  fromNumber        String
  toNumber          String

  // Timing
  initiatedAt       DateTime @default(now())
  answeredAt        DateTime?
  endedAt           DateTime?
  duration          Int?             // Seconds

  // AI Processing
  scriptId          String
  transcriptRaw     String?  @db.Text
  transcriptProcessed Json?          // Structured transcript with intents

  // Sentiment & Intent
  overallSentiment  Sentiment?
  detectedIntents   String[]
  keyMoments        Json?            // Important moments in call

  // Outcome
  status            VoiceCallStatus @default(INITIATED)
  outcome           CallOutcome?
  outcomeDetails    Json?

  // Offers & Actions
  offersPresented   Json?
  offerAccepted     Json?
  actionsTaken      Json?            // Pause, discount, escalate, etc.

  // Escalation
  escalatedToHuman  Boolean  @default(false)
  escalationReason  String?
  humanAgentId      String?

  // Quality
  qualityScore      Float?           // 0-100
  qualityNotes      String?

  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer          Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  intervention      Intervention? @relation(fields: [interventionId], references: [id])

  @@index([companyId, customerId])
  @@index([twilioCallSid])
  @@index([status, outcome])
  @@map("voice_calls")
}

model UpsellOffer {
  id                String   @id @default(cuid())
  companyId         String
  customerId        String

  // Offer Details
  type              UpsellType
  moment            UpsellMoment
  productId         String?

  // Presentation
  contentId         String?          // Link to GeneratedContent
  position          String           // Where shown in flow

  // Offer Terms
  originalPrice     Float?
  offerPrice        Float?
  discount          Float?
  validUntil        DateTime?

  // Behavioral Config
  triggerUsed       String?          // Which trigger presented this

  // Outcome
  presented         Boolean  @default(false)
  presentedAt       DateTime?
  accepted          Boolean?
  acceptedAt        DateTime?
  revenue           Float?           // If accepted

  // Attribution
  attributionWindow Int?             // Hours

  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer          Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([companyId, customerId])
  @@index([type, moment, accepted])
  @@map("upsell_offers")
}

model UpsellConfig {
  id                      String    @id @default(cuid())
  companyId               String    @unique

  enabled                 Boolean   @default(true)
  aiRecommendations       Boolean   @default(true)

  // Frequency limits (JSON)
  globalLimits            Json      // { maxPresentationsPerDay, maxPresentationsPerWeek, cooldownAfterDecline, cooldownAfterAccept }

  // Channel settings (JSON)
  channelDefaults         Json      @default("{}") // Per-channel configuration

  // AI settings (JSON)
  aiSettings              Json      // { minConfidence, minRelevanceScore, maxRecommendations, optimizeFor }

  // Behavioral triggers (JSON)
  triggerSettings         Json      // { enabledTriggers, triggerConfigs }

  // A/B testing (JSON)
  abTesting               Json      @default("{\"enabled\": false, \"defaultTrafficSplit\": 50}")

  // Timestamps
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  // Relations
  company                 Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("upsell_configs")
}

model SaveFlowConfig {
  id                String   @id @default(cuid())
  companyId         String   @unique

  enabled           Boolean  @default(true)

  // Stage Configurations (JSON for flexibility)
  patternInterrupt  Json
  diagnosisSurvey   Json
  branchingInterventions Json
  nuclearOffer      Json
  lossVisualization Json
  exitSurvey        Json
  winback           Json

  // Voice AI Settings
  voiceAIEnabled    Boolean  @default(false)
  voiceAIConfig     Json?

  // A/B Testing
  activeExperiments Json?

  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("save_flow_configs")
}

model VoiceScript {
  id                String   @id @default(cuid())
  companyId         String

  // Script Details
  name              String
  type              VoiceScriptType
  description       String?

  // Script Content (JSON for flexibility)
  opening           Json     // greeting, patternInterrupt, acknowledgment
  diagnosis         Json     // primaryQuestion, followUpQuestions, sentimentResponses
  interventions     Json     // condition-based responses with offers
  objectionHandling Json     // objection-response pairs
  closing           Json     // acceptOffer, declineOffer, escalateToHuman, scheduleCallback
  behavioralTriggers Json    // stage-based trigger configuration

  // Status
  isActive          Boolean  @default(true)
  isDefault         Boolean  @default(false)

  // Performance
  usageCount        Int      @default(0)
  avgSaveRate       Float?
  avgCallDuration   Float?

  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, name])
  @@index([companyId, type])
  @@map("voice_scripts")
}

model BehavioralTrigger {
  id                String   @id @default(cuid())

  // Trigger Details
  name              String   @unique
  displayName       String
  description       String?
  category          String   // e.g., "urgency", "social_proof", "loss_aversion"

  // Implementation Guide (JSON)
  implementation    Json     // pricing, headlines, visuals guidance
  examples          String[]

  // Usage Stats
  usageCount        Int      @default(0)
  avgEffectiveness  Float?

  // Status
  isActive          Boolean  @default(true)

  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([category])
  @@map("behavioral_triggers")
}

model MomentumAnalytics {
  id                String   @id @default(cuid())
  companyId         String
  periodStart       DateTime
  periodEnd         DateTime

  // Save Metrics
  totalSaveAttempts Int      @default(0)
  successfulSaves   Int      @default(0)
  saveRate          Float    @default(0)
  revenuePreserved  Float    @default(0)

  // Stage Performance (JSON)
  stageMetrics      Json     // Performance by stage

  // Channel Performance
  emailSaves        Int      @default(0)
  smsSaves          Int      @default(0)
  voiceSaves        Int      @default(0)
  inAppSaves        Int      @default(0)

  // Voice AI Metrics
  totalCalls        Int      @default(0)
  avgCallDuration   Float    @default(0)
  voiceSaveRate     Float    @default(0)

  // Content Performance
  contentGenerated  Int      @default(0)
  topPerformingContent Json?

  // Upsell Metrics
  upsellsPresented  Int      @default(0)
  upsellsAccepted   Int      @default(0)
  upsellRevenue     Float    @default(0)

  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, periodStart, periodEnd])
  @@index([companyId])
  @@index([periodStart, periodEnd])
  @@map("momentum_analytics")
}

// =============================================================================
// MOMENTUM INTELLIGENCE ENUMS
// =============================================================================

enum ChurnRiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum InterventionType {
  SAVE_FLOW
  PROACTIVE_OUTREACH
  PAYMENT_RECOVERY
  WINBACK
  UPSELL
  SERVICE_RECOVERY
}

enum InterventionUrgency {
  IMMEDIATE
  WITHIN_24H
  WITHIN_7D
  MONITORING
}

enum InterventionStatus {
  PENDING
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED
}

enum InterventionOutcome {
  SAVED
  OFFER_ACCEPTED
  DOWNGRADED
  PAUSED
  CANCELLED
  NO_RESPONSE
  ESCALATED
}

enum DeliveryChannel {
  EMAIL
  SMS
  VOICE
  IN_APP
  WEBHOOK
}

enum SaveOutcome {
  SAVED_STAGE_1
  SAVED_STAGE_2
  SAVED_STAGE_3
  SAVED_STAGE_4
  SAVED_STAGE_5
  SAVED_VOICE
  CANCELLED
  PAUSED
  DOWNGRADED
}

enum CallDirection {
  INBOUND
  OUTBOUND
}

enum VoiceCallStatus {
  INITIATED
  RINGING
  IN_PROGRESS
  COMPLETED
  FAILED
  BUSY
  NO_ANSWER
}

enum CallOutcome {
  SAVED
  OFFER_ACCEPTED
  DECLINED
  ESCALATED_TO_HUMAN
  CALLBACK_SCHEDULED
  DISCONNECTED
}

enum Sentiment {
  POSITIVE
  NEUTRAL
  NEGATIVE
  ANGRY
}

enum ContentType {
  EMAIL_SEQUENCE
  SMS_MESSAGE
  VOICE_SCRIPT
  AD_COPY
  LANDING_PAGE
  IN_APP_MODAL
  PUSH_NOTIFICATION
}

enum ContentStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  ACTIVE
  ARCHIVED
}

enum UpsellType {
  SHIPPING_PROTECTION
  TIER_UPGRADE
  FREQUENCY_UPGRADE
  ADD_ON
  GIFT_SUBSCRIPTION
  ANNUAL_PLAN
}

enum UpsellMoment {
  CHECKOUT
  POST_PURCHASE
  DAY_7
  DAY_14
  DAY_30
  MONTH_2
  MONTH_3
  SAVE_FLOW
  WINBACK
}

enum VoiceScriptType {
  INBOUND_SAVE
  OUTBOUND_SAVE
  WINBACK
  UPSELL
}

// =============================================================================
// MOMENTUM INTELLIGENCE - INTENT DETECTION (Enhanced)
// =============================================================================

model IntentDetection {
  id                     String   @id @default(cuid())
  companyId              String
  customerId             String
  sessionId              String?

  // Primary intent
  primaryIntent          String
  primaryConfidence      Float

  // Secondary intents (JSON array)
  secondaryIntents       Json     @default("[]")

  // Cancel-specific
  cancelReason           String?
  cancelReasonConfidence Float?

  // Sentiment
  sentiment              String
  sentimentScore         Float

  // Urgency
  urgency                String

  // Source
  source                 String
  sourceData             Json?

  // Timestamps
  detectedAt             DateTime @default(now())
  createdAt              DateTime @default(now())

  @@index([companyId])
  @@index([customerId])
  @@index([primaryIntent])
  @@index([detectedAt])
  @@map("intent_detections")
}

model ChurnSignal {
  id         String   @id @default(cuid())
  customerId String
  signalType String
  weight     Float
  value      String
  confidence Float    @default(0.8)
  decayDays  Int
  detectedAt DateTime @default(now())
  expiresAt  DateTime
  metadata   Json?

  @@index([customerId])
  @@index([signalType])
  @@index([expiresAt])
  @@map("churn_signals")
}

model ChurnRiskScore {
  id                  String    @id @default(cuid())
  customerId          String    @unique
  companyId           String
  score               Float
  riskLevel           String
  signalBreakdown     Json
  trend               String
  trendDelta          Float
  predictedChurnDate  DateTime?
  recommendedActions  String[]  @default([])
  calculatedAt        DateTime  @default(now())
  nextCalculationAt   DateTime

  @@index([companyId])
  @@index([riskLevel])
  @@index([score])
  @@map("churn_risk_scores")
}

model CustomerEngagementMetrics {
  id                       String    @id @default(cuid())
  customerId               String    @unique
  companyId                String

  // Login/Activity
  lastLoginAt              DateTime?
  loginFrequency           Float     @default(0)
  loginFrequencyTrend      Float     @default(0)

  // Feature usage
  featuresUsed             String[]  @default([])
  featureUsageScore        Float     @default(0)

  // Order metrics
  totalOrders              Int       @default(0)
  ordersLast30Days         Int       @default(0)
  ordersLast90Days         Int       @default(0)
  orderFrequencyTrend      Float     @default(0)

  // Skip behavior
  totalSkips               Int       @default(0)
  skipsLast30Days          Int       @default(0)
  skipRate                 Float     @default(0)

  // Support
  supportTicketsTotal      Int       @default(0)
  supportTicketsLast30Days Int       @default(0)
  avgTicketResolutionHours Float     @default(0)

  // Feedback
  lastNpsScore             Int?
  lastNpsDate              DateTime?
  lastFeedbackSentiment    String?

  // Scores
  engagementScore          Float     @default(50)
  healthScore              Float     @default(50)

  calculatedAt             DateTime  @default(now())

  @@index([companyId])
  @@index([engagementScore])
  @@index([healthScore])
  @@map("customer_engagement_metrics")
}

// =============================================================================
// CUSTOMER SERVICE MANAGEMENT
// Two-Tier AI Customer Service System (AI Rep + AI Manager + Human)
// =============================================================================

model CSSession {
  id                String    @id @default(cuid())
  companyId         String
  customerId        String

  // Session Details
  channel           String    // voice, chat, email, sms
  currentTier       CSTier    @default(AI_REP)
  status            CSSessionStatus @default(ACTIVE)

  // Issue
  issueCategory     String?
  issueSummary      String?

  // Sentiment Tracking
  customerSentiment String    @default("NEUTRAL")
  sentimentHistory  Json      @default("[]")

  // Escalation
  escalationHistory Json      @default("[]")

  // Context
  context           Json      @default("{}")

  // Resolution
  resolutionType    String?
  resolutionSummary String?
  resolutionActions Json?
  customerSatisfaction Int?
  followUpRequired  Boolean   @default(false)
  followUpDate      DateTime?

  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  resolvedAt        DateTime?

  // Relations
  messages          CSMessage[]
  refunds           Refund[]
  rmas              RMA[]

  @@index([companyId])
  @@index([customerId])
  @@index([status])
  @@index([currentTier])
  @@map("cs_sessions")
}

model CSMessage {
  id         String   @id @default(cuid())
  sessionId  String
  role       String   // customer, ai_rep, ai_manager, human_agent, system
  content    String   @db.Text
  sentiment  String?
  metadata   Json?

  // Timestamps
  createdAt  DateTime @default(now())

  // Relations
  session    CSSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@map("cs_messages")
}

model CSConfig {
  id                String   @id @default(cuid())
  companyId         String   @unique

  enabled           Boolean  @default(true)

  // Tier configurations (JSON)
  aiRepConfig       Json
  aiManagerConfig   Json
  humanAgentConfig  Json

  // Irate customer protocol
  irateProtocol     Json

  // Channel configurations
  channelConfigs    Json

  // Business hours
  businessHours     Json

  // Response templates
  responseTemplates Json     @default("[]")

  // Integrations
  integrations      Json     @default("{}")

  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("cs_configs")
}

// =============================================================================
// REFUND MANAGEMENT
// =============================================================================

model Refund {
  id              String   @id @default(cuid())
  companyId       String
  customerId      String
  orderId         String
  rmaId           String?
  csSessionId     String?

  // Refund Details
  type            RefundType @default(MANUAL)
  status          RefundStatus @default(PENDING)
  reason          RefundReason
  reasonDetails   String?

  // Amount
  requestedAmount Decimal  @db.Decimal(10, 2)
  approvedAmount  Decimal? @db.Decimal(10, 2)
  currency        String   @default("USD")
  amountBreakdown Json?

  // Method
  method          RefundMethod @default(ORIGINAL_PAYMENT)

  // Approval
  approvalLevel   String
  approvedBy      String?
  approvedAt      DateTime?
  rejectedBy      String?
  rejectedAt      DateTime?
  rejectionReason String?
  autoApprovalRule String?

  // Processing
  paymentProcessor     String?
  processorTransactionId String?
  processedAt          DateTime?
  failureReason        String?
  retryCount           Int @default(0)

  // Metadata
  initiatedBy     String   // customer, ai_rep, ai_manager, human_agent, system
  channel         String?
  customerImpact  String?
  fraudScore      Float?
  tags            String[] @default([])

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  completedAt     DateTime?

  // Relations
  csSession       CSSession? @relation(fields: [csSessionId], references: [id])

  @@index([companyId])
  @@index([customerId])
  @@index([orderId])
  @@index([status])
  @@index([type])
  @@map("refunds")
}

model RefundPolicy {
  id              String   @id @default(cuid())
  companyId       String   @unique

  enabled         Boolean  @default(true)

  // Rules (JSON)
  generalRules    Json
  autoApprovalRules Json   @default("[]")
  tierLimits      Json
  reasonSpecificRules Json @default("[]")

  // Notifications
  notifications   Json

  // Fraud prevention
  fraudPrevention Json

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("refund_policies")
}

// =============================================================================
// RMA (RETURN MERCHANDISE AUTHORIZATION)
// =============================================================================

model RMA {
  id              String   @id @default(cuid())
  rmaNumber       String   @unique
  companyId       String
  customerId      String
  orderId         String
  csSessionId     String?

  // RMA Details
  type            RMAType  @default(RETURN)
  status          RMAStatus @default(REQUESTED)
  reason          ReturnReason
  reasonDetails   String?

  // Items
  items           Json     // Array of RMAItem

  // Shipping
  labelType       String   // prepaid, customer_paid, pickup
  carrier         String?
  trackingNumber  String?
  trackingUrl     String?
  labelUrl        String?
  labelSentAt     DateTime?
  shippedAt       DateTime?
  deliveredAt     DateTime?
  returnAddress   Json

  // Inspection
  inspectionStatus  String?
  inspectionResult  String?
  inspectionNotes   String?
  inspectionPhotos  String[] @default([])
  inspectedAt       DateTime?
  inspectedBy       String?

  // Resolution
  resolutionType    String   @default("refund")
  resolutionStatus  String   @default("pending")
  resolutionData    Json?

  // Timeline
  timeline        Json     @default("[]")

  // Metadata
  initiatedBy     String
  channel         String?
  priority        String   @default("normal")
  tags            String[] @default([])
  internalNotes   String?

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  expiresAt       DateTime
  completedAt     DateTime?

  // Relations
  csSession       CSSession? @relation(fields: [csSessionId], references: [id])

  @@index([companyId])
  @@index([customerId])
  @@index([orderId])
  @@index([status])
  @@index([rmaNumber])
  @@map("rmas")
}

model RMAPolicy {
  id              String   @id @default(cuid())
  companyId       String   @unique

  enabled         Boolean  @default(true)

  // Rules (JSON)
  generalRules    Json
  returnReasons   Json     @default("[]")
  shippingConfig  Json
  inspectionConfig Json
  resolutionConfig Json

  // Notifications
  notifications   Json

  // Automation
  automation      Json

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("rma_policies")
}

// =============================================================================
// TERMS & CONDITIONS
// =============================================================================

model TermsDocument {
  id              String   @id @default(cuid())
  companyId       String

  // Document Details
  type            TermsType
  title           String
  version         String
  status          TermsStatus @default(DRAFT_TERMS)

  // Content
  fullText        String   @db.Text
  htmlFormatted   String?  @db.Text
  sections        Json     @default("[]")
  language        String   @default("en")
  translations    Json?

  // Readability
  readabilityScore Int     @default(0)
  wordCount       Int      @default(0)
  estimatedReadTime Int    @default(0)

  // Metadata
  author          String?
  lastModifiedBy  String?
  reviewedBy      String?
  approvedBy      String?
  approvedAt      DateTime?
  generatedBy     String?  // human, ai, hybrid
  aiModel         String?
  tags            String[] @default([])
  internalNotes   String?
  externalUrl     String?

  // Compliance
  complianceFrameworks String[] @default([])
  jurisdictions   String[] @default([])
  complianceRequirements Json @default("[]")

  // History
  history         Json     @default("[]")

  // Dates
  effectiveDate   DateTime?
  expirationDate  DateTime?

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  publishedAt     DateTime?

  // Relations
  summaries       TermsSummary[]
  acceptances     TermsAcceptance[]

  @@index([companyId])
  @@index([type])
  @@index([status])
  @@map("terms_documents")
}

model TermsSummary {
  id              String   @id @default(cuid())
  termsDocumentId String

  // Summary Details
  format          String   // bullet_points, faq, plain_language, key_points, comparison
  level           String   // simple, standard, technical, legal

  content         String   @db.Text
  keyPoints       Json?
  faqs            Json?
  importantDates  Json?
  userRights      Json?
  userObligations Json?

  language        String   @default("en")

  // Timestamps
  createdAt       DateTime @default(now())

  // Relations
  termsDocument   TermsDocument @relation(fields: [termsDocumentId], references: [id], onDelete: Cascade)

  @@index([termsDocumentId])
  @@map("terms_summaries")
}

model TermsAcceptance {
  id                String   @id @default(cuid())
  termsDocumentId   String
  termsVersion      String
  customerId        String
  userId            String?

  // Acceptance Details
  acceptanceMethod  String   // checkbox, click, signature, verbal, implicit

  // Context
  ipAddress         String?
  userAgent         String?
  location          String?
  deviceType        String?
  channel           String?

  // Withdrawal
  withdrawnAt       DateTime?
  withdrawalReason  String?

  // Timestamps
  acceptedAt        DateTime @default(now())

  // Relations
  termsDocument     TermsDocument @relation(fields: [termsDocumentId], references: [id])

  @@index([termsDocumentId])
  @@index([customerId])
  @@index([acceptedAt])
  @@map("terms_acceptances")
}

model TermsAnalytics {
  id                String   @id @default(cuid())
  termsDocumentId   String

  // Views
  totalViews        Int      @default(0)
  uniqueViews       Int      @default(0)
  avgTimeOnPage     Float    @default(0)

  // Acceptances
  totalAcceptances  Int      @default(0)
  acceptanceRate    Float    @default(0)

  // Section engagement
  sectionViews      Json     @default("{}")

  // Search
  searchQueries     Json     @default("[]")

  // FAQ clicks
  faqClicks         Json     @default("{}")

  // Period
  periodStart       DateTime
  periodEnd         DateTime

  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([termsDocumentId, periodStart, periodEnd])
  @@index([termsDocumentId])
  @@map("terms_analytics")
}

// =============================================================================
// CUSTOMER SERVICE ENUMS
// =============================================================================

enum CSTier {
  AI_REP
  AI_MANAGER
  HUMAN_AGENT
}

enum CSSessionStatus {
  ACTIVE
  WAITING_CUSTOMER
  ESCALATED
  RESOLVED
  ABANDONED
}

// =============================================================================
// REFUND ENUMS
// =============================================================================

enum RefundStatus {
  PENDING
  APPROVED
  PROCESSING
  COMPLETED
  REJECTED
  CANCELLED
  // Note: FAILED already exists in TransactionStatus context
}

enum RefundType {
  AUTO
  MANUAL
  BULK
  MANAGER_OVERRIDE
}

enum RefundReason {
  PRODUCT_DEFECT
  WRONG_ITEM
  NOT_AS_DESCRIBED
  SHIPPING_DAMAGE
  NEVER_RECEIVED
  DUPLICATE_CHARGE
  SUBSCRIPTION_CANCELLATION
  CUSTOMER_REQUEST
  SERVICE_ISSUE
  QUALITY_ISSUE
  LATE_DELIVERY
  PRICE_MATCH
  GOODWILL
  OTHER_REASON
}

enum RefundMethod {
  ORIGINAL_PAYMENT
  STORE_CREDIT
  GIFT_CARD
  CHECK_PAYMENT
  BANK_TRANSFER
}

// =============================================================================
// RMA ENUMS
// =============================================================================

enum RMAStatus {
  REQUESTED
  RMA_APPROVED
  LABEL_SENT
  RMA_IN_TRANSIT
  RECEIVED
  INSPECTING
  INSPECTION_COMPLETE
  PROCESSING_REFUND
  RMA_COMPLETED
  RMA_REJECTED
  RMA_CANCELLED
  RMA_EXPIRED
}

enum RMAType {
  RETURN
  EXCHANGE
  WARRANTY
  REPAIR
  RECALL
}

enum ReturnReason {
  DEFECTIVE
  WRONG_SIZE
  WRONG_COLOR
  WRONG_ITEM_RECEIVED
  NOT_AS_DESCRIBED_RETURN
  DAMAGED_IN_SHIPPING
  ARRIVED_LATE
  NO_LONGER_NEEDED
  BETTER_PRICE_FOUND
  QUALITY_NOT_EXPECTED
  ACCIDENTAL_ORDER
  WARRANTY_CLAIM
  RECALL_RETURN
  OTHER_RETURN_REASON
}

// =============================================================================
// TERMS ENUMS
// =============================================================================

enum TermsType {
  TERMS_OF_SERVICE
  PRIVACY_POLICY
  REFUND_POLICY_DOC
  SHIPPING_POLICY
  SUBSCRIPTION_TERMS
  COOKIE_POLICY
  ACCEPTABLE_USE
  DATA_PROCESSING
  SLA
  CUSTOM_TERMS
}

enum TermsStatus {
  DRAFT_TERMS
  PENDING_REVIEW
  TERMS_APPROVED
  TERMS_ACTIVE
  TERMS_ARCHIVED
  SUPERSEDED
}

// =============================================================================
// CONTENT GENERATION
// =============================================================================

model ContentTemplate {
  id                    String    @id @default(cuid())
  companyId             String

  name                  String
  description           String?
  type                  String
  purpose               String
  status                String    @default("DRAFT")

  subject               String?
  preheader             String?
  body                  String
  bodyHtml              String?

  variables             Json      @default("[]")

  aiGenerated           Boolean   @default(false)
  aiProvider            String?
  aiPrompt              String?

  triggersApplied       String[]  @default([])
  triggerConfig         Json?

  personalizationLevel  String    @default("basic")
  dynamicSections       Json?

  usageCount            Int       @default(0)
  conversionRate        Float?
  openRate              Float?
  clickRate             Float?

  version               Int       @default(1)
  previousVersionId     String?

  createdBy             String
  publishedAt           DateTime?

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([companyId])
  @@index([type])
  @@index([purpose])
  @@index([status])
  @@map("content_templates")
}

model GeneratedContent {
  id                    String    @id @default(cuid())
  companyId             String
  templateId            String?

  type                  String
  purpose               String
  provider              String

  prompt                String
  systemPrompt          String?

  subject               String?
  body                  String
  bodyHtml              String?

  variations            Json?
  selectedVariationId   String?

  customerId            String?
  customerContext       Json?

  triggersApplied       String[]  @default([])
  triggerApplications   Json?

  qualityScore          Float?
  readabilityScore      Float?
  sentimentScore        Float?

  tokensUsed            Int       @default(0)
  generationTimeMs      Int       @default(0)
  cost                  Float?

  status                String    @default("GENERATED")
  reviewedBy            String?
  reviewedAt            DateTime?
  reviewNotes           String?

  createdAt             DateTime  @default(now())

  // Relations
  company               Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([type])
  @@index([purpose])
  @@index([status])
  @@map("generated_contents")
}

model ContentGenerationConfig {
  id                    String    @id @default(cuid())
  companyId             String    @unique

  providers             Json
  claude                Json
  ollama                Json
  quality               Json
  triggers              Json
  brandVoice            Json
  personalization       Json

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("content_generation_configs")
}

// =============================================================================
// DELIVERY ORCHESTRATION
// =============================================================================

model DeliveryMessage {
  id                      String    @id @default(cuid())
  companyId               String
  customerId              String

  recipientEmail          String?
  recipientPhone          String?
  recipientDeviceTokens   String[]  @default([])

  channel                 String
  priority                String    @default("NORMAL")

  templateId              String?
  contentId               String?
  subject                 String?
  body                    String
  bodyHtml                String?

  category                String
  tags                    String[]  @default([])

  scheduleType            String    @default("IMMEDIATE")
  scheduledFor            DateTime?
  optimalSendWindow       Json?

  status                  String    @default("PENDING")
  statusHistory           Json      @default("[]")

  providerMessageId       String?
  sentAt                  DateTime?
  deliveredAt             DateTime?
  openedAt                DateTime?
  clickedAt               DateTime?
  convertedAt             DateTime?
  failedAt                DateTime?
  failureReason           String?

  opensCount              Int       @default(0)
  clicksCount             Int       @default(0)
  clickedLinks            String[]  @default([])

  variantId               String?
  experimentId            String?

  automationId            String?
  automationStepId        String?

  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  @@index([companyId])
  @@index([customerId])
  @@index([status])
  @@index([scheduledFor])
  @@map("delivery_messages")
}

model DeliveryRetry {
  id                      String    @id @default(cuid())
  messageId               String
  retriesRemaining        Int
  lastRetryAt             DateTime?
  nextRetryAt             DateTime

  @@index([messageId])
  @@index([nextRetryAt])
  @@map("delivery_retries")
}

model CustomerPreference {
  id                      String    @id @default(cuid())
  customerId              String
  channel                 String
  unsubscribed            Boolean   @default(false)
  unsubscribedAt          DateTime?

  @@unique([customerId, channel])
  @@map("customer_preferences")
}

model DeliveryConfig {
  id                      String    @id @default(cuid())
  companyId               String    @unique

  channelPriority         String[]
  defaultChannel          String

  sendTimeOptimization    Json
  globalRateLimits        Json

  honorUnsubscribes       Boolean   @default(true)
  doubleOptIn             Boolean   @default(false)

  trackOpens              Boolean   @default(true)
  trackClicks             Boolean   @default(true)
  trackConversions        Boolean   @default(true)

  retrySettings           Json

  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  @@map("delivery_configs")
}

model Automation {
  id                      String    @id @default(cuid())
  companyId               String

  name                    String
  description             String?
  category                String
  status                  String    @default("DRAFT")

  trigger                 Json
  steps                   Json

  settings                Json

  enrollmentCount         Int       @default(0)
  completionCount         Int       @default(0)
  conversionCount         Int       @default(0)
  conversionRate          Float?

  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  activatedAt             DateTime?

  enrollments             AutomationEnrollment[]

  @@index([companyId])
  @@index([status])
  @@map("automations")
}

model AutomationEnrollment {
  id                      String    @id @default(cuid())
  automationId            String
  customerId              String

  status                  String    @default("ACTIVE")

  currentStepId           String?
  currentStepStartedAt    DateTime?

  stepsCompleted          String[]  @default([])
  messagesSent            String[]  @default([])

  triggerData             Json?

  enrolledAt              DateTime  @default(now())
  completedAt             DateTime?
  exitedAt                DateTime?
  exitReason              String?

  convertedAt             DateTime?
  conversionValue         Decimal?  @db.Decimal(10, 2)

  automation              Automation @relation(fields: [automationId], references: [id])

  @@index([automationId])
  @@index([customerId])
  @@index([status])
  @@map("automation_enrollments")
}

// =============================================================================
// ANALYTICS & REPORTING
// =============================================================================

model AnalyticsReport {
  id                      String    @id @default(cuid())
  companyId               String

  name                    String
  description             String?

  metrics                 Json      // Array of MetricCategory
  customMetrics           Json?     // Custom metric definitions

  filters                 Json      // Date range, segments, products, channels
  schedule                Json?     // Frequency, day, time, timezone
  delivery                Json      // Format, recipients, options

  isActive                Boolean   @default(true)

  lastGeneratedAt         DateTime?

  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  @@index([companyId])
  @@index([isActive])
  @@map("analytics_reports")
}

model AnalyticsSnapshot {
  id                      String    @id @default(cuid())
  companyId               String

  snapshotDate            DateTime
  granularity             String    // hour, day, week, month

  // Churn metrics
  churnRate               Float     @default(0)
  churnedCustomers        Int       @default(0)
  churnedRevenue          Decimal   @db.Decimal(10, 2) @default(0)

  // Save flow metrics
  saveAttempts            Int       @default(0)
  successfulSaves         Int       @default(0)
  saveRate                Float     @default(0)
  revenueSaved            Decimal   @db.Decimal(10, 2) @default(0)

  // Voice metrics
  totalCalls              Int       @default(0)
  avgCallDuration         Float     @default(0)
  callSaveRate            Float     @default(0)

  // Delivery metrics
  messagesSent            Int       @default(0)
  messagesDelivered       Int       @default(0)
  deliveryRate            Float     @default(0)
  openRate                Float     @default(0)
  clickRate               Float     @default(0)

  // Upsell metrics
  upsellsPresented        Int       @default(0)
  upsellsConverted        Int       @default(0)
  upsellConversionRate    Float     @default(0)
  upsellRevenue           Decimal   @db.Decimal(10, 2) @default(0)

  // Revenue metrics
  totalRevenue            Decimal   @db.Decimal(10, 2) @default(0)
  recurringRevenue        Decimal   @db.Decimal(10, 2) @default(0)
  netRevenueRetention     Float     @default(0)

  // Active customers
  activeSubscriptions     Int       @default(0)
  atRiskCustomers         Int       @default(0)

  createdAt               DateTime  @default(now())

  @@unique([companyId, snapshotDate, granularity])
  @@index([companyId])
  @@index([snapshotDate])
  @@map("analytics_snapshots")
}

model DashboardAlert {
  id                      String    @id @default(cuid())
  companyId               String

  type                    String    // warning, critical, info, success
  category                String    // churn, save_flow, delivery, upsell, revenue, engagement
  title                   String
  message                 String

  metric                  String?
  threshold               Float?
  currentValue            Float?
  actionUrl               String?

  acknowledgedAt          DateTime?
  acknowledgedBy          String?

  dismissedAt             DateTime?
  dismissedBy             String?

  createdAt               DateTime  @default(now())

  @@index([companyId])
  @@index([type])
  @@index([category])
  @@index([createdAt])
  @@map("dashboard_alerts")
}

// =============================================================================
// INTEGRATIONS FRAMEWORK
// =============================================================================

model IntegrationDefinition {
  id                  String    @id @default(cuid())
  provider            String    @unique
  category            String
  name                String
  description         String
  logoUrl             String?
  documentationUrl    String?
  isOrgOnly           Boolean   @default(false)
  isClientAllowed     Boolean   @default(true)
  isPlatformOffered   Boolean   @default(false)
  credentialSchema    Json
  settingsSchema      Json      @default("{}")
  requiredCompliance  String[]  @default([])
  status              String    @default("active")
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@map("integration_definitions")
}

model PlatformIntegration {
  id                    String    @id @default(cuid())
  organizationId        String
  provider              String
  category              String
  name                  String
  description           String?
  credentials           Json
  settings              Json      @default("{}")
  environment           String    @default("SANDBOX")
  isSharedWithClients   Boolean   @default(false)
  clientPricing         Json?
  status                String    @default("PENDING")
  lastTestedAt          DateTime?
  lastTestResult        String?
  errorMessage          String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  createdBy             String
  updatedBy             String?

  organization          Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  clientIntegrations    ClientIntegration[]

  @@unique([organizationId, provider])
  @@index([organizationId])
  @@map("platform_integrations")
}

model ClientIntegration {
  id                      String    @id @default(cuid())
  clientId                String
  provider                String
  category                String
  name                    String
  description             String?
  mode                    String    @default("OWN")
  credentials             Json?
  platformIntegrationId   String?
  settings                Json      @default("{}")
  environment             String    @default("SANDBOX")
  usageThisMonth          Json?
  isDefault               Boolean   @default(false)
  priority                Int       @default(0)
  status                  String    @default("PENDING")
  isVerified              Boolean   @default(false)
  verifiedAt              DateTime?
  verifiedBy              String?
  lastTestedAt            DateTime?
  lastTestResult          String?
  errorMessage            String?
  merchantAccountId       String?   @unique
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  createdBy               String
  updatedBy               String?

  client                  Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  platformIntegration     PlatformIntegration? @relation(fields: [platformIntegrationId], references: [id])
  merchantAccount         MerchantAccount? @relation(fields: [merchantAccountId], references: [id])

  @@unique([clientId, provider, name])
  @@index([clientId])
  @@map("client_integrations")
}
