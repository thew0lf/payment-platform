// Payment Platform - Prisma Schema
// Multi-tenant hierarchical payment orchestration platform
// SOC2, PCI-DSS, ISO 27001 Compliant Design

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-1.1.x", "linux-musl-arm64-openssl-3.0.x", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// HIERARCHY MODELS
// Organization → Client → Company → Department → Team → User
// =============================================================================

model Organization {
  id       String  @id @default(cuid())
  name     String
  slug     String  @unique
  domain   String? @unique
  logo     String?
  settings Json    @default("{}")

  // Billing
  billingEmail  String?
  billingPlan   BillingPlan   @default(STARTER)
  billingStatus BillingStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  clients              Client[]
  users                User[]                @relation("OrganizationUsers")
  apiKeys              ApiKey[]
  platformIntegrations PlatformIntegration[]
  vendors              Vendor[]

  // Subscription Plans
  subscriptionPlans    SubscriptionPlan[]
  subscriptionSettings SubscriptionSettings?

  // Feature Development
  features             Feature[]

  // Email Templates
  emailTemplates       EmailTemplate[]

  // Waitlist
  waitlist             Waitlist[]

  // CS AI Pricing
  csAIPricing          CSAIPricing?

  @@map("organizations")
}

model Client {
  id             String  @id @default(cuid())
  organizationId String
  name           String
  slug           String
  code           String? @unique // 4-char alphanumeric code (e.g., "ACME")
  contactName    String?
  contactEmail   String?
  contactPhone   String?
  settings       Json    @default("{}")

  // Client plan/status
  plan   ClientPlan   @default(BASIC)
  status EntityStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  companies    Company[]
  users        User[]              @relation("ClientUsers")
  integrations ClientIntegration[]

  // Subscription Plans
  subscriptionPlans    SubscriptionPlan[]
  subscriptionSettings SubscriptionSettings?

  // Integration Usage (for billing)
  integrationUsage IntegrationUsage[]

  // Email Templates
  emailTemplates EmailTemplate[]

  // Waitlist (link back from completed registration)
  waitlistEntry        Waitlist?

  // Custom Pricing Plans (for negotiated rates)
  customPricingPlans   PricingPlan[] @relation("CustomPlans")

  // Client Subscription (billing)
  subscription         ClientSubscription?

  // Feature 04: Shared Gateway Risk Management
  merchantRiskProfile  MerchantRiskProfile?
  gatewayTermsAcceptances GatewayTermsAcceptance[]

  // Soft delete fields
  deletedAt DateTime?
  deletedBy String?
  cascadeId String?

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([deletedAt])
  @@map("clients")
}

model Company {
  id       String  @id @default(cuid())
  clientId String
  name     String
  slug     String
  code     String? @unique // 4-char alphanumeric code (e.g., "BREW") - globally unique
  domain   String?
  logo     String?
  timezone String  @default("UTC")
  currency String  @default("USD")
  settings Json    @default("{}")

  // Payment configuration
  paymentConfig Json @default("{}")

  // Status
  status EntityStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  client           Client            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  departments      Department[]
  users            User[]            @relation("CompanyUsers")
  paymentProviders PaymentProvider[]
  subscriptions    Subscription[]
  transactions     Transaction[]
  customers        Customer[]
  products         Product[]
  orders           Order[]

  // Momentum Intelligence Relations
  customerIntents   CustomerIntent[]
  interventions     Intervention[]
  saveAttempts      SaveAttempt[]
  voiceCalls        VoiceCall[]
  generatedContents GeneratedContent[]
  upsellOffers      UpsellOffer[]
  saveFlowConfig    SaveFlowConfig?
  voiceScripts      VoiceScript[]
  momentumAnalytics MomentumAnalytics[]
  upsellConfig      UpsellConfig?

  // Feature 10: Enhanced Products
  categories         Category[]
  tags               Tag[]
  variantOptions     VariantOption[]
  collections        Collection[]
  bundles            Bundle[]
  inventoryLocations InventoryLocation[]
  marketingVideos    MarketingVideo[]
  videoTemplates     MarketingVideoTemplate[]

  // Feature 03: Vendor System
  vendorConnections VendorClientConnection[]

  // Customer Service Relations
  refunds        Refund[]
  refundSettings RefundSettings?
  customerTags   CustomerTag[]

  // Product Reviews
  productReviews     ProductReview[]
  productReviewStats ProductReviewStats[]
  reviewConfig       ReviewConfig?

  // Landing Pages
  landingPages         LandingPage[]
  landingPageSessions  LandingPageSession[]
  abTests              ABTest[]
  landingPopups        LandingPagePopup[]
  dynamicTextRules     DynamicTextRule[]
  conversionGoals      ConversionGoal[]

  // Subscription Plans
  subscriptionPlans    SubscriptionPlan[]
  subscriptionSettings SubscriptionSettings?

  // Fulfillment Providers
  fulfillmentProviders FulfillmentProvider[]

  // Hosted Payment Pages
  paymentPages PaymentPage[]

  // Funnel Builder
  funnels Funnel[]

  // Lead Management
  leads Lead[]

  // Card Vault (stored payment methods)
  cardVaults CardVault[]

  // Integration Usage (for billing)
  integrationUsage IntegrationUsage[]

  // AI Funnel Generator
  aiMethodologyTemplates AIMethodologyTemplate[]
  aiFunnelGenerations    AIFunnelGeneration[]

  // Email Templates
  emailTemplates EmailTemplate[]

  // CS AI Usage Tracking
  csAIUsage        CSAIUsage[]
  csAIUsageSummary CSAIUsageSummary[]

  // Product Import System
  productImportJobs    ProductImportJob[]
  productImages        ProductImage[]
  fieldMappingProfiles FieldMappingProfile[]

  // Shopify-Inspired: Sales Channels
  salesChannels SalesChannel[]

  // Soft delete fields
  deletedAt DateTime?
  deletedBy String?
  cascadeId String?

  // Sites (multiple storefronts per company)
  sites Site[]

  // Carts
  carts               Cart[]
  cartUpsellAnalytics CartUpsellAnalytics[]

  // Wishlists
  wishlists Wishlist[]

  // Product Comparisons
  productComparisons ProductComparison[]

  // Cross-Site Sessions
  crossSiteSessions CrossSiteSession[]

  // Cart Promotion & Pricing System
  promotions    Promotion[]
  taxRates      TaxRate[]
  shippingZones ShippingZone[]
  inventoryHolds InventoryHold[]

  // Smart Upsell & Recommendations
  productBulkDiscounts       ProductBulkDiscount[]
  productSubscriptionConfigs ProductSubscriptionConfig[]
  upsellTargetingRules       UpsellTargetingRule[]
  upsellExperiments          UpsellExperiment[]
  productViews               ProductView[]
  recommendationConfig       RecommendationConfig?
  recommendationImpressions  RecommendationImpression[]

  // Cart Recovery (MI)
  cartSaveConfig   CartSaveConfig?
  cartSaveAttempts CartSaveAttempt[]

  @@unique([clientId, slug])
  @@index([clientId])
  @@index([status])
  @@index([deletedAt])
  @@map("companies")
}

// Site model - multiple sites/storefronts per company
// Sites share company-level resources (customers, products, orders)
model Site {
  id        String @id @default(cuid())
  companyId String
  name      String
  slug      String
  code      String? @unique // 4-char alphanumeric code - globally unique

  // Site type
  type SiteType @default(STOREFRONT)

  // Site-specific configuration
  domain      String?  // Custom domain for this site
  subdomain   String?  // Subdomain if using platform domain
  logo        String?
  favicon     String?
  description String?

  // Branding
  primaryColor   String?
  secondaryColor String?
  accentColor    String?

  // SEO
  metaTitle       String?
  metaDescription String?
  ogImage         String?

  // Site settings
  settings Json @default("{}")

  // E-commerce features
  enableCart         Boolean @default(true)
  enableWishlist     Boolean @default(true)
  enableCompare      Boolean @default(false)
  enableQuickView    Boolean @default(true)
  enableBundleBuilder Boolean @default(false)
  maxCompareItems    Int     @default(4)
  cartExpirationDays Int     @default(30)
  checkoutMode       String  @default("standard")
  guestCheckout      Boolean @default(true)

  // Localization (can differ from company defaults)
  timezone String?
  currency String?
  locale   String? @default("en")

  // Status
  isDefault Boolean      @default(false) // Primary site for the company
  status    EntityStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Funnels can be associated with specific sites
  funnels Funnel[]

  // Landing pages can be site-specific
  landingPages LandingPage[]

  // Carts
  carts Cart[]

  // Wishlists
  wishlists Wishlist[]

  // Product Comparisons
  productComparisons ProductComparison[]

  // Soft delete fields
  deletedAt DateTime?
  deletedBy String?
  cascadeId String?

  @@unique([companyId, slug])
  @@index([companyId])
  @@index([domain])
  @@index([deletedAt])
  @@map("sites")
}

model Department {
  id          String  @id @default(cuid())
  companyId   String
  name        String
  slug        String
  description String?
  settings    Json    @default("{}")

  // Status
  status EntityStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  teams   Team[]
  users   User[]  @relation("DepartmentUsers")

  // Soft delete fields
  deletedAt DateTime?
  deletedBy String?
  cascadeId String?

  @@unique([companyId, slug])
  @@index([companyId])
  @@index([deletedAt])
  @@map("departments")
}

model Team {
  id           String  @id @default(cuid())
  departmentId String
  name         String
  slug         String
  description  String?
  settings     Json    @default("{}")

  // Team lead
  teamLeadId String?

  // Status
  status EntityStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  department Department   @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  teamLead   User?        @relation("TeamLead", fields: [teamLeadId], references: [id])
  members    TeamMember[]

  @@unique([departmentId, slug])
  @@index([departmentId])
  @@index([teamLeadId])
  @@map("teams")
}

// =============================================================================
// USER & ACCESS CONTROL
// =============================================================================

model User {
  id           String  @id @default(cuid())
  email        String  @unique
  passwordHash String?
  firstName    String?
  lastName     String?
  avatar       String?
  phone        String?

  // Auth
  auth0Id       String?   @unique
  emailVerified Boolean   @default(false)
  lastLoginAt   DateTime?

  // Primary scope (where user was created)
  scopeType ScopeType
  scopeId   String

  // Global role
  role UserRole @default(USER)

  // Status
  status UserStatus @default(ACTIVE)

  // User Preferences (theme, sidebar, etc.)
  preferences Json @default("{\"theme\": \"system\", \"sidebarCollapsed\": false}")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Direct relations to hierarchy levels
  organization   Organization? @relation("OrganizationUsers", fields: [organizationId], references: [id])
  organizationId String?

  client   Client? @relation("ClientUsers", fields: [clientId], references: [id])
  clientId String?

  company   Company? @relation("CompanyUsers", fields: [companyId], references: [id])
  companyId String?

  department   Department? @relation("DepartmentUsers", fields: [departmentId], references: [id])
  departmentId String?

  // Team memberships (many-to-many)
  teamMemberships TeamMember[]
  teamsLed        Team[]       @relation("TeamLead")

  // Activity
  auditLogs    AuditLog[]
  deletionLogs DeletionLog[] @relation("UserDeletions")

  // Feature 10: Enhanced Products
  inventoryAdjustments InventoryAdjustment[]
  marketingVideos      MarketingVideo[]

  // Soft delete tracking
  deletedCategories      Category[]                    @relation("CategoryDeletedBy")
  deletedMetafields      CategoryMetafieldDefinition[] @relation("MetafieldDeletedBy")
  deletedSalesChannels   SalesChannel[]                @relation("SalesChannelDeletedBy")

  // Feature 02: RBAC Relations
  roleAssignments  UserRoleAssignment[]
  permissionGrants PermissionGrant[]
  sessions         UserSession[]

  // Customer Service Relations
  customerNotes    CustomerNote[]
  refundsRequested Refund[]       @relation("RefundRequester")
  refundsApproved  Refund[]       @relation("RefundApprover")
  refundsRejected  Refund[]       @relation("RefundRejecter")

  // Password Reset Tokens
  passwordResetTokens PasswordResetToken[]

  // Soft delete fields
  deletedAt DateTime?
  deletedBy String?
  cascadeId String?

  @@index([deletedAt])
  @@map("users")
}

// Password Reset Token - SOC2 CC6.1, ISO A.9.4.3 compliant
// Secure password reset with time-limited tokens
model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique // Hashed token (SHA-256)
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  // IP and user agent for audit
  ipAddress String?
  userAgent String?

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model TeamMember {
  id     String   @id @default(cuid())
  teamId String
  userId String
  role   TeamRole @default(MEMBER)

  // Timestamps
  joinedAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
  @@map("team_members")
}

// =============================================================================
// CUSTOMER & ADDRESS MODELS
// =============================================================================

model Customer {
  id        String @id @default(cuid())
  companyId String

  // Customer info
  email     String
  firstName String?
  lastName  String?
  phone     String?

  // Metadata
  metadata Json @default("{}")

  // Status
  status CustomerStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company         Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  addresses       Address[]
  billingAccounts BillingAccount[]
  paymentVaults   PaymentVault[]
  subscriptions   Subscription[]
  giftPurchases   Subscription[]   @relation("GiftPurchases")
  transactions    Transaction[]
  orders          Order[]

  // Momentum Intelligence Relations
  customerIntents CustomerIntent[]
  interventions   Intervention[]
  saveAttempts    SaveAttempt[]
  voiceCalls      VoiceCall[]
  upsellOffers    UpsellOffer[]

  // Feature 10C: Marketing Videos
  marketingVideos MarketingVideo[]

  // Customer Service Relations
  notes   CustomerNote[]
  refunds Refund[]

  // Product Reviews
  productReviews ProductReview[]
  reviewVotes    ReviewVote[]

  // Payment Pages
  paymentPageSessions PaymentPageSession[]

  // Lead (source lead that converted to this customer)
  sourceLead Lead?

  // Card Vault (stored payment methods)
  cardVaults CardVault[]

  // Carts
  carts Cart[]

  // Wishlists
  wishlists Wishlist[]

  // Product Comparisons
  productComparisons ProductComparison[]

  // Cross-Site Sessions
  crossSiteSessions CrossSiteSession[]

  // Smart Upsell & Recommendations
  upsellImpressions         UpsellImpression[]
  productViews              ProductView[]
  recommendationImpressions RecommendationImpression[]
  cartUpsellAnalytics       CartUpsellAnalytics[]

  // Cart Recovery (MI)
  cartSaveAttempts CartSaveAttempt[]

  // Soft delete fields
  deletedAt DateTime?
  deletedBy String?
  cascadeId String?

  @@unique([companyId, email, deletedAt])
  @@index([companyId, email])
  @@index([deletedAt])
  @@map("customers")
}

model Address {
  id         String @id @default(cuid())
  customerId String

  // Address type
  type      AddressType @default(BOTH)
  label     String? // "Home", "Office", "Warehouse"
  isDefault Boolean     @default(false)

  // Contact
  firstName String
  lastName  String
  company   String?
  phone     String?

  // Address fields
  street1    String
  street2    String?
  city       String
  state      String
  postalCode String
  country    String  @default("US")

  // Delivery
  deliveryInstructions String?

  // Validation
  isValidated        Boolean   @default(false)
  validatedAt        DateTime?
  validationResponse Json?

  // Status
  status EntityStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Soft delete fields (CustomerAddress)
  deletedAt DateTime?
  deletedBy String?
  cascadeId String?

  @@index([customerId, type])
  @@index([deletedAt])
  @@map("addresses")
}

// =============================================================================
// PAYMENT VAULT & BILLING (PCI-DSS COMPLIANT)
// =============================================================================

model PaymentVault {
  id         String @id @default(cuid())
  customerId String

  // Payment method type
  type PaymentMethodType

  // Gateway reference (never store raw card data)
  gatewayCustomerId String? // Customer ID at payment gateway
  gatewayPaymentId  String? // Payment method ID at gateway

  // ===========================================
  // ENCRYPTED SENSITIVE DATA (AES-256-GCM)
  // ===========================================
  // All sensitive data stored in encrypted JSON blob
  // Contains: full card number, CVV token, full account numbers,
  // check routing/account, check images, etc.
  encryptedData  String  // Encrypted JSON with sensitive payment details
  keyVersion     Int     @default(1) // For key rotation
  encryptionAlgo String  @default("AES-256-GCM") // Encryption algorithm used

  // For CHECK payments, encryptedData contains:
  // - routingNumber: Full 9-digit ABA routing number
  // - accountNumber: Full bank account number
  // - checkNumber: Check number
  // - checkImageFront: Base64 or S3 reference to front image
  // - checkImageBack: Base64 or S3 reference to back image
  // - micrLine: Full MICR line data

  // ===========================================
  // DISPLAY DATA ONLY (Safe to store unencrypted)
  // ===========================================
  last4       String  // Last 4 digits of card/account
  bin         String? // First 6 digits (BIN) - identifies issuer, not cardholder
  brand       String? // VISA, MASTERCARD, AMEX, etc. (for cards)
  expMonth    Int?    // Card expiry month
  expYear     Int?    // Card expiry year
  bankName    String? // Bank name (for ACH/CHECK)
  accountType String? // checking, savings
  funding     String? // credit, debit, prepaid (for cards)

  // Check-specific display fields (non-sensitive)
  checkNumberLast4 String? // Last 4 of check number
  routingLast4     String? // Last 4 of routing number

  // Fingerprint for duplicate detection
  fingerprint String?

  // Billing address (reference for AVS)
  billingAddressSnapshot Json?

  // Status
  isDefault Boolean @default(false)
  isActive  Boolean @default(true)

  // Compliance
  consentRecordedAt DateTime?
  consentIp         String?

  // Usage tracking
  lastUsedAt DateTime?
  usageCount Int       @default(0)

  // Expiration
  expiresAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  customer        Customer         @relation(fields: [customerId], references: [id], onDelete: Cascade)
  billingAccounts BillingAccount[]
  transactions    Transaction[]
  subscriptions   Subscription[]

  @@index([customerId, isActive])
  @@index([fingerprint])
  @@map("payment_vaults")
}

model BillingAccount {
  id         String @id @default(cuid())
  customerId String

  // Display name
  name String? // "Primary Card", "Business Account"

  // Default payment method
  paymentVaultId String?

  // Billing address (current, updatable)
  billingAddress Json

  // Auto-pay settings
  autoPayEnabled Boolean @default(true)
  autoPayDay     Int? // Day of month for auto-pay

  // Status
  isDefault Boolean      @default(false)
  status    EntityStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  customer     Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  paymentVault PaymentVault? @relation(fields: [paymentVaultId], references: [id])
  orders       Order[]

  @@index([customerId])
  @@map("billing_accounts")
}

// =============================================================================
// PRODUCT CATALOG (COFFEE)
// =============================================================================

model Product {
  id        String @id @default(cuid())
  companyId String

  // Product identification
  sku         String
  name        String
  slug        String
  description String?

  // Category (use dynamic categories via categoryAssignments)
  // Legacy field - will be removed after migration
  // Products should use the Category model via ProductCategoryAssignment

  // Sizing
  weight     Decimal? @db.Decimal(10, 2)
  weightUnit String   @default("oz") // oz, g, lb, kg

  // Pricing
  price          Decimal  @db.Decimal(10, 2)
  compareAtPrice Decimal? @db.Decimal(10, 2)
  costPrice      Decimal? @db.Decimal(10, 2) // For margin tracking
  currency       String   @default("USD")

  // Subscription settings
  isSubscribable       Boolean  @default(true)
  subscriptionDiscount Decimal? @db.Decimal(5, 2) // Percentage

  // Fulfillment type (for subscription billing awareness)
  fulfillmentType           ProductFulfillmentType @default(PHYSICAL)
  electronicDeliveryMethod  ElectronicDeliveryMethod?
  electronicDeliveryUrl     String?  // Download URL, access link, etc.
  electronicDeliveryDays    Int?     // Days until access expires (null = forever)

  // Inventory
  trackInventory    Boolean @default(true)
  stockQuantity     Int     @default(0)
  lowStockThreshold Int     @default(10)

  // Status
  status    ProductStatus @default(ACTIVE)
  isVisible Boolean       @default(true)

  // SEO/Display
  images          Json    @default("[]") // Array of image URLs
  metaTitle       String?
  metaDescription String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // AI Generated Content
  aiGeneratedDescription Boolean   @default(false)
  aiGeneratedAt          DateTime?

  // Import tracking
  importSource      String?   // IntegrationProvider value (ROASTIFY, SHOPIFY, etc.)
  externalId        String?   // ID from external system
  externalSku       String?   // Original SKU if renamed during import
  lastSyncedAt      DateTime? // Last inventory sync

  // Flexible Attributes (JSON)
  attributes Json? // Custom key-value attributes

  // Relations
  company    Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Product Import System
  productImages ProductImage[]
  orderItems OrderItem[]

  // Feature 10: Categories, Tags, Media
  categoryAssignments ProductCategoryAssignment[]
  tags                ProductTag[]
  media               ProductMedia[]
  priceRules          ProductPriceRule[]

  // Feature 10B: Variants, Collections, Bundles, Inventory
  variants        ProductVariant[]
  collectionItems CollectionProduct[]
  bundle          Bundle?
  bundleItems     BundleItem[]
  inventoryLevels InventoryLevel[]

  // Feature 10C: Marketing Videos
  marketingVideos MarketingVideo[]

  // Feature 03: Vendor System
  vendorProductSyncs VendorProductSync[]

  // Product Reviews
  reviews     ProductReview[]
  reviewStats ProductReviewStats?

  // Subscription Plans
  subscriptionPlans ProductSubscriptionPlan[]
  subscriptionItems SubscriptionItem[]

  // Fulfillment Providers
  fulfillmentAssignments ProductFulfillmentAssignment[]

  // Shopify-Inspired: Metafields and Sales Channels
  metafieldValues ProductMetafieldValue[]
  salesChannels   ProductSalesChannel[]

  // Cart items
  cartItems           CartItem[]
  savedCartItems      SavedCartItem[]
  cartUpsellAnalytics CartUpsellAnalytics[]

  // Wishlist items
  wishlistItems WishlistItem[]

  // Product Comparison items
  comparisonItems ProductComparisonItem[]

  // Smart Upsell & Recommendations
  bulkDiscount              ProductBulkDiscount?
  subscriptionConfig        ProductSubscriptionConfig?
  productViews              ProductView[]
  recommendationImpressions RecommendationImpression[]

  // Landing Page Catalog
  landingPageProducts LandingPageProduct[]

  // Inventory Holds
  inventoryHolds InventoryHold[]

  // Soft delete fields
  deletedAt DateTime?
  deletedBy String?
  cascadeId String?

  @@unique([companyId, sku, deletedAt])
  @@unique([companyId, slug, deletedAt])
  @@unique([companyId, externalId, importSource])
  @@index([companyId, status])
  @@index([companyId, status, trackInventory])
  @@index([companyId, importSource])
  @@index([deletedAt])
  @@map("products")
}

// =============================================================================
// CART SYSTEM
// =============================================================================

model Cart {
  id            String     @id @default(cuid())
  companyId     String
  siteId        String?
  customerId    String?
  sessionToken  String?    @unique
  visitorId     String?

  status        CartStatus @default(ACTIVE)
  currency      String     @default("USD")

  subtotal      Decimal    @default(0) @db.Decimal(12, 2)
  discountTotal Decimal    @default(0) @db.Decimal(12, 2)
  taxTotal      Decimal    @default(0) @db.Decimal(12, 2)
  shippingTotal Decimal    @default(0) @db.Decimal(12, 2)
  grandTotal    Decimal    @default(0) @db.Decimal(12, 2)
  itemCount     Int        @default(0)

  discountCodes Json       @default("[]")

  shippingPostalCode String?
  shippingCountry    String?

  notes         String?
  metadata      Json       @default("{}")

  utmSource     String?
  utmMedium     String?
  utmCampaign   String?

  recoveryEmailSent   Boolean   @default(false)
  recoveryEmailSentAt DateTime?
  recoveryClicks      Int       @default(0)

  mergedIntoCartId String?
  mergedAt         DateTime?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  lastActivityAt DateTime @default(now())
  expiresAt      DateTime?
  convertedAt    DateTime?
  abandonedAt    DateTime?

  orderId        String?  @unique

  // Landing Page Integration (attribution tracking)
  landingPageId  String?
  sourceType     CartSourceType @default(DIRECT)

  company   Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  site      Site?     @relation(fields: [siteId], references: [id], onDelete: SetNull)
  customer  Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  landingPage LandingPage? @relation(fields: [landingPageId], references: [id], onDelete: SetNull)
  items              CartItem[]
  savedItems         SavedCartItem[]
  inventoryHolds     InventoryHold[]
  cartUpsellAnalytics CartUpsellAnalytics[]
  landingPageSession LandingPageSession?
  funnelSessions     FunnelSession[]

  // Smart Upsell
  upsellImpressions UpsellImpression[]

  // Cart Recovery (MI)
  saveAttempts     CartSaveAttempt[]
  interventions    CartIntervention[]

  @@index([companyId, status])
  @@index([companyId, customerId])
  @@index([sessionToken])
  @@index([visitorId])
  @@index([status, expiresAt])
  @@index([companyId, siteId, status])
  @@index([landingPageId])
  @@index([sourceType, companyId, status])
  @@index([companyId, status, lastActivityAt]) // DBA optimization for abandoned cart queries
  @@map("carts")
}

model CartItem {
  id          String @id @default(cuid())
  cartId      String

  productId   String
  variantId   String?

  productSnapshot Json

  quantity       Int     @default(1)
  unitPrice      Decimal @db.Decimal(10, 2)
  originalPrice  Decimal @db.Decimal(10, 2)
  discountAmount Decimal @default(0) @db.Decimal(10, 2)
  lineTotal      Decimal @db.Decimal(10, 2)

  customFields   Json    @default("{}")
  giftMessage    String?
  isGift         Boolean @default(false)

  addedAt   DateTime @default(now())
  updatedAt DateTime @updatedAt

  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([cartId])
  @@index([productId])
  @@map("cart_items")
}

model SavedCartItem {
  id        String @id @default(cuid())
  cartId    String

  productId String
  variantId String?

  quantity    Int     @default(1)
  priceAtSave Decimal @db.Decimal(10, 2)

  savedAt   DateTime @default(now())

  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@unique([cartId, productId, variantId])
  @@index([cartId])
  @@map("saved_cart_items")
}

// Cart Upsell Analytics - tracks impressions and conversions from algorithm-based cart upsells
model CartUpsellAnalytics {
  id        String @id @default(cuid())
  companyId String
  cartId    String
  productId String // The upsell product shown

  sessionToken  String?
  customerId    String?

  // Upsell metadata
  reason        String   // UpsellReason enum value (FREQUENTLY_BOUGHT_TOGETHER, SIMILAR_CATEGORY, etc.)
  score         Decimal  @db.Decimal(5, 4) // Confidence score 0.0-1.0
  position      Int      @default(0) // Position in the suggestions list (0-indexed)
  placement     String   @default("cart_page") // Where shown (cart_page, checkout, mini_cart)

  // Tracking timestamps
  impressedAt   DateTime  @default(now())
  viewedAt      DateTime? // Visible for 1+ second (viewport tracking)
  clickedAt     DateTime? // User clicked to view product details
  addedAt       DateTime? // User added to cart (conversion)
  declinedAt    DateTime? // User explicitly dismissed

  // Revenue tracking (populated on conversion)
  productPrice  Decimal?  @db.Decimal(10, 2) // Price at time of impression
  quantity      Int       @default(1) // Quantity added if converted
  revenue       Decimal?  @db.Decimal(10, 2) // Total revenue if converted

  // Relations
  company   Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  cart      Cart      @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  customer  Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  @@index([companyId, impressedAt])
  @@index([cartId])
  @@index([productId, impressedAt])
  @@index([reason, impressedAt])
  @@index([customerId, impressedAt])
  @@map("cart_upsell_analytics")
}

model InventoryHold {
  id        String @id @default(cuid())
  companyId String
  cartId    String
  orderId   String?

  productId String
  /// Empty string is used as sentinel for "no variant" to ensure unique constraint
  /// works correctly. In PostgreSQL, NULL values are treated as distinct in unique
  /// constraints, which would allow duplicate holds for the same cart+product.
  /// Using "" as sentinel ensures exactly one hold per cart+product+variant.
  variantId String @default("")

  quantity  Int
  status    InventoryHoldStatus @default(ACTIVE)

  expiresAt   DateTime
  releasedAt  DateTime?
  convertedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([cartId, productId, variantId])
  @@index([companyId, status])
  @@index([status, expiresAt])
  @@index([productId, variantId, status])
  @@map("inventory_holds")
}

// =============================================================================
// CART PROMOTION & PRICING SYSTEM
// =============================================================================

model Promotion {
  id        String @id @default(cuid())
  companyId String

  // Promotion Code
  code        String
  name        String
  description String?

  // Promotion Type and Scope
  type  PromotionType
  scope PromotionScope

  // Value Configuration
  value              Decimal  @db.Decimal(10, 2) // Amount or percentage
  minimumOrderAmount Decimal? @db.Decimal(10, 2) // Minimum cart total required
  maximumDiscount    Decimal? @db.Decimal(10, 2) // Cap on discount amount

  // Buy X Get Y Configuration (when type = BUY_X_GET_Y)
  buyQuantity  Int? // Buy this many
  getQuantity  Int? // Get this many free/discounted
  getProductId String? // Specific product to get (optional)

  // Usage Limits
  maxUsesTotal       Int? // Total uses across all customers
  maxUsesPerCustomer Int? // Uses per customer
  currentUses        Int  @default(0)

  // Validity Period
  startsAt  DateTime
  expiresAt DateTime?

  // Targeting (JSON for flexibility)
  // e.g., {"productIds": [], "categoryIds": [], "customerTags": [], "excludeProductIds": []}
  targeting Json @default("{}")

  // Status
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company      Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  usageRecords PromotionUsage[]

  @@unique([companyId, code])
  @@index([companyId, isActive])
  @@index([code])
  @@index([startsAt, expiresAt])
  @@map("promotions")
}

model PromotionUsage {
  id          String @id @default(cuid())
  promotionId String
  cartId      String?
  orderId     String?
  customerId  String?

  // Discount applied
  discountAmount Decimal @db.Decimal(10, 2)

  // Timestamps
  appliedAt DateTime @default(now())

  // Relations
  promotion Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)

  @@index([promotionId])
  @@index([customerId])
  @@index([orderId])
  @@map("promotion_usages")
}

model TaxRate {
  id        String @id @default(cuid())
  companyId String

  // Geographic Scope
  country String  // ISO 3166-1 alpha-2 (e.g., "US", "CA", "GB")
  state   String? // State/Province code (e.g., "CA", "NY", "ON")
  city    String? // Optional city-level tax
  zipCode String? // Optional zip code pattern (e.g., "90210", "902*")

  // Tax Configuration
  taxType TaxType
  name    String  // Display name (e.g., "California Sales Tax")
  rate    Decimal @db.Decimal(6, 4) // Rate as decimal (e.g., 0.0725 for 7.25%)

  // Compound tax (applied on top of other taxes)
  isCompound Boolean @default(false)
  priority   Int     @default(0) // Order of application for compound taxes

  // Product Category Exemptions (JSON array of category IDs)
  exemptCategories Json @default("[]")

  // Status
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, isActive])
  @@index([country, state])
  @@index([country, state, city])
  @@map("tax_rates")
}

model ShippingZone {
  id        String @id @default(cuid())
  companyId String

  // Zone Identification
  name        String
  description String?

  // Geographic Coverage (JSON arrays for flexibility)
  countries String[] // ISO 3166-1 alpha-2 codes
  states    String[] // State/Province codes (with country prefix, e.g., "US-CA")
  zipCodes  String[] // Zip code patterns (supports wildcards, e.g., "902*")

  // Priority (higher = more specific, checked first)
  priority Int @default(0)

  // Status
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  rules   ShippingRule[]

  @@index([companyId, isActive])
  @@index([priority])
  @@map("shipping_zones")
}

model ShippingRule {
  id             String @id @default(cuid())
  shippingZoneId String

  // Rule Identification
  name        String // e.g., "Standard Shipping", "Express", "Free Shipping"
  description String?
  carrier     String? // e.g., "USPS", "UPS", "FedEx"
  serviceCode String? // Carrier service code

  // Rule Type
  type ShippingRuleType

  // Pricing Configuration (based on type)
  baseRate          Decimal  @db.Decimal(10, 2) // Base shipping cost
  perItemRate       Decimal? @db.Decimal(10, 2) // Additional per item
  perWeightUnitRate Decimal? @db.Decimal(10, 2) // Per lb/kg
  weightUnit        String   @default("lb") // "lb" or "kg"

  // Free Shipping Threshold
  freeShippingThreshold Decimal? @db.Decimal(10, 2)

  // Weight/Size Limits
  minWeight   Decimal? @db.Decimal(10, 2)
  maxWeight   Decimal? @db.Decimal(10, 2)
  minOrderTotal Decimal? @db.Decimal(10, 2)
  maxOrderTotal Decimal? @db.Decimal(10, 2)

  // Delivery Time
  estimatedDaysMin Int?
  estimatedDaysMax Int?

  // Display Order
  sortOrder Int @default(0)

  // Status
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  zone ShippingZone @relation(fields: [shippingZoneId], references: [id], onDelete: Cascade)

  @@index([shippingZoneId, isActive])
  @@index([sortOrder])
  @@map("shipping_rules")
}

// Cart-Promotion Application (tracks which promotions are applied to a cart)
model CartPromotion {
  id        String @id @default(cuid())
  cartId    String
  promotionId String

  // Applied discount
  discountAmount Decimal @db.Decimal(10, 2)

  // Timestamps
  appliedAt DateTime @default(now())

  @@unique([cartId, promotionId])
  @@index([cartId])
  @@index([promotionId])
  @@map("cart_promotions")
}

// =============================================================================
// WISHLIST SYSTEM
// =============================================================================

model Wishlist {
  id        String  @id @default(cuid())
  companyId String
  siteId    String?

  // Owner - either customer or session
  customerId   String?
  sessionToken String? @unique

  // Wishlist metadata
  name     String  @default("My Wishlist")
  isPublic Boolean @default(false)

  // Shareable URL slug (generated when isPublic = true)
  sharedUrl String? @unique

  // Counts
  itemCount Int @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company  Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  site     Site?         @relation(fields: [siteId], references: [id], onDelete: SetNull)
  customer Customer?     @relation(fields: [customerId], references: [id], onDelete: SetNull)
  items    WishlistItem[]

  @@index([companyId])
  @@index([customerId])
  @@index([siteId])
  @@index([sharedUrl])
  @@map("wishlists")
}

model WishlistItem {
  id         String @id @default(cuid())
  wishlistId String

  // Product reference
  productId String
  variantId String?

  // Snapshot at time of addition
  productSnapshot Json

  // Priority for ordering (lower = higher priority)
  priority Int @default(100)

  // Personal notes
  notes String?

  // Timestamps
  addedAt   DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  wishlist Wishlist @relation(fields: [wishlistId], references: [id], onDelete: Cascade)
  product  Product  @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@unique([wishlistId, productId, variantId])
  @@index([wishlistId])
  @@index([productId])
  @@map("wishlist_items")
}

// =============================================================================
// ORDER SYSTEM (IMMUTABLE HISTORICAL RECORDS)
// =============================================================================

model Order {
  id               String  @id @default(cuid())
  companyId        String
  customerId       String
  subscriptionId   String?
  billingAccountId String?

  // Order identification
  orderNumber String  @unique
  externalId  String? // External system reference

  // Order type
  type OrderType @default(ONE_TIME)

  // Status
  status OrderStatus @default(PENDING)

  // ===========================================
  // ADDRESS SNAPSHOTS (Immutable after lock)
  // ===========================================

  // Shipping address - copied at order, editable until locked
  shippingSnapshot  Json
  shippingAddressId String? // Reference to original address

  // Billing address - copied at order, editable until locked
  billingSnapshot  Json
  billingAddressId String? // Reference to original address

  // Address lock mechanism
  addressLockedAt DateTime? // null = editable, set = frozen
  addressLockedBy String? // "system", "fulfillment", userId

  // ===========================================
  // ORDER TOTALS
  // ===========================================

  subtotal       Decimal @db.Decimal(10, 2)
  discountAmount Decimal @default(0) @db.Decimal(10, 2)
  discountCode   String?
  shippingAmount Decimal @default(0) @db.Decimal(10, 2)
  taxAmount      Decimal @default(0) @db.Decimal(10, 2)
  total          Decimal @db.Decimal(10, 2)
  currency       String  @default("USD")

  // ===========================================
  // PAYMENT
  // ===========================================

  paymentStatus   PaymentStatus @default(PENDING)
  paidAt          DateTime?
  paymentMethod   String? // Display: "VISA ending 4242" or "Check #1234"
  paymentVaultId  String? // Reference to PaymentVault for sensitive data

  // Display-only payment snapshot (NO SENSITIVE DATA)
  // All sensitive info (full numbers, images) stored in PaymentVault
  paymentSnapshot Json?   // { type, brand, last4, bin, expMonth, expYear, funding, bankName, checkNumberLast4 }

  // ===========================================
  // FULFILLMENT TRACKING
  // ===========================================

  fulfillmentStatus FulfillmentStatus @default(UNFULFILLED)
  fulfilledAt       DateTime?

  // Customer notes
  customerNotes String?
  internalNotes String?

  // Metadata
  metadata Json @default("{}")

  // Environment (sandbox vs production)
  environment String @default("production") // "sandbox" or "production"

  // Continuity tracking
  continuitySessionId String?
  frictionLevel       String?
  momentumScore       Int?

  // ===========================================
  // TIMESTAMPS
  // ===========================================

  orderedAt    DateTime  @default(now()) // When customer placed order
  confirmedAt  DateTime? // When payment confirmed
  canceledAt   DateTime?
  cancelReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company        Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer       Customer        @relation(fields: [customerId], references: [id])
  subscription   Subscription?   @relation(fields: [subscriptionId], references: [id])
  billingAccount BillingAccount? @relation(fields: [billingAccountId], references: [id])
  items          OrderItem[]
  shipments      Shipment[]
  transactions   Transaction[]

  // Feature 03: Vendor System
  vendorOrders VendorOrder[]

  // Refunds
  refunds Refund[]

  // Product Reviews (for verified purchase tracking)
  productReviews ProductReview[]

  // Soft delete fields
  deletedAt DateTime?
  deletedBy String?
  cascadeId String?

  @@index([companyId, orderedAt])
  @@index([companyId, status, fulfillmentStatus])
  @@index([customerId])
  @@index([status])
  @@index([orderNumber])
  @@index([deletedAt])
  @@map("orders")
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  productId String? // Nullable for deleted products

  // ===========================================
  // PRODUCT SNAPSHOT (Immutable)
  // Captures product state at time of order
  // ===========================================

  sku         String
  name        String
  description String?

  // Product attributes snapshot
  productSnapshot Json // Full product data at order time

  // Quantity & Pricing
  quantity       Int
  unitPrice      Decimal @db.Decimal(10, 2)
  discountAmount Decimal @default(0) @db.Decimal(10, 2)
  taxAmount      Decimal @default(0) @db.Decimal(10, 2)
  totalPrice     Decimal @db.Decimal(10, 2)

  // Fulfillment
  fulfilledQuantity Int               @default(0)
  fulfillmentStatus FulfillmentStatus @default(UNFULFILLED)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  order   Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

// =============================================================================
// SHIPPING & FULFILLMENT
// =============================================================================

model Shipment {
  id      String @id @default(cuid())
  orderId String

  // Fulfillment Provider (for subscription billing awareness)
  fulfillmentProviderId String?

  // Shipment identification
  shipmentNumber String @unique

  // Carrier & Tracking
  carrier        ShippingCarrier
  carrierService String? // "Priority Mail", "Ground", "2-Day"
  trackingNumber String?
  trackingUrl    String?

  // Shipping method used
  shippingMethod ShippingMethod @default(GROUND)

  // Package details
  weight        Decimal? @db.Decimal(10, 2)
  weightUnit    String   @default("oz")
  length        Decimal? @db.Decimal(10, 2)
  width         Decimal? @db.Decimal(10, 2)
  height        Decimal? @db.Decimal(10, 2)
  dimensionUnit String   @default("in")

  // Cost
  shippingCost    Decimal? @db.Decimal(10, 2)
  insuranceAmount Decimal? @db.Decimal(10, 2)

  // Labels
  shippingLabelUrl String?
  returnLabelUrl   String?

  // Address snapshot (from order at time of shipment)
  shippingAddressSnapshot Json

  // Status
  status ShipmentStatus @default(PENDING)

  // Estimated dates
  estimatedShipDate     DateTime?
  estimatedDeliveryDate DateTime?

  // Actual dates
  shippedAt   DateTime?
  deliveredAt DateTime?

  // Signature
  signatureRequired Boolean @default(false)
  signedBy          String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  order               Order                @relation(fields: [orderId], references: [id], onDelete: Cascade)
  events              ShipmentEvent[]
  fulfillmentProvider FulfillmentProvider? @relation(fields: [fulfillmentProviderId], references: [id])

  @@index([orderId])
  @@index([trackingNumber])
  @@index([fulfillmentProviderId])
  @@map("shipments")
}

model ShipmentEvent {
  id         String @id @default(cuid())
  shipmentId String

  // Event details
  status      ShipmentEventType
  description String
  location    String?

  // Raw carrier data
  carrierCode    String?
  carrierMessage String?
  carrierData    Json?

  // When it happened
  occurredAt DateTime

  // Timestamps
  createdAt DateTime @default(now())

  // Relations
  shipment Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  @@index([shipmentId, occurredAt])
  @@map("shipment_events")
}

// =============================================================================
// PAYMENT PROVIDER & TRANSACTIONS
// =============================================================================

model PaymentProvider {
  id        String              @id @default(cuid())
  companyId String
  name      String
  type      PaymentProviderType

  // Credentials (encrypted at application level)
  encryptedCredentials String
  keyVersion           Int    @default(1)

  // Configuration
  isDefault   Boolean @default(false)
  isActive    Boolean @default(true)
  priority    Int     @default(0)
  environment String  @default("sandbox") // sandbox, production

  // Supported features
  supportsRefunds   Boolean @default(true)
  supportsVoid      Boolean @default(true)
  supportsRecurring Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company       Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  transactions  Transaction[]
  subscriptions Subscription[]

  @@map("payment_providers")
}

model Subscription {
  id         String @id @default(cuid())
  companyId  String
  customerId String

  // ─────────────────────────────────────────────────────────────────────────────
  // PLAN REFERENCE
  // ─────────────────────────────────────────────────────────────────────────────
  subscriptionPlanId String? // Links to SubscriptionPlan template

  // Plan details (snapshot at subscription creation)
  planName   String
  planAmount Decimal         @db.Decimal(10, 2)
  currency   String          @default("USD")
  interval   BillingInterval

  // ─────────────────────────────────────────────────────────────────────────────
  // BILLING CYCLE
  // ─────────────────────────────────────────────────────────────────────────────
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  nextBillingDate    DateTime?
  cycleCount         Int      @default(0) // How many billing cycles completed

  // ─────────────────────────────────────────────────────────────────────────────
  // TRIAL SYSTEM (Phase 3)
  // ─────────────────────────────────────────────────────────────────────────────
  trialStart DateTime?
  trialEnd   DateTime?
  trialStatus TrialStatus @default(NONE)

  // Trial start trigger tracking
  trialStartTrigger       TrialStartTrigger?
  trialStartedByShipment  String?   // shipmentId that triggered trial start
  trialStartedByDelivery  String?   // shipmentId that triggered on delivery
  trialFallbackUsed       Boolean   @default(false) // True if started via fallback days

  // Trial conversion tracking
  trialConversionTrigger   TrialStartTrigger?
  trialConvertedAt         DateTime?
  trialConvertedByShipment String?
  trialConvertedByDelivery String?

  // Trial return handling
  trialReturnReceived    Boolean   @default(false)
  trialReturnAt          DateTime?
  trialReturnAction      TrialReturnAction?
  trialExtensionDays     Int?      // Additional days granted due to return

  // ─────────────────────────────────────────────────────────────────────────────
  // SHIPPING-AWARE BILLING (Phase 3/12)
  // ─────────────────────────────────────────────────────────────────────────────
  shippingAddressId       String?
  shippingPreferences     Json    @default("{}")
  lastShipmentId          String? // Most recent shipment
  lastShipmentStatus      String? // Track delivery status
  lastDeliveryAt          DateTime?
  awaitingDeliveryForBilling Boolean @default(false) // True if waiting for delivery to proceed

  // ─────────────────────────────────────────────────────────────────────────────
  // PAYMENT (Phase 4)
  // ─────────────────────────────────────────────────────────────────────────────
  paymentVaultId    String?
  paymentProviderId String?
  paymentFailed     Boolean   @default(false)
  paymentFailedAt   DateTime?
  paymentFailCount  Int       @default(0)
  paymentLastError  String?

  // ─────────────────────────────────────────────────────────────────────────────
  // STATUS & LIFECYCLE (Phase 5)
  // ─────────────────────────────────────────────────────────────────────────────
  status       SubscriptionStatus @default(ACTIVE)
  canceledAt   DateTime?
  cancelReason String?
  cancelSource String?  // 'customer', 'admin', 'system', 'ai_churn'

  // Pause functionality
  pausedAt       DateTime?
  pauseResumeAt  DateTime?
  pauseReason    String?
  pauseCount     Int      @default(0)

  // Skip functionality
  skipNextBilling  Boolean   @default(false)
  skipCount        Int       @default(0)
  lastSkipAt       DateTime?

  // ─────────────────────────────────────────────────────────────────────────────
  // LOYALTY & PRICING (Phase 6)
  // ─────────────────────────────────────────────────────────────────────────────
  loyaltyTier        Int?      // Current loyalty tier index
  loyaltyDiscountPct Decimal?  @db.Decimal(5, 2) // Current loyalty discount
  loyaltyLockedAt    DateTime? // When loyalty rate was locked

  // Price lock
  priceLocked        Boolean   @default(false)
  priceLockedAmount  Decimal?  @db.Decimal(10, 2)
  priceLockedUntil   DateTime?
  priceLockCycles    Int?

  // ─────────────────────────────────────────────────────────────────────────────
  // QUANTITY (Phase 6)
  // ─────────────────────────────────────────────────────────────────────────────
  quantity           Int      @default(1)
  quantityPending    Int?     // Pending quantity change for next cycle

  // ─────────────────────────────────────────────────────────────────────────────
  // GIFTING (Phase 8)
  // ─────────────────────────────────────────────────────────────────────────────
  isGift              Boolean   @default(false)
  giftPurchaserId     String?   // Customer who purchased the gift
  giftRecipientEmail  String?
  giftMessage         String?
  giftDurationType    GiftDurationType?
  giftCyclesRemaining Int?

  // ─────────────────────────────────────────────────────────────────────────────
  // MULTI-PRODUCT (Phase 9)
  // ─────────────────────────────────────────────────────────────────────────────
  bundleType      SubscriptionBundleType?
  parentSubId     String?  // For bundle child subscriptions

  // ─────────────────────────────────────────────────────────────────────────────
  // AI TRACKING (Phase 10-11)
  // ─────────────────────────────────────────────────────────────────────────────
  churnRiskScore   Decimal?  @db.Decimal(5, 2) // 0-100
  churnRiskUpdatedAt DateTime?
  aiPredictions    Json?     // AI model outputs
  aiActions        Json?     // Actions AI has recommended/taken

  // ─────────────────────────────────────────────────────────────────────────────
  // RETENTION (Phase 7)
  // ─────────────────────────────────────────────────────────────────────────────
  retentionOfferCount Int       @default(0)
  lastRetentionOffer  DateTime?
  downselledFrom      String?   // Previous plan ID if downgraded
  winbackEligible     Boolean   @default(false)
  winbackOfferedAt    DateTime?

  // ─────────────────────────────────────────────────────────────────────────────
  // METADATA & TIMESTAMPS
  // ─────────────────────────────────────────────────────────────────────────────
  metadata  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ─────────────────────────────────────────────────────────────────────────────
  // RELATIONS
  // ─────────────────────────────────────────────────────────────────────────────
  company          Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer         Customer          @relation(fields: [customerId], references: [id], onDelete: Cascade)
  subscriptionPlan SubscriptionPlan? @relation(fields: [subscriptionPlanId], references: [id])
  paymentVault     PaymentVault?     @relation(fields: [paymentVaultId], references: [id])
  paymentProvider  PaymentProvider?  @relation(fields: [paymentProviderId], references: [id])
  giftPurchaser    Customer?         @relation("GiftPurchases", fields: [giftPurchaserId], references: [id])
  parentSub        Subscription?     @relation("BundleChildren", fields: [parentSubId], references: [id])

  // Reverse relations
  childSubs        Subscription[]    @relation("BundleChildren")
  transactions     Transaction[]
  orders           Order[]
  rebillAttempts   SubscriptionRebill[]
  items            SubscriptionItem[]

  // Soft delete fields
  deletedAt DateTime?
  deletedBy String?
  cascadeId String?

  // Indexes for query performance with large datasets
  @@index([companyId, status])
  @@index([companyId, interval])
  @@index([companyId, nextBillingDate])
  @@index([companyId, createdAt]) // For date range analytics queries
  @@index([companyId, canceledAt]) // For cancellation analytics queries
  @@index([customerId])
  @@index([subscriptionPlanId])
  @@index([trialStatus])
  @@index([churnRiskScore])
  @@index([createdAt(sort: Desc), id])  // For cursor-based pagination
  @@index([deletedAt])
  @@map("subscriptions")
}

// Subscription Items - Products in a subscription (for multi-product)
model SubscriptionItem {
  id             String @id @default(cuid())
  subscriptionId String
  productId      String

  // Quantity
  quantity       Int    @default(1)

  // Pricing override (null = use plan price)
  priceOverride  Decimal? @db.Decimal(10, 2)

  // Item status
  isActive       Boolean @default(true)
  addedAt        DateTime @default(now())
  removedAt      DateTime?

  // For customization
  options        Json    @default("{}")

  // Relations
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  product        Product      @relation(fields: [productId], references: [id])

  @@unique([subscriptionId, productId])
  @@index([productId])
  @@map("subscription_items")
}

// Trial Status Enum
enum TrialStatus {
  NONE           // No trial
  AWAITING_TRIGGER // Trial purchased but waiting for trigger (shipment/delivery)
  ACTIVE         // Trial is running
  CONVERTED      // Trial successfully converted to paid
  EXPIRED        // Trial ended without conversion
  CANCELLED      // Trial was cancelled
  RETURNED       // Product was returned during trial
}

// Tracks rebill attempts for subscriptions with stored payment methods
model SubscriptionRebill {
  id             String @id @default(cuid())
  subscriptionId String
  transactionId  String? // Links to successful transaction

  // Billing period this rebill covers
  billingPeriodStart DateTime
  billingPeriodEnd   DateTime

  // Amount charged
  amount   Decimal @db.Decimal(10, 2)
  currency String  @default("USD")

  // Attempt tracking
  attemptNumber Int      @default(1) // 1st, 2nd, 3rd retry, etc.
  status        RebillStatus @default(PENDING)

  // Results
  failureReason   String?
  failureCode     String?
  providerResponse Json?

  // Dunning schedule
  nextRetryAt     DateTime? // When to retry if failed
  retriesRemaining Int       @default(3)

  // Timestamps
  scheduledAt DateTime  // When rebill was scheduled
  processedAt DateTime? // When processing completed
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  transaction  Transaction? @relation(fields: [transactionId], references: [id])

  @@index([subscriptionId, status])
  @@index([status, scheduledAt])
  @@index([nextRetryAt])
  @@map("subscription_rebills")
}

// =============================================================================
// SUBSCRIPTION PLANS - Multi-Level Reusable Plans (Phase 1)
// =============================================================================

model SubscriptionPlan {
  id String @id @default(cuid())

  // ─────────────────────────────────────────────────────────────────────────
  // OWNERSHIP (exactly one set based on scope)
  // ─────────────────────────────────────────────────────────────────────────
  scope          SubscriptionPlanScope
  organizationId String?
  clientId       String?
  companyId      String?

  // ─────────────────────────────────────────────────────────────────────────
  // PLAN IDENTIFICATION
  // ─────────────────────────────────────────────────────────────────────────
  name             String  // Internal name (unique within scope)
  displayName      String  // Customer-facing name
  description      String?
  shortDescription String? // One-liner for cards

  // ─────────────────────────────────────────────────────────────────────────
  // PRICING
  // ─────────────────────────────────────────────────────────────────────────
  basePriceMonthly  Decimal  @db.Decimal(10, 2) // Monthly price
  basePriceAnnual   Decimal? @db.Decimal(10, 2) // Annual price (optional)
  annualDiscountPct Decimal? @db.Decimal(5, 2)  // e.g., 10.00 = 10% off
  currency          String   @default("USD")

  // ─────────────────────────────────────────────────────────────────────────
  // BILLING CYCLE
  // ─────────────────────────────────────────────────────────────────────────
  availableIntervals BillingInterval[]
  defaultInterval    BillingInterval @default(MONTHLY)

  // ─────────────────────────────────────────────────────────────────────────
  // TRIAL CONFIGURATION
  // ─────────────────────────────────────────────────────────────────────────
  trialEnabled             Boolean           @default(false)
  trialDays                Int?              // X days trial
  trialIncludesShipment    Boolean           @default(false)
  trialStartTrigger        TrialStartTrigger @default(ON_PURCHASE)
  trialConversionTrigger   TrialStartTrigger @default(ON_PURCHASE)
  trialWaitForDelivery     Boolean           @default(false)
  trialExtendDaysPostDelivery Int?           @default(0)
  trialNoTrackingFallbackDays Int?           // Start trial after X days if no tracking
  trialReturnAction        TrialReturnAction @default(PAUSE_ALERT)
  trialReturnExtendDays    Int?              // Days to extend if EXTEND_TRIAL action

  // ─────────────────────────────────────────────────────────────────────────
  // RECURRING CONFIGURATION
  // ─────────────────────────────────────────────────────────────────────────
  recurringEnabled               Boolean           @default(true)
  recurringIntervalDays          Int?              // Override: every X days
  recurringIncludesShipment      Boolean           @default(true)
  recurringTrigger               TrialStartTrigger @default(ON_PURCHASE)
  recurringWaitForDelivery       Boolean           @default(false)
  recurringExtendDaysPostDelivery Int?             @default(0)

  // ─────────────────────────────────────────────────────────────────────────
  // SHIPMENT-AWARE BILLING OPTIONS
  // ─────────────────────────────────────────────────────────────────────────
  partialShipmentAction    PartialShipmentAction @default(PROCEED)
  backorderAction          BackorderAction       @default(DELAY_CHARGE)
  shippingCostAction       ShippingCostAction    @default(ABSORB_COST)
  gracePeriodDays          Int?                  // Days before alerting on stuck shipment

  // ─────────────────────────────────────────────────────────────────────────
  // PAUSE & SKIP CONFIGURATION
  // ─────────────────────────────────────────────────────────────────────────
  pauseEnabled     Boolean @default(true)
  pauseMaxDuration Int?    // Max pause days (null = unlimited)
  skipEnabled      Boolean @default(true)
  skipMaxPerYear   Int?    // Max skips per year (null = unlimited)

  // ─────────────────────────────────────────────────────────────────────────
  // QUANTITY CONFIGURATION
  // ─────────────────────────────────────────────────────────────────────────
  includedQuantity     Int     @default(1) // Units per billing cycle
  maxQuantity          Int?    // Max units allowed (null = unlimited)
  quantityChangeProrate Boolean @default(true) // Prorate or next cycle

  // ─────────────────────────────────────────────────────────────────────────
  // LOYALTY PRICING
  // ─────────────────────────────────────────────────────────────────────────
  loyaltyEnabled       Boolean @default(false)
  loyaltyTiers         Json?   // [{ afterRebills: 6, discountPct: 5 }, { afterRebills: 12, discountPct: 10 }]
  loyaltyStackable     Boolean @default(false) // Stack with other discounts?

  // ─────────────────────────────────────────────────────────────────────────
  // PRICE LOCK & EARLY RENEWAL
  // ─────────────────────────────────────────────────────────────────────────
  priceLockEnabled     Boolean @default(false)
  priceLockCycles      Int?    // Lock for X cycles (null = forever)
  earlyRenewalEnabled  Boolean @default(false)
  earlyRenewalProrate  Boolean @default(true)

  // ─────────────────────────────────────────────────────────────────────────
  // RETENTION SETTINGS
  // ─────────────────────────────────────────────────────────────────────────
  downsellPlanId       String? // Plan to offer on cancel
  winbackEnabled       Boolean @default(false)
  winbackDiscountPct   Decimal? @db.Decimal(5, 2)
  winbackTrialDays     Int?

  // ─────────────────────────────────────────────────────────────────────────
  // GIFTING
  // ─────────────────────────────────────────────────────────────────────────
  giftingEnabled       Boolean @default(false)
  giftDurationDefault  GiftDurationType @default(ONGOING)
  giftFixedCycles      Int?    // If FIXED, how many cycles

  // ─────────────────────────────────────────────────────────────────────────
  // MULTI-PRODUCT BUNDLE (for bundle subscriptions)
  // ─────────────────────────────────────────────────────────────────────────
  bundleType           SubscriptionBundleType?
  bundleMinProducts    Int?
  bundleMaxProducts    Int?

  // ─────────────────────────────────────────────────────────────────────────
  // NOTIFICATIONS
  // ─────────────────────────────────────────────────────────────────────────
  notifyRenewalEnabled   Boolean @default(false)
  notifyRenewalDaysBefore Int?   @default(3)

  // ─────────────────────────────────────────────────────────────────────────
  // DISPLAY & MARKETING
  // ─────────────────────────────────────────────────────────────────────────
  sortOrder    Int     @default(0)
  isPublic     Boolean @default(true)  // Show on storefront
  isFeatured   Boolean @default(false) // Highlight this plan
  badgeText    String?                 // "Most Popular", "Best Value"
  features     Json    @default("[]")  // Array of feature strings

  // ─────────────────────────────────────────────────────────────────────────
  // MOMENTUM INTELLIGENCE SETTINGS
  // ─────────────────────────────────────────────────────────────────────────
  miEnabled                  Boolean @default(true)   // Enable MI features for this plan
  miChurnDetectionEnabled    Boolean @default(true)   // Enable churn prediction
  miChurnThresholdCritical   Int     @default(80)     // Score threshold for CRITICAL risk
  miChurnThresholdHigh       Int     @default(60)     // Score threshold for HIGH risk
  miChurnThresholdMedium     Int     @default(40)     // Score threshold for MEDIUM risk
  miSaveFlowEnabled          Boolean @default(true)   // Enable save flow on cancellation
  miSaveFlowMaxAttempts      Int     @default(3)      // Max save attempts per subscription
  miInterventionsEnabled     Boolean @default(true)   // Enable behavioral interventions
  miInterventionTypes        Json    @default("[]")   // Allowed intervention types: ["DISCOUNT", "PAUSE", "SKIP", "DOWNGRADE"]
  miSocialProofEnabled       Boolean @default(false)  // Show social proof (reviews, purchase count)
  miUrgencyEnabled           Boolean @default(false)  // Show urgency indicators (limited stock, timer)
  miUpsellEnabled            Boolean @default(true)   // Enable AI-driven upsells
  miCrossSellEnabled         Boolean @default(true)   // Enable cross-sell recommendations
  miPersonalizationEnabled   Boolean @default(true)   // Enable personalized messaging

  // ─────────────────────────────────────────────────────────────────────────
  // METADATA
  // ─────────────────────────────────────────────────────────────────────────
  metadata Json @default("{}")

  // ─────────────────────────────────────────────────────────────────────────
  // STATUS & TIMESTAMPS
  // ─────────────────────────────────────────────────────────────────────────
  status      SubscriptionPlanStatus @default(DRAFT)
  publishedAt DateTime?
  archivedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  // Soft delete
  deletedAt DateTime?
  deletedBy String?
  cascadeId String?

  // ─────────────────────────────────────────────────────────────────────────
  // RELATIONS
  // ─────────────────────────────────────────────────────────────────────────
  organization Organization? @relation(fields: [organizationId], references: [id])
  client       Client?       @relation(fields: [clientId], references: [id])
  company      Company?      @relation(fields: [companyId], references: [id])
  downsellPlan SubscriptionPlan? @relation("PlanDownsell", fields: [downsellPlanId], references: [id])

  // Reverse relations
  downsellFrom  SubscriptionPlan[] @relation("PlanDownsell")
  productPlans  ProductSubscriptionPlan[]
  subscriptions Subscription[]

  @@unique([scope, organizationId, name])
  @@unique([scope, clientId, name])
  @@unique([scope, companyId, name])
  @@index([scope, status])
  @@index([companyId, status])
  @@index([clientId, status])
  @@index([organizationId, status])
  @@index([deletedAt])
  @@map("subscription_plans")
}

// Junction table: Product ↔ SubscriptionPlan
model ProductSubscriptionPlan {
  id        String @id @default(cuid())
  productId String
  planId    String

  // Override pricing for this specific product
  overridePriceMonthly Decimal? @db.Decimal(10, 2)
  overridePriceAnnual  Decimal? @db.Decimal(10, 2)

  // Override trial settings
  overrideTrialDays Int?

  // Selection
  isDefault Boolean @default(false) // Default plan for this product
  sortOrder Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  plan    SubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([productId, planId])
  @@index([planId])
  @@map("product_subscription_plans")
}

// Subscription Settings at different hierarchy levels
model SubscriptionSettings {
  id String @id @default(cuid())

  // Ownership - exactly one set
  organizationId String? @unique
  clientId       String? @unique
  companyId      String? @unique

  // Enable/Disable subscriptions at this level
  subscriptionsEnabled Boolean @default(true)

  // Payment method fallback settings
  paymentFallbackEnabled    Boolean @default(true)
  paymentFallbackMaxRetries Int     @default(3)

  // AI settings
  aiCostControlEnabled  Boolean  @default(false)
  aiCostControlDisclaimer String?
  aiMaxDiscountPct      Decimal? @db.Decimal(5, 2) @default(30)
  aiAutoApproveEnabled  Boolean  @default(false)
  aiABTestingEnabled    Boolean  @default(false)
  aiABTestingDisclaimer String?

  // Shipping savings tracking
  shippingSavingsEnabled Boolean @default(true)

  // Notification defaults
  defaultNotifyRenewal    Boolean @default(false)
  defaultNotifyFailed     Boolean @default(true)
  defaultNotifyPaused     Boolean @default(true)
  defaultNotifyCancelled  Boolean @default(true)
  defaultNotifyShipped    Boolean @default(true)
  defaultNotifyDelivered  Boolean @default(false)
  defaultNotifyPriceChange Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization? @relation(fields: [organizationId], references: [id])
  client       Client?       @relation(fields: [clientId], references: [id])
  company      Company?      @relation(fields: [companyId], references: [id])

  @@map("subscription_settings")
}

// =============================================================================
// FULFILLMENT PROVIDERS - Track shipment & delivery for subscription billing
// =============================================================================

enum FulfillmentProviderType {
  INTERNAL        // Company handles fulfillment internally
  THIRD_PARTY     // 3PL provider
  DROPSHIP        // Drop shipping vendor
  DIGITAL         // Digital/electronic delivery
  PRINT_ON_DEMAND // POD service
  MARKETPLACE     // VendorCompany from marketplace
}

enum FulfillmentProviderStatus {
  ACTIVE
  PAUSED
  INACTIVE
}

model FulfillmentProvider {
  id        String @id @default(cuid())
  companyId String

  name        String
  code        String   // Short code for reference (e.g., "SHIP-EASY")
  description String?
  type        FulfillmentProviderType
  status      FulfillmentProviderStatus @default(ACTIVE)

  // Contact
  contactEmail   String?
  contactPhone   String?
  contactName    String?
  webhookUrl     String?  // For receiving updates

  // Integration
  integrationId  String?  // Links to ClientIntegration if API-based
  apiCredentials Json?    // Encrypted credentials if not using ClientIntegration

  // Vendor Company (if marketplace fulfillment)
  vendorCompanyId String?

  // Capabilities
  supportsTracking       Boolean @default(true)
  supportsPartialShip    Boolean @default(false)
  supportsHoldForGroup   Boolean @default(false)  // Can hold until full order ready
  avgProcessingDays      Int?                     // Expected days to ship
  avgDeliveryDays        Int?                     // Expected transit time

  // For subscription billing
  trackingUpdatesEnabled Boolean @default(true)   // Subscribe to tracking updates
  deliveryConfirmEnabled Boolean @default(true)   // Subscribe to delivery confirmations

  // Display
  sortOrder Int     @default(0)
  isDefault Boolean @default(false)

  // Metadata
  metadata Json @default("{}")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Soft delete
  deletedAt DateTime?
  deletedBy String?

  // Relations
  company       Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  vendorCompany VendorCompany?     @relation(fields: [vendorCompanyId], references: [id])
  shipments     Shipment[]
  assignments   ProductFulfillmentAssignment[]

  @@unique([companyId, code, deletedAt])
  @@index([companyId, status])
  @@index([companyId, type])
  @@map("fulfillment_providers")
}

// Junction: Product ↔ FulfillmentProvider (products can have multiple providers)
model ProductFulfillmentAssignment {
  id         String @id @default(cuid())
  productId  String
  providerId String

  priority   Int     @default(0)    // Lower = preferred
  isDefault  Boolean @default(false)

  // Override settings per product
  overrideProcessingDays Int?
  overrideDeliveryDays   Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product  Product              @relation(fields: [productId], references: [id], onDelete: Cascade)
  provider FulfillmentProvider  @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([productId, providerId])
  @@index([providerId])
  @@map("product_fulfillment_assignments")
}

model Transaction {
  id                String  @id @default(cuid())
  companyId         String
  customerId        String?
  subscriptionId    String?
  orderId           String?
  paymentProviderId String?
  paymentVaultId    String?

  // Transaction reference
  transactionNumber String @unique

  // Transaction details
  type        TransactionType
  amount      Decimal         @db.Decimal(10, 2)
  currency    String          @default("USD")
  description String?

  // Provider response
  providerTransactionId String?
  providerResponse      Json?

  // Status
  status        TransactionStatus @default(PENDING)
  failureReason String?
  failureCode   String?

  // Refund tracking
  refundedAmount      Decimal? @db.Decimal(10, 2)
  parentTransactionId String? // For refunds, links to original charge

  // Risk & Fraud
  riskScore Int?
  riskFlags String[]

  // AVS/CVV results
  avsResult String?
  cvvResult String?

  // Continuity tracking
  continuitySessionId String?
  frictionLevel       String?
  momentumScore       Int?

  // Environment (sandbox vs production)
  environment String @default("production") // "sandbox" or "production"

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  processedAt DateTime?

  // Relations
  company         Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer        Customer?        @relation(fields: [customerId], references: [id])
  subscription    Subscription?    @relation(fields: [subscriptionId], references: [id])
  order           Order?           @relation(fields: [orderId], references: [id])
  paymentProvider PaymentProvider? @relation(fields: [paymentProviderId], references: [id])
  paymentVault    PaymentVault?    @relation(fields: [paymentVaultId], references: [id])
  rebillAttempts  SubscriptionRebill[]

  @@index([companyId, createdAt])
  @@index([companyId, status, createdAt])
  @@index([customerId])
  @@index([orderId])
  @@index([subscriptionId])
  @@index([paymentProviderId])
  @@index([paymentVaultId])
  @@index([parentTransactionId])
  @@index([status])
  @@map("transactions")
}

// =============================================================================
// MERCHANT ACCOUNTS
// =============================================================================

model MerchantAccount {
  id        String @id @default(cuid())
  companyId String

  // Friendly naming
  name        String
  description String?
  color       String?
  icon        String?
  tags        String[] @default([])

  // Provider configuration
  providerType    String
  merchantId      String
  descriptor      String?
  descriptorPhone String?
  credentials     Json
  environment     String  @default("sandbox")

  // Status
  status          String    @default("pending")
  statusReason    String?
  statusChangedAt DateTime?

  // Transaction limits
  minTransactionAmount    Int  @default(50)
  maxTransactionAmount    Int  @default(10000000)
  dailyTransactionLimit   Int?
  dailyVolumeLimit        Int?
  weeklyTransactionLimit  Int?
  weeklyVolumeLimit       Int?
  monthlyTransactionLimit Int?
  monthlyVolumeLimit      Int?
  yearlyTransactionLimit  Int?
  yearlyVolumeLimit       Int?
  velocityWindow          Int?
  velocityMaxTransactions Int?
  velocityMaxAmount       Int?

  // Current usage
  todayTransactionCount Int       @default(0)
  todayVolume           Int       @default(0)
  todaySuccessCount     Int       @default(0)
  todayFailureCount     Int       @default(0)
  weekTransactionCount  Int       @default(0)
  weekVolume            Int       @default(0)
  monthTransactionCount Int       @default(0)
  monthVolume           Int       @default(0)
  yearTransactionCount  Int       @default(0)
  yearVolume            Int       @default(0)
  lastTransactionAt     DateTime?
  usageResetAt          DateTime  @default(now())

  // Fees & restrictions (JSON)
  fees         Json?
  restrictions Json?

  // Routing
  priority     Int     @default(100)
  weight       Int     @default(100)
  isDefault    Boolean @default(false)
  isBackupOnly Boolean @default(false)

  // Health
  healthStatus     String    @default("healthy")
  successRate      Float     @default(100)
  avgLatencyMs     Float     @default(0)
  lastHealthCheck  DateTime?
  lastErrorCode    String?
  lastErrorMessage String?
  lastErrorAt      DateTime?
  uptimePercent    Float     @default(100)

  // Financial
  reserveBalance   Int?
  availableBalance Int?

  // Metadata
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  // Integration relation
  clientIntegration ClientIntegration?

  // Soft delete fields
  deletedAt DateTime?
  deletedBy String?
  cascadeId String?

  @@unique([companyId, name, deletedAt])
  @@index([companyId])
  @@index([providerType])
  @@index([status])
  @@index([deletedAt])
  @@map("merchant_accounts")
}

// =============================================================================
// ACCOUNT POOLS (Load Balancing & Failover)
// =============================================================================

model AccountPool {
  id        String @id @default(cuid())
  companyId String

  // Friendly naming
  name        String
  description String?
  color       String?
  icon        String?
  tags        String[] @default([])

  // Members (stored as JSON array of PoolMembership)
  accounts Json @default("[]")

  // Load balancing strategy
  balancingStrategy String @default("WEIGHTED")

  // Configuration (stored as JSON)
  failover      Json // FailoverConfig
  healthRouting Json // HealthRoutingConfig
  limitRouting  Json // LimitRoutingConfig
  stickySession Json? // StickySessionConfig (optional)

  // Status
  status String @default("active")

  // Round-robin state
  lastAccountIndex Int @default(0)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  @@unique([companyId, name])
  @@index([companyId])
  @@index([status])
  @@map("account_pools")
}

// =============================================================================
// ROUTING RULES (Gateway Rule Engine)
// =============================================================================

model RoutingRule {
  id        String @id @default(cuid())
  companyId String

  // Friendly naming
  name        String
  description String?
  color       String?
  tags        String[] @default([])

  // Status
  status   String @default("INACTIVE")
  priority Int    @default(100)

  // Conditions & Actions (JSON)
  conditions Json
  actions    Json

  // Fallback
  fallbackAction  String?
  fallbackPoolId  String?
  fallbackMessage String?

  // A/B Testing
  testingEnabled       Boolean   @default(false)
  testingTrafficPct    Float?
  testingControlPoolId String?
  testingTestPoolId    String?
  testingStartDate     DateTime?
  testingEndDate       DateTime?
  testingMetrics       String[]  @default([])

  // Scheduling
  activateAt        DateTime?
  deactivateAt      DateTime?
  timezone          String?
  recurringSchedule String?

  // Analytics
  matchCount          Int       @default(0)
  lastMatchedAt       DateTime?
  avgProcessingTimeMs Float     @default(0)

  // Metadata
  version   Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  // Soft delete fields
  deletedAt DateTime?
  deletedBy String?
  cascadeId String?

  @@unique([companyId, name, deletedAt])
  @@index([companyId])
  @@index([status])
  @@index([priority])
  @@index([deletedAt])
  @@map("routing_rules")
}

model RoutingDecision {
  id            String @id @default(cuid())
  companyId     String
  transactionId String

  // Decision
  primaryAccountId   String?
  primaryAccountName String?
  fallbackAccountIds String[] @default([])
  blocked            Boolean  @default(false)
  blockReason        String?
  flaggedForReview   Boolean  @default(false)
  reviewReason       String?
  require3ds         Boolean  @default(false)

  // Amounts
  surchargeAmount Int @default(0)
  discountAmount  Int @default(0)
  originalAmount  Int
  finalAmount     Int

  // Applied rules
  appliedRuleIds   String[] @default([])
  appliedRuleNames String[] @default([])

  // Performance
  evaluationTimeMs  Int
  conditionsChecked Int
  rulesEvaluated    Int

  // Context
  contextSnapshot Json?

  createdAt DateTime @default(now())

  @@index([companyId])
  @@index([transactionId])
  @@index([createdAt])
  @@map("routing_decisions")
}

// =============================================================================
// BILLING & USAGE TRACKING
// =============================================================================

model PricingPlan {
  id String @id @default(cuid())

  // Plan identification
  name        String  @unique
  displayName String
  description String?

  // Plan Type & Visibility
  planType   String  @default("DEFAULT") // DEFAULT, CUSTOM, LEGACY
  isPublic   Boolean @default(true) // Show in public plan list (for self-service)
  clientId   String? // If CUSTOM plan, which client it belongs to (NULL = default plan)
  basePlanId String? // For CUSTOM plans: which default plan this is based on

  // Self-service controls
  allowSelfUpgrade   Boolean @default(true) // Can clients upgrade to this plan themselves?
  allowSelfDowngrade Boolean @default(false) // Can clients downgrade from this plan themselves?
  requiresApproval   Boolean @default(false) // Does switching to this plan require ORG approval?

  // Stripe Product/Price IDs
  stripeProductId String? // Stripe Product ID for this plan
  stripePriceId   String? // Stripe Price ID (monthly)
  stripeAnnualPriceId String? // Stripe Price ID (annual)

  // Billing
  billingInterval String @default("MONTHLY")
  baseCost        Int    @default(0)
  annualCost      Int?   // Annual price (if different from baseCost * 12)
  currency        String @default("USD")

  // Included allowances (JSON)
  included Json // { transactions: number, volume: number, apiCalls: number, ... }

  // Overage pricing (JSON)
  overage Json // { transactionPrice: number, volumePercent: number, ... }

  // Features (JSON)
  features Json @default("[]")

  // Limits (JSON)
  limits Json? // { maxCompanies: number, maxUsers: number, ... }

  // Status
  status    String  @default("active") // active, deprecated, hidden
  isDefault Boolean @default(false) // Default plan for new clients

  // Metadata
  sortOrder Int      @default(0)
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  subscriptions  ClientSubscription[]
  client         Client?       @relation("CustomPlans", fields: [clientId], references: [id])
  basePlan       PricingPlan?  @relation("DerivedPlans", fields: [basePlanId], references: [id])
  derivedPlans   PricingPlan[] @relation("DerivedPlans")

  @@index([status])
  @@index([planType])
  @@index([clientId])
  @@index([isPublic])
  @@map("pricing_plans")
}

model ClientSubscription {
  id       String @id @default(cuid())
  clientId String @unique
  planId   String

  // Status
  status          String    @default("active")
  statusReason    String?
  statusChangedAt DateTime?

  // Billing cycle
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  nextBillingDate    DateTime?
  billingAnchorDay   Int       @default(1)

  // Trial
  trialStart DateTime?
  trialEnd   DateTime?

  // Cancellation
  canceledAt        DateTime?
  cancelReason      String?
  cancelAtPeriodEnd Boolean   @default(false)

  // Pause
  pausedAt      DateTime?
  pauseResumeAt DateTime?
  pauseReason   String?

  // Discount
  discountPercent   Float?
  discountReason    String?
  discountExpiresAt DateTime?

  // Stripe integration
  stripeCustomerId     String?
  stripeSubscriptionId String?

  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  client       Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  plan         PricingPlan   @relation(fields: [planId], references: [id])
  usagePeriods UsagePeriod[]
  invoices     Invoice[]

  @@index([planId])
  @@index([status])
  @@map("client_subscriptions")
}

model UsagePeriod {
  id             String @id @default(cuid())
  subscriptionId String
  clientId       String

  // Period dates
  periodStart DateTime
  periodEnd   DateTime

  // Transaction metrics
  transactionCount  Int    @default(0)
  transactionVolume BigInt @default(0)
  transactionCost   Int    @default(0)

  // Volume cost
  volumeCost Int @default(0)

  // API usage
  apiCallCount Int @default(0)
  apiCallCost  Int @default(0)

  // Resource usage
  companiesUsed Int @default(0)
  usersUsed     Int @default(0)
  storageUsedMb Int @default(0)

  // Costs
  baseCost    Int @default(0)
  overageCost Int @default(0)
  totalCost   Int @default(0)

  // Status
  status String @default("active")

  // Metadata
  closedAt  DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  subscription   ClientSubscription   @relation(fields: [subscriptionId], references: [id])
  companyRecords CompanyUsageRecord[]
  usageEvents    UsageEvent[]
  invoices       Invoice[]

  @@index([subscriptionId])
  @@index([clientId])
  @@index([status])
  @@index([periodStart, periodEnd])
  @@map("usage_periods")
}

model CompanyUsageRecord {
  id            String @id @default(cuid())
  usagePeriodId String
  companyId     String

  // Metrics
  transactionCount  Int    @default(0)
  transactionVolume BigInt @default(0)
  apiCallCount      Int    @default(0)

  // Calculated costs (allocated share)
  allocatedCost Int @default(0)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  usagePeriod UsagePeriod @relation(fields: [usagePeriodId], references: [id], onDelete: Cascade)

  @@unique([usagePeriodId, companyId])
  @@index([companyId])
  @@map("company_usage_records")
}

model UsageEvent {
  id            String  @id @default(cuid())
  usagePeriodId String
  companyId     String?

  // Event details
  eventType String
  quantity  Int    @default(1)
  unitCost  Int    @default(0)
  totalCost Int    @default(0)

  // Reference
  referenceType String?
  referenceId   String?

  // Metadata
  metadata   Json?
  occurredAt DateTime @default(now())
  createdAt  DateTime @default(now())

  // Relations
  usagePeriod UsagePeriod @relation(fields: [usagePeriodId], references: [id], onDelete: Cascade)

  @@index([usagePeriodId])
  @@index([companyId])
  @@index([eventType])
  @@index([occurredAt])
  @@map("usage_events")
}

model Invoice {
  id             String  @id @default(cuid())
  clientId       String
  subscriptionId String
  usagePeriodId  String?

  // Invoice number
  invoiceNumber String @unique

  // Period
  periodStart DateTime
  periodEnd   DateTime

  // Amounts (in cents)
  subtotal   Int
  discount   Int @default(0)
  tax        Int @default(0)
  total      Int
  amountPaid Int @default(0)
  amountDue  Int

  // Currency
  currency String @default("USD")

  // Line items (JSON array)
  lineItems Json @default("[]")

  // Status
  status String @default("draft")

  // Dates
  dueDate  DateTime
  paidAt   DateTime?
  voidedAt DateTime?
  sentAt   DateTime?

  // Stripe
  stripeInvoiceId       String?
  stripePaymentIntentId String?

  // Payment
  paymentMethod String?

  // PDF
  pdfUrl String?

  // Notes
  notes String?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  subscription ClientSubscription @relation(fields: [subscriptionId], references: [id])
  usagePeriod  UsagePeriod?       @relation(fields: [usagePeriodId], references: [id])

  @@index([clientId])
  @@index([subscriptionId])
  @@index([status])
  @@index([dueDate])
  @@map("invoices")
}

// =============================================================================
// SYSTEM MODELS
// =============================================================================

model ApiKey {
  id             String @id @default(cuid())
  organizationId String
  name           String
  keyHash        String @unique
  keyPrefix      String // First 8 chars for identification

  // Permissions
  scopes String[] @default([])

  // Usage
  lastUsedAt DateTime?
  expiresAt  DateTime?

  // Status
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("api_keys")
}

model AuditLog {
  id     String  @id @default(cuid())
  userId String?

  // What happened
  action   String
  entity   String
  entityId String?

  // Context
  scopeType ScopeType?
  scopeId   String?

  // Details
  changes   Json?
  metadata  Json?
  ipAddress String?
  userAgent String?

  // Data classification (for compliance)
  dataClassification DataClassification?

  // Timestamp
  createdAt DateTime @default(now())

  // Relations
  user User? @relation(fields: [userId], references: [id])

  @@index([entity, entityId])
  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@map("audit_logs")
}

// =============================================================================
// ENUMS
// =============================================================================

// Hierarchy & Access
enum BillingPlan {
  STARTER
  PROFESSIONAL
  ENTERPRISE
  CUSTOM
}

enum BillingStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  SUSPENDED
}

enum ClientPlan {
  FOUNDERS    // Early adopters / founding members
  BASIC
  STANDARD
  PREMIUM
  ENTERPRISE
}

enum EntityStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  DELETED
}

// Site Types
enum SiteType {
  STOREFRONT
  FUNNEL
  TRIAL
  MARKETPLACE
  B2B_PORTAL
}

// Cart Status
enum CartStatus {
  ACTIVE
  CONVERTED
  ABANDONED
  MERGED
  EXPIRED
}

// Inventory Hold Status
enum InventoryHoldStatus {
  ACTIVE
  RELEASED
  CONVERTED
  EXPIRED
}

// Cart Source Type - Attribution tracking
enum CartSourceType {
  DIRECT        // Direct site visit
  LANDING_PAGE  // From landing page
  FUNNEL        // From funnel flow
  EMAIL         // From email campaign
}

// Landing Page Session Status
enum LandingPageSessionStatus {
  ACTIVE     // Visitor actively browsing
  CONVERTED  // Cart converted to order
  ABANDONED  // Session abandoned (no activity)
  EXPIRED    // Session token expired
}

// Promotion Types
enum PromotionType {
  PERCENTAGE_OFF     // e.g., 20% off
  FIXED_AMOUNT_OFF   // e.g., $10 off
  BUY_X_GET_Y        // e.g., Buy 2 Get 1 Free
  FREE_SHIPPING      // Free shipping
  FREE_GIFT          // Free product with purchase
}

enum PromotionScope {
  CART              // Applies to entire cart
  PRODUCT           // Applies to specific products
  CATEGORY          // Applies to specific categories
  SHIPPING          // Applies to shipping only
}

// Tax Types
enum TaxType {
  SALES_TAX         // US Sales Tax
  VAT               // Value Added Tax (EU)
  GST               // Goods and Services Tax (CA, AU)
  HST               // Harmonized Sales Tax (Canada)
  PST               // Provincial Sales Tax (Canada)
  CONSUMPTION       // Consumption Tax (Japan, etc.)
}

// Shipping Rule Types
enum ShippingRuleType {
  FLAT_RATE         // Fixed cost regardless of order
  PER_ITEM          // Cost per item in cart
  WEIGHT_BASED      // Based on total weight
  PRICE_BASED       // Based on order total
  FREE              // Always free
  CALCULATED        // Real-time carrier rates (future)
}

enum ScopeType {
  ORGANIZATION
  CLIENT
  COMPANY
  DEPARTMENT
  TEAM
  // Vendor hierarchy (parallel to Client)
  VENDOR
  VENDOR_COMPANY
  VENDOR_DEPARTMENT
  VENDOR_TEAM
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  USER
  VIEWER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

enum TeamRole {
  LEAD
  MEMBER
  VIEWER
}

// Customer & Address
enum CustomerStatus {
  ACTIVE
  INACTIVE
  BLOCKED
}

enum AddressType {
  SHIPPING
  BILLING
  BOTH
}

// Payment
enum PaymentProviderType {
  PAYFLOW
  NMI
  AUTHORIZE_NET
  STRIPE
  BRAINTREE
  SQUARE
  CUSTOM
}

enum PaymentMethodType {
  CARD
  ACH
  CHECK
  WIRE
  WALLET_APPLE
  WALLET_GOOGLE
  PAYPAL
  AFFIRM
  KLARNA
  CASH
  INVOICE
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  PAID
  PARTIALLY_REFUNDED
  REFUNDED
  FAILED
  VOIDED
}

enum TransactionType {
  CHARGE
  REFUND
  VOID
  CHARGEBACK
  ADJUSTMENT
  AUTHORIZATION
  CAPTURE
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  VOIDED
  DISPUTED
}

// Subscription
enum BillingInterval {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELED
  PAST_DUE
  TRIALING
  EXPIRED
}

enum RebillStatus {
  PENDING    // Scheduled but not yet processed
  PROCESSING // Currently being processed
  SUCCESS    // Payment succeeded
  FAILED     // Payment failed, may retry
  EXHAUSTED  // All retries exhausted
  SKIPPED    // Skipped (e.g., subscription paused)
}

// ═══════════════════════════════════════════════════════════════════════════════
// SUBSCRIPTION PLANS - Multi-Level Reusable Plans
// ═══════════════════════════════════════════════════════════════════════════════

enum SubscriptionPlanScope {
  ORGANIZATION // Platform-wide templates
  CLIENT       // Client-level plans
  COMPANY      // Company-level plans
}

enum SubscriptionPlanStatus {
  DRAFT      // Not yet published
  ACTIVE     // Available for use
  ARCHIVED   // Hidden but existing subscriptions continue
  DEPRECATED // Sunset - no new subscriptions
}

enum TrialStartTrigger {
  ON_PURCHASE // Trial starts immediately at checkout
  ON_SHIPMENT // Trial starts when tracking added
  ON_DELIVERY // Trial starts when delivered
  MANUAL      // Trial starts when marked by staff
}

enum TrialReturnAction {
  EXTEND_TRIAL   // Give customer more time
  CANCEL         // End subscription
  CONVERT_ANYWAY // Proceed to paid despite return
  PAUSE_ALERT    // Pause and notify staff
}

enum PartialShipmentAction {
  PROCEED       // Bill now, ship what's available
  WAIT_ALL      // Wait for all items before billing
  PRORATE       // Bill proportionally to shipped items
}

enum BackorderAction {
  DELAY_CHARGE  // Wait until in stock
  CHARGE_SHIP_LATER // Charge now, ship when available
  SKIP_CYCLE    // Skip this billing cycle
}

enum ShippingCostAction {
  ABSORB_COST   // Company absorbs shipping cost changes
  PASS_TO_CUSTOMER // Pass cost to customer
  FREE_SHIPPING // Always free shipping
}

enum ProductFulfillmentType {
  PHYSICAL   // Tangible goods - requires shipping
  VIRTUAL    // Intangible - no fulfillment (insurance, warranty)
  ELECTRONIC // Digital goods - delivered via email/SMS
}

enum ElectronicDeliveryMethod {
  EMAIL         // Send via email
  SMS           // Send via SMS
  EMAIL_AND_SMS // Send via both
  DOWNLOAD_LINK // Provide download URL
}

enum GiftDurationType {
  ONE_TIME // Single shipment/delivery only
  FIXED    // X months/cycles
  ONGOING  // Until cancelled
}

enum SubscriptionBundleType {
  FIXED         // Same products every cycle
  ROTATING      // Different products each cycle (curated)
  BUILD_YOUR_OWN // Customer picks X items
  MIX_AND_MATCH  // Customer modifies each cycle
}

// Product
enum ProductStatus {
  ACTIVE
  DRAFT
  ARCHIVED
  OUT_OF_STOCK
}

// Order
enum OrderType {
  ONE_TIME
  SUBSCRIPTION
  GIFT
  REPLACEMENT
  SAMPLE
}

enum OrderStatus {
  PENDING // Created, awaiting payment
  CONFIRMED // Payment received
  PROCESSING // Being prepared (address locked)
  PARTIALLY_SHIPPED // Some items shipped
  SHIPPED // All items shipped
  DELIVERED // Customer received
  COMPLETED // Finalized
  CANCELED // Canceled by customer/system
  REFUNDED // Fully refunded
}

enum FulfillmentStatus {
  UNFULFILLED
  PARTIALLY_FULFILLED
  FULFILLED
  RETURNED
}

// Shipping
enum ShippingCarrier {
  USPS
  UPS
  FEDEX
  DHL
  AMAZON
  LOCAL_DELIVERY
  PICKUP
  OTHER
}

enum ShippingMethod {
  GROUND
  EXPRESS
  OVERNIGHT
  TWO_DAY
  SAME_DAY
  PICKUP
  FREE
}

enum ShipmentStatus {
  PENDING // Label not created
  LABEL_CREATED // Label printed, not shipped
  IN_TRANSIT // With carrier
  OUT_FOR_DELIVERY // On truck for delivery
  DELIVERED // Delivered
  FAILED // Delivery failed
  RETURNED // Returned to sender
  EXCEPTION // Problem occurred
}

enum ShipmentEventType {
  LABEL_CREATED
  PICKED_UP
  IN_TRANSIT
  ARRIVED_AT_FACILITY
  DEPARTED_FACILITY
  OUT_FOR_DELIVERY
  DELIVERY_ATTEMPTED
  DELIVERED
  EXCEPTION
  RETURNED_TO_SENDER
}

// Compliance
enum DataClassification {
  PUBLIC
  INTERNAL
  CONFIDENTIAL
  PII
  PCI
  PHI
}

// =============================================================================
// MOMENTUM INTELLIGENCE™ MODELS
// AI-Powered Behavioral Commerce Platform
// =============================================================================

model CustomerIntent {
  id         String @id @default(cuid())
  companyId  String
  customerId String

  // Risk Assessment
  churnScore Float          @default(0)
  churnRisk  ChurnRiskLevel @default(LOW)
  confidence Float          @default(0)

  // Contributing Signals
  signals        Json // Array of detected signals
  primaryFactors String[]

  // Recommended Action
  recommendedAction InterventionType?
  urgency           InterventionUrgency @default(MONITORING)

  // Timestamps
  calculatedAt DateTime @default(now())
  expiresAt    DateTime

  // Relations
  company       Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer      Customer       @relation(fields: [customerId], references: [id], onDelete: Cascade)
  interventions Intervention[]

  @@index([companyId, customerId])
  @@index([companyId, calculatedAt]) // For date range analytics queries
  @@index([churnRisk, urgency])
  @@map("customer_intents")
}

model Intervention {
  id         String  @id @default(cuid())
  companyId  String
  customerId String
  intentId   String?

  // Intervention Details
  type    InterventionType
  channel DeliveryChannel
  stage   String? // For multi-stage flows

  // Content
  templateId String?
  content    Json? // Generated/customized content
  offers     Json? // Any offers presented

  // Execution
  status      InterventionStatus @default(PENDING)
  scheduledAt DateTime?
  executedAt  DateTime?

  // Outcome
  outcome        InterventionOutcome?
  outcomeDetails Json?
  revenueImpact  Float? // Positive = saved, Negative = lost

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company   Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer  Customer        @relation(fields: [customerId], references: [id], onDelete: Cascade)
  intent    CustomerIntent? @relation(fields: [intentId], references: [id])
  voiceCall VoiceCall?

  @@index([companyId, customerId])
  @@index([status, scheduledAt])
  @@index([type, outcome])
  @@map("interventions")
}

model SaveAttempt {
  id         String @id @default(cuid())
  companyId  String
  customerId String

  // Flow Tracking
  flowConfigId String
  startedAt    DateTime  @default(now())
  completedAt  DateTime?

  // Stage Progress
  currentStage Int  @default(1)
  stageHistory Json // Array of stage entries with timestamps

  // Diagnosis
  cancellationReason String?
  reasonCategory     String?

  // Outcome
  outcome       SaveOutcome?
  savedBy       String? // Which stage/offer saved them
  offerAccepted Json?

  // Attribution
  revenuePreserved Float? // LTV that was saved

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company  Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([companyId, customerId])
  @@index([outcome, savedBy])
  @@index([companyId, createdAt]) // For date range analytics queries
  @@map("save_attempts")
}

model VoiceCall {
  id             String  @id @default(cuid())
  companyId      String
  customerId     String
  interventionId String? @unique

  // Twilio Details
  twilioCallSid String        @unique
  direction     CallDirection
  fromNumber    String
  toNumber      String

  // Timing
  initiatedAt DateTime  @default(now())
  answeredAt  DateTime?
  endedAt     DateTime?
  duration    Int? // Seconds

  // AI Processing
  scriptId            String
  transcriptRaw       String? @db.Text
  transcriptProcessed Json? // Structured transcript with intents

  // Sentiment & Intent
  overallSentiment Sentiment?
  detectedIntents  String[]
  keyMoments       Json? // Important moments in call

  // Outcome
  status         VoiceCallStatus @default(INITIATED)
  outcome        CallOutcome?
  outcomeDetails Json?

  // Offers & Actions
  offersPresented Json?
  offerAccepted   Json?
  actionsTaken    Json? // Pause, discount, escalate, etc.

  // Escalation
  escalatedToHuman Boolean @default(false)
  escalationReason String?
  humanAgentId     String?

  // Quality
  qualityScore Float? // 0-100
  qualityNotes String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company      Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer     Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  intervention Intervention? @relation(fields: [interventionId], references: [id])
  csAIUsage    CSAIUsage[]

  @@index([companyId, customerId])
  @@index([twilioCallSid])
  @@index([status, outcome])
  @@index([companyId, initiatedAt]) // For date range analytics queries
  @@map("voice_calls")
}

model UpsellOffer {
  id         String @id @default(cuid())
  companyId  String
  customerId String

  // Offer Details
  type      UpsellType
  moment    UpsellMoment
  productId String?

  // Presentation
  contentId String? // Link to GeneratedContent
  position  String // Where shown in flow

  // Offer Terms
  originalPrice Float?
  offerPrice    Float?
  discount      Float?
  validUntil    DateTime?

  // Behavioral Config
  triggerUsed String? // Which trigger presented this

  // Outcome
  presented   Boolean   @default(false)
  presentedAt DateTime?
  accepted    Boolean?
  acceptedAt  DateTime?
  revenue     Float? // If accepted

  // Attribution
  attributionWindow Int? // Hours

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company  Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([companyId, customerId])
  @@index([companyId, createdAt]) // For date range analytics queries
  @@index([type, moment, accepted])
  @@map("upsell_offers")
}

model UpsellConfig {
  id        String @id @default(cuid())
  companyId String @unique

  enabled           Boolean @default(true)
  aiRecommendations Boolean @default(true)

  // Frequency limits (JSON)
  globalLimits Json // { maxPresentationsPerDay, maxPresentationsPerWeek, cooldownAfterDecline, cooldownAfterAccept }

  // Channel settings (JSON)
  channelDefaults Json @default("{}") // Per-channel configuration

  // AI settings (JSON)
  aiSettings Json // { minConfidence, minRelevanceScore, maxRecommendations, optimizeFor }

  // Behavioral triggers (JSON)
  triggerSettings Json // { enabledTriggers, triggerConfigs }

  // A/B testing (JSON)
  abTesting Json @default("{\"enabled\": false, \"defaultTrafficSplit\": 50}")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("upsell_configs")
}

model SaveFlowConfig {
  id        String @id @default(cuid())
  companyId String @unique

  enabled Boolean @default(true)

  // Stage Configurations (JSON for flexibility)
  patternInterrupt       Json
  diagnosisSurvey        Json
  branchingInterventions Json
  nuclearOffer           Json
  lossVisualization      Json
  exitSurvey             Json
  winback                Json

  // Voice AI Settings
  voiceAIEnabled Boolean @default(false)
  voiceAIConfig  Json?

  // A/B Testing
  activeExperiments Json?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("save_flow_configs")
}

model VoiceScript {
  id        String @id @default(cuid())
  companyId String

  // Script Details
  name        String
  type        VoiceScriptType
  description String?

  // Script Content (JSON for flexibility)
  opening            Json // greeting, patternInterrupt, acknowledgment
  diagnosis          Json // primaryQuestion, followUpQuestions, sentimentResponses
  interventions      Json // condition-based responses with offers
  objectionHandling  Json // objection-response pairs
  closing            Json // acceptOffer, declineOffer, escalateToHuman, scheduleCallback
  behavioralTriggers Json // stage-based trigger configuration

  // Status
  isActive  Boolean @default(true)
  isDefault Boolean @default(false)

  // Performance
  usageCount      Int    @default(0)
  avgSaveRate     Float?
  avgCallDuration Float?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, name])
  @@index([companyId, type])
  @@map("voice_scripts")
}

model BehavioralTrigger {
  id String @id @default(cuid())

  // Trigger Details
  name        String  @unique
  displayName String
  description String?
  category    String // e.g., "urgency", "social_proof", "loss_aversion"

  // Implementation Guide (JSON)
  implementation Json // pricing, headlines, visuals guidance
  examples       String[]

  // Usage Stats
  usageCount       Int    @default(0)
  avgEffectiveness Float?

  // Status
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@map("behavioral_triggers")
}

model MomentumAnalytics {
  id          String   @id @default(cuid())
  companyId   String
  periodStart DateTime
  periodEnd   DateTime

  // Save Metrics
  totalSaveAttempts Int   @default(0)
  successfulSaves   Int   @default(0)
  saveRate          Float @default(0)
  revenuePreserved  Float @default(0)

  // Stage Performance (JSON)
  stageMetrics Json // Performance by stage

  // Channel Performance
  emailSaves Int @default(0)
  smsSaves   Int @default(0)
  voiceSaves Int @default(0)
  inAppSaves Int @default(0)

  // Voice AI Metrics
  totalCalls      Int   @default(0)
  avgCallDuration Float @default(0)
  voiceSaveRate   Float @default(0)

  // Content Performance
  contentGenerated     Int   @default(0)
  topPerformingContent Json?

  // Upsell Metrics
  upsellsPresented Int   @default(0)
  upsellsAccepted  Int   @default(0)
  upsellRevenue    Float @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, periodStart, periodEnd])
  @@index([companyId])
  @@index([periodStart, periodEnd])
  @@map("momentum_analytics")
}

// =============================================================================
// MOMENTUM INTELLIGENCE ENUMS
// =============================================================================

enum ChurnRiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum InterventionType {
  SAVE_FLOW
  PROACTIVE_OUTREACH
  PAYMENT_RECOVERY
  WINBACK
  UPSELL
  SERVICE_RECOVERY
}

enum InterventionUrgency {
  IMMEDIATE
  WITHIN_24H
  WITHIN_7D
  MONITORING
}

enum InterventionStatus {
  PENDING
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED
}

enum InterventionOutcome {
  SAVED
  OFFER_ACCEPTED
  DOWNGRADED
  PAUSED
  CANCELLED
  NO_RESPONSE
  ESCALATED
}

enum DeliveryChannel {
  EMAIL
  SMS
  VOICE
  IN_APP
  WEBHOOK
}

enum SaveOutcome {
  SAVED_STAGE_1
  SAVED_STAGE_2
  SAVED_STAGE_3
  SAVED_STAGE_4
  SAVED_STAGE_5
  SAVED_VOICE
  CANCELLED
  PAUSED
  DOWNGRADED
}

enum CallDirection {
  INBOUND
  OUTBOUND
}

enum VoiceCallStatus {
  INITIATED
  RINGING
  IN_PROGRESS
  COMPLETED
  FAILED
  BUSY
  NO_ANSWER
}

enum CallOutcome {
  SAVED
  OFFER_ACCEPTED
  DECLINED
  ESCALATED_TO_HUMAN
  CALLBACK_SCHEDULED
  DISCONNECTED
}

enum Sentiment {
  POSITIVE
  NEUTRAL
  NEGATIVE
  ANGRY
}

enum ContentType {
  EMAIL_SEQUENCE
  SMS_MESSAGE
  VOICE_SCRIPT
  AD_COPY
  LANDING_PAGE
  IN_APP_MODAL
  PUSH_NOTIFICATION
}

enum ContentStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  ACTIVE
  ARCHIVED
}

enum UpsellMoment {
  CHECKOUT
  POST_PURCHASE
  DAY_7
  DAY_14
  DAY_30
  MONTH_2
  MONTH_3
  SAVE_FLOW
  WINBACK
}

enum VoiceScriptType {
  INBOUND_SAVE
  OUTBOUND_SAVE
  WINBACK
  UPSELL
}

// =============================================================================
// MOMENTUM INTELLIGENCE - INTENT DETECTION (Enhanced)
// =============================================================================

model IntentDetection {
  id         String  @id @default(cuid())
  companyId  String
  customerId String
  sessionId  String?

  // Primary intent
  primaryIntent     String
  primaryConfidence Float

  // Secondary intents (JSON array)
  secondaryIntents Json @default("[]")

  // Cancel-specific
  cancelReason           String?
  cancelReasonConfidence Float?

  // Sentiment
  sentiment      String
  sentimentScore Float

  // Urgency
  urgency String

  // Source
  source     String
  sourceData Json?

  // Timestamps
  detectedAt DateTime @default(now())
  createdAt  DateTime @default(now())

  @@index([companyId])
  @@index([customerId])
  @@index([primaryIntent])
  @@index([detectedAt])
  @@map("intent_detections")
}

model ChurnSignal {
  id         String   @id @default(cuid())
  customerId String
  signalType String
  weight     Float
  value      String
  confidence Float    @default(0.8)
  decayDays  Int
  detectedAt DateTime @default(now())
  expiresAt  DateTime
  metadata   Json?

  @@index([customerId])
  @@index([signalType])
  @@index([expiresAt])
  @@map("churn_signals")
}

model ChurnRiskScore {
  id                 String    @id @default(cuid())
  customerId         String    @unique
  companyId          String
  score              Float
  riskLevel          String
  signalBreakdown    Json
  trend              String
  trendDelta         Float
  predictedChurnDate DateTime?
  recommendedActions String[]  @default([])
  calculatedAt       DateTime  @default(now())
  nextCalculationAt  DateTime

  @@index([companyId])
  @@index([riskLevel])
  @@index([score])
  @@map("churn_risk_scores")
}

model CustomerEngagementMetrics {
  id         String @id @default(cuid())
  customerId String @unique
  companyId  String

  // Login/Activity
  lastLoginAt         DateTime?
  loginFrequency      Float     @default(0)
  loginFrequencyTrend Float     @default(0)

  // Feature usage
  featuresUsed      String[] @default([])
  featureUsageScore Float    @default(0)

  // Order metrics
  totalOrders         Int   @default(0)
  ordersLast30Days    Int   @default(0)
  ordersLast90Days    Int   @default(0)
  orderFrequencyTrend Float @default(0)

  // Skip behavior
  totalSkips      Int   @default(0)
  skipsLast30Days Int   @default(0)
  skipRate        Float @default(0)

  // Support
  supportTicketsTotal      Int   @default(0)
  supportTicketsLast30Days Int   @default(0)
  avgTicketResolutionHours Float @default(0)

  // Feedback
  lastNpsScore          Int?
  lastNpsDate           DateTime?
  lastFeedbackSentiment String?

  // Scores
  engagementScore Float @default(50)
  healthScore     Float @default(50)

  calculatedAt DateTime @default(now())

  @@index([companyId])
  @@index([engagementScore])
  @@index([healthScore])
  @@map("customer_engagement_metrics")
}

// =============================================================================
// CUSTOMER SERVICE MANAGEMENT
// Two-Tier AI Customer Service System (AI Rep + AI Manager + Human)
// =============================================================================

model CSSession {
  id         String @id @default(cuid())
  companyId  String
  customerId String

  // Session Details
  channel     String // voice, chat, email, sms
  currentTier CSTier          @default(AI_REP)
  status      CSSessionStatus @default(ACTIVE)

  // Issue
  issueCategory String?
  issueSummary  String?

  // Sentiment Tracking
  customerSentiment String @default("NEUTRAL")
  sentimentHistory  Json   @default("[]")

  // Escalation
  escalationHistory Json @default("[]")

  // Context
  context Json @default("{}")

  // Resolution
  resolutionType       String?
  resolutionSummary    String?
  resolutionActions    Json?
  customerSatisfaction Int?
  followUpRequired     Boolean   @default(false)
  followUpDate         DateTime?

  // Timestamps
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  resolvedAt DateTime?

  // Relations
  messages       CSMessage[]
  refunds        Refund[]
  rmas           RMA[]
  csAIUsage      CSAIUsage[]
  funnelSessions FunnelSession[]

  @@index([companyId])
  @@index([customerId])
  @@index([status])
  @@index([currentTier])
  @@map("cs_sessions")
}

model CSMessage {
  id        String  @id @default(cuid())
  sessionId String
  role      String // customer, ai_rep, ai_manager, human_agent, system
  content   String  @db.Text
  sentiment String?
  metadata  Json?

  // Timestamps
  createdAt DateTime @default(now())

  // Relations
  session CSSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@map("cs_messages")
}

model CSConfig {
  id        String @id @default(cuid())
  companyId String @unique

  enabled Boolean @default(true)

  // Tier configurations (JSON)
  aiRepConfig      Json
  aiManagerConfig  Json
  humanAgentConfig Json

  // Irate customer protocol
  irateProtocol Json

  // Channel configurations
  channelConfigs Json

  // Business hours
  businessHours Json

  // Response templates
  responseTemplates Json @default("[]")

  // Integrations
  integrations Json @default("{}")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("cs_configs")
}

// =============================================================================
// CS AI BILLING & USAGE TRACKING
// =============================================================================

model CSAIUsage {
  id        String @id @default(cuid())
  companyId String
  clientId  String

  // Session/Call Reference
  csSessionId String?
  voiceCallId String?

  // Usage Type
  usageType CSAIUsageType
  tier      CSTier
  channel   String // voice, chat, email, sms

  // Duration Tracking (for voice/chat)
  durationSeconds Int?

  // Message/Token Tracking (for chat/AI)
  messageCount   Int @default(0)
  aiMessageCount Int @default(0)
  inputTokens    Int @default(0)
  outputTokens   Int @default(0)

  // Twilio Costs (for voice)
  twilioMinutes   Decimal? @db.Decimal(10, 4)
  twilioCostCents Int?

  // Cost Calculation (in cents)
  baseCost   Int @default(0)
  markupCost Int @default(0)
  totalCost  Int @default(0)

  // Billing Status
  billingPeriod String? // '2025-12'
  invoiced      Boolean   @default(false)
  invoicedAt    DateTime?
  invoiceId     String?

  // Metadata
  metadata Json?

  // Timestamps
  occurredAt DateTime @default(now())
  createdAt  DateTime @default(now())

  // Relations
  company   Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  csSession CSSession? @relation(fields: [csSessionId], references: [id])
  voiceCall VoiceCall? @relation(fields: [voiceCallId], references: [id])

  @@index([companyId, occurredAt])
  @@index([clientId, billingPeriod])
  @@index([usageType, occurredAt])
  @@index([invoiced])
  @@map("cs_ai_usage")
}

model CSAIPricing {
  id             String @id @default(cuid())
  organizationId String @unique

  // Voice Call Pricing (per minute, in cents)
  voicePerMinuteCents Int @default(50) // $0.50/min

  // Chat Session Pricing
  chatPerMessageCents Int @default(5) // $0.05/message
  chatPerSessionCents Int @default(100) // $1.00/session base

  // AI Token Pricing (per 1000 tokens, in cents)
  inputTokenPrice  Int @default(3) // $0.03 per 1K
  outputTokenPrice Int @default(15) // $0.15 per 1K

  // Tier Multipliers
  aiRepMultiplier      Float @default(1.0) // Base rate
  aiManagerMultiplier  Float @default(1.5) // 50% more
  humanAgentMultiplier Float @default(3.0) // 3x rate

  // Monthly Allowances (included in base plan)
  monthlyMinutesAllowance  Int @default(100) // 100 minutes/month
  monthlyMessagesAllowance Int @default(500) // 500 messages/month

  // Overage Pricing (after allowance)
  overageVoicePerMinuteCents Int @default(75) // $0.75/min overage
  overageChatPerMessageCents Int @default(8) // $0.08/message overage

  // Feature Flags
  csAIEnabled Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("cs_ai_pricing")
}

model CSAIUsageSummary {
  id        String @id @default(cuid())
  companyId String
  clientId  String

  // Billing Period
  periodStart DateTime
  periodEnd   DateTime

  // Voice Usage
  totalVoiceMinutes Decimal @db.Decimal(10, 2) @default(0)
  totalVoiceCalls   Int     @default(0)
  voiceCostCents    Int     @default(0)

  // Chat Usage
  totalChatSessions Int @default(0)
  totalChatMessages Int @default(0)
  chatCostCents     Int @default(0)

  // AI Token Usage
  totalInputTokens  Int @default(0)
  totalOutputTokens Int @default(0)
  aiTokenCostCents  Int @default(0)

  // Usage by Tier
  aiRepMinutes      Decimal @db.Decimal(10, 2) @default(0)
  aiManagerMinutes  Decimal @db.Decimal(10, 2) @default(0)
  humanAgentMinutes Decimal @db.Decimal(10, 2) @default(0)

  // Costs
  totalBaseCost   Int @default(0)
  totalMarkupCost Int @default(0)
  totalCost       Int @default(0)

  // Allowances
  allowanceUsedMinutes  Int @default(0)
  allowanceUsedMessages Int @default(0)
  overageMinutes        Int @default(0)
  overageMessages       Int @default(0)

  // Billing Status
  invoiced   Boolean   @default(false)
  invoicedAt DateTime?
  invoiceId  String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, periodStart])
  @@index([clientId, periodStart])
  @@index([invoiced])
  @@map("cs_ai_usage_summary")
}

enum CSAIUsageType {
  VOICE_CALL
  CHAT_SESSION
  EMAIL_SUPPORT
  SMS_SUPPORT
}

// =============================================================================
// REFUND MANAGEMENT
// =============================================================================

model Refund {
  id          String  @id @default(cuid())
  companyId   String
  customerId  String
  orderId     String
  rmaId       String?
  csSessionId String?

  // Refund Details
  type          RefundType   @default(MANUAL)
  status        RefundStatus @default(PENDING)
  reason        RefundReason
  reasonDetails String?

  // Amount
  requestedAmount Decimal  @db.Decimal(10, 2)
  approvedAmount  Decimal? @db.Decimal(10, 2)
  currency        String   @default("USD")
  amountBreakdown Json?

  // Method
  method RefundMethod @default(ORIGINAL_PAYMENT)

  // Approval
  approvalLevel    String
  approvedBy       String?
  approvedAt       DateTime?
  rejectedBy       String?
  rejectedAt       DateTime?
  rejectionReason  String?
  autoApprovalRule String?

  // Processing
  paymentProcessor       String?
  processorTransactionId String?
  processedAt            DateTime?
  failureReason          String?
  retryCount             Int       @default(0)

  // Metadata
  initiatedBy    String // customer, ai_rep, ai_manager, human_agent, system
  channel        String?
  customerImpact String?
  fraudScore     Float?
  tags           String[] @default([])

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  // Relations
  company         Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer        Customer   @relation(fields: [customerId], references: [id])
  order           Order      @relation(fields: [orderId], references: [id])
  csSession       CSSession? @relation(fields: [csSessionId], references: [id])
  requestedByUser User?      @relation("RefundRequester", fields: [initiatedBy], references: [id])
  approvedByUser  User?      @relation("RefundApprover", fields: [approvedBy], references: [id])
  rejectedByUser  User?      @relation("RefundRejecter", fields: [rejectedBy], references: [id])

  @@index([companyId])
  @@index([customerId])
  @@index([orderId])
  @@index([status])
  @@index([type])
  @@map("refunds")
}

model RefundPolicy {
  id        String @id @default(cuid())
  companyId String @unique

  enabled Boolean @default(true)

  // Rules (JSON)
  generalRules        Json
  autoApprovalRules   Json @default("[]")
  tierLimits          Json
  reasonSpecificRules Json @default("[]")

  // Notifications
  notifications Json

  // Fraud prevention
  fraudPrevention Json

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("refund_policies")
}

// =============================================================================
// RMA (RETURN MERCHANDISE AUTHORIZATION)
// =============================================================================

model RMA {
  id          String  @id @default(cuid())
  rmaNumber   String  @unique
  companyId   String
  customerId  String
  orderId     String
  csSessionId String?

  // RMA Details
  type          RMAType      @default(RETURN)
  status        RMAStatus    @default(REQUESTED)
  reason        ReturnReason
  reasonDetails String?

  // Items
  items Json // Array of RMAItem

  // Shipping
  labelType      String // prepaid, customer_paid, pickup
  carrier        String?
  trackingNumber String?
  trackingUrl    String?
  labelUrl       String?
  labelSentAt    DateTime?
  shippedAt      DateTime?
  deliveredAt    DateTime?
  returnAddress  Json

  // Inspection
  inspectionStatus String?
  inspectionResult String?
  inspectionNotes  String?
  inspectionPhotos String[]  @default([])
  inspectedAt      DateTime?
  inspectedBy      String?

  // Resolution
  resolutionType   String @default("refund")
  resolutionStatus String @default("pending")
  resolutionData   Json?

  // Timeline
  timeline Json @default("[]")

  // Metadata
  initiatedBy   String
  channel       String?
  priority      String   @default("normal")
  tags          String[] @default([])
  internalNotes String?

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  expiresAt   DateTime
  completedAt DateTime?

  // Relations
  csSession CSSession? @relation(fields: [csSessionId], references: [id])

  @@index([companyId])
  @@index([customerId])
  @@index([orderId])
  @@index([status])
  @@index([rmaNumber])
  @@map("rmas")
}

model RMAPolicy {
  id        String @id @default(cuid())
  companyId String @unique

  enabled Boolean @default(true)

  // Rules (JSON)
  generalRules     Json
  returnReasons    Json @default("[]")
  shippingConfig   Json
  inspectionConfig Json
  resolutionConfig Json

  // Notifications
  notifications Json

  // Automation
  automation Json

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("rma_policies")
}

// =============================================================================
// TERMS & CONDITIONS
// =============================================================================

model TermsDocument {
  id        String @id @default(cuid())
  companyId String

  // Document Details
  type    TermsType
  title   String
  version String
  status  TermsStatus @default(DRAFT_TERMS)

  // Content
  fullText      String  @db.Text
  htmlFormatted String? @db.Text
  sections      Json    @default("[]")
  language      String  @default("en")
  translations  Json?

  // Readability
  readabilityScore  Int @default(0)
  wordCount         Int @default(0)
  estimatedReadTime Int @default(0)

  // Metadata
  author         String?
  lastModifiedBy String?
  reviewedBy     String?
  approvedBy     String?
  approvedAt     DateTime?
  generatedBy    String? // human, ai, hybrid
  aiModel        String?
  tags           String[]  @default([])
  internalNotes  String?
  externalUrl    String?

  // Compliance
  complianceFrameworks   String[] @default([])
  jurisdictions          String[] @default([])
  complianceRequirements Json     @default("[]")

  // History
  history Json @default("[]")

  // Dates
  effectiveDate  DateTime?
  expirationDate DateTime?

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  // Relations
  summaries   TermsSummary[]
  acceptances TermsAcceptance[]

  @@index([companyId])
  @@index([type])
  @@index([status])
  @@map("terms_documents")
}

model TermsSummary {
  id              String @id @default(cuid())
  termsDocumentId String

  // Summary Details
  format String // bullet_points, faq, plain_language, key_points, comparison
  level  String // simple, standard, technical, legal

  content         String @db.Text
  keyPoints       Json?
  faqs            Json?
  importantDates  Json?
  userRights      Json?
  userObligations Json?

  language String @default("en")

  // Timestamps
  createdAt DateTime @default(now())

  // Relations
  termsDocument TermsDocument @relation(fields: [termsDocumentId], references: [id], onDelete: Cascade)

  @@index([termsDocumentId])
  @@map("terms_summaries")
}

model TermsAcceptance {
  id              String  @id @default(cuid())
  termsDocumentId String
  termsVersion    String
  customerId      String
  userId          String?

  // Acceptance Details
  acceptanceMethod String // checkbox, click, signature, verbal, implicit

  // Context
  ipAddress  String?
  userAgent  String?
  location   String?
  deviceType String?
  channel    String?

  // Withdrawal
  withdrawnAt      DateTime?
  withdrawalReason String?

  // Timestamps
  acceptedAt DateTime @default(now())

  // Relations
  termsDocument TermsDocument @relation(fields: [termsDocumentId], references: [id])

  @@index([termsDocumentId])
  @@index([customerId])
  @@index([acceptedAt])
  @@map("terms_acceptances")
}

model TermsAnalytics {
  id              String @id @default(cuid())
  termsDocumentId String

  // Views
  totalViews    Int   @default(0)
  uniqueViews   Int   @default(0)
  avgTimeOnPage Float @default(0)

  // Acceptances
  totalAcceptances Int   @default(0)
  acceptanceRate   Float @default(0)

  // Section engagement
  sectionViews Json @default("{}")

  // Search
  searchQueries Json @default("[]")

  // FAQ clicks
  faqClicks Json @default("{}")

  // Period
  periodStart DateTime
  periodEnd   DateTime

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([termsDocumentId, periodStart, periodEnd])
  @@index([termsDocumentId])
  @@map("terms_analytics")
}

// =============================================================================
// CUSTOMER SERVICE ENUMS
// =============================================================================

enum CSTier {
  AI_REP
  AI_MANAGER
  HUMAN_AGENT
}

enum CSSessionStatus {
  ACTIVE
  WAITING_CUSTOMER
  ESCALATED
  RESOLVED
  ABANDONED
}

// =============================================================================
// REFUND ENUMS
// =============================================================================

enum RefundStatus {
  PENDING
  APPROVED
  PROCESSING
  COMPLETED
  REJECTED
  CANCELLED
  FAILED
}

enum RefundType {
  AUTO
  MANUAL
  FULL
  PARTIAL
  BULK
  MANAGER_OVERRIDE
}

enum RefundReason {
  PRODUCT_DEFECT
  DAMAGED_ITEM
  WRONG_ITEM
  NOT_AS_DESCRIBED
  SHIPPING_DAMAGE
  SHIPPING_ISSUE
  NEVER_RECEIVED
  DUPLICATE_CHARGE
  DUPLICATE_ORDER
  SUBSCRIPTION_CANCELLATION
  CUSTOMER_REQUEST
  SERVICE_ISSUE
  QUALITY_ISSUE
  LATE_DELIVERY
  PRICE_MATCH
  GOODWILL
  FRAUD
  OTHER
  OTHER_REASON
}

enum RefundMethod {
  ORIGINAL_PAYMENT
  STORE_CREDIT
  GIFT_CARD
  CHECK_PAYMENT
  BANK_TRANSFER
}

// =============================================================================
// RMA ENUMS
// =============================================================================

enum RMAStatus {
  REQUESTED
  RMA_APPROVED
  LABEL_SENT
  RMA_IN_TRANSIT
  RECEIVED
  INSPECTING
  INSPECTION_COMPLETE
  PROCESSING_REFUND
  RMA_COMPLETED
  RMA_REJECTED
  RMA_CANCELLED
  RMA_EXPIRED
}

enum RMAType {
  RETURN
  EXCHANGE
  WARRANTY
  REPAIR
  RECALL
}

enum ReturnReason {
  DEFECTIVE
  WRONG_SIZE
  WRONG_COLOR
  WRONG_ITEM_RECEIVED
  NOT_AS_DESCRIBED_RETURN
  DAMAGED_IN_SHIPPING
  ARRIVED_LATE
  NO_LONGER_NEEDED
  BETTER_PRICE_FOUND
  QUALITY_NOT_EXPECTED
  ACCIDENTAL_ORDER
  WARRANTY_CLAIM
  RECALL_RETURN
  OTHER_RETURN_REASON
}

// =============================================================================
// TERMS ENUMS
// =============================================================================

enum TermsType {
  TERMS_OF_SERVICE
  PRIVACY_POLICY
  REFUND_POLICY_DOC
  SHIPPING_POLICY
  SUBSCRIPTION_TERMS
  COOKIE_POLICY
  ACCEPTABLE_USE
  DATA_PROCESSING
  SLA
  CUSTOM_TERMS
}

enum TermsStatus {
  DRAFT_TERMS
  PENDING_REVIEW
  TERMS_APPROVED
  TERMS_ACTIVE
  TERMS_ARCHIVED
  SUPERSEDED
}

// =============================================================================
// OAUTH & INTEGRATION AUTH ENUMS
// =============================================================================

enum AuthType {
  API_KEY // Traditional API key authentication
  OAUTH2 // OAuth 2.0 authorization code flow
  OAUTH2_CLIENT // OAuth 2.0 client credentials flow
  BASIC_AUTH // Basic HTTP authentication
  CUSTOM // Custom authentication (webhook-based, etc.)
}

enum OAuthTokenStatus {
  ACTIVE // Token is valid and can be used
  EXPIRED // Token has expired, needs refresh
  REFRESH_FAILED // Refresh attempt failed
  REVOKED // Token was revoked by user or provider
  INVALID // Token is invalid (e.g., changed permissions)
}

enum OAuthFlowType {
  PLATFORM // Platform-level integration (org admin connecting)
  CLIENT // Client-level integration (client connecting their own)
}

// =============================================================================
// CONTENT GENERATION
// =============================================================================

model ContentTemplate {
  id        String @id @default(cuid())
  companyId String

  name        String
  description String?
  type        String
  purpose     String
  status      String  @default("DRAFT")

  subject   String?
  preheader String?
  body      String
  bodyHtml  String?

  variables Json @default("[]")

  aiGenerated Boolean @default(false)
  aiProvider  String?
  aiPrompt    String?

  triggersApplied String[] @default([])
  triggerConfig   Json?

  personalizationLevel String @default("basic")
  dynamicSections      Json?

  usageCount     Int    @default(0)
  conversionRate Float?
  openRate       Float?
  clickRate      Float?

  version           Int     @default(1)
  previousVersionId String?

  createdBy   String
  publishedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([type])
  @@index([purpose])
  @@index([status])
  @@map("content_templates")
}

model GeneratedContent {
  id         String  @id @default(cuid())
  companyId  String
  templateId String?

  type     String
  purpose  String
  provider String

  prompt       String
  systemPrompt String?

  subject  String?
  body     String
  bodyHtml String?

  variations          Json?
  selectedVariationId String?

  customerId      String?
  customerContext Json?

  triggersApplied     String[] @default([])
  triggerApplications Json?

  qualityScore     Float?
  readabilityScore Float?
  sentimentScore   Float?

  tokensUsed       Int    @default(0)
  generationTimeMs Int    @default(0)
  cost             Float?

  status      String    @default("GENERATED")
  reviewedBy  String?
  reviewedAt  DateTime?
  reviewNotes String?

  createdAt DateTime @default(now())

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([type])
  @@index([purpose])
  @@index([status])
  @@map("generated_contents")
}

model ContentGenerationConfig {
  id        String @id @default(cuid())
  companyId String @unique

  providers       Json
  claude          Json
  ollama          Json
  quality         Json
  triggers        Json
  brandVoice      Json
  personalization Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("content_generation_configs")
}

// =============================================================================
// DELIVERY ORCHESTRATION
// =============================================================================

model DeliveryMessage {
  id         String @id @default(cuid())
  companyId  String
  customerId String

  recipientEmail        String?
  recipientPhone        String?
  recipientDeviceTokens String[] @default([])

  channel  String
  priority String @default("NORMAL")

  templateId String?
  contentId  String?
  subject    String?
  body       String
  bodyHtml   String?

  category String
  tags     String[] @default([])

  scheduleType      String    @default("IMMEDIATE")
  scheduledFor      DateTime?
  optimalSendWindow Json?

  status        String @default("PENDING")
  statusHistory Json   @default("[]")

  providerMessageId String?
  sentAt            DateTime?
  deliveredAt       DateTime?
  openedAt          DateTime?
  clickedAt         DateTime?
  convertedAt       DateTime?
  failedAt          DateTime?
  failureReason     String?

  opensCount   Int      @default(0)
  clicksCount  Int      @default(0)
  clickedLinks String[] @default([])

  variantId    String?
  experimentId String?

  automationId     String?
  automationStepId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([companyId, createdAt]) // For date range analytics queries
  @@index([customerId])
  @@index([status])
  @@index([scheduledFor])
  @@map("delivery_messages")
}

model DeliveryRetry {
  id               String    @id @default(cuid())
  messageId        String
  retriesRemaining Int
  lastRetryAt      DateTime?
  nextRetryAt      DateTime

  @@index([messageId])
  @@index([nextRetryAt])
  @@map("delivery_retries")
}

model CustomerPreference {
  id             String    @id @default(cuid())
  customerId     String
  channel        String
  unsubscribed   Boolean   @default(false)
  unsubscribedAt DateTime?

  @@unique([customerId, channel])
  @@map("customer_preferences")
}

model DeliveryConfig {
  id        String @id @default(cuid())
  companyId String @unique

  channelPriority String[]
  defaultChannel  String

  sendTimeOptimization Json
  globalRateLimits     Json

  honorUnsubscribes Boolean @default(true)
  doubleOptIn       Boolean @default(false)

  trackOpens       Boolean @default(true)
  trackClicks      Boolean @default(true)
  trackConversions Boolean @default(true)

  retrySettings Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("delivery_configs")
}

model Automation {
  id        String @id @default(cuid())
  companyId String

  name        String
  description String?
  category    String
  status      String  @default("DRAFT")

  trigger Json
  steps   Json

  settings Json

  enrollmentCount Int    @default(0)
  completionCount Int    @default(0)
  conversionCount Int    @default(0)
  conversionRate  Float?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  activatedAt DateTime?

  enrollments AutomationEnrollment[]

  @@index([companyId])
  @@index([status])
  @@map("automations")
}

model AutomationEnrollment {
  id           String @id @default(cuid())
  automationId String
  customerId   String

  status String @default("ACTIVE")

  currentStepId        String?
  currentStepStartedAt DateTime?

  stepsCompleted String[] @default([])
  messagesSent   String[] @default([])

  triggerData Json?

  enrolledAt  DateTime  @default(now())
  completedAt DateTime?
  exitedAt    DateTime?
  exitReason  String?

  convertedAt     DateTime?
  conversionValue Decimal?  @db.Decimal(10, 2)

  automation Automation @relation(fields: [automationId], references: [id])

  @@index([automationId])
  @@index([customerId])
  @@index([status])
  @@map("automation_enrollments")
}

// =============================================================================
// ANALYTICS & REPORTING
// =============================================================================

model AnalyticsReport {
  id        String @id @default(cuid())
  companyId String

  name        String
  description String?

  metrics       Json // Array of MetricCategory
  customMetrics Json? // Custom metric definitions

  filters  Json // Date range, segments, products, channels
  schedule Json? // Frequency, day, time, timezone
  delivery Json // Format, recipients, options

  isActive Boolean @default(true)

  lastGeneratedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([isActive])
  @@map("analytics_reports")
}

model AnalyticsSnapshot {
  id        String @id @default(cuid())
  companyId String

  snapshotDate DateTime
  granularity  String // hour, day, week, month

  // Churn metrics
  churnRate        Float   @default(0)
  churnedCustomers Int     @default(0)
  churnedRevenue   Decimal @default(0) @db.Decimal(10, 2)

  // Save flow metrics
  saveAttempts    Int     @default(0)
  successfulSaves Int     @default(0)
  saveRate        Float   @default(0)
  revenueSaved    Decimal @default(0) @db.Decimal(10, 2)

  // Voice metrics
  totalCalls      Int   @default(0)
  avgCallDuration Float @default(0)
  callSaveRate    Float @default(0)

  // Delivery metrics
  messagesSent      Int   @default(0)
  messagesDelivered Int   @default(0)
  deliveryRate      Float @default(0)
  openRate          Float @default(0)
  clickRate         Float @default(0)

  // Upsell metrics
  upsellsPresented     Int     @default(0)
  upsellsConverted     Int     @default(0)
  upsellConversionRate Float   @default(0)
  upsellRevenue        Decimal @default(0) @db.Decimal(10, 2)

  // Revenue metrics
  totalRevenue        Decimal @default(0) @db.Decimal(10, 2)
  recurringRevenue    Decimal @default(0) @db.Decimal(10, 2)
  netRevenueRetention Float   @default(0)

  // Active customers
  activeSubscriptions Int @default(0)
  atRiskCustomers     Int @default(0)

  createdAt DateTime @default(now())

  @@unique([companyId, snapshotDate, granularity])
  @@index([companyId])
  @@index([snapshotDate])
  @@map("analytics_snapshots")
}

model DashboardAlert {
  id        String @id @default(cuid())
  companyId String

  type     String // warning, critical, info, success
  category String // churn, save_flow, delivery, upsell, revenue, engagement
  title    String
  message  String

  metric       String?
  threshold    Float?
  currentValue Float?
  actionUrl    String?

  acknowledgedAt DateTime?
  acknowledgedBy String?

  dismissedAt DateTime?
  dismissedBy String?

  createdAt DateTime @default(now())

  @@index([companyId])
  @@index([type])
  @@index([category])
  @@index([createdAt])
  @@map("dashboard_alerts")
}

// =============================================================================
// INTEGRATIONS FRAMEWORK
// =============================================================================

model IntegrationDefinition {
  id                 String   @id @default(cuid())
  provider           String   @unique
  category           String
  name               String
  description        String
  logoUrl            String?
  documentationUrl   String?
  isOrgOnly          Boolean  @default(false)
  isClientAllowed    Boolean  @default(true)
  isPlatformOffered  Boolean  @default(false)
  credentialSchema   Json
  settingsSchema     Json     @default("{}")
  requiredCompliance String[] @default([])
  status             String   @default("active")

  // OAuth Configuration
  authType    AuthType @default(API_KEY)
  oauthConfig Json? // OAuth-specific config: authorizationUrl, tokenUrl, scopes, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("integration_definitions")
}

// OAuth Token Storage for OAuth-based integrations
model OAuthToken {
  id String @id @default(cuid())

  // Ownership - can be platform-level or client-level
  platformIntegrationId String?
  clientIntegrationId   String?

  // Token data (encrypted)
  accessToken  String  @db.Text
  refreshToken String? @db.Text
  tokenType    String  @default("Bearer")

  // Expiration tracking
  expiresAt        DateTime?
  refreshExpiresAt DateTime?

  // Scopes granted
  scopes String[] @default([])

  // Provider-specific data
  providerUserId    String? // User ID at the OAuth provider
  providerAccountId String? // Account ID if different from user
  providerData      Json? // Additional provider-specific metadata

  // Encryption
  keyVersion Int @default(1)

  // Status
  status          OAuthTokenStatus @default(ACTIVE)
  lastRefreshedAt DateTime?
  lastUsedAt      DateTime?
  errorMessage    String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([platformIntegrationId])
  @@index([clientIntegrationId])
  @@index([status])
  @@index([expiresAt])
  @@map("oauth_tokens")
}

// OAuth State for CSRF protection during authorization flow
model OAuthState {
  id    String @id @default(cuid())
  state String @unique

  // Context for the OAuth flow
  provider       String
  organizationId String?
  clientId       String?
  userId         String

  // Flow type
  flowType OAuthFlowType @default(PLATFORM)

  // Redirect after completion
  redirectUrl String?

  // Additional context
  metadata Json?

  // Expiration (short-lived)
  expiresAt DateTime

  // Status
  usedAt DateTime?

  createdAt DateTime @default(now())

  @@index([state])
  @@index([expiresAt])
  @@map("oauth_states")
}

model PlatformIntegration {
  id                  String    @id @default(cuid())
  organizationId      String
  provider            String
  category            String
  name                String
  description         String?
  credentials         Json
  settings            Json      @default("{}")
  environment         String    @default("SANDBOX")
  isSharedWithClients Boolean   @default(false)
  clientPricing       Json?
  status              String    @default("PENDING")
  lastTestedAt        DateTime?
  lastTestResult      String?
  errorMessage        String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  createdBy           String
  updatedBy           String?

  organization       Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  clientIntegrations ClientIntegration[]
  usage              IntegrationUsage[]

  // Feature 04: Shared Gateway Risk Management
  gatewayPricingTiers   GatewayPricingTier[]
  gatewayTermsDocuments GatewayTermsDocument[]
  merchantRiskProfiles  MerchantRiskProfile[]

  @@unique([organizationId, provider])
  @@index([organizationId])
  @@map("platform_integrations")
}

model ClientIntegration {
  id                    String    @id @default(cuid())
  clientId              String
  provider              String
  category              String
  name                  String
  description           String?
  mode                  String    @default("OWN")
  credentials           Json?
  platformIntegrationId String?
  settings              Json      @default("{}")
  environment           String    @default("SANDBOX")
  usageThisMonth        Json?
  isDefault             Boolean   @default(false)
  priority              Int       @default(0)
  status                String    @default("PENDING")
  isVerified            Boolean   @default(false)
  verifiedAt            DateTime?
  verifiedBy            String?
  lastTestedAt          DateTime?
  lastTestResult        String?
  errorMessage          String?
  merchantAccountId     String?   @unique
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  createdBy             String
  updatedBy             String?

  client              Client               @relation(fields: [clientId], references: [id], onDelete: Cascade)
  platformIntegration PlatformIntegration? @relation(fields: [platformIntegrationId], references: [id])
  merchantAccount     MerchantAccount?     @relation(fields: [merchantAccountId], references: [id])
  usage               IntegrationUsage[]

  @@unique([clientId, provider, name])
  @@index([clientId])
  @@map("client_integrations")
}

// =============================================================================
// INTEGRATION USAGE TRACKING
// Tracks API usage for billing and metering platform-provided integrations
// =============================================================================

model IntegrationUsage {
  id String @id @default(cuid())

  // Company context (who made the request and will be billed)
  companyId String
  clientId  String

  // Integration reference
  provider              String // e.g., 'GOOGLE_PLACES'
  clientIntegrationId   String? // If using client's own integration
  platformIntegrationId String? // If using platform integration

  // Usage tracking
  usageType    String    @default("request") // 'request', 'session', 'transaction', etc.
  sessionToken String? // For session-based billing (e.g., Google Places)
  requestCount Int       @default(1) // Number of requests in this record
  timestamp    DateTime  @default(now())

  // Cost tracking
  baseCostCents    Int    @default(0) // Original API cost in cents
  markupPercent    Float  @default(40) // Platform markup percentage
  billableCents    Int    @default(0) // baseCost + markup
  currency         String @default("USD")

  // Billing status
  billingPeriod String? // e.g., '2025-12' for December 2025
  invoiceId     String? // Reference to invoice when billed
  billedAt      DateTime?

  // Request metadata
  endpoint     String? // API endpoint called
  metadata     Json?   // Additional context (request params, etc.)
  responseCode Int? // HTTP response code

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company             Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  client              Client               @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientIntegration   ClientIntegration?   @relation(fields: [clientIntegrationId], references: [id])
  platformIntegration PlatformIntegration? @relation(fields: [platformIntegrationId], references: [id])

  @@index([companyId])
  @@index([clientId])
  @@index([provider])
  @@index([billingPeriod])
  @@index([sessionToken])
  @@index([timestamp])
  @@map("integration_usage")
}

// =============================================================================
// SOFT DELETE & DELETION AUDIT LOG
// Enterprise soft delete system with cascade tracking and retention management
// =============================================================================

model DeletionLog {
  id String @id @default(cuid())

  // Entity identification
  entityType String // Model name: Client, Company, Customer, etc.
  entityId   String // ID of the deleted entity
  entityName String? // Friendly name for display

  // Company context (for access control)
  companyId String?

  // Who deleted
  deletedBy String // User ID who initiated deletion
  deletedAt DateTime @default(now())
  reason    String? // Optional deletion reason

  // Cascade tracking
  cascadeId    String? // Groups related cascade deletions
  cascadedFrom String? // Parent entity ID if cascade-deleted

  // Entity snapshot (for potential restoration)
  snapshot Json? // Full entity data at deletion time

  // Retention management
  expiresAt DateTime // When permanent purge is allowed

  // Restoration tracking
  restoredAt DateTime?
  restoredBy String?

  // Permanent deletion tracking
  purgedAt    DateTime?
  purgeReason String? // RETENTION_EXPIRED, GDPR_REQUEST, ADMIN_REQUEST

  // Relations
  deletedByUser User? @relation("UserDeletions", fields: [deletedBy], references: [id])

  @@index([entityType, entityId])
  @@index([companyId])
  @@index([cascadeId])
  @@index([deletedAt])
  @@index([restoredAt])
  @@index([expiresAt])
  @@map("deletion_logs")
}

// =============================================================================
// WEBHOOK NOTIFICATIONS
// =============================================================================

model Webhook {
  id        String @id @default(cuid())
  companyId String

  // Webhook details
  name   String
  url    String
  events String[] @default([])

  // Authentication
  secret  String?
  headers Json?   @default("{}")

  // Status
  isActive        Boolean   @default(true)
  lastTriggeredAt DateTime?
  lastStatus      String?
  failureCount    Int       @default(0)

  // Soft delete
  deletedAt DateTime?
  deletedBy String?
  cascadeId String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, name, deletedAt])
  @@index([companyId])
  @@index([deletedAt])
  @@map("webhooks")
}

// =============================================================================
// FEATURE 10: ENHANCED PRODUCTS SYSTEM
// Categories, Tags, Media, Price Rules
// =============================================================================

model Category {
  id        String  @id @default(cuid())
  companyId String
  parentId  String?

  name        String
  slug        String
  description String?
  imageUrl    String?

  // Hierarchy
  level Int    @default(0)
  path  String // Materialized path: "root/parent/child"

  // Display
  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  // SEO
  metaTitle       String?
  metaDescription String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Soft Delete
  deletedAt DateTime?
  deletedBy String?
  cascadeId String?

  // Relations
  company       Company                     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  parent        Category?                   @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children      Category[]                  @relation("CategoryHierarchy")
  products      ProductCategoryAssignment[]
  deletedByUser User?                       @relation("CategoryDeletedBy", fields: [deletedBy], references: [id])

  // Shopify-Inspired: Category Metafield Definitions
  metafieldDefinitions CategoryMetafieldDefinition[]

  @@unique([companyId, slug, deletedAt])
  @@unique([companyId, parentId, name, deletedAt])
  @@index([companyId, parentId])
  @@index([companyId, isActive])
  @@index([path])
  @@index([deletedAt])
  @@map("categories")
}

model ProductCategoryAssignment {
  id         String  @id @default(cuid())
  productId  String
  categoryId String
  isPrimary  Boolean @default(false)
  sortOrder  Int     @default(0)

  createdAt DateTime @default(now())

  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([productId, categoryId])
  @@index([categoryId])
  @@map("product_categories")
}

model Tag {
  id        String @id @default(cuid())
  companyId String

  name  String
  slug  String
  color String? // Hex color for UI

  createdAt DateTime @default(now())

  company  Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  products ProductTag[]

  @@unique([companyId, slug])
  @@index([companyId])
  @@map("tags")
}

model ProductTag {
  id        String @id @default(cuid())
  productId String
  tagId     String

  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([productId, tagId])
  @@index([tagId])
  @@map("product_tags")
}

model ProductMedia {
  id        String  @id @default(cuid())
  productId String
  variantId String? // Optional: variant-specific media

  type         MediaType
  url          String
  thumbnailUrl String?

  // Metadata
  filename String
  mimeType String
  size     Int // Bytes
  width    Int?
  height   Int?
  duration Int? // Seconds (for video)

  // Display
  altText   String?
  caption   String?
  sortOrder Int     @default(0)
  isPrimary Boolean @default(false)

  // AI Generation Info
  generatedBy        String? // 'RUNWAY', 'CLOUDINARY', etc.
  generationMetadata Json? // Task ID, settings used, etc.

  // Storage Info
  storageProvider String  @default("S3")
  storageKey      String // S3 key or path
  cdnUrl          String? // CloudFront URL

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@index([productId, type, sortOrder])
  @@index([variantId])
  @@map("product_media")
}

model ProductPriceRule {
  id        String @id @default(cuid())
  productId String

  name String
  type PriceRuleType

  // Conditions
  minQuantity     Int?
  maxQuantity     Int?
  customerGroupId String?
  startDate       DateTime?
  endDate         DateTime?

  // Adjustment
  adjustmentType  AdjustmentType
  adjustmentValue Decimal        @db.Decimal(10, 2)

  // Priority (higher wins)
  priority Int     @default(0)
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId, isActive])
  @@index([startDate, endDate])
  @@map("product_price_rules")
}

// =============================================================================
// FEATURE 10B: EXTENDED PRODUCTS
// Variants, Collections, Bundles, Inventory
// =============================================================================

model ProductVariant {
  id        String @id @default(cuid())
  productId String

  name    String // e.g., "Large / Red"
  sku     String
  barcode String?

  // Variant Options
  options Json // { "Size": "Large", "Color": "Red" }

  // Pricing (overrides product if set)
  price          Decimal? @db.Decimal(10, 2)
  compareAtPrice Decimal? @db.Decimal(10, 2)
  costPrice      Decimal? @db.Decimal(10, 2)

  // Physical (overrides product if set)
  weight Decimal? @db.Decimal(10, 3)

  // Inventory
  trackInventory    Boolean @default(true)
  inventoryQuantity Int     @default(0)
  lowStockThreshold Int?

  // Status
  isActive  Boolean @default(true)
  sortOrder Int     @default(0)

  // Soft Delete
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product         Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  media           ProductMedia[]
  inventoryLevels InventoryLevel[]
  bundleItems     BundleItem[]

  @@unique([productId, sku])
  @@index([productId, isActive, deletedAt])
  @@index([sku])
  @@map("product_variants")
}

model VariantOption {
  id        String @id @default(cuid())
  companyId String

  name        String // e.g., "Size", "Color"
  displayName String
  sortOrder   Int    @default(0)

  createdAt DateTime @default(now())

  company Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  values  VariantOptionValue[]

  @@unique([companyId, name])
  @@map("variant_options")
}

model VariantOptionValue {
  id       String @id @default(cuid())
  optionId String

  value        String // e.g., "Small", "Medium", "Large"
  displayValue String?
  colorCode    String? // Hex for color swatches
  imageUrl     String? // Image for visual options
  sortOrder    Int     @default(0)

  createdAt DateTime @default(now())

  option VariantOption @relation(fields: [optionId], references: [id], onDelete: Cascade)

  @@unique([optionId, value])
  @@map("variant_option_values")
}

model Collection {
  id        String @id @default(cuid())
  companyId String

  name        String
  slug        String
  description String?

  // Display
  imageUrl  String?
  bannerUrl String?

  // Type
  type CollectionType @default(MANUAL)

  // Auto-collection rules (if type = AUTOMATIC)
  rules Json? // { conditions: [...], match: 'all' | 'any' }

  // Publishing
  isActive    Boolean   @default(true)
  publishedAt DateTime?

  // SEO
  metaTitle       String?
  metaDescription String?

  // Display Order
  sortOrder Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company  Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  products CollectionProduct[]

  @@unique([companyId, slug])
  @@index([companyId, isActive])
  @@map("collections")
}

model CollectionProduct {
  id           String @id @default(cuid())
  collectionId String
  productId    String
  sortOrder    Int    @default(0)

  createdAt DateTime @default(now())

  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  product    Product    @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([collectionId, productId])
  @@index([productId])
  @@map("collection_products")
}

model Bundle {
  id        String @id @default(cuid())
  companyId String
  productId String @unique // Bundle IS a product

  // Bundle Settings
  type     BundleType @default(FIXED)
  minItems Int? // For MIX_AND_MATCH
  maxItems Int?

  // Pricing
  pricingStrategy BundlePricing   @default(FIXED)
  discountType    AdjustmentType?
  discountValue   Decimal?        @db.Decimal(10, 2)

  // Status
  isActive  Boolean   @default(true)
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  product Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  items   BundleItem[]

  @@index([companyId])
  @@map("bundles")
}

model BundleItem {
  id        String  @id @default(cuid())
  bundleId  String
  productId String
  variantId String?

  quantity   Int     @default(1)
  isRequired Boolean @default(true)
  sortOrder  Int     @default(0)

  // Override pricing for this item in bundle
  priceOverride Decimal? @db.Decimal(10, 2)

  createdAt DateTime @default(now())

  bundle  Bundle          @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@unique([bundleId, productId, variantId])
  @@map("bundle_items")
}

model InventoryLocation {
  id        String @id @default(cuid())
  companyId String

  name String
  code String
  type LocationType @default(WAREHOUSE)

  // Address
  address1   String?
  address2   String?
  city       String?
  state      String?
  postalCode String?
  country    String?

  isActive  Boolean @default(true)
  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company         Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  inventoryLevels InventoryLevel[]

  @@unique([companyId, code])
  @@map("inventory_locations")
}

model InventoryLevel {
  id         String  @id @default(cuid())
  locationId String
  productId  String?
  variantId  String?

  // Quantities
  onHand    Int @default(0)
  committed Int @default(0) // Reserved for orders
  incoming  Int @default(0) // Expected from POs
  available Int @default(0) // Computed: onHand - committed

  // Thresholds
  reorderPoint    Int?
  reorderQuantity Int?

  updatedAt DateTime @updatedAt

  location    InventoryLocation     @relation(fields: [locationId], references: [id], onDelete: Cascade)
  product     Product?              @relation(fields: [productId], references: [id])
  variant     ProductVariant?       @relation(fields: [variantId], references: [id])
  adjustments InventoryAdjustment[]

  @@unique([locationId, productId, variantId])
  @@index([productId])
  @@index([variantId])
  @@map("inventory_levels")
}

model InventoryAdjustment {
  id               String @id @default(cuid())
  inventoryLevelId String

  type             AdjustmentReason
  quantity         Int // Positive or negative
  previousQuantity Int
  newQuantity      Int

  reason        String?
  referenceType String? // 'ORDER', 'TRANSFER', 'COUNT'
  referenceId   String?

  createdAt   DateTime @default(now())
  createdById String

  inventoryLevel InventoryLevel @relation(fields: [inventoryLevelId], references: [id], onDelete: Cascade)
  createdBy      User           @relation(fields: [createdById], references: [id])

  @@index([inventoryLevelId, createdAt])
  @@index([referenceType, referenceId])
  @@map("inventory_adjustments")
}

// =============================================================================
// FEATURE 10C: AI MARKETING VIDEOS
// =============================================================================

model MarketingVideo {
  id        String  @id @default(cuid())
  companyId String
  productId String?

  // Video Info
  name   String
  type   MarketingVideoType
  status VideoGenerationStatus @default(PENDING)

  // Template & Style
  templateId String?
  style      Json? // Colors, fonts, mood

  // Content
  script        String?
  voiceoverText String?
  callToAction  String?

  // Final Output
  outputUrl    String?
  thumbnailUrl String?
  duration     Int? // Seconds

  // Generation Tracking
  generationStartedAt   DateTime?
  generationCompletedAt DateTime?
  generationError       String?
  creditsUsed           Decimal?  @db.Decimal(10, 2)

  // Momentum Intelligence Link (for retention videos)
  customerId     String?
  interventionId String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String

  company   Company                 @relation(fields: [companyId], references: [id], onDelete: Cascade)
  product   Product?                @relation(fields: [productId], references: [id])
  template  MarketingVideoTemplate? @relation(fields: [templateId], references: [id])
  customer  Customer?               @relation(fields: [customerId], references: [id])
  createdBy User                    @relation(fields: [createdById], references: [id])
  scenes    MarketingVideoScene[]
  variants  MarketingVideoVariant[]

  @@index([companyId, status])
  @@index([productId])
  @@index([customerId])
  @@map("marketing_videos")
}

model MarketingVideoScene {
  id      String @id @default(cuid())
  videoId String

  sceneNumber Int
  duration    Int // Seconds

  // Visual
  mediaType        SceneMediaType
  mediaUrl         String?
  mediaGeneratedBy String? // 'RUNWAY', 'STATIC', etc.

  // Text Overlay
  textOverlay  String?
  textPosition String? // 'top', 'center', 'bottom'
  textStyle    Json?

  // Transition
  transitionIn  String? // 'fade', 'slide', etc.
  transitionOut String?

  createdAt DateTime @default(now())

  video MarketingVideo @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([videoId, sceneNumber])
  @@map("marketing_video_scenes")
}

model MarketingVideoVariant {
  id      String @id @default(cuid())
  videoId String

  platform    VideoPlatform
  aspectRatio String // '9:16', '1:1', '16:9'

  outputUrl    String?
  thumbnailUrl String?

  // Platform-specific metadata
  metadata Json?

  createdAt DateTime @default(now())

  video MarketingVideo @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([videoId, platform])
  @@map("marketing_video_variants")
}

model MarketingVideoTemplate {
  id        String  @id @default(cuid())
  companyId String? // Null = system template

  name        String
  description String?
  type        MarketingVideoType

  // Template Structure
  sceneCount      Int
  defaultDuration Int // Total seconds
  structure       Json // Scene definitions

  // Style Defaults
  defaultStyle Json?

  // Script Template
  scriptTemplate String?

  isActive Boolean @default(true)
  isSystem Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company?         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  videos  MarketingVideo[]

  @@index([type, isActive])
  @@map("marketing_video_templates")
}

// =============================================================================
// FEATURE 10/10B/10C ENUMS
// =============================================================================

enum MediaType {
  IMAGE
  VIDEO
  MODEL_3D
  DOCUMENT
}

enum PriceRuleType {
  QUANTITY_BREAK // Buy more, save more
  CUSTOMER_GROUP // Special pricing for group
  TIME_BASED // Sale pricing
  SUBSCRIPTION // Recurring order discount
}

enum AdjustmentType {
  FIXED_AMOUNT // -$5.00
  PERCENTAGE // -10%
  FIXED_PRICE // Set to $19.99
}

enum CollectionType {
  MANUAL // Manually curated
  AUTOMATIC // Rules-based auto-population
}

enum BundleType {
  FIXED // Specific products, fixed quantities
  MIX_AND_MATCH // Customer chooses from allowed products
  SUBSCRIPTION_BOX // Curated monthly box
}

enum BundlePricing {
  FIXED // Set bundle price
  CALCULATED // Sum of items with optional discount
  TIERED // Price varies by selection
}

enum LocationType {
  WAREHOUSE
  STORE
  DROPSHIP
  VIRTUAL
}

enum AdjustmentReason {
  RECEIVED // Stock received
  SOLD // Sold to customer
  RETURNED // Customer return
  DAMAGED // Damaged/written off
  LOST // Lost/shrinkage
  FOUND // Found during count
  TRANSFERRED // Moved between locations
  COUNT_ADJUSTMENT // Physical count correction
  OTHER
}

// Shopify-Inspired Product Management Enums
enum MetafieldType {
  TEXT         // Single-line text input
  TEXTAREA     // Multi-line text input
  NUMBER       // Numeric input
  SELECT       // Single-select dropdown
  MULTI_SELECT // Multi-select checkboxes
  BOOLEAN      // Toggle/checkbox
  DATE         // Date picker
  COLOR        // Color picker
  URL          // URL input with validation
}

enum SalesChannelType {
  ONLINE_STORE // Primary web storefront
  POS          // Point of sale / in-person
  WHOLESALE    // B2B wholesale channel
  MARKETPLACE  // Third-party marketplaces
  SOCIAL       // Social commerce (Instagram, TikTok, etc.)
  CUSTOM       // Custom/API-only channel
}

enum MarketingVideoType {
  PRODUCT_SHOWCASE // Standard product video
  PRODUCT_LAUNCH // New product announcement
  SALE_PROMO // Sale/discount promotion
  TESTIMONIAL // Customer testimonial style
  TUTORIAL // How-to/explainer
  BRAND_STORY // Brand narrative
  RETENTION_WINBACK // Personalized win-back
  RETENTION_ANNIVERSARY // Customer milestone
  RETENTION_REMINDER // Subscription reminder
  SOCIAL_AD // Generic social ad
}

enum VideoGenerationStatus {
  PENDING
  GENERATING_SCRIPT
  GENERATING_MEDIA
  GENERATING_VOICE
  COMPOSING
  EXPORTING
  COMPLETED
  FAILED
}

enum SceneMediaType {
  PRODUCT_IMAGE
  AI_GENERATED_VIDEO
  STOCK_VIDEO
  SOLID_COLOR
  GRADIENT
}

enum VideoPlatform {
  TIKTOK
  INSTAGRAM_REELS
  INSTAGRAM_STORIES
  INSTAGRAM_FEED
  FACEBOOK_REELS
  FACEBOOK_FEED
  YOUTUBE_SHORTS
  YOUTUBE
  TWITTER
  LINKEDIN
}

// =============================================================================
// FEATURE 02: DYNAMIC RBAC SYSTEM
// Role-Based Access Control with Permission Ceiling Pattern
// =============================================================================

model Permission {
  id          String  @id @default(cuid())
  code        String  @unique // e.g., "transactions:read", "users:write"
  name        String // Human-readable name
  description String?
  category    String // Grouping: "transactions", "users", "settings"

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  rolePermissions  RolePermission[]
  permissionGrants PermissionGrant[]

  @@index([category])
  @@map("permissions")
}

model Role {
  id          String  @id @default(cuid())
  name        String // e.g., "Company Admin", "Billing Manager"
  slug        String // e.g., "company_admin", "billing_manager"
  description String?
  color       String? // For UI display

  // Scope - where this role can be assigned
  scopeType ScopeType // ORGANIZATION, CLIENT, COMPANY, etc.
  scopeId   String? // Optional: limit to specific org/client/company

  // Role properties
  isSystem  Boolean @default(false) // Built-in roles (cannot be deleted)
  isDefault Boolean @default(false) // Auto-assigned to new users at this scope
  priority  Int     @default(100) // Lower = more important (for display)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Soft delete
  deletedAt DateTime?
  deletedBy String?

  // Relations
  permissions         RolePermission[]
  userRoleAssignments UserRoleAssignment[]

  @@unique([scopeType, scopeId, slug])
  @@index([scopeType, scopeId])
  @@index([deletedAt])
  @@map("roles")
}

model RolePermission {
  id           String @id @default(cuid())
  roleId       String
  permissionId String

  // Constraints
  constraints Json? // Optional: limit permission scope (e.g., {"resourceId": "..."})

  // Timestamps
  createdAt DateTime @default(now())

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model UserRoleAssignment {
  id     String @id @default(cuid())
  userId String
  roleId String

  // Scope where this role applies
  scopeType ScopeType
  scopeId   String

  // Assignment metadata
  assignedBy String?
  assignedAt DateTime  @default(now())
  expiresAt  DateTime? // Optional: temporary role assignment

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId, scopeType, scopeId])
  @@index([userId])
  @@index([roleId])
  @@index([scopeType, scopeId])
  @@map("user_role_assignments")
}

model PermissionGrant {
  id           String @id @default(cuid())
  userId       String
  permissionId String

  // Scope where this permission applies
  scopeType ScopeType
  scopeId   String

  // Grant type
  grantType PermissionGrantType @default(ALLOW) // ALLOW or DENY

  // Grant metadata
  grantedBy String?
  grantedAt DateTime  @default(now())
  expiresAt DateTime?
  reason    String? // Why was this granted/denied

  // Constraints
  constraints Json? // Optional scope limitations

  // Relations
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId, scopeType, scopeId])
  @@index([userId])
  @@index([scopeType, scopeId])
  @@map("permission_grants")
}

model UserSession {
  id     String @id @default(cuid())
  userId String

  // Session info
  sessionToken String  @unique
  userAgent    String?
  ipAddress    String?
  deviceInfo   Json?

  // Location
  city    String?
  country String?

  // Status
  isActive     Boolean  @default(true)
  lastActiveAt DateTime @default(now())

  // Timestamps
  createdAt    DateTime  @default(now())
  expiresAt    DateTime
  revokedAt    DateTime?
  revokedBy    String?
  revokeReason String?

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionToken])
  @@index([isActive, expiresAt])
  @@map("user_sessions")
}

// RBAC Enums
enum PermissionGrantType {
  ALLOW
  DENY
}

// =============================================================================
// VENDOR SYSTEM (Feature 03)
// Parallel to Client hierarchy: Organization → Vendor → VendorCompany
// =============================================================================

enum VendorStatus {
  PENDING_VERIFICATION
  VERIFIED
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum VendorTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum VendorType {
  SUPPLIER
  DROPSHIPPER
  WHITE_LABEL
  AFFILIATE
  CUSTOMER_SERVICE_CENTER
}

enum ConnectionStatus {
  PENDING
  ACTIVE
  SUSPENDED
  TERMINATED
}

enum ProductSyncMode {
  MANUAL
  AUTOMATIC
  WEBHOOK
}

enum ProductSyncStatus {
  PENDING
  SYNCING
  COMPLETED
  FAILED
}

// Vendor - Parallel to Client under Organization
model Vendor {
  id             String  @id @default(cuid())
  organizationId String
  name           String
  slug           String
  code           String? @unique // 4-char alphanumeric code (e.g., "ACFL")

  // Contact
  contactName  String?
  contactEmail String?
  contactPhone String?

  // Business Info
  businessName String?
  taxId        String?
  website      String?
  logo         String?
  description  String? @db.Text

  // Status & Classification
  status     VendorStatus @default(PENDING_VERIFICATION)
  tier       VendorTier   @default(BRONZE)
  vendorType VendorType   @default(SUPPLIER)
  isVerified Boolean      @default(false)
  verifiedAt DateTime?

  // Performance Metrics (denormalized for quick access)
  averageRating   Float? @default(0)
  totalOrders     Int    @default(0)
  completionRate  Float? @default(100)
  averageShipDays Float?

  // Settings
  settings Json @default("{}")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization      Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  vendorCompanies   VendorCompany[]
  clientConnections VendorClientConnection[]

  // Soft delete fields
  deletedAt DateTime?
  deletedBy String?
  cascadeId String?

  @@unique([organizationId, slug])
  @@index([status])
  @@index([tier])
  @@index([vendorType])
  @@index([deletedAt])
  @@map("vendors")
}

// VendorCompany - Parallel to Company under Client
model VendorCompany {
  id       String  @id @default(cuid())
  vendorId String
  name     String
  slug     String
  code     String? @unique // 4-char alphanumeric code (e.g., "ACOF")

  // Business Info
  domain   String?
  logo     String?
  timezone String  @default("UTC")
  currency String  @default("USD")

  // Location
  address    String?
  city       String?
  state      String?
  country    String  @default("US")
  postalCode String?

  // Capabilities
  capabilities      String[] // e.g., ["white_label", "dropship", "wholesale"]
  productCategories String[] // Categories this vendor company specializes in

  // Status
  status EntityStatus @default(ACTIVE)

  // Settings
  settings Json @default("{}")

  // Lead times
  defaultLeadTimeDays Int @default(3)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  vendor            Vendor                   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  clientConnections VendorClientConnection[]
  products          VendorProduct[]
  orders            VendorOrder[]

  // Fulfillment providers using this vendor company
  fulfillmentProviders FulfillmentProvider[]

  // Soft delete fields
  deletedAt DateTime?
  deletedBy String?
  cascadeId String?

  @@unique([vendorId, slug])
  @@index([status])
  @@index([deletedAt])
  @@map("vendor_companies")
}

// VendorClientConnection - Bridge between Company and VendorCompany
model VendorClientConnection {
  id              String @id @default(cuid())
  vendorId        String
  vendorCompanyId String
  companyId       String // The client's company that is connected

  // Status
  status ConnectionStatus @default(PENDING)

  // Connection settings
  customPricing Json? // Company-specific pricing overrides
  terms         Json? // Agreement terms
  creditLimit   Float?
  paymentTerms  String? // e.g., "NET30", "NET60"

  // Product sync settings
  syncMode        ProductSyncMode @default(MANUAL)
  lastSyncAt      DateTime?
  autoSyncEnabled Boolean         @default(false)

  // Performance tracking per connection
  totalOrders  Int   @default(0)
  totalRevenue Float @default(0)

  // Timestamps
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  approvedAt DateTime?
  approvedBy String?

  // Relations
  vendor         Vendor              @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  vendorCompany  VendorCompany       @relation(fields: [vendorCompanyId], references: [id], onDelete: Cascade)
  company        Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  syncedProducts VendorProductSync[]
  orders         VendorOrder[]

  @@unique([vendorCompanyId, companyId])
  @@index([status])
  @@index([vendorId])
  @@index([vendorCompanyId])
  @@index([companyId])
  @@map("vendor_client_connections")
}

// VendorProduct - Products offered by vendor companies
model VendorProduct {
  id              String @id @default(cuid())
  vendorCompanyId String

  // Product info
  sku         String
  name        String
  description String? @db.Text

  // Pricing
  wholesalePrice Float // Price to clients
  retailPrice    Float? // Suggested retail price
  currency       String @default("USD")

  // Inventory
  stockQuantity     Int @default(0)
  lowStockThreshold Int @default(10)

  // Product details
  weight     Float?
  dimensions Json? // { length, width, height, unit }
  images     String[]
  categories String[]

  // Lead time
  leadTimeDays Int?

  // Status
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  vendorCompany  VendorCompany       @relation(fields: [vendorCompanyId], references: [id], onDelete: Cascade)
  syncedProducts VendorProductSync[]
  orderItems     VendorOrderItem[]

  @@unique([vendorCompanyId, sku])
  @@index([isActive])
  @@map("vendor_products")
}

// VendorProductSync - Tracks which vendor products are synced to which company
model VendorProductSync {
  id               String  @id @default(cuid())
  connectionId     String
  vendorProductId  String
  companyProductId String? // Link to the company's product if synced

  // Sync status
  status     ProductSyncStatus @default(PENDING)
  lastSyncAt DateTime?
  syncError  String?

  // Price override for this connection
  customPrice Float?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  connection     VendorClientConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  vendorProduct  VendorProduct          @relation(fields: [vendorProductId], references: [id], onDelete: Cascade)
  companyProduct Product?               @relation(fields: [companyProductId], references: [id], onDelete: SetNull)

  @@unique([connectionId, vendorProductId])
  @@index([status])
  @@map("vendor_product_syncs")
}

// VendorOrder - Orders placed with vendors
model VendorOrder {
  id              String @id @default(cuid())
  connectionId    String
  vendorCompanyId String
  orderNumber     String @unique

  // Source order (if created from a customer order)
  sourceOrderId String?

  // Status
  status OrderStatus @default(PENDING)

  // Totals
  subtotal     Float
  shippingCost Float  @default(0)
  tax          Float  @default(0)
  total        Float
  currency     String @default("USD")

  // Shipping
  shippingAddress Json?
  shippingMethod  String?
  trackingNumber  String?
  carrier         ShippingCarrier?

  // Dates
  expectedDeliveryAt DateTime?
  shippedAt          DateTime?
  deliveredAt        DateTime?

  // Notes
  notes       String? @db.Text
  vendorNotes String? @db.Text

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  connection    VendorClientConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  vendorCompany VendorCompany          @relation(fields: [vendorCompanyId], references: [id], onDelete: Cascade)
  sourceOrder   Order?                 @relation(fields: [sourceOrderId], references: [id], onDelete: SetNull)
  items         VendorOrderItem[]

  @@index([status])
  @@index([vendorCompanyId])
  @@index([sourceOrderId])
  @@map("vendor_orders")
}

// VendorOrderItem - Line items in vendor orders
model VendorOrderItem {
  id              String @id @default(cuid())
  vendorOrderId   String
  vendorProductId String

  // Item details
  sku        String
  name       String
  quantity   Int
  unitPrice  Float
  totalPrice Float

  // Fulfillment
  quantityFulfilled Int @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  vendorOrder   VendorOrder   @relation(fields: [vendorOrderId], references: [id], onDelete: Cascade)
  vendorProduct VendorProduct @relation(fields: [vendorProductId], references: [id], onDelete: Cascade)

  @@index([vendorOrderId])
  @@map("vendor_order_items")
}

// MarketplaceReview - Reviews for vendor products in the marketplace
model MarketplaceReview {
  id              String @id @default(cuid())
  vendorId        String
  vendorCompanyId String
  companyId       String // The Company (client's company) writing the review

  // Review content
  rating  Int // 1-5 stars
  title   String?
  content String? @db.Text

  // Verification
  isVerified       Boolean @default(false)
  verifiedPurchase Boolean @default(false)

  // Moderation
  isApproved  Boolean   @default(true)
  moderatedAt DateTime?
  moderatedBy String?

  // Helpful votes
  helpfulCount Int @default(0)

  // Response from vendor
  vendorResponse String?   @db.Text
  respondedAt    DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([vendorId])
  @@index([vendorCompanyId])
  @@index([companyId])
  @@index([rating])
  @@map("marketplace_reviews")
}

// =============================================================================
// CUSTOMER NOTES & TAGS
// =============================================================================

enum NoteType {
  INTERNAL
  CUSTOMER_SERVICE
  SYSTEM
}

model CustomerNote {
  id         String   @id @default(cuid())
  customerId String
  userId     String?
  content    String   @db.Text
  type       NoteType @default(INTERNAL)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  user     User?    @relation(fields: [userId], references: [id])

  @@index([customerId])
  @@map("customer_notes")
}

model CustomerTag {
  id          String   @id @default(cuid())
  companyId   String
  name        String
  color       String   @default("#3B82F6")
  description String?
  createdAt   DateTime @default(now())

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, name])
  @@map("customer_tags")
}

// =============================================================================
// REFUND SETTINGS (per company/client)
// =============================================================================

model RefundSettings {
  id        String @id @default(cuid())
  companyId String @unique

  // Auto-approval settings
  autoApprovalEnabled   Boolean @default(false)
  autoApprovalMaxAmount Decimal @default(100.00) @db.Decimal(10, 2)
  autoApprovalMaxDays   Int     @default(30) // Days since order

  // Restrictions
  requireReason       Boolean @default(true)
  requireApproval     Boolean @default(true)
  allowPartialRefunds Boolean @default(true)

  // Notifications
  notifyOnRequest    Boolean @default(true)
  notifyOnApproval   Boolean @default(true)
  notifyOnCompletion Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("refund_settings")
}

// =============================================================================
// PRODUCT REVIEWS & RATINGS (Customer Review Plugin - Yotpo-style)
// =============================================================================

enum ReviewStatus {
  PENDING     // Awaiting moderation
  APPROVED    // Published and visible
  REJECTED    // Rejected by moderator
  FLAGGED     // Flagged for review
}

enum ReviewSource {
  WEBSITE     // Submitted via website widget
  EMAIL       // Submitted via email request
  API         // Submitted via API
  IMPORT      // Imported from external source
}

model ProductReview {
  id         String @id @default(cuid())
  companyId  String
  productId  String
  customerId String?
  orderId    String? // Link to verified purchase

  // Review Content
  rating      Int // 1-5 stars
  title       String?
  content     String?  @db.Text
  pros        String[] // What they liked
  cons        String[] // What they didn't like

  // Reviewer Info (for non-logged-in reviews)
  reviewerName  String?
  reviewerEmail String?

  // Verification
  isVerifiedPurchase Boolean @default(false)
  purchaseDate       DateTime?

  // Moderation
  status       ReviewStatus @default(PENDING)
  moderatedAt  DateTime?
  moderatedBy  String?
  moderationNotes String?
  rejectReason String?

  // AI Analysis
  sentimentScore Float?  // -1 to 1
  keyPhrases     String[]
  aiSummary      String?

  // Engagement
  helpfulCount   Int @default(0)
  unhelpfulCount Int @default(0)
  reportCount    Int @default(0)

  // Merchant Response
  merchantResponse   String?   @db.Text
  merchantRespondedAt DateTime?
  merchantRespondedBy String?

  // Source Tracking
  source    ReviewSource @default(WEBSITE)
  sourceId  String?      // External review ID if imported
  ipAddress String?
  userAgent String?

  // Featured/Pinned
  isFeatured Boolean @default(false)
  isPinned   Boolean @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Soft delete
  deletedAt DateTime?
  deletedBy String?

  // Relations
  company  Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  product  Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  customer Customer?        @relation(fields: [customerId], references: [id], onDelete: SetNull)
  order    Order?           @relation(fields: [orderId], references: [id], onDelete: SetNull)
  media    ReviewMedia[]
  votes    ReviewVote[]

  @@unique([orderId, productId]) // One review per product per order
  @@index([companyId])
  @@index([productId])
  @@index([customerId])
  @@index([status])
  @@index([rating])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("product_reviews")
}

model ReviewMedia {
  id       String @id @default(cuid())
  reviewId String

  // Media Details
  type     String // image, video
  url      String
  filename String?
  mimeType String?
  size     Int?   // bytes

  // Processing
  thumbnailUrl String?
  isProcessed  Boolean @default(false)
  processedAt  DateTime?

  // Moderation
  isApproved Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())

  // Relations
  review ProductReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@index([reviewId])
  @@map("review_media")
}

model ReviewVote {
  id         String @id @default(cuid())
  reviewId   String
  customerId String?
  ipAddress  String?

  // Vote
  isHelpful Boolean // true = helpful, false = not helpful

  // Timestamps
  createdAt DateTime @default(now())

  // Relations
  review   ProductReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  customer Customer?     @relation(fields: [customerId], references: [id], onDelete: SetNull)

  @@unique([reviewId, customerId])
  @@unique([reviewId, ipAddress])
  @@index([reviewId])
  @@map("review_votes")
}

model ReviewConfig {
  id        String @id @default(cuid())
  companyId String @unique

  enabled Boolean @default(true)

  // Moderation Settings
  autoApprove           Boolean @default(false) // Auto-approve reviews
  requireVerifiedPurchase Boolean @default(false)
  minRatingForAutoApprove Int?   // Only auto-approve if rating >= this
  moderationKeywords    String[] // Keywords that trigger manual review

  // Display Settings
  showVerifiedBadge     Boolean @default(true)
  showReviewerName      Boolean @default(true)
  showReviewDate        Boolean @default(true)
  allowAnonymous        Boolean @default(true)
  sortDefault           String  @default("newest") // newest, oldest, highest, lowest, helpful

  // Content Settings
  minReviewLength       Int     @default(0)
  maxReviewLength       Int     @default(5000)
  allowMedia            Boolean @default(true)
  maxMediaPerReview     Int     @default(5)
  allowProsAndCons      Boolean @default(true)

  // Email Settings
  sendReviewRequest     Boolean @default(true)
  reviewRequestDelay    Int     @default(7) // Days after delivery
  sendResponseNotification Boolean @default(true)

  // Widget Settings
  widgetTheme           String  @default("light") // light, dark, auto
  widgetPosition        String  @default("bottom") // bottom, side, modal
  widgetPrimaryColor    String  @default("#3B82F6")
  widgetCustomCss       String? @db.Text

  // SEO Settings
  enableRichSnippets    Boolean @default(true)
  schemaType            String  @default("Product") // Product, LocalBusiness

  // Incentive Settings
  incentiveEnabled      Boolean @default(false)
  incentiveType         String? // discount, points, entry
  incentiveValue        String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("review_configs")
}

// Product Review Statistics (Denormalized for performance)
model ProductReviewStats {
  id        String @id @default(cuid())
  companyId String
  productId String @unique

  // Aggregate Stats
  totalReviews     Int   @default(0)
  approvedReviews  Int   @default(0)
  averageRating    Float @default(0)

  // Rating Distribution
  rating1Count Int @default(0)
  rating2Count Int @default(0)
  rating3Count Int @default(0)
  rating4Count Int @default(0)
  rating5Count Int @default(0)

  // Verified Stats
  verifiedReviews  Int   @default(0)
  verifiedAvgRating Float @default(0)

  // Top Keywords (JSON array)
  topKeywords Json @default("[]")

  // Timestamps
  updatedAt DateTime @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("product_review_stats")
}

// =============================================================================
// LANDING PAGE BUILDER
// =============================================================================

model LandingPage {
  id        String @id @default(cuid())
  companyId String

  // Optional site association (for multi-site companies)
  siteId    String?
  site      Site?   @relation(fields: [siteId], references: [id], onDelete: SetNull)

  // Identity & Routing
  name      String // "Main Site", "Holiday Promo 2024"
  slug      String // Internal reference
  subdomain String? @unique // "coffee-explorer" → coffee-explorer.avnz.io

  // Theme & Design
  theme       LandingPageTheme @default(STARTER)
  colorScheme Json             @default("{}") // { primary, secondary, accent, background, text }
  typography  Json             @default("{}") // { headingFont, bodyFont, scale }

  // Cart Theming (NEW)
  cartTheme      Json @default("{}") // CartTheme - colors, layout, content
  productCatalog Json @default("{}") // ProductCatalog - mode, filters, sort

  // Global Settings
  favicon   String?
  ogImage   String?
  customCss String? @db.Text
  customJs  String? @db.Text

  // SEO
  metaTitle       String?
  metaDescription String?
  keywords        String[]

  // Analytics
  googleAnalyticsId String?
  facebookPixelId   String?

  // Hosting Configuration
  hostingType LandingPageHosting @default(PLATFORM) // PLATFORM = our AWS, CLIENT = their AWS

  // Platform-hosted settings (when hostingType = PLATFORM)
  platformDistributionId String? // CloudFront distribution ID
  platformUrl            String? // https://coffee-explorer.avnz.io
  platformS3Path         String? // landing-pages/company-id/page-slug/

  // Client-hosted settings (when hostingType = CLIENT)
  clientBucketName    String?
  clientDistributionId String?
  clientUrl           String?

  // Status & Publishing
  status      LandingPageStatus @default(DRAFT)
  publishedAt DateTime?
  publishedBy String?
  lastDeployedAt DateTime?

  // Versioning
  version Int @default(1)

  // Billing & Usage Tracking
  billingEnabled Boolean @default(true)
  monthlyFee     Int     @default(0) // Base fee in cents (e.g., 999 = $9.99/mo)

  // Usage Metrics (updated on each request/deploy)
  totalPageViews   BigInt   @default(0)
  totalBandwidthMb BigInt   @default(0) // MB transferred
  totalDeploys     Int      @default(0)
  lastPageViewAt   DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Soft Delete
  deletedAt DateTime?
  deletedBy String?

  // Relations
  company  Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sections LandingPageSection[]
  domains  LandingPageDomain[]
  usage    LandingPageUsage[]
  abTests  ABTest[]
  popups   LandingPagePopup[]
  dynamicTextRules DynamicTextRule[]
  conversionGoals  ConversionGoal[]
  // Cart Integration
  sessions        LandingPageSession[]
  carts           Cart[]
  catalogProducts LandingPageProduct[]

  @@unique([companyId, slug, deletedAt])
  @@index([subdomain])
  @@index([status])
  @@index([deletedAt])
  @@map("landing_pages")
}

// ═══════════════════════════════════════════════════════════════════════════════
// LANDING PAGE SESSIONS - Visitor tracking for landing page → cart attribution
// ═══════════════════════════════════════════════════════════════════════════════

model LandingPageSession {
  id            String   @id @default(cuid())
  sessionToken  String   @unique // 256-bit random, base64url encoded (~43 chars)
  landingPageId String

  // Visitor Identification
  visitorId     String?  // Persistent visitor ID (from cookie)
  ipAddressHash String?  // SHA-256 hash for privacy (with salt)
  userAgent     String?
  referrer      String?

  // Device Detection
  deviceType    String?  // 'desktop', 'mobile', 'tablet'
  browser       String?  // 'Chrome', 'Safari', 'Firefox', etc.
  os            String?  // 'Windows', 'macOS', 'iOS', 'Android', etc.

  // UTM Parameters
  utmSource     String?
  utmMedium     String?
  utmCampaign   String?
  utmTerm       String?
  utmContent    String?

  // Conversion Tracking
  cartId        String?  @unique
  status        LandingPageSessionStatus @default(ACTIVE)
  convertedAt   DateTime?
  orderId       String?
  abandonedAt   DateTime?

  // Timestamps
  startedAt      DateTime @default(now())
  lastActivityAt DateTime @default(now())

  // Company Scope
  companyId     String

  // Relations
  landingPage   LandingPage @relation(fields: [landingPageId], references: [id], onDelete: Cascade)
  company       Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  cart          Cart?       @relation(fields: [cartId], references: [id], onDelete: SetNull)

  // Performance-optimized indexes (per DBA review)
  @@index([landingPageId, startedAt])
  @@index([landingPageId, status])
  @@index([companyId, startedAt])
  @@index([companyId, convertedAt])
  @@index([status])
  @@map("landing_page_sessions")
}

model LandingPageSection {
  id            String @id @default(cuid())
  landingPageId String

  // Section Identity
  type SectionType
  name String? // Custom override name: "Our Story"

  // Positioning
  order   Int
  enabled Boolean @default(true)

  // Content (type-specific JSON - see SectionContent types)
  content Json

  // Styling Overrides
  styles Json? // { backgroundColor, textColor, padding, animation }

  // Responsive Visibility
  hideOnMobile  Boolean @default(false)
  hideOnDesktop Boolean @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  landingPage LandingPage @relation(fields: [landingPageId], references: [id], onDelete: Cascade)

  @@index([landingPageId, order])
  @@map("landing_page_sections")
}

model LandingPageDomain {
  id            String @id @default(cuid())
  landingPageId String

  domain    String  @unique // "www.coffeeexplorer.com"
  isPrimary Boolean @default(false)

  // SSL Status (ACM certificate)
  sslStatus    DomainSslStatus @default(PENDING)
  sslCertArn   String? // ACM certificate ARN
  sslExpiresAt DateTime?

  // DNS Verification
  verificationToken  String?
  verificationRecord String? // CNAME record value
  verifiedAt         DateTime?

  // CloudFront Distribution (if using custom domain)
  distributionId String?
  distributionArn String?

  // Billing for custom domains
  monthlyFee Int @default(0) // Additional fee for custom domain hosting (cents)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  landingPage LandingPage @relation(fields: [landingPageId], references: [id], onDelete: Cascade)

  @@map("landing_page_domains")
}

// Usage tracking for billing - records monthly usage per landing page
model LandingPageUsage {
  id            String @id @default(cuid())
  landingPageId String
  companyId     String

  // Billing Period
  periodStart DateTime
  periodEnd   DateTime

  // Usage Metrics
  pageViews      BigInt @default(0)
  uniqueVisitors BigInt @default(0)
  bandwidthMb    BigInt @default(0) // MB transferred
  deployCount    Int    @default(0)

  // Calculated Costs (in cents)
  baseFee        Int @default(0) // Monthly base fee
  bandwidthFee   Int @default(0) // Overage charges
  customDomainFee Int @default(0) // Custom domain fee
  totalFee       Int @default(0) // Total for period

  // Status
  invoiced   Boolean   @default(false)
  invoicedAt DateTime?
  invoiceId  String? // Link to billing invoice

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  landingPage LandingPage @relation(fields: [landingPageId], references: [id], onDelete: Cascade)

  @@unique([landingPageId, periodStart])
  @@index([companyId, periodStart])
  @@map("landing_page_usage")
}

// Service fee configuration (organization-level pricing)
model LandingPagePricing {
  id             String @id @default(cuid())
  organizationId String @unique

  // Base Pricing (in cents)
  monthlyBaseFee       Int @default(999)  // $9.99/mo per page
  customDomainFee      Int @default(499)  // $4.99/mo per custom domain

  // Included Allowances
  includedPageViews    Int @default(10000)  // Views per month
  includedBandwidthMb  Int @default(1000)   // MB per month
  includedDeploys      Int @default(50)     // Deploys per month

  // Overage Pricing (in cents per unit)
  overageViewsPer1000  Int @default(50)   // $0.50 per 1000 views over limit
  overageBandwidthPerGb Int @default(100) // $1.00 per GB over limit

  // Free Tier
  freePagesAllowed     Int @default(1)  // First page free
  freeTrialDays        Int @default(14) // Trial period

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("landing_page_pricing")
}

// ═══════════════════════════════════════════════════════════════
// AI USAGE TRACKING - For billing AI content generation
// ═══════════════════════════════════════════════════════════════

model AIUsage {
  id        String @id @default(cuid())
  companyId String
  userId    String

  // Request Details
  feature      AIFeature // What feature was used
  operation    String    // Specific operation (generate_headline, rewrite_section, etc.)
  modelId      String    // AI model used (e.g., anthropic.claude-3-sonnet)

  // Token Usage (for billing)
  inputTokens  Int
  outputTokens Int
  totalTokens  Int

  // Cost Calculation (in cents)
  inputCost    Int      // Cost for input tokens
  outputCost   Int      // Cost for output tokens
  totalCost    Int      // Total cost in cents

  // Request Context
  landingPageId String?
  metadata      Json?   // Additional context (section type, prompt length, etc.)

  // Status
  status    AIUsageStatus @default(SUCCESS)
  errorMsg  String?

  // Timestamps
  createdAt DateTime @default(now())

  @@index([companyId, createdAt])
  @@index([userId, createdAt])
  @@index([feature, createdAt])
  @@map("ai_usage")
}

// Monthly AI usage summary for billing
model AIUsageSummary {
  id        String @id @default(cuid())
  companyId String

  // Billing Period
  periodStart DateTime
  periodEnd   DateTime

  // Aggregated Usage
  totalRequests    Int @default(0)
  totalInputTokens  Int @default(0)
  totalOutputTokens Int @default(0)
  totalTokens      Int @default(0)

  // Costs (in cents)
  totalCost Int @default(0)

  // Usage by Feature
  usageByFeature Json @default("{}") // { LANDING_PAGE_CONTENT: { requests: 10, tokens: 5000, cost: 100 } }

  // Billing Status
  invoiced   Boolean   @default(false)
  invoicedAt DateTime?
  invoiceId  String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, periodStart])
  @@index([companyId, periodStart])
  @@map("ai_usage_summary")
}

// AI pricing configuration (organization-level)
model AIPricing {
  id             String @id @default(cuid())
  organizationId String @unique

  // Token pricing (per 1000 tokens, in cents)
  inputTokenPrice  Int @default(3)   // $0.03 per 1K input tokens
  outputTokenPrice Int @default(15)  // $0.15 per 1K output tokens

  // Monthly allowances (included in base plan)
  monthlyTokenAllowance Int @default(100000) // 100K tokens/month included

  // Overage pricing (per 1000 tokens, in cents)
  overageInputPrice  Int @default(4)  // $0.04 per 1K input tokens after allowance
  overageOutputPrice Int @default(20) // $0.20 per 1K output tokens after allowance

  // Feature flags
  aiEnabled Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("ai_pricing")
}

enum AIFeature {
  LANDING_PAGE_CONTENT    // Generate/rewrite landing page text
  LANDING_PAGE_SECTION    // Generate entire section content
  AB_TEST_VARIANTS        // Generate A/B test copy variants
  PRODUCT_DESCRIPTION     // Product descriptions
  SEO_OPTIMIZATION        // Meta tags, keywords
  IMAGE_ALT_TEXT          // Alt text generation
  LOGO_GENERATION         // AI-generated logo images (Titan Image Generator)
}

enum AIUsageStatus {
  SUCCESS
  FAILED
  RATE_LIMITED
}

enum LandingPageTheme {
  STARTER       // Clean minimal (default)
  ARTISAN       // Warm, handcrafted (coffee, bakery)
  VELOCITY      // Modern tech (SaaS)
  LUXE          // Elegant premium (fashion, jewelry)
  WELLNESS      // Calm, clean (health, spa)
  FOODIE        // Vibrant (restaurant, delivery)
  PROFESSIONAL  // Corporate (agency, B2B)
  CREATOR       // Personal brand (courses)
  MARKETPLACE   // E-commerce focused
}

enum SectionType {
  // Navigation
  HEADER
  FOOTER

  // Hero Variants
  HERO_CENTERED
  HERO_SPLIT
  HERO_VIDEO
  HERO_CAROUSEL

  // Content
  FEATURES_GRID
  FEATURES_LIST
  FEATURES_ICONS
  ABOUT_STORY
  ABOUT_TEAM
  ABOUT_TIMELINE

  // Social Proof
  TESTIMONIALS_CARDS
  TESTIMONIALS_CAROUSEL
  TESTIMONIALS_WALL
  LOGOS_STRIP
  STATS_COUNTER

  // Commerce
  PRICING_TABLE
  PRICING_COMPARISON
  PRODUCTS_GRID
  PRODUCTS_CAROUSEL

  // Engagement
  CTA_BANNER
  CTA_SPLIT
  NEWSLETTER
  CONTACT_FORM
  FAQ_ACCORDION
  FAQ_GRID

  // Media
  GALLERY_GRID
  GALLERY_MASONRY
  VIDEO_EMBED

  // Custom
  HTML_BLOCK
  SPACER
  DIVIDER
}

enum LandingPageStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum LandingPageHosting {
  PLATFORM // Hosted on our AWS (subdomain.avnz.io)
  CLIENT   // Hosted on client's AWS
}

enum DomainSslStatus {
  PENDING     // Certificate requested
  VALIDATING  // DNS validation in progress
  ACTIVE      // Certificate active
  FAILED      // Validation failed
  EXPIRED     // Certificate expired
}

// ═══════════════════════════════════════════════════════════════
// A/B TESTING - Variant Management & Traffic Splitting
// ═══════════════════════════════════════════════════════════════

enum ABTestStatus {
  DRAFT     // Not yet running
  RUNNING   // Actively splitting traffic
  PAUSED    // Temporarily stopped
  COMPLETED // Test finished, winner declared
  ARCHIVED  // Historical record
}

model ABTest {
  id            String @id @default(cuid())
  landingPageId String
  companyId     String

  // Test Configuration
  name        String // "Summer CTA Test"
  description String?
  status      ABTestStatus @default(DRAFT)

  // Traffic Allocation
  trafficPercentage Int @default(100) // % of total traffic to include in test (0-100)

  // Scheduling
  startedAt   DateTime?
  endedAt     DateTime?
  scheduledStart DateTime?
  scheduledEnd   DateTime?

  // Statistical Settings
  confidenceLevel   Int @default(95)      // 90, 95, 99
  minimumSampleSize Int @default(100)     // Minimum visitors per variant
  primaryMetric     String @default("conversions") // What to optimize

  // Results
  winnerId            String? // Variant ID that won
  winnerDeclaredAt    DateTime?
  statisticalSignificance Float? // 0.0 - 1.0

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  // Relations
  landingPage LandingPage @relation(fields: [landingPageId], references: [id], onDelete: Cascade)
  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  variants    ABTestVariant[]

  @@index([landingPageId])
  @@index([companyId])
  @@index([status])
  @@map("ab_tests")
}

model ABTestVariant {
  id       String @id @default(cuid())
  testId   String

  // Variant Identity
  name     String    // "Control", "Variant A", "Variant B"
  isControl Boolean  @default(false)

  // Traffic Weight
  weight   Int @default(50) // % traffic allocation (all variants must sum to 100)

  // Content Changes (JSON patches to apply to base page)
  changes Json // { sectionId: string, field: string, value: any }[]

  // Metrics (updated in real-time)
  visitors    BigInt @default(0)
  conversions BigInt @default(0)
  conversionRate Float @default(0)
  bounceRate     Float @default(0)
  avgTimeOnPage  Float @default(0) // seconds

  // Revenue tracking (optional)
  totalRevenue   BigInt @default(0) // cents
  avgOrderValue  Float  @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  test ABTest @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@index([testId])
  @@map("ab_test_variants")
}

// Visitor assignment tracking (which variant did they see?)
model ABTestAssignment {
  id        String @id @default(cuid())
  testId    String
  variantId String
  visitorId String // Anonymous visitor cookie/fingerprint

  // Assignment details
  assignedAt DateTime @default(now())
  converted  Boolean  @default(false)
  convertedAt DateTime?

  // Attribution
  revenue    BigInt? // If conversion had revenue (cents)

  @@unique([testId, visitorId])
  @@index([variantId])
  @@map("ab_test_assignments")
}

// ═══════════════════════════════════════════════════════════════
// POPUPS & STICKY BARS - Engagement Overlays
// ═══════════════════════════════════════════════════════════════

enum PopupType {
  MODAL        // Center overlay
  SLIDE_IN     // Corner slide-in
  FULLSCREEN   // Full page takeover
  STICKY_BAR   // Top/bottom persistent bar
  BANNER       // Dismissable notification bar
}

enum PopupTrigger {
  IMMEDIATE       // Show on page load
  TIME_DELAY      // After X seconds
  SCROLL_PERCENT  // After scrolling X%
  EXIT_INTENT     // Mouse leaves viewport
  CLICK           // Click on element
  INACTIVITY      // No activity for X seconds
}

enum PopupStatus {
  DRAFT
  ACTIVE
  PAUSED
  SCHEDULED
  ARCHIVED
}

model LandingPagePopup {
  id            String @id @default(cuid())
  landingPageId String
  companyId     String

  // Identity
  name   String
  type   PopupType @default(MODAL)
  status PopupStatus @default(DRAFT)

  // Trigger Configuration
  trigger       PopupTrigger @default(TIME_DELAY)
  triggerValue  Int?         // Seconds for TIME_DELAY, % for SCROLL_PERCENT
  triggerSelector String?    // CSS selector for CLICK trigger

  // Display Settings
  position  String @default("center") // center, top, bottom, top-left, top-right, bottom-left, bottom-right
  animation String @default("fade")   // fade, slide, bounce, zoom
  overlay   Boolean @default(true)    // Show dark overlay behind
  overlayClose Boolean @default(true) // Click overlay to close

  // Content (similar to section content)
  content Json // { headline, body, ctaText, ctaUrl, image, formFields }
  styles  Json? // { backgroundColor, textColor, width, borderRadius }

  // Scheduling
  startDate DateTime?
  endDate   DateTime?

  // Frequency & Targeting
  showOnce      Boolean @default(false)  // Only show once per visitor
  showEveryDays Int?                      // Re-show after X days
  showOnMobile  Boolean @default(true)
  showOnDesktop Boolean @default(true)

  // Page targeting
  showOnAllPages Boolean @default(true)
  targetPages    String[] // Specific page paths if not all

  // Metrics
  impressions BigInt @default(0)
  closes      BigInt @default(0)
  conversions BigInt @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  // Relations
  landingPage LandingPage @relation(fields: [landingPageId], references: [id], onDelete: Cascade)
  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([landingPageId])
  @@index([companyId])
  @@index([status])
  @@map("landing_page_popups")
}

// ═══════════════════════════════════════════════════════════════
// DYNAMIC TEXT REPLACEMENT - URL Parameter-based Content Swapping
// ═══════════════════════════════════════════════════════════════

model DynamicTextRule {
  id            String @id @default(cuid())
  landingPageId String
  companyId     String

  // Rule Configuration
  name        String  // "City Personalization"
  enabled     Boolean @default(true)

  // URL Parameter to watch
  parameterName String // e.g., "city", "utm_campaign", "keyword"

  // Default value if parameter not present
  defaultValue String

  // Replacement targets (CSS selectors or section IDs)
  targets Json // [{ selector: ".hero-headline", field: "text" }, { sectionId: "xxx", field: "headline" }]

  // Optional: Predefined mappings for specific values
  valueMappings Json? // { "new-york": "New York City", "la": "Los Angeles" }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  landingPage LandingPage @relation(fields: [landingPageId], references: [id], onDelete: Cascade)
  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([landingPageId])
  @@index([companyId])
  @@map("dynamic_text_rules")
}

// ═══════════════════════════════════════════════════════════════
// CONVERSION TRACKING - Goal & Event Management
// ═══════════════════════════════════════════════════════════════

enum ConversionGoalType {
  FORM_SUBMIT   // Form submission
  BUTTON_CLICK  // CTA button click
  LINK_CLICK    // External link click
  PAGE_VISIT    // Visit to thank you page
  SCROLL_DEPTH  // Scroll to specific %
  TIME_ON_PAGE  // Time threshold reached
  CUSTOM        // Custom JS event
}

model ConversionGoal {
  id            String @id @default(cuid())
  landingPageId String
  companyId     String

  // Goal Configuration
  name        String
  type        ConversionGoalType
  isPrimary   Boolean @default(false) // Main goal for A/B test winner selection

  // Type-specific config
  selector    String?  // CSS selector for clicks
  targetUrl   String?  // URL for PAGE_VISIT
  threshold   Int?     // % for SCROLL_DEPTH, seconds for TIME_ON_PAGE
  eventName   String?  // Custom event name

  // Optional: Revenue value (for ROI calculations)
  revenueValue Int? // Fixed value in cents (e.g., lead worth $50)

  // Metrics
  totalConversions BigInt @default(0)
  totalRevenue     BigInt @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  landingPage LandingPage @relation(fields: [landingPageId], references: [id], onDelete: Cascade)
  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  events      ConversionEvent[]

  @@index([landingPageId])
  @@index([companyId])
  @@map("conversion_goals")
}

model ConversionEvent {
  id        String @id @default(cuid())
  goalId    String
  visitorId String

  // Event details
  occurredAt DateTime @default(now())
  pageUrl    String?
  referrer   String?

  // Attribution
  utmSource   String?
  utmMedium   String?
  utmCampaign String?

  // Optional: Revenue
  revenue Int?

  // Relations
  goal ConversionGoal @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@index([goalId])
  @@index([visitorId])
  @@index([occurredAt])
  @@map("conversion_events")
}

// ═══════════════════════════════════════════════════════════════════════════════
// HOSTED PAYMENT PAGES - Stripe-style checkout with multi-gateway support
// PCI DSS 4.0, ISO 27001, SOC2 Compliant
// ═══════════════════════════════════════════════════════════════════════════════

enum PaymentPageStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum PaymentPageType {
  CHECKOUT      // One-time payment for products/services
  SUBSCRIPTION  // Recurring billing with trial support
  DONATION      // Pay-what-you-want with suggested amounts
  INVOICE       // Pay specific invoice
  PRODUCT       // Single product purchase
  CUSTOM        // Fully custom checkout flow
}

enum CheckoutPageThemeCategory {
  MINIMAL       // Clean, simple - Stripe-inspired
  MODERN        // Contemporary design
  ENTERPRISE    // Professional, corporate
  LUXURY        // Premium, high-end
  FRIENDLY      // Warm, approachable
  DARK          // Dark mode first
  SPEED         // One-click focused
  TRUST         // Security-focused for finance
}

enum PaymentSessionStatus {
  PENDING       // Session created, awaiting payment
  PROCESSING    // Payment in progress
  REQUIRES_ACTION // 3DS or additional auth needed
  COMPLETED     // Payment successful
  FAILED        // Payment failed
  EXPIRED       // Session expired
  ABANDONED     // Customer left without completing
  CANCELLED     // Customer cancelled
}

enum PaymentGatewayType {
  STRIPE        // Stripe Elements
  PAYPAL        // PayPal Smart Buttons
  PAYPAL_REST   // PayPal REST API (own hosted)
  NMI           // NMI Hosted Fields
  AUTHORIZE_NET // Authorize.net Accept.js
  SQUARE        // Square Web Payments SDK
  OWN_HOSTED    // Direct card input (your tokenization)
}

// ═══════════════════════════════════════════════════════════════════════════════
// PAYMENT PAGE THEMES - Pre-built and custom themes
// ═══════════════════════════════════════════════════════════════════════════════

model CheckoutPageTheme {
  id          String @id @default(cuid())

  // Identity
  name        String
  description String?
  category    CheckoutPageThemeCategory

  // Preview
  previewImageUrl   String?
  previewImageDark  String?

  // Availability
  isSystem          Boolean @default(false)  // Platform-provided, cannot be deleted
  isPublic          Boolean @default(false)  // Available in marketplace
  organizationId    String?                  // If org-specific
  companyId         String?                  // If company-specific

  // Style Configuration (JSON for flexibility)
  styles            Json    // ThemeStyles type - colors, fonts, spacing
  layout            Json    // ThemeLayout type - single-page, split-screen, etc.
  components        Json    // ComponentStyles - button, input, card styles

  // Dark Mode Support
  darkModeStyles    Json?   // Optional dark mode overrides

  // Metrics (for marketplace)
  usageCount        Int     @default(0)
  averageConversion Decimal? @db.Decimal(5, 2)
  rating            Decimal? @db.Decimal(3, 2)
  reviewCount       Int     @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  // Relations
  paymentPages PaymentPage[]

  @@index([category])
  @@index([isPublic])
  @@index([isSystem])
  @@map("checkout_page_themes")
}

// ═══════════════════════════════════════════════════════════════════════════════
// PAYMENT PAGES - Main checkout page configuration
// ═══════════════════════════════════════════════════════════════════════════════

model PaymentPage {
  id        String @id @default(cuid())
  companyId String

  // Identity & URL
  name        String
  slug        String          // URL slug: pay.avnz.io/{company}/{slug}
  customDomain String?        // Optional: checkout.clientsite.com

  // Type & Status
  type        PaymentPageType
  status      PaymentPageStatus @default(DRAFT)

  // Theme & Branding
  themeId       String?
  customStyles  Json?          // Override theme styles

  // Branding
  logoUrl       String?
  faviconUrl    String?
  brandColor    String?        // Primary brand color

  // Content
  title         String?        // Page title
  description   String?        // Description shown to customer
  headline      String?        // Main headline on page
  subheadline   String?        // Supporting text

  // Payment Configuration
  paymentConfig Json           // PaymentPageConfig - amounts, currencies, methods

  // Accepted Payment Methods (ordered by preference)
  acceptedGateways Json        // Array of PaymentGatewayType with priority

  // Product/Line Items Configuration
  lineItemsConfig Json?        // For CHECKOUT type - product definitions

  // Subscription Configuration
  subscriptionConfig Json?     // For SUBSCRIPTION type - plans, trials

  // Donation Configuration
  donationConfig Json?         // For DONATION type - suggested amounts, min/max

  // Customer Fields Configuration
  customerFieldsConfig Json    // Which fields to collect (email, name, phone, address)

  // Shipping Configuration
  shippingEnabled Boolean @default(false)
  shippingConfig  Json?        // Shipping methods and rates

  // Tax Configuration
  taxEnabled      Boolean @default(false)
  taxConfig       Json?        // Tax calculation settings

  // Discount/Coupon Configuration
  discountsEnabled Boolean @default(false)
  discountsConfig  Json?       // Coupon settings

  // Terms & Policies
  termsUrl          String?
  privacyUrl        String?
  refundPolicyUrl   String?
  customTermsText   String?    @db.Text
  requireTermsAccept Boolean   @default(false)

  // Success/Cancel Configuration
  successUrl        String?    // Redirect after success
  cancelUrl         String?    // Redirect on cancel
  successMessage    String?    // Message shown on success

  // Webhook Configuration
  webhookUrl        String?    // Notify on payment events
  webhookSecret     String?    // HMAC secret for webhook verification

  // AI & Analytics
  aiInsightsEnabled    Boolean @default(true)
  conversionTracking   Boolean @default(true)

  // A/B Testing
  isVariant         Boolean @default(false)
  parentPageId      String?    // Original page if this is a variant
  variantName       String?    // A, B, C, etc.
  variantWeight     Int?       // Traffic percentage (0-100)

  // SEO
  metaTitle         String?
  metaDescription   String?
  ogImage           String?
  noIndex           Boolean @default(false)

  // Security
  allowedDomains    Json?      // Domains that can embed this page
  rateLimit         Int?       // Sessions per IP per hour

  // PCI Compliance
  scriptInventory   Json?      // Authorized scripts for PCI 6.4.3
  cspPolicy         Json?      // Content Security Policy

  // Publishing
  publishedAt       DateTime?
  publishedBy       String?

  // Soft delete
  deletedAt         DateTime?
  deletedBy         String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String

  // Relations
  company   Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  theme     CheckoutPageTheme? @relation(fields: [themeId], references: [id])
  sessions  PaymentPageSession[]
  analytics PaymentPageAnalytics[]
  variants  PaymentPage[]      @relation("PageVariants")
  parent    PaymentPage?       @relation("PageVariants", fields: [parentPageId], references: [id])

  @@unique([companyId, slug])
  @@index([companyId])
  @@index([status])
  @@index([type])
  @@index([deletedAt])
  @@map("payment_pages")
}

// ═══════════════════════════════════════════════════════════════════════════════
// PAYMENT SESSIONS - Individual checkout sessions
// ═══════════════════════════════════════════════════════════════════════════════

model PaymentPageSession {
  id        String @id @default(cuid())
  pageId    String

  // Session Identity
  sessionToken    String   @unique  // Public token for URL
  expiresAt       DateTime

  // Customer Information
  customerId      String?           // If existing customer
  customerEmail   String?
  customerName    String?
  customerPhone   String?

  // Billing Address
  billingAddress  Json?

  // Shipping Address (if different)
  shippingAddress Json?

  // Payment Details
  currency        String   @default("USD")
  subtotal        Decimal  @db.Decimal(15, 2)
  discountAmount  Decimal  @default(0) @db.Decimal(15, 2)
  taxAmount       Decimal  @default(0) @db.Decimal(15, 2)
  shippingAmount  Decimal  @default(0) @db.Decimal(15, 2)
  total           Decimal  @db.Decimal(15, 2)

  // Line Items
  lineItems       Json?    // Array of items with prices

  // Subscription Details (if applicable)
  subscriptionPlanId String?
  trialDays         Int?

  // Discount Applied
  discountCode      String?
  discountId        String?

  // Status & Completion
  status            PaymentSessionStatus @default(PENDING)
  completedAt       DateTime?
  failedAt          DateTime?
  failureReason     String?

  // Gateway Information
  selectedGateway   PaymentGatewayType?
  gatewaySessionId  String?            // External session ID (Stripe PaymentIntent, etc.)
  gatewayCustomerId String?            // External customer ID

  // Transaction Reference
  transactionId     String?            // Our internal transaction ID
  orderId           String?            // Our internal order ID
  subscriptionId    String?            // Our internal subscription ID

  // AI Risk Assessment
  riskScore         Int?               // 0-100
  riskLevel         String?            // LOW, MEDIUM, HIGH, CRITICAL
  riskFactors       Json?              // Explanation of risk factors

  // Device & Analytics
  deviceType        String?            // desktop, mobile, tablet
  browserType       String?
  browserVersion    String?
  osType            String?
  ipAddress         String?
  country           String?
  region            String?
  city              String?

  // Attribution
  utmSource         String?
  utmMedium         String?
  utmCampaign       String?
  utmTerm           String?
  utmContent        String?
  referrer          String?

  // Journey Tracking (for funnel analysis)
  journeyEvents     Json?              // Array of timestamped events

  // A/B Test Tracking
  variantId         String?            // Which variant was shown

  // Custom Metadata
  metadata          Json?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  page      PaymentPage @relation(fields: [pageId], references: [id], onDelete: Cascade)
  customer  Customer?   @relation(fields: [customerId], references: [id])

  @@index([pageId])
  @@index([sessionToken])
  @@index([status])
  @@index([customerId])
  @@index([expiresAt])
  @@index([createdAt])
  @@map("payment_page_sessions")
}

// ═══════════════════════════════════════════════════════════════════════════════
// PAYMENT PAGE ANALYTICS - Aggregated metrics
// ═══════════════════════════════════════════════════════════════════════════════

model PaymentPageAnalytics {
  id        String @id @default(cuid())
  pageId    String

  // Time Period
  date      DateTime @db.Date
  hour      Int?     // 0-23 for hourly breakdown, null for daily

  // Traffic Metrics
  pageViews         Int @default(0)
  uniqueVisitors    Int @default(0)

  // Conversion Funnel
  sessionsStarted      Int @default(0)
  emailEntered         Int @default(0)
  paymentMethodSelected Int @default(0)
  paymentAttempted     Int @default(0)
  paymentCompleted     Int @default(0)

  // Outcomes
  successfulPayments   Int @default(0)
  failedPayments       Int @default(0)
  abandonedSessions    Int @default(0)
  expiredSessions      Int @default(0)

  // Revenue
  totalRevenue         Decimal @default(0) @db.Decimal(15, 2)
  averageOrderValue    Decimal? @db.Decimal(15, 2)

  // Rates (calculated)
  conversionRate       Decimal? @db.Decimal(5, 4)  // 0.0000 to 1.0000
  abandonmentRate      Decimal? @db.Decimal(5, 4)
  failureRate          Decimal? @db.Decimal(5, 4)

  // Gateway Breakdown
  gatewayBreakdown     Json?    // { stripe: { attempts: 10, success: 8 }, paypal: {...} }

  // Device Breakdown
  deviceBreakdown      Json?    // { desktop: 60, mobile: 35, tablet: 5 }

  // Geographic Breakdown
  countryBreakdown     Json?    // { US: 70, CA: 15, UK: 10, ... }

  // AI Insights (generated periodically)
  aiInsights           Json?    // AI-generated insights and recommendations

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  page PaymentPage @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@unique([pageId, date, hour])
  @@index([pageId])
  @@index([date])
  @@map("payment_page_analytics")
}

// ═══════════════════════════════════════════════════════════════════════════════
// PAYMENT PAGE GATEWAY CONFIG - Per-page gateway settings
// ═══════════════════════════════════════════════════════════════════════════════

model PaymentPageGatewayConfig {
  id        String @id @default(cuid())
  pageId    String

  // Gateway
  gateway           PaymentGatewayType
  integrationId     String?            // Reference to ClientIntegration

  // Priority & Status
  priority          Int @default(0)    // Lower = higher priority
  isEnabled         Boolean @default(true)

  // Gateway-specific settings
  settings          Json?              // Gateway-specific configuration

  // Display Configuration
  displayName       String?            // Custom name shown to customer
  iconUrl           String?            // Custom icon

  // Restrictions
  minAmount         Decimal? @db.Decimal(15, 2)
  maxAmount         Decimal? @db.Decimal(15, 2)
  allowedCurrencies Json?              // Array of currency codes
  allowedCountries  Json?              // Array of country codes

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([pageId, gateway])
  @@index([pageId])
  @@map("payment_page_gateway_configs")
}

// ═══════════════════════════════════════════════════════════════════════════════
// CUSTOM DOMAINS - Domain configuration for payment pages
// ═══════════════════════════════════════════════════════════════════════════════

model PaymentPageDomain {
  id        String @id @default(cuid())
  companyId String

  // Domain Configuration
  domain            String   @unique   // checkout.example.com
  isVerified        Boolean  @default(false)
  verificationToken String?            // DNS TXT record value
  verifiedAt        DateTime?

  // SSL Configuration
  sslStatus         String   @default("PENDING") // PENDING, PROVISIONING, ACTIVE, FAILED
  sslExpiresAt      DateTime?

  // DNS Records (for customer to configure)
  cnameTarget       String?            // What CNAME should point to

  // Default Page
  defaultPageId     String?            // Default page for this domain

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String

  @@index([companyId])
  @@index([domain])
  @@map("payment_page_domains")
}

// ═══════════════════════════════════════════════════════════════════════════════
// FUNNEL BUILDER - Multi-stage conversion funnels with A/B testing
// ═══════════════════════════════════════════════════════════════════════════════

enum FunnelType {
  DIRECT_CHECKOUT     // Checkout only
  PRODUCT_CHECKOUT    // Product Selection → Checkout
  LANDING_CHECKOUT    // Landing → Checkout
  FULL_FUNNEL         // Landing → Product → Checkout
}

enum FunnelStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum StageType {
  LANDING
  PRODUCT_SELECTION
  CHECKOUT
}

enum FunnelSessionStatus {
  ACTIVE
  COMPLETED
  ABANDONED
  EXPIRED
}

enum FunnelEventType {
  // Navigation
  STAGE_ENTERED
  STAGE_COMPLETED
  STAGE_ABANDONED
  // Product Selection
  PRODUCT_VIEWED
  PRODUCT_ADDED
  PRODUCT_REMOVED
  QUANTITY_CHANGED
  // Checkout
  CHECKOUT_STARTED
  FIELD_COMPLETED
  PAYMENT_METHOD_SELECTED
  COUPON_APPLIED
  COUPON_FAILED
  // Conversion
  PAYMENT_INITIATED
  PAYMENT_COMPLETED
  PAYMENT_FAILED
  // Other
  ERROR_OCCURRED
  CUSTOM_EVENT
}

enum FunnelVariantStatus {
  ACTIVE
  PAUSED
  WINNER
  LOSER
}

enum WinnerSelectionMode {
  MANUAL              // Option 1: Manual only
  AUTO_PAUSE_LOSERS   // Option 2: Auto-pause losers, manual winner
  AUTO_WITH_APPROVAL  // Option 3: Auto-select winner, requires approval
}

enum FunnelABTestStatus {
  DRAFT
  RUNNING
  PAUSED
  COMPLETED
  CANCELLED
}

enum AIInsightType {
  DROP_OFF_ALERT
  CONVERSION_OPPORTUNITY
  PRICING_SUGGESTION
  UX_IMPROVEMENT
  COPY_ENHANCEMENT
  AB_TEST_RECOMMENDATION
  SEGMENT_INSIGHT
  BENCHMARK_COMPARISON
}

enum InsightStatus {
  PENDING
  APPLIED
  DISMISSED
  EXPIRED
}

enum InsightSource {
  RULE_BASED
  LLM
}

enum FunnelTemplateType {
  FULL_FUNNEL
  COMPONENT
}

model Funnel {
  id              String          @id @default(cuid())
  companyId       String
  company         Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Optional site association (for multi-site companies)
  siteId          String?
  site            Site?           @relation(fields: [siteId], references: [id], onDelete: SetNull)

  // Basic Info
  name            String
  slug            String          // Company-scoped slug for admin reference
  shortId         String          @unique // Public URL: /f/{shortId} - globally unique short ID
  description     String?

  // Configuration
  type            FunnelType
  status          FunnelStatus    @default(DRAFT)

  // Settings (branding, URLs, behavior, SEO, AI settings)
  settings        Json            @default("{}")

  // A/B Testing
  activeTestId    String?         // Current A/B test

  // Analytics (denormalized for performance)
  totalVisits     Int             @default(0)
  totalConversions Int            @default(0)

  // Timestamps
  publishedAt     DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  createdBy       String

  // Relations
  stages          FunnelStage[]
  variants        FunnelVariant[]
  sessions        FunnelSession[]
  aiInsights      FunnelAIInsight[]
  abTests         FunnelABTest[]
  aiGeneration    AIFunnelGeneration?

  @@unique([companyId, slug])
  @@index([companyId])
  @@index([status])
  @@index([shortId])
  @@map("funnels")
}

model FunnelStage {
  id              String          @id @default(cuid())
  funnelId        String
  funnel          Funnel          @relation(fields: [funnelId], references: [id], onDelete: Cascade)

  // Stage Info
  name            String          // "Landing", "Products", "Checkout"
  type            StageType
  order           Int             // 0, 1, 2...

  // Stage Configuration (polymorphic JSON based on type)
  config          Json            @default("{}")

  // Design
  themeId         String?
  customStyles    Json?

  // Timestamps
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@unique([funnelId, order])
  @@index([funnelId])
  @@map("funnel_stages")
}

model FunnelVariant {
  id              String              @id @default(cuid())
  funnelId        String
  funnel          Funnel              @relation(fields: [funnelId], references: [id], onDelete: Cascade)

  // Variant Info
  name            String              // "Control", "Variant A", "Variant B"
  description     String?
  isControl       Boolean             @default(false)

  // Traffic Allocation
  trafficWeight   Int                 @default(50) // Percentage

  // Configuration Override (stage overrides for this variant)
  stageOverrides  Json?

  // Status
  status          FunnelVariantStatus @default(ACTIVE)

  // Metrics (denormalized for performance)
  totalSessions   Int                 @default(0)
  conversions     Int                 @default(0)
  revenue         Decimal             @default(0) @db.Decimal(15, 2)

  // Timestamps
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // Relations
  sessions        FunnelSession[]
  testResults     FunnelABTestResult[]

  @@index([funnelId])
  @@index([status])
  @@map("funnel_variants")
}

model FunnelSession {
  id              String              @id @default(cuid())
  funnelId        String
  funnel          Funnel              @relation(fields: [funnelId], references: [id])

  // Session Token (for anonymous tracking)
  sessionToken    String              @unique

  // A/B Test Assignment
  variantId       String?
  variant         FunnelVariant?      @relation(fields: [variantId], references: [id])

  // Lead Tracking (links anonymous session to identified lead)
  leadId          String?
  lead            Lead?               @relation(fields: [leadId], references: [id])

  // Progress
  currentStageOrder Int               @default(0)
  completedStages   Int[]             @default([])
  status          FunnelSessionStatus @default(ACTIVE)

  // Cart Integration (for churn detection and cart save flow)
  cartId          String?
  cart            Cart?               @relation(fields: [cartId], references: [id])

  // Checkout Behavior Tracking (for churn detection analytics)
  checkoutBehavior Json?

  // Collected Data
  selectedProducts  Json              @default("[]")
  customerInfo      Json              @default("{}")
  shippingAddress   Json?
  billingAddress    Json?
  customFields      Json              @default("{}")

  // Attribution
  entryUrl        String?
  utmSource       String?
  utmMedium       String?
  utmCampaign     String?
  utmTerm         String?
  utmContent      String?
  referrer        String?
  userAgent       String?
  ipAddress       String?

  // Device Info
  deviceType      String?             // mobile, tablet, desktop
  browser         String?
  os              String?

  // Outcome
  orderId         String?             @unique
  totalAmount     Decimal?            @db.Decimal(15, 2)
  currency        String?

  // Timestamps
  startedAt       DateTime            @default(now())
  lastActivityAt  DateTime            @default(now())
  completedAt     DateTime?
  abandonedAt     DateTime?

  // Consent Tracking (Compliance)
  termsAcceptedAt   DateTime?
  privacyAcceptedAt DateTime?

  // Customer Service Integration
  csSessionId     String?
  csSession       CSSession?      @relation(fields: [csSessionId], references: [id])

  // Events for detailed tracking
  events          FunnelEvent[]

  @@index([funnelId])
  @@index([variantId])
  @@index([leadId])
  @@index([cartId])
  @@index([status])
  @@index([startedAt])
  @@index([csSessionId])
  @@map("funnel_sessions")
}

model FunnelEvent {
  id              String          @id @default(cuid())
  sessionId       String
  session         FunnelSession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Event Info
  type            FunnelEventType
  stageOrder      Int

  // Event Data
  data            Json            @default("{}")

  // Timestamp
  timestamp       DateTime        @default(now())

  @@index([sessionId])
  @@index([type])
  @@index([timestamp])
  @@map("funnel_events")
}

model FunnelABTest {
  id              String              @id @default(cuid())
  funnelId        String
  funnel          Funnel              @relation(fields: [funnelId], references: [id], onDelete: Cascade)

  // Test Info
  name            String
  hypothesis      String?

  // Configuration
  winnerSelectionMode WinnerSelectionMode @default(MANUAL)
  minimumSessions Int                 @default(100)
  confidenceThreshold Decimal         @default(0.95) @db.Decimal(3, 2)

  // Auto-actions
  autoPauseLosers Boolean             @default(false)
  autoSelectWinner Boolean            @default(false)
  requireApproval Boolean             @default(true)

  // Status
  status          FunnelABTestStatus  @default(DRAFT)

  // Results
  winnerId        String?

  // Timestamps
  startedAt       DateTime?
  endedAt         DateTime?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  createdBy       String

  // Relations
  results         FunnelABTestResult[]

  @@index([funnelId])
  @@index([status])
  @@map("funnel_ab_tests")
}

model FunnelABTestResult {
  id              String          @id @default(cuid())
  testId          String
  test            FunnelABTest    @relation(fields: [testId], references: [id], onDelete: Cascade)
  variantId       String
  variant         FunnelVariant   @relation(fields: [variantId], references: [id])

  // Metrics at snapshot time
  sessions        Int
  conversions     Int
  conversionRate  Decimal         @db.Decimal(5, 4)
  revenue         Decimal         @db.Decimal(15, 2)
  avgOrderValue   Decimal         @db.Decimal(15, 2)

  // Statistical Analysis
  confidenceLevel Decimal         @db.Decimal(5, 4)
  improvementOverControl Decimal? @db.Decimal(6, 4)
  isStatisticallySignificant Boolean @default(false)

  // Timestamp
  calculatedAt    DateTime        @default(now())

  @@index([testId])
  @@index([variantId])
  @@map("funnel_ab_test_results")
}

model FunnelAIInsight {
  id              String          @id @default(cuid())
  funnelId        String
  funnel          Funnel          @relation(fields: [funnelId], references: [id], onDelete: Cascade)

  // Insight Info
  type            AIInsightType
  category        String          // "conversion", "pricing", "ux", "copy"
  title           String
  description     String          @db.Text

  // Confidence
  confidenceScore Decimal         @db.Decimal(3, 2) // 0.00 - 1.00
  dataPoints      Int             // Number of sessions analyzed

  // Recommendation
  recommendation  Json            // Specific changes suggested
  estimatedImpact String?         // "Potential +15% conversion"

  // Action Status
  status          InsightStatus   @default(PENDING)
  actionTaken     String?
  actionTakenAt   DateTime?
  actionTakenBy   String?

  // Source
  source          InsightSource   // RULE_BASED or LLM
  creditsUsed     Int             @default(0)

  // Timestamps
  generatedAt     DateTime        @default(now())
  expiresAt       DateTime?

  @@index([funnelId])
  @@index([status])
  @@index([type])
  @@map("funnel_ai_insights")
}

model AICreditsBalance {
  id              String          @id @default(cuid())
  companyId       String          @unique

  // Balance
  monthlyAllocation Int           @default(100)
  currentBalance  Int             @default(100)
  purchasedCredits Int            @default(0)

  // Reset
  lastResetAt     DateTime        @default(now())
  nextResetAt     DateTime

  // Timestamps
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@map("ai_credits_balances")
}

model AICreditsUsage {
  id              String          @id @default(cuid())
  companyId       String

  // Usage Info
  action          String          // "funnel_insight", "copy_generation", etc.
  creditsUsed     Int
  funnelId        String?

  // Timestamp
  usedAt          DateTime        @default(now())

  @@index([companyId])
  @@index([usedAt])
  @@map("ai_credits_usage")
}

model FunnelTemplate {
  id              String              @id @default(cuid())

  // Template Info
  name            String
  slug            String              @unique  // For /preview/{slug}
  description     String
  thumbnail       String?             // Preview image URL

  // Type
  templateType    FunnelTemplateType
  category        String              // "ecommerce", "saas", "donations", etc.

  // Configuration
  config          Json                // Full funnel or component config

  // Demo
  demoUrl         String?

  // Metadata
  featured        Boolean             @default(false)
  industry        String[]            @default([])
  tags            String[]            @default([])

  // Stats
  usageCount      Int                 @default(0)

  // Timestamps
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([category])
  @@index([templateType])
  @@map("funnel_templates")
}

// =============================================================================
// FEATURE DEVELOPMENT TRACKING
// Organization-level feature development pipeline with QA workflow
// =============================================================================

model Feature {
  id              String        @id @default(cuid())
  organizationId  String

  // Identification
  code            String        @unique // "01-funnels", "02-subscriptions"
  name            String
  description     String?
  branch          String        // "feature/01-funnels"

  // Status
  status          FeatureStatus @default(DEVELOPMENT)
  priority        Int           @default(0) // Higher = more urgent

  // Ownership
  developerId     String?       // User who developed
  developerName   String?       // For display
  qaAssigneeId    String?       // User/AI doing QA
  qaAssigneeName  String?
  reviewerId      String?       // Sr Dev reviewing
  reviewerName    String?

  // Documentation (JSON for flexibility)
  specDocument    Json?         // Feature specification
  qaChecklist     Json?         // Generated test cases
  qaReport        Json?         // QA findings
  reviewQuestions Json?         // Questions from Sr Dev → Human
  humanAnswers    Json?         // Human responses to questions

  // Files changed
  filesAdded      String[]      @default([])
  filesModified   String[]      @default([])
  filesDeleted    String[]      @default([])

  // Permissions added
  permissionsAdded String[]     @default([])

  // Metrics
  qaRounds        Int           @default(0)
  issuesFound     Int           @default(0)
  issuesResolved  Int           @default(0)

  // Timestamps
  startedAt       DateTime      @default(now())
  qaStartedAt     DateTime?
  reviewStartedAt DateTime?
  questionsReadyAt DateTime?
  answeredAt      DateTime?
  approvedAt      DateTime?
  mergedAt        DateTime?

  // Relations
  organization    Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  issues          FeatureIssue[]
  activities      FeatureActivity[]
  testAccounts    FeatureTestAccount[]

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([organizationId])
  @@index([status])
  @@index([priority])
  @@map("features")
}

enum FeatureStatus {
  DEVELOPMENT       // Active development
  // Code Review Phase (before QA)
  READY_FOR_REVIEW  // Dev complete, waiting for code review
  CODE_REVIEW       // Sr Dev reviewing code
  REVIEW_FIXING     // Developer fixing review issues
  // QA Phase (after code review passes)
  READY_FOR_QA      // Code review passed, waiting for QA
  QA_IN_PROGRESS    // QA actively testing
  QA_COMPLETE       // Issues documented
  SR_REVIEW         // Sr Dev reviewing QA report
  QUESTIONS_READY   // Questions waiting for human
  AWAITING_ANSWERS  // Human notified, waiting
  SR_FIXING         // Sr Dev fixing issues
  READY_FOR_RETEST  // Fixes done, back to QA
  APPROVED          // Ready to merge
  MERGED            // Done
  CANCELLED         // Abandoned
}

model FeatureIssue {
  id              String        @id @default(cuid())
  featureId       String

  // Identification
  code            String        // "QA-001", "QA-002"

  // Classification
  severity        IssueSeverity
  category        IssueCategory

  // Details
  title           String
  description     String        @db.Text
  stepsToReproduce String?      @db.Text
  expectedBehavior String?      @db.Text
  actualBehavior  String?       @db.Text

  // Location
  filePath        String?
  lineNumber      Int?
  pageUrl         String?       // For UI issues
  apiEndpoint     String?       // For API issues

  // Evidence
  screenshots     String[]      @default([])
  errorLogs       String?       @db.Text

  // Resolution
  status          IssueStatus   @default(OPEN)
  resolution      String?       @db.Text
  resolvedBy      String?
  resolvedAt      DateTime?

  // QA verification after fix
  retestStatus    RetestStatus?
  retestNotes     String?
  retestedAt      DateTime?
  retestedBy      String?

  // Relations
  feature         Feature       @relation(fields: [featureId], references: [id], onDelete: Cascade)

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([featureId])
  @@index([status])
  @@index([severity])
  @@map("feature_issues")
}

enum IssueSeverity {
  CRITICAL      // Blocks release, security issue
  HIGH          // Major functionality broken
  MEDIUM        // Functionality impaired but workaround exists
  LOW           // Minor/cosmetic issue
  SUGGESTION    // Enhancement idea for future
}

enum IssueCategory {
  BUG              // Code defect
  SECURITY         // Security vulnerability
  PERFORMANCE      // Slow, inefficient
  UX               // User experience issue
  ACCESSIBILITY    // A11y issue
  CODE_QUALITY     // Code smell, maintainability
  TESTING          // Missing tests
  DOCUMENTATION    // Missing/wrong docs
  PERMISSIONS      // RBAC/auth issue
  DATA_INTEGRITY   // Data validation issue
  INTEGRATION      // Third-party integration issue
}

enum IssueStatus {
  OPEN            // New issue
  IN_PROGRESS     // Being fixed
  RESOLVED        // Fix applied
  WONT_FIX        // Intentional, not a bug
  DUPLICATE       // Already reported
  CANNOT_REPRODUCE // Unable to reproduce
}

enum RetestStatus {
  PENDING   // Waiting for retest
  PASSED    // Fix verified
  FAILED    // Fix didn't work
}

model FeatureActivity {
  id              String        @id @default(cuid())
  featureId       String

  // Activity info
  action          String        // "STATUS_CHANGED", "ISSUE_CREATED", etc.
  fromStatus      FeatureStatus?
  toStatus        FeatureStatus?
  details         Json?

  // Actor
  performedBy     String        // User ID or "AI_QA", "AI_SR_DEV"
  performedByName String?

  // Timestamp
  performedAt     DateTime      @default(now())

  // Relations
  feature         Feature       @relation(fields: [featureId], references: [id], onDelete: Cascade)

  @@index([featureId])
  @@index([performedAt])
  @@map("feature_activities")
}

// Test accounts for QA to use when testing features
model FeatureTestAccount {
  id              String        @id @default(cuid())
  featureId       String

  // Account info
  role            String        // "org_admin", "client_admin", "company_user"
  email           String
  password        String        // Stored encrypted or as temp password
  userId          String?       // Reference to actual user

  // Context
  organizationId  String?
  clientId        String?
  companyId       String?

  // Notes
  purpose         String        // "Test as company user without permissions"

  // Relations
  feature         Feature       @relation(fields: [featureId], references: [id], onDelete: Cascade)

  createdAt       DateTime      @default(now())

  @@index([featureId])
  @@map("feature_test_accounts")
}

// =============================================================================
// QA CHECKLIST TEMPLATES
// Standard checks that QA should perform for every feature
// =============================================================================

model QAChecklistTemplate {
  id              String              @id @default(cuid())

  // Identification
  name            String              // "Security Checks", "Permission Checks"
  description     String?
  category        QACheckCategory

  // Checks
  checks          QAChecklistItem[]

  // Applicability
  applicableTo    String[]            @default([]) // ["api", "frontend", "both"]
  isRequired      Boolean             @default(true)

  // Order
  displayOrder    Int                 @default(0)

  isActive        Boolean             @default(true)

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@map("qa_checklist_templates")
}

model QAChecklistItem {
  id              String              @id @default(cuid())
  templateId      String

  // Check details
  title           String
  description     String              @db.Text
  howToTest       String?             @db.Text // Instructions for QA

  // Tools/commands
  testCommand     String?             // CLI command to run
  testEndpoint    String?             // API endpoint to test

  // Expected result
  expectedResult  String              @db.Text

  // Severity if fails
  failureSeverity IssueSeverity       @default(MEDIUM)

  // Order
  displayOrder    Int                 @default(0)

  isActive        Boolean             @default(true)

  // Relations
  template        QAChecklistTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([templateId])
  @@map("qa_checklist_items")
}

enum QACheckCategory {
  SECURITY            // Auth, permissions, input validation
  PERMISSIONS         // RBAC, tenant isolation
  FUNCTIONALITY       // Core feature works
  ERROR_HANDLING      // Error states handled
  EDGE_CASES          // Boundary conditions
  PERFORMANCE         // Load times, efficiency
  ACCESSIBILITY       // A11y compliance
  RESPONSIVE          // Mobile/tablet
  DATA_INTEGRITY      // Data saved correctly
  INTEGRATION         // Third-party services
  DOCUMENTATION       // API docs, help text
}

// =============================================================================
// CODE REVIEW CHECKLIST TEMPLATES
// Senior developer review checks before QA (compliance, security, code quality)
// =============================================================================

model CodeReviewChecklistTemplate {
  id              String                    @id @default(cuid())

  // Identification
  name            String                    // "SOC2 Compliance", "Security Checks"
  description     String?
  category        CodeReviewCategory

  // Checks
  checks          CodeReviewChecklistItem[]

  // Compliance reference
  complianceRef   String?                   // "SOC2 CC6.1", "PCI-DSS 3.4", "GDPR Art 17"

  // Applicability
  applicableTo    String[]                  @default([]) // ["api", "frontend", "both"]
  isRequired      Boolean                   @default(true)

  // Order
  displayOrder    Int                       @default(0)

  isActive        Boolean                   @default(true)

  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt

  @@map("code_review_checklist_templates")
}

model CodeReviewChecklistItem {
  id              String                       @id @default(cuid())
  templateId      String

  // Check details
  code            String                       // "SEC_001", "SOC2_003"
  title           String
  description     String                       @db.Text
  checkSteps      String[]                     @default([]) // Steps to verify

  // Compliance
  complianceRef   String?                      // "SOC2 CC6.1", "PCI-DSS 3.4"
  failureImpact   String?                      @db.Text // What happens if this fails

  // Severity if fails
  severity        IssueSeverity                @default(MEDIUM)

  // Order
  displayOrder    Int                          @default(0)

  isActive        Boolean                      @default(true)

  // Relations
  template        CodeReviewChecklistTemplate  @relation(fields: [templateId], references: [id], onDelete: Cascade)

  createdAt       DateTime                     @default(now())
  updatedAt       DateTime                     @updatedAt

  @@index([templateId])
  @@map("code_review_checklist_items")
}

enum CodeReviewCategory {
  // Code Quality
  CODE_QUALITY        // Conventions, readability, maintainability
  ARCHITECTURE        // Design patterns, separation of concerns
  TYPE_SAFETY         // TypeScript types, DTOs
  ERROR_HANDLING      // Exception handling, logging
  MAINTAINABILITY     // Self-documenting code, dependencies
  TESTING             // Unit tests, integration tests
  // Security (OWASP)
  SECURITY            // OWASP Top 10 vulnerabilities
  AUTHENTICATION      // JWT, sessions, MFA
  AUTHORIZATION       // RBAC, IDOR prevention
  INPUT_VALIDATION    // Whitelist validation, sanitization
  OUTPUT_ENCODING     // XSS prevention, encoding
  CRYPTOGRAPHY        // Encryption, key management
  // Compliance
  SOC2                // Service Organization Control 2
  ISO27001            // ISO 27001 information security
  PCI_DSS             // Payment Card Industry Data Security Standard
  GDPR                // General Data Protection Regulation
  // Performance & Best Practices
  PERFORMANCE         // N+1 queries, caching, optimization
  DATABASE            // Migrations, transactions, integrity
  API_DESIGN          // RESTful conventions, versioning
  LOGGING             // Log levels, sensitive data protection
}

// =============================================================================
// LEAD MANAGEMENT SYSTEM
// Separate from Customer for pre-conversion tracking with progressive capture
// =============================================================================

enum LeadStatus {
  ANONYMOUS       // No identifying info yet
  IDENTIFIED      // Has email or phone
  QUALIFIED       // Engaged, high intent
  CONVERTED       // Became a customer
  ABANDONED       // Left funnel without converting
  NURTURING       // Re-engagement sequence
  DISQUALIFIED    // Invalid, spam, or opted out
}

enum LeadSource {
  FUNNEL          // Captured via funnel
  LANDING_PAGE    // Direct landing page
  CHECKOUT_ABANDON // Cart/checkout abandonment
  FORM            // Contact/signup form
  IMPORT          // Bulk import
  API             // External API
  MANUAL          // Manually entered
}

model Lead {
  id              String        @id @default(cuid())
  companyId       String
  company         Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Identity (progressive capture - saved as fields are entered)
  email           String?       // First capture priority
  emailVerified   Boolean       @default(false)
  phone           String?
  phoneVerified   Boolean       @default(false)
  firstName       String?
  lastName        String?

  // Source Tracking
  source          LeadSource    @default(FUNNEL)
  sourceId        String?       // funnelId, formId, etc.
  sourceName      String?       // "Coffee Explorer Funnel"

  // Attribution (from first touch)
  utmSource       String?
  utmMedium       String?
  utmCampaign     String?
  utmTerm         String?
  utmContent      String?
  referrer        String?
  landingPage     String?

  // Device/Browser (from first session)
  deviceType      String?       // mobile, tablet, desktop
  browser         String?
  os              String?
  ipAddress       String?
  geoCountry      String?
  geoRegion       String?
  geoCity         String?

  // Funnel Progress (snapshot of best progress)
  funnelId        String?       // Last/primary funnel
  highestStage    Int           @default(0)
  lastStageName   String?       // "Checkout"
  abandonStage    Int?          // Where they dropped off
  abandonReason   String?       // "payment_failed", "exited", "idle"

  // Progressive Form Data (JSON for flexibility)
  // Stores all captured fields: { firstName: "John", address1: "123 Main", ... }
  capturedFields  Json          @default("{}")
  fieldCaptureLog Json          @default("[]") // [{ field, value, timestamp, stage }]

  // Engagement Metrics
  totalSessions   Int           @default(0)
  totalPageViews  Int           @default(0)
  totalTimeOnSite Int           @default(0) // seconds
  engagementScore Float         @default(0) // 0-1, calculated
  intentScore     Float         @default(0) // 0-1, purchase likelihood

  // Value Assessment
  estimatedValue  Decimal       @default(0) @db.Decimal(10, 2) // Potential revenue
  cartValue       Decimal       @default(0) @db.Decimal(10, 2) // Last cart total
  cartItems       Json          @default("[]") // Products in abandoned cart

  // Status & Lifecycle
  status          LeadStatus    @default(ANONYMOUS)
  qualifiedAt     DateTime?
  qualifiedReason String?       // "high_intent", "returning", "filled_checkout"

  // Conversion (if converted to customer)
  convertedAt     DateTime?
  customerId      String?       @unique
  customer        Customer?     @relation(fields: [customerId], references: [id])
  conversionOrderId String?     // First order that converted them

  // Re-engagement
  lastContactedAt DateTime?
  contactCount    Int           @default(0)
  optedOut        Boolean       @default(false)
  optedOutAt      DateTime?

  // Timestamps
  firstSeenAt     DateTime      @default(now())
  lastSeenAt      DateTime      @default(now())
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Soft delete
  deletedAt       DateTime?
  deletedBy       String?

  // Relations
  sessions        FunnelSession[]
  activities      LeadActivity[]
  visitorProfile  FunnelVisitorProfile?

  @@unique([companyId, email])
  @@index([companyId])
  @@index([status])
  @@index([email])
  @@index([phone])
  @@index([funnelId])
  @@index([engagementScore])
  @@index([lastSeenAt])
  @@index([convertedAt])
  @@map("leads")
}

model LeadActivity {
  id              String        @id @default(cuid())
  leadId          String
  lead            Lead          @relation(fields: [leadId], references: [id], onDelete: Cascade)

  // Activity Info
  type            String        // "field_captured", "stage_reached", "cart_updated", "email_opened"
  category        String        // "capture", "engagement", "funnel", "email", "conversion"
  description     String?

  // Activity Data
  data            Json          @default("{}")
  // For field_captured: { field: "email", value: "john@...", stage: 1 }
  // For stage_reached: { stage: 2, stageName: "Checkout" }
  // For cart_updated: { action: "add", productId: "...", quantity: 2 }

  // Context
  sessionToken    String?
  funnelId        String?
  stageOrder      Int?

  // Timestamp
  occurredAt      DateTime      @default(now())

  @@index([leadId])
  @@index([type])
  @@index([occurredAt])
  @@map("lead_activities")
}

model FunnelVisitorProfile {
  id              String        @id @default(cuid())

  // Identity (multiple methods)
  visitorFingerprint String?    @unique  // Browser fingerprint hash
  leadId          String?       @unique
  lead            Lead?         @relation(fields: [leadId], references: [id])
  email           String?

  // Aggregated Behavior (across all sessions)
  totalSessions   Int           @default(0)
  totalPurchases  Int           @default(0)
  totalRevenue    Decimal       @default(0) @db.Decimal(10, 2)
  totalAbandons   Int           @default(0)

  // Preferences (Learned over time)
  preferredDevice String?       // 'desktop' | 'mobile' | 'tablet'
  preferredTimeOfDay Int?       // Hour most active (0-23)
  preferredDayOfWeek Int?       // Day most active (0-6)

  // Engagement Patterns
  avgTimeToConvert Int?         // Seconds from start to purchase
  avgSessionDuration Int?       // Seconds
  avgScrollDepth   Float?       // 0-1
  avgPagesPerSession Float?

  // Product Preferences
  viewedCategories Json?        // { "coffee": 5, "accessories": 2 }
  purchasedCategories Json?     // { "coffee": 3 }
  priceRangePref  String?       // 'budget' | 'mid' | 'premium'

  // Conversion Signals (What works for this visitor)
  respondsToDiscounts Boolean   @default(false)
  respondsToUrgency Boolean     @default(false)
  respondsToSocialProof Boolean @default(false)
  respondsToPriceAnchor Boolean @default(false)

  // Risk Assessment
  abandonmentRate  Float        @default(0)  // Historical (0-1)
  avgAbandonStage  Float?       // Where they usually drop (stage order)
  lastAbandonReason String?     // Most recent abandon reason

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([email])
  @@index([visitorFingerprint])
  @@map("funnel_visitor_profiles")
}

// =============================================================================
// CARD VAULT - Secure Payment Method Storage
// PCI-compliant tokenized storage for payment methods
// =============================================================================

enum CardVaultStatus {
  ACTIVE          // Ready for use
  EXPIRED         // Card has expired
  REVOKED         // Customer requested removal
  FAILED          // Repeated failures, disabled
  PENDING         // Awaiting verification
}

enum CardType {
  VISA
  MASTERCARD
  AMEX
  DISCOVER
  DINERS
  JCB
  UNIONPAY
  OTHER
}

enum CardVaultProvider {
  PAYPAL_PAYFLOW   // PayPal Payflow Pro vault
  STRIPE           // Stripe payment methods
  NMI              // NMI customer vault
  AUTHORIZE_NET    // Authorize.net CIM
  INTERNAL         // Our own encrypted storage (backup only)
}

model CardVault {
  id              String            @id @default(cuid())
  companyId       String
  customerId      String

  // Provider & Token
  provider        CardVaultProvider
  providerToken   String            // Provider's vault token/profile ID
  providerCustomerId String?        // Provider's customer ID (if different)

  // Card Display Info (for UI only - NOT actual card data)
  cardType        CardType
  lastFour        String            // Last 4 digits: "4242"
  cardholderName  String?           // Name on card (encrypted)
  expirationMonth Int               // 1-12
  expirationYear  Int               // YYYY format

  // Billing Address (encrypted JSON)
  billingAddress  Json?             // { address1, city, state, zip, country }

  // Status
  status          CardVaultStatus   @default(PENDING)
  isDefault       Boolean           @default(false)

  // Usage Tracking
  lastUsedAt      DateTime?
  successfulUses  Int               @default(0)
  failedUses      Int               @default(0)
  lastFailureReason String?

  // Expiration Alert
  expirationAlertSent Boolean       @default(false)
  expirationAlertAt   DateTime?

  // Metadata
  nickname        String?           // "Work Visa", "Personal Amex"
  metadata        Json              @default("{}")

  // Timestamps
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Soft delete (for audit trail)
  deletedAt       DateTime?
  deletedBy       String?

  // Relations
  company         Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer        Customer          @relation(fields: [customerId], references: [id], onDelete: Cascade)
  transactions    CardVaultTransaction[]

  @@unique([companyId, customerId, providerToken])
  @@index([companyId])
  @@index([customerId])
  @@index([status])
  @@index([expirationYear, expirationMonth])
  @@map("card_vaults")
}

model CardVaultTransaction {
  id              String        @id @default(cuid())
  cardVaultId     String
  cardVault       CardVault     @relation(fields: [cardVaultId], references: [id], onDelete: Cascade)

  // Transaction Reference
  transactionId   String?       // Link to Transaction model
  orderId         String?       // Link to Order model

  // Result
  success         Boolean
  amount          Decimal       @db.Decimal(10, 2)
  currency        String        @default("USD")

  // Provider Response
  providerResponse Json?        // Raw provider response (sanitized)
  errorCode       String?
  errorMessage    String?

  // Metadata
  type            String        // "authorization", "capture", "refund", "void"
  source          String?       // "funnel", "subscription", "manual"

  // Timestamp
  processedAt     DateTime      @default(now())

  @@index([cardVaultId])
  @@index([transactionId])
  @@index([processedAt])
  @@map("card_vault_transactions")
}

// Internal encrypted card storage (used only as fallback/bridge)
// IMPORTANT: This is for temporary storage during checkout,
// NOT for long-term card storage - always migrate to provider vault
model EncryptedCard {
  id              String        @id @default(cuid())
  companyId       String
  sessionToken    String?       // Funnel session reference

  // Encrypted card data (AES-256-GCM)
  encryptedData   String        @db.Text // { cardNumber, cvv, expMonth, expYear }
  keyVersion      Int           @default(1) // For key rotation

  // Fingerprint for duplicate detection
  cardFingerprint String        // Hash of card number for dedup

  // Status
  status          String        @default("pending") // pending, processed, expired, deleted
  processedAt     DateTime?
  expiresAt       DateTime      // Auto-expire after 15 minutes

  // Migration tracking
  migratedToVaultId String?     // CardVault ID after provider tokenization

  // Timestamps
  createdAt       DateTime      @default(now())

  @@index([sessionToken])
  @@index([cardFingerprint])
  @@index([expiresAt])
  @@map("encrypted_cards")
}

// =============================================================================
// AI FUNNEL GENERATOR
// Momentum Intelligence Feature: AI-powered funnel generation
// =============================================================================

model AIMethodologyTemplate {
  id              String          @id @default(cuid())

  // Template metadata
  name            String
  description     String?
  methodology     MarketingMethodology

  // AI configuration
  systemPrompt    String          @db.Text
  stagePrompts    Json            // { landing: "...", checkout: "...", email: "..." }

  // Discovery questions
  questions       Json            // [{ id, question, type, options?, required }]

  // Default funnel structure
  defaultStages   Json            // Default stages to create

  // Template status
  isSystem        Boolean         @default(false) // System-provided template
  isActive        Boolean         @default(true)

  // Ownership (null = system template)
  companyId       String?
  company         Company?        @relation(fields: [companyId], references: [id])

  // Usage tracking
  usageCount      Int             @default(0)

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  generations     AIFunnelGeneration[]

  @@index([methodology])
  @@index([companyId])
  @@map("ai_methodology_templates")
}

model AIFunnelGeneration {
  id              String          @id @default(cuid())
  companyId       String
  company         Company         @relation(fields: [companyId], references: [id])

  // Generation inputs
  templateId      String?
  template        AIMethodologyTemplate? @relation(fields: [templateId], references: [id])
  methodology     MarketingMethodology
  productIds      String[]
  discoveryAnswers Json           // User's answers to questions

  // AI configuration used
  aiProvider      String          // 'bedrock' | 'openai'
  aiModel         String          // 'claude-3-sonnet' | 'gpt-4-turbo'

  // Generated content
  generatedContent Json           // Full AI output (structured)
  rawResponses    Json?           // Raw AI responses (for debugging)

  // Result
  status          GenerationStatus @default(PENDING)
  errorMessage    String?

  // Created funnel (after user saves)
  funnelId        String?         @unique
  funnel          Funnel?         @relation(fields: [funnelId], references: [id])

  // Metrics
  tokensUsed      Int?
  generationTimeMs Int?
  editCount       Int             @default(0) // How much user edited

  // Lifecycle
  createdAt       DateTime        @default(now())
  createdBy       String
  completedAt     DateTime?
  savedAt         DateTime?

  @@index([companyId])
  @@index([status])
  @@index([createdAt])
  @@map("ai_funnel_generations")
}

enum MarketingMethodology {
  NCI           // Non-Verbal Communication Influence (Proprietary)
  AIDA          // Attention, Interest, Desire, Action
  PAS           // Problem, Agitation, Solution
  BAB           // Before, After, Bridge
  FOUR_PS       // Promise, Picture, Proof, Push
  STORYBRAND    // Donald Miller's Hero Journey
  PASTOR        // Problem, Amplify, Story, Transform, Offer, Response
  QUEST         // Qualify, Understand, Educate, Stimulate, Transition
  FAB           // Features, Advantages, Benefits
  CUSTOM        // User-defined methodology
}

enum GenerationStatus {
  PENDING       // Waiting to start
  GENERATING    // AI is generating content
  COMPLETED     // Successfully generated
  FAILED        // Generation failed
  SAVED         // User saved as funnel
  DISCARDED     // User discarded
}

// =============================================================================
// EMAIL TEMPLATES & SENDING
// SOC2/ISO27001 Compliant Transactional Email System
// =============================================================================

model EmailTemplate {
  id              String              @id @default(cuid())

  // Template identification
  code            String              // Unique code per scope: 'password-reset', 'welcome', 'order-confirmation'
  name            String              // Display name: "Password Reset Email"
  description     String?             // Purpose description
  category        EmailTemplateCategory

  // Content (supports Handlebars syntax)
  subject         String              // Subject line with variables: "Reset your {{companyName}} password"
  htmlBody        String              @db.Text // HTML email body
  textBody        String?             @db.Text // Plain text fallback

  // Sender configuration
  fromName        String?             // Override from name
  fromEmail       String?             // Override from email (must be verified)
  replyTo         String?             // Reply-to address

  // Multi-tenant scoping (exactly one must be set, or none for system templates)
  organizationId  String?             // Platform-wide system templates
  clientId        String?             // Client-level templates
  companyId       String?             // Company-level templates

  // Relations
  organization    Organization?       @relation(fields: [organizationId], references: [id])
  client          Client?             @relation(fields: [clientId], references: [id])
  company         Company?            @relation(fields: [companyId], references: [id])

  // Template status
  isSystem        Boolean             @default(false) // System-provided, cannot delete
  isActive        Boolean             @default(true)
  version         Int                 @default(1)

  // Variables schema (for validation & documentation)
  variables       Json?               // [{ name: "userName", type: "string", required: true }]

  // Preview
  previewData     Json?               // Sample data for previewing template

  // Timestamps
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  createdBy       String?
  updatedBy       String?

  // Soft delete
  deletedAt       DateTime?
  deletedBy       String?

  // Send history
  emailSendLogs   EmailSendLog[]

  @@unique([organizationId, code], name: "org_template_code")
  @@unique([clientId, code], name: "client_template_code")
  @@unique([companyId, code], name: "company_template_code")
  @@index([category])
  @@index([isActive])
  @@index([deletedAt])
  @@map("email_templates")
}

model EmailSendLog {
  id              String              @id @default(cuid())

  // Template used (optional - could be ad-hoc)
  templateId      String?
  template        EmailTemplate?      @relation(fields: [templateId], references: [id])
  templateCode    String?             // Denormalized for queries

  // Multi-tenant context
  organizationId  String?
  clientId        String?
  companyId       String?

  // Recipient
  toEmail         String
  toName          String?

  // Sender
  fromEmail       String
  fromName        String?
  replyTo         String?

  // Content snapshot (for audit/compliance)
  subject         String
  category        EmailTemplateCategory

  // Variables used (for debugging/audit - PII should be masked)
  variablesUsed   Json?

  // Delivery info
  provider        String              @default("ses") // 'ses', 'sendgrid', etc.
  messageId       String?             // Provider's message ID
  status          EmailSendStatus     @default(QUEUED)

  // Delivery tracking
  sentAt          DateTime?
  deliveredAt     DateTime?
  openedAt        DateTime?
  clickedAt       DateTime?
  bouncedAt       DateTime?
  complainedAt    DateTime?

  // Error handling
  errorCode       String?
  errorMessage    String?
  retryCount      Int                 @default(0)
  lastRetryAt     DateTime?

  // Related entity (for linking back)
  relatedEntityType String?           // 'user', 'order', 'subscription', etc.
  relatedEntityId   String?

  // Compliance
  ipAddress       String?             // Requester IP (for abuse detection)
  userAgent       String?

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([toEmail])
  @@index([templateCode])
  @@index([status])
  @@index([createdAt])
  @@index([companyId, createdAt])
  @@index([relatedEntityType, relatedEntityId])
  @@map("email_send_logs")
}

enum EmailTemplateCategory {
  AUTHENTICATION    // Password reset, email verification, 2FA
  TRANSACTIONAL     // Order confirmation, shipping, receipts
  SUBSCRIPTION      // Trial ending, renewal, cancellation
  NOTIFICATION      // Alerts, reminders, updates
  MARKETING         // Promotional (requires consent)
  SYSTEM            // Internal system notifications
}

enum EmailSendStatus {
  QUEUED            // In queue to be sent
  SENDING           // Currently being sent
  SENT              // Successfully sent to provider
  DELIVERED         // Confirmed delivered
  OPENED            // Email opened (tracking pixel)
  CLICKED           // Link clicked
  BOUNCED           // Hard or soft bounce
  COMPLAINED        // Marked as spam
  FAILED            // Send failed
  REJECTED          // Rejected by provider
}

// =============================================================================
// WAITLIST & FOUNDERS
// Client registration waitlist with viral referral system
// =============================================================================

model Waitlist {
  id              String          @id @default(cuid())

  // Organization scope
  organizationId  String
  organization    Organization    @relation(fields: [organizationId], references: [id])

  // Contact info
  email           String
  phone           String?
  companyName     String?         // Prospective company name
  firstName       String?
  lastName        String?

  // Founder identity (FND-XXXX format)
  founderNumber   String          @unique

  // Position tracking (for gamification)
  basePosition    Int             // Original signup position
  currentPosition Int             // Position after referral boosts

  // Referral system
  referralCode    String          @unique  // Their unique referral code
  referredBy      String?         // Referral code of who referred them
  referralCount   Int             @default(0)

  // Status
  status          WaitlistStatus  @default(PENDING)
  emailVerified   Boolean         @default(false)
  phoneVerified   Boolean         @default(false)

  // Invite tracking
  invitedAt       DateTime?
  inviteToken     String?         @unique
  inviteExpiresAt DateTime?
  registeredAt    DateTime?

  // Link to created client (after registration)
  clientId        String?         @unique
  client          Client?         @relation(fields: [clientId], references: [id])

  // Marketing & tracking
  source          String?         // utm_source
  medium          String?         // utm_medium
  campaign        String?         // utm_campaign
  variant         String?         // A/B test variant
  metadata        Json            @default("{}")

  // Timestamps
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Referral relationships
  referrer        Waitlist?       @relation("WaitlistReferrals", fields: [referredBy], references: [referralCode])
  referrals       Waitlist[]      @relation("WaitlistReferrals")

  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([status])
  @@index([currentPosition])
  @@index([founderNumber])
  @@index([inviteToken])
  @@map("waitlist")
}

enum WaitlistStatus {
  PENDING           // Signed up, awaiting verification
  VERIFIED          // Email/phone verified
  INVITED           // Invite sent
  REGISTERED        // Completed registration
  DECLINED          // Opted out
}

// =============================================================================
// FEATURE 04: SHARED GATEWAY RISK MANAGEMENT
// Pricing, Terms, Risk Assessment, Reserves, and Chargeback Tracking
// =============================================================================

enum MerchantRiskLevel {
  LOW               // Clean history, low-risk MCC
  STANDARD          // Normal business, typical risk
  ELEVATED          // Some flags, higher monitoring
  HIGH              // High-risk MCC or history
  VERY_HIGH         // Very high risk, significant deposit required
  SUSPENDED         // Account suspended, no processing
}

enum MerchantAccountStatus {
  PENDING_REVIEW    // Awaiting initial risk assessment
  APPROVED          // Approved, can process
  GOOD_STANDING     // Active, in good standing
  UNDER_REVIEW      // Being reviewed for issues
  RESTRICTED        // Limited processing allowed
  SUSPENDED         // Processing suspended
  TERMINATED        // Account terminated
}

enum GatewayTermsVersion {
  V1_0              // Initial version
  V2_0              // Updated terms
  V2_1              // Minor updates
}

enum ReserveTransactionType {
  HOLD              // Amount held from transaction
  RELEASE           // Scheduled release
  CHARGEBACK_DEBIT  // Debited for chargeback
  ADJUSTMENT        // Manual adjustment
  REFUND            // Refund from reserve
}

enum ChargebackStatus {
  RECEIVED          // Initial notification
  UNDER_REVIEW      // Being reviewed
  REPRESENTMENT     // Fighting the chargeback
  WON               // Chargeback reversed
  LOST              // Chargeback upheld
  ACCEPTED          // Merchant accepted
}

enum ChargebackReason {
  FRAUD             // Fraudulent transaction
  NOT_RECOGNIZED    // Customer doesn't recognize
  NOT_RECEIVED      // Product/service not received
  NOT_AS_DESCRIBED  // Product different than described
  DUPLICATE         // Duplicate charge
  CANCELED          // Recurring canceled but charged
  CREDIT_NOT_ISSUED // Refund not processed
  TECHNICAL         // Technical/processing error
  OTHER             // Other reason
}

enum RiskAssessmentType {
  INITIAL           // Initial application assessment
  PERIODIC          // Scheduled review
  TRIGGERED         // Triggered by event (chargeback, etc)
  MANUAL            // Manual review
}

// Gateway Pricing Tier - Defines pricing for each risk level
model GatewayPricingTier {
  id                    String              @id @default(cuid())
  platformIntegrationId String

  // Tier identification
  tierName              String              // "Standard", "Elevated Risk", etc.
  riskLevel             MerchantRiskLevel

  // Application fee (one-time, $0 for founders)
  applicationFee        Int                 @default(0) // In cents
  isFounderPricing      Boolean             @default(false)

  // Transaction fees
  transactionPercentage Decimal             @db.Decimal(5, 4) // e.g., 0.0290 = 2.9%
  transactionFlat       Int                 // Flat fee in cents, e.g., 30 = $0.30

  // Chargeback fees
  chargebackFee         Int                 // Per chargeback in cents
  chargebackReviewFee   Int                 @default(0) // Fee for representment

  // Reserve settings
  reservePercentage     Decimal             @db.Decimal(5, 4) // e.g., 0.05 = 5%
  reserveHoldDays       Int                 // Days to hold reserve
  reserveCap            Int?                // Maximum reserve in cents (optional)

  // Additional fees
  setupFee              Int?                // One-time setup fee in cents
  monthlyFee            Int?                // Monthly fee in cents
  monthlyMinimum        Int?                // Monthly minimum processing in cents

  // Security deposit
  securityDepositMin    Int?                // Minimum security deposit in cents
  securityDepositMax    Int?                // Maximum security deposit in cents

  // Thresholds for escalation
  chargebackThreshold   Decimal             @db.Decimal(5, 4) @default(0.01) // 1%

  // Active status
  isActive              Boolean             @default(true)

  // Timestamps
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  // Relations
  platformIntegration   PlatformIntegration @relation(fields: [platformIntegrationId], references: [id], onDelete: Cascade)
  merchantProfiles      MerchantRiskProfile[]

  @@unique([platformIntegrationId, riskLevel])
  @@index([platformIntegrationId])
  @@index([riskLevel])
  @@map("gateway_pricing_tiers")
}

// Gateway Terms Document - Legal terms for shared gateway usage
model GatewayTermsDocument {
  id                    String              @id @default(cuid())
  platformIntegrationId String

  // Document identification
  version               GatewayTermsVersion
  title                 String              // "High-Risk Merchant Agreement"

  // Content
  content               String              @db.Text // Full legal text (Markdown/HTML)
  summary               String?             @db.Text // Summary for quick review

  // Risk level applicability
  applicableRiskLevels  MerchantRiskLevel[] // Which risk levels require this

  // Effective dates
  effectiveDate         DateTime
  expiresAt             DateTime?           // If terms expire

  // Status
  isActive              Boolean             @default(true)
  isCurrent             Boolean             @default(false) // Current version for new signups

  // Timestamps
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  createdBy             String

  // Relations
  platformIntegration   PlatformIntegration @relation(fields: [platformIntegrationId], references: [id], onDelete: Cascade)
  acceptances           GatewayTermsAcceptance[]

  @@unique([platformIntegrationId, version])
  @@index([platformIntegrationId])
  @@index([isActive, isCurrent])
  @@map("gateway_terms_documents")
}

// Gateway Terms Acceptance - Record of client accepting terms
model GatewayTermsAcceptance {
  id                    String              @id @default(cuid())
  termsDocumentId       String
  clientId              String

  // Acceptance details
  acceptedAt            DateTime            @default(now())
  acceptedBy            String              // User ID who accepted
  acceptorName          String              // Name of person accepting
  acceptorTitle         String?             // Title/role
  acceptorEmail         String              // Email of acceptor

  // Verification data (for legal compliance)
  ipAddress             String
  userAgent             String?
  acceptanceMethod      String              @default("ELECTRONIC") // ELECTRONIC, PHYSICAL

  // Digital signature (optional)
  signatureHash         String?             // Hash of acceptance action

  // Status
  isValid               Boolean             @default(true)
  revokedAt             DateTime?
  revokedBy             String?
  revokedReason         String?

  // Timestamps
  createdAt             DateTime            @default(now())

  // Relations
  termsDocument         GatewayTermsDocument @relation(fields: [termsDocumentId], references: [id])
  client                Client               @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([termsDocumentId, clientId])
  @@index([clientId])
  @@index([acceptedAt])
  @@map("gateway_terms_acceptances")
}

// Merchant Risk Profile - Risk assessment for each client
model MerchantRiskProfile {
  id                    String              @id @default(cuid())
  clientId              String              @unique
  platformIntegrationId String

  // Current risk status
  riskLevel             MerchantRiskLevel   @default(STANDARD)
  riskScore             Int                 @default(50) // 0-100, higher = riskier
  accountStatus         MerchantAccountStatus @default(PENDING_REVIEW)

  // Current pricing tier
  pricingTierId         String?

  // Business information
  mccCode               String?             // Merchant Category Code
  mccDescription        String?
  businessType          String?             // LLC, Corp, Sole Prop, etc.
  businessAge           Int?                // Years in business
  annualVolume          Int?                // Expected annual volume in cents
  averageTicket         Int?                // Average transaction in cents

  // Processing metrics (updated regularly)
  totalProcessed        BigInt              @default(0) // Total processed in cents
  transactionCount      Int                 @default(0)
  chargebackCount       Int                 @default(0)
  chargebackRatio       Decimal             @db.Decimal(5, 4) @default(0) // Current ratio
  refundRatio           Decimal             @db.Decimal(5, 4) @default(0)

  // Reserve tracking
  reserveBalance        BigInt              @default(0) // Current reserve in cents
  reserveHeldTotal      BigInt              @default(0) // Total held all time
  reserveReleasedTotal  BigInt              @default(0) // Total released

  // Security deposit
  securityDeposit       Int                 @default(0) // Required deposit in cents
  securityDepositPaid   Int                 @default(0) // Amount paid
  securityDepositPaidAt DateTime?

  // Risk flags
  isHighRiskMCC         Boolean             @default(false)
  hasChargebackHistory  Boolean             @default(false)
  hasComplianceIssues   Boolean             @default(false)
  requiresMonitoring    Boolean             @default(false)

  // Review scheduling
  lastReviewDate        DateTime?
  nextReviewDate        DateTime?
  reviewFrequency       Int                 @default(90) // Days between reviews

  // Notes
  internalNotes         String?             @db.Text

  // Timestamps
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  approvedAt            DateTime?
  approvedBy            String?

  // Relations
  client                Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  platformIntegration   PlatformIntegration @relation(fields: [platformIntegrationId], references: [id])
  pricingTier           GatewayPricingTier? @relation(fields: [pricingTierId], references: [id])
  riskAssessments       RiskAssessment[]
  reserveTransactions   ReserveTransaction[]
  chargebacks           ChargebackRecord[]

  @@index([clientId])
  @@index([platformIntegrationId])
  @@index([riskLevel])
  @@index([accountStatus])
  @@map("merchant_risk_profiles")
}

// Risk Assessment - Individual risk assessment record
model RiskAssessment {
  id                    String              @id @default(cuid())
  merchantRiskProfileId String

  // Assessment info
  assessmentType        RiskAssessmentType
  assessmentDate        DateTime            @default(now())
  assessedBy            String?             // User ID or 'SYSTEM'

  // Results
  previousRiskLevel     MerchantRiskLevel
  newRiskLevel          MerchantRiskLevel
  previousRiskScore     Int
  newRiskScore          Int

  // Factors considered (JSON for flexibility)
  factors               Json                // { mcc, chargebackRatio, volume, age, etc. }

  // AI Assessment (if used)
  aiModel               String?             // 'bedrock-claude-3-haiku', etc.
  aiConfidence          Decimal?            @db.Decimal(5, 4) // 0-1 confidence score
  aiExplanation         String?             @db.Text

  // Notes and reasoning
  reasoning             String?             @db.Text
  recommendedActions    String[]            // Actions to take

  // Approval (for manual review)
  requiresApproval      Boolean             @default(false)
  approvedAt            DateTime?
  approvedBy            String?

  // Timestamps
  createdAt             DateTime            @default(now())

  // Relations
  merchantRiskProfile   MerchantRiskProfile @relation(fields: [merchantRiskProfileId], references: [id], onDelete: Cascade)

  @@index([merchantRiskProfileId])
  @@index([assessmentDate])
  @@index([assessmentType])
  @@map("risk_assessments")
}

// Reserve Transaction - Track reserve holds and releases
model ReserveTransaction {
  id                    String                  @id @default(cuid())
  merchantRiskProfileId String

  // Transaction info
  type                  ReserveTransactionType
  amount                Int                     // Amount in cents (positive for hold, negative for release)
  balanceAfter          BigInt                  // Reserve balance after this transaction

  // Related transaction (if applicable)
  relatedTransactionId  String?                 // Original payment transaction
  relatedChargebackId   String?                 // If related to chargeback

  // Scheduling (for releases)
  scheduledReleaseDate  DateTime?
  releasedAt            DateTime?

  // Notes
  description           String?
  internalNotes         String?

  // Timestamps
  createdAt             DateTime                @default(now())
  createdBy             String?                 // User ID or 'SYSTEM'

  // Relations
  merchantRiskProfile   MerchantRiskProfile     @relation(fields: [merchantRiskProfileId], references: [id], onDelete: Cascade)
  chargeback            ChargebackRecord?       @relation(fields: [relatedChargebackId], references: [id])

  @@index([merchantRiskProfileId])
  @@index([type])
  @@index([scheduledReleaseDate])
  @@index([createdAt])
  @@map("reserve_transactions")
}

// Chargeback Record - Track chargebacks
model ChargebackRecord {
  id                    String              @id @default(cuid())
  merchantRiskProfileId String

  // Chargeback identification
  chargebackId          String              @unique // Provider's chargeback ID
  transactionId         String?             // Original transaction ID
  orderId               String?             // Related order

  // Amounts
  amount                Int                 // Chargeback amount in cents
  currency              String              @default("USD")
  fee                   Int                 // Chargeback fee charged in cents

  // Details
  reason                ChargebackReason
  reasonCode            String?             // Provider's reason code
  reasonDescription     String?

  // Status tracking
  status                ChargebackStatus    @default(RECEIVED)

  // Dates
  receivedAt            DateTime
  respondByDate         DateTime?           // Deadline to respond
  resolvedAt            DateTime?

  // Representment (if fighting)
  representmentSubmittedAt DateTime?
  representmentEvidence    Json?            // Evidence submitted
  representmentNotes       String?          @db.Text

  // Outcome
  outcomeDate           DateTime?
  outcomeAmount         Int?                // Amount recovered if won
  outcomeFee            Int?                // Fee refunded if won

  // Impact tracking
  impactedReserve       Boolean             @default(false)
  reserveDebitAmount    Int?                // Amount debited from reserve

  // Notes
  internalNotes         String?             @db.Text

  // Timestamps
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  // Relations
  merchantRiskProfile   MerchantRiskProfile @relation(fields: [merchantRiskProfileId], references: [id], onDelete: Cascade)
  reserveTransactions   ReserveTransaction[]

  @@index([merchantRiskProfileId])
  @@index([status])
  @@index([receivedAt])
  @@index([transactionId])
  @@map("chargeback_records")
}

// MCC Code Reference - High-risk MCC codes
model MCCCodeReference {
  id                    String              @id @default(cuid())

  // MCC info
  code                  String              @unique // 4-digit MCC code
  description           String
  category              String              // Retail, Travel, etc.

  // Risk classification
  isHighRisk            Boolean             @default(false)
  defaultRiskLevel      MerchantRiskLevel   @default(STANDARD)

  // Restrictions
  requiresEnhancedReview Boolean            @default(false)
  prohibited            Boolean             @default(false) // Cannot process at all
  restrictedCountries   String[]            // Countries where restricted

  // Notes
  notes                 String?

  // Timestamps
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  @@index([isHighRisk])
  @@index([category])
  @@map("mcc_code_references")
}

// =============================================================================
// PRODUCT IMPORT SYSTEM
// Import products from external fulfillment providers (Roastify, Shopify, etc.)
// =============================================================================

enum ImportJobStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED
}

enum ImportJobPhase {
  QUEUED
  FETCHING
  MAPPING
  CREATING
  DOWNLOADING_IMAGES
  UPLOADING_IMAGES
  GENERATING_THUMBNAILS
  FINALIZING
  DONE
}

// Product Import Job - Tracks import operations
model ProductImportJob {
  id            String          @id @default(cuid())
  companyId     String
  clientId      String
  integrationId String
  provider      String          // IntegrationProvider value (ROASTIFY, SHOPIFY, etc.)

  // Job status
  status        ImportJobStatus @default(PENDING)
  phase         ImportJobPhase  @default(QUEUED)

  // Counts
  totalProducts     Int
  totalImages       Int         @default(0)
  processedProducts Int         @default(0)
  processedImages   Int         @default(0)
  importedCount     Int         @default(0)
  skippedCount      Int         @default(0)
  errorCount        Int         @default(0)

  // Progress
  progress                  Int     @default(0) // 0-100
  currentItem               String? // "Importing: Ethiopian Yirgacheffe..."
  estimatedSecondsRemaining Int?

  // Configuration
  config        Json            // { mappings, conflictResolution, imageOption }

  // Results
  errorLog      Json?           // [{ productId, error, timestamp }]
  importedIds   String[]        // Product IDs created

  // Timing
  createdBy     String
  createdAt     DateTime        @default(now())
  startedAt     DateTime?
  completedAt   DateTime?

  // Relations
  company       Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Indexes for common query patterns
  @@index([companyId])              // Company-scoped job listings
  @@index([companyId, status])      // Company + status filtering
  @@index([status, createdAt])      // Status filtering with time ordering
  @@index([provider])               // Provider-specific analytics
  @@map("product_import_jobs")
}

// Product Image - Managed images with CDN storage
model ProductImage {
  id          String   @id @default(cuid())
  productId   String
  companyId   String

  // Storage reference
  s3Key       String   @unique
  cdnUrl      String

  // Metadata
  originalUrl     String?  // External URL if imported
  importSource    String?  // IntegrationProvider value
  filename        String
  contentType     String
  size            Int      // bytes
  width           Int?
  height          Int?

  // Thumbnails
  thumbnailSmall  String?
  thumbnailMedium String?
  thumbnailLarge  String?
  thumbnailBytes  Int      @default(0)

  // Ordering
  position    Int      @default(0)
  isPrimary   Boolean  @default(false)
  altText     String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([companyId])
  @@map("product_images")
}

// Storage Usage - Track storage consumption for billing
model StorageUsage {
  id             String   @id @default(cuid())
  organizationId String
  clientId       String?
  companyId      String?

  // Usage metrics
  totalBytes     BigInt   @default(0)
  fileCount      Int      @default(0)
  imageCount     Int      @default(0)
  thumbnailBytes BigInt   @default(0)

  // Monthly rollup
  month          DateTime // First day of month

  // Breakdown by source
  usageBySource  Json?    // { "UPLOAD": 1024, "ROASTIFY": 2048 }

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([organizationId, clientId, companyId, month])
  @@index([organizationId])
  @@index([clientId])
  @@index([companyId])
  @@map("storage_usage")
}

// Field Mapping Profile - Save mapping configurations for reuse
model FieldMappingProfile {
  id          String   @id @default(cuid())
  companyId   String
  provider    String   // IntegrationProvider value
  name        String
  mappings    Json     // [{ sourceField, targetField, transform }]
  isDefault   Boolean  @default(false)

  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Indexes for common query patterns
  @@index([companyId, provider])    // Listing profiles by company and provider
  @@unique([companyId, provider, name])
  @@map("field_mapping_profiles")
}

// ============================================================================
// Shopify-Inspired Product Management System
// ============================================================================

// Category Metafield Definition - defines what custom fields each category has
// Based on Shopify's category metafields concept
model CategoryMetafieldDefinition {
  id          String        @id @default(cuid())
  categoryId  String

  // Field definition
  key         String        // e.g., "roast_level", "origin"
  name        String        // Display name: "Roast Level", "Origin"
  type        MetafieldType // TEXT, NUMBER, SELECT, etc.

  // Configuration
  required    Boolean       @default(false)
  options     Json?         // For SELECT/MULTI_SELECT: ["Light", "Medium", "Dark"]
  validation  Json?         // Validation rules: { min: 0, max: 100, pattern: "..." }
  helpText    String?       // Help text shown below field
  placeholder String?       // Placeholder text in input
  defaultValue String?      // Default value for new products

  // Display
  sortOrder   Int           @default(0)
  isActive    Boolean       @default(true)

  // Timestamps
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Soft Delete
  deletedAt   DateTime?
  deletedBy   String?

  // Relations
  category    Category      @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  values      ProductMetafieldValue[]
  deletedByUser User?       @relation("MetafieldDeletedBy", fields: [deletedBy], references: [id])

  @@unique([categoryId, key, deletedAt])
  @@index([categoryId, isActive])
  @@index([deletedAt])
  @@map("category_metafield_definitions")
}

// Product Metafield Value - stores actual custom field values per product
// NOTE: Application layer MUST enforce that only ONE value column is populated based on definition type
// Multi-category behavior: Products inherit metafield definitions from ALL assigned categories
model ProductMetafieldValue {
  id           String   @id @default(cuid())
  productId    String
  definitionId String

  // Typed value storage - only one should be set based on definition type
  // Application validation required: only populate the column matching definition.type
  textValue    String?      // For TEXT, TEXTAREA, SELECT, URL, COLOR
  numberValue  Decimal?     @db.Decimal(20, 6) // For NUMBER
  booleanValue Boolean?     // For BOOLEAN
  dateValue    DateTime?    // For DATE
  jsonValue    Json?        // For MULTI_SELECT (array of values)

  // Timestamps
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  product      Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  definition   CategoryMetafieldDefinition @relation(fields: [definitionId], references: [id], onDelete: Cascade)

  @@unique([productId, definitionId])
  @@index([definitionId])
  @@index([productId]) // For loading all metafields for a product
  @@index([definitionId, textValue]) // For filtering products by text metafield values
  @@map("product_metafield_values")
}

// Sales Channel - where products can be published
// Based on Shopify's publishing/channels concept
model SalesChannel {
  id          String           @id @default(cuid())
  companyId   String

  // Channel identity
  name        String           // "Online Store", "POS", "Wholesale"
  slug        String           // URL-safe identifier
  type        SalesChannelType // ONLINE_STORE, POS, WHOLESALE, etc.

  // Configuration
  description String?
  iconUrl     String?          // Channel icon/logo
  settings    Json?            // Channel-specific settings

  // Status
  isActive    Boolean          @default(true)
  isDefault   Boolean          @default(false) // Products added to this by default

  // Display
  sortOrder   Int              @default(0)

  // Timestamps
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // Soft Delete
  deletedAt   DateTime?
  deletedBy   String?

  // Relations
  company     Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  products    ProductSalesChannel[]
  deletedByUser User?          @relation("SalesChannelDeletedBy", fields: [deletedBy], references: [id])

  @@unique([companyId, slug, deletedAt])
  @@index([companyId, isActive])
  @@index([type])
  @@index([deletedAt])
  @@map("sales_channels")
}

// Product-Channel junction - tracks which products are published where
model ProductSalesChannel {
  id          String    @id @default(cuid())
  productId   String
  channelId   String

  // Publishing status
  isPublished Boolean   @default(true)
  publishedAt DateTime? // When product was first published to this channel

  // Channel-specific overrides (optional)
  channelPrice Decimal?  @db.Decimal(12, 4) // Override price (increased precision for multi-currency)
  isVisible    Boolean   @default(true)      // Can be hidden from specific channels

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  product     Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  channel     SalesChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([productId, channelId])
  @@index([channelId])
  @@index([isPublished])
  @@index([productId, isPublished]) // For querying product's published channels
  @@index([channelId, isPublished, isVisible]) // For channel product listings
  @@map("product_sales_channels")
}

// =============================================================================
// PRODUCT COMPARISON SYSTEM
// =============================================================================
// Allows customers to compare up to 4 products side-by-side.
// Supports both anonymous (session-based) and authenticated users.
// Comparisons can be shared via unique share tokens.

model ProductComparison {
  id        String  @id @default(cuid())
  companyId String

  // Site association (for multi-site support)
  siteId String?

  // User identification (one of these should be set)
  customerId   String? // Authenticated user
  sessionToken String? @unique // Anonymous session
  visitorId    String? // Cross-session visitor tracking

  // Comparison metadata
  name String? // Optional user-defined name (e.g., "Coffee Makers")

  // Sharing functionality
  shareToken String?   @unique // Unique token for sharing
  isShared   Boolean   @default(false)
  sharedAt   DateTime? // When sharing was enabled

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  expiresAt DateTime? // Optional expiration

  // Merge tracking (when anonymous comparison is merged with user account)
  mergedIntoComparisonId String?
  mergedAt               DateTime?

  // Relations
  company  Company                 @relation(fields: [companyId], references: [id], onDelete: Cascade)
  site     Site?                   @relation(fields: [siteId], references: [id], onDelete: SetNull)
  customer Customer?               @relation(fields: [customerId], references: [id], onDelete: SetNull)
  items    ProductComparisonItem[]

  @@index([companyId])
  @@index([companyId, customerId])
  @@index([sessionToken])
  @@index([visitorId])
  @@index([shareToken])
  @@index([companyId, siteId])
  @@index([expiresAt])
  @@map("product_comparisons")
}

model ProductComparisonItem {
  id           String @id @default(cuid())
  comparisonId String

  // Product reference
  productId String
  variantId String? // Optional variant for products with variants

  // Snapshot of product data at time of addition
  // Allows display even if product is updated/deleted
  productSnapshot Json

  // Position in comparison (0-3, max 4 items)
  position Int @default(0)

  // Timestamps
  addedAt   DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  comparison ProductComparison @relation(fields: [comparisonId], references: [id], onDelete: Cascade)
  product    Product           @relation(fields: [productId], references: [id], onDelete: Restrict)

  // Ensure unique product per comparison (no duplicates)
  @@unique([comparisonId, productId, variantId])
  @@index([comparisonId])
  @@index([productId])
  @@map("product_comparison_items")
}

// ═══════════════════════════════════════════════════════════════════════════════
// CROSS-SITE SESSION MODEL
// Unified session management across multiple sites within a company
// ═══════════════════════════════════════════════════════════════════════════════

enum CrossSiteSessionStatus {
  ACTIVE
  EXPIRED
  MERGED
  REVOKED
}

model CrossSiteSession {
  id           String   @id @default(cuid())
  companyId    String
  sessionToken String   @unique

  // User identification (optional for guest sessions)
  visitorId  String? // Anonymous visitor ID
  customerId String? // Linked customer when logged in

  // Session status
  status CrossSiteSessionStatus @default(ACTIVE)

  // Linked data references (stored as JSON for flexibility)
  // Format: [{ type: 'CART' | 'WISHLIST' | 'COMPARISON', entityId, siteId, lastUpdated }]
  dataReferences Json @default("[]")

  // Device/browser information
  deviceInfo Json? // { userAgent, ipAddress, fingerprint }

  // Activity tracking
  firstSeenAt  DateTime @default(now())
  lastActiveAt DateTime @default(now())
  expiresAt    DateTime

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company  Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  // Indexes
  @@index([companyId])
  @@index([customerId])
  @@index([sessionToken])
  @@index([status])
  @@index([expiresAt])
  @@map("cross_site_sessions")
}

// =============================================================================
// SMART UPSELL & RECOMMENDATION SYSTEM
// =============================================================================

enum SubscriptionFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
  BIMONTHLY
  QUARTERLY
}

enum UpsellType {
  BULK_DISCOUNT
  SUBSCRIPTION
  FREE_SHIPPING_ADD
  FREE_GIFT_THRESHOLD
  COMPLEMENTARY
  BUNDLE_UPGRADE
  PREMIUM_VERSION
  SHIPPING_PROTECTION
  WARRANTY
  QUANTITY_DISCOUNT
  TIER_UPGRADE
  FREQUENCY_UPGRADE
  ADD_ON
  GIFT_SUBSCRIPTION
  ANNUAL_PLAN
}

enum UpsellUrgency {
  LOW
  MEDIUM
  HIGH
}

enum UpsellExperimentStatus {
  DRAFT
  RUNNING
  PAUSED
  COMPLETED
}

// Bulk discount configuration per product
model ProductBulkDiscount {
  id        String @id @default(cuid())
  productId String @unique
  companyId String

  enabled Boolean @default(true)
  tiers   Json // BulkDiscountTier[]

  stackWithOtherDiscounts Boolean @default(false)
  maxDiscountPercent      Int     @default(30)

  validFrom  DateTime?
  validUntil DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, enabled])
  @@map("product_bulk_discounts")
}

// Subscription configuration per product
model ProductSubscriptionConfig {
  id        String @id @default(cuid())
  productId String @unique
  companyId String

  enabled       Boolean @default(true)
  discountTiers Json // { frequency, discountPercent, label }[]

  defaultFrequency     SubscriptionFrequency @default(MONTHLY)
  freeShippingIncluded Boolean               @default(true)

  eligibility Json // Eligibility rules

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, enabled])
  @@map("product_subscription_configs")
}

// Upsell targeting rules
model UpsellTargetingRule {
  id        String @id @default(cuid())
  companyId String

  name        String
  description String?
  priority    Int     @default(100)
  enabled     Boolean @default(true)

  conditions Json // UpsellConditions
  upsellType UpsellType
  offer      Json // UpsellOffer

  message    String
  urgency    UpsellUrgency @default(MEDIUM)
  placements String[]

  // Limits
  maxImpressions Int? // Per customer per day
  maxAcceptances Int? // Total acceptances before disable

  validFrom  DateTime?
  validUntil DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company     Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  impressions UpsellImpression[]

  @@index([companyId, enabled, priority])
  @@map("upsell_targeting_rules")
}

// Upsell impression tracking
model UpsellImpression {
  id         String  @id @default(cuid())
  cartId     String
  ruleId     String
  customerId String?
  sessionId  String

  placement String
  variant   String? // For A/B testing

  impressedAt DateTime  @default(now())
  viewedAt    DateTime? // Visible for 1+ second
  clickedAt   DateTime?
  acceptedAt  DateTime?
  declinedAt  DateTime?

  offer   Json // Offer shown
  revenue Decimal? @db.Decimal(10, 2) // If accepted

  cart     Cart                @relation(fields: [cartId], references: [id], onDelete: Cascade)
  rule     UpsellTargetingRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  customer Customer?           @relation(fields: [customerId], references: [id], onDelete: SetNull)

  @@index([cartId])
  @@index([ruleId, impressedAt])
  @@index([customerId, impressedAt])
  @@index([sessionId])
  @@map("upsell_impressions")
}

// A/B testing for upsells
model UpsellExperiment {
  id        String @id @default(cuid())
  companyId String

  name        String
  description String?
  status      UpsellExperimentStatus @default(DRAFT)

  control  Json // UpsellVariant
  variants Json // UpsellVariant[]

  trafficPercent Int   @default(100)
  variantWeights Int[]

  primaryMetric     String @default("CONVERSION")
  minimumSampleSize Int    @default(1000)
  confidenceLevel   Float  @default(0.95)

  startedAt DateTime?
  endedAt   DateTime?

  results Json? // ExperimentResults

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, status])
  @@map("upsell_experiments")
}

// Product view tracking for recommendations
model ProductView {
  id        String @id @default(cuid())
  productId String
  companyId String
  sessionId String

  customerId String?

  viewedAt DateTime @default(now())
  duration Int? // Seconds on page

  source          String? // 'DIRECT', 'RECOMMENDATION', 'SEARCH'
  sourceProductId String? // If came from recommendation

  product  Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  company  Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  @@index([productId, viewedAt])
  @@index([sessionId, viewedAt])
  @@index([companyId, viewedAt])
  @@index([customerId, viewedAt])
  @@map("product_views")
}

// Recommendation configuration per company
model RecommendationConfig {
  id        String @id @default(cuid())
  companyId String @unique

  alsoBought       Json // AlsoBoughtConfig
  youMightLike     Json // YouMightLikeConfig
  frequentlyViewed Json // FrequentlyViewedConfig
  global           Json // GlobalConfig

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("recommendation_configs")
}

// Recommendation performance tracking
model RecommendationImpression {
  id        String @id @default(cuid())
  companyId String
  productId String // Product being viewed
  type      String // ALSO_BOUGHT, YOU_MIGHT_LIKE, FREQUENTLY_VIEWED
  sessionId String

  customerId String?

  recommendedIds String[] // Products shown
  impressedAt    DateTime @default(now())

  clickedProductId String? // Which was clicked
  clickedAt        DateTime?
  addedToCart      Boolean   @default(false)
  addedAt          DateTime?

  company  Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  product  Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  customer Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  @@index([companyId, type, impressedAt])
  @@index([productId, type])
  @@index([sessionId, impressedAt])
  @@map("recommendation_impressions")
}

// ═══════════════════════════════════════════════════════════════════════════════
// LANDING PAGE PRODUCT CATALOG - Manual product selection for landing pages
// ═══════════════════════════════════════════════════════════════════════════════

model LandingPageProduct {
  id            String @id @default(cuid())
  landingPageId String
  productId     String
  sortOrder     Int    @default(0)

  createdAt DateTime @default(now())

  landingPage LandingPage @relation(fields: [landingPageId], references: [id], onDelete: Cascade)
  product     Product     @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([landingPageId, productId])
  @@index([landingPageId, sortOrder])
  @@map("landing_page_products")
}

// ═══════════════════════════════════════════════════════════════════════════════
// CART SAVE CONFIG - Company-level cart recovery configuration
// ═══════════════════════════════════════════════════════════════════════════════

model CartSaveConfig {
  id        String @id @default(cuid())
  companyId String @unique

  enabled Boolean @default(true)

  // Stage configurations (JSON)
  stageConfigs Json // CartSaveFlowConfig

  // Global settings
  maxAttemptsPerCart  Int     @default(10)
  respectUnsubscribe  Boolean @default(true)
  blackoutHoursStart  Int     @default(22) // 10 PM
  blackoutHoursEnd    Int     @default(8)  // 8 AM

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("cart_save_configs")
}

// ═══════════════════════════════════════════════════════════════════════════════
// CART SAVE ATTEMPT - Tracks recovery attempts for abandoned carts
// ═══════════════════════════════════════════════════════════════════════════════

enum CartSaveStatus {
  ACTIVE
  PAUSED
  CONVERTED
  EXHAUSTED
  UNSUBSCRIBED
}

model CartSaveAttempt {
  id         String @id @default(cuid())
  cartId     String
  companyId  String
  customerId String?

  status       CartSaveStatus @default(ACTIVE)
  currentStage String         // CartSaveStage enum value

  // Diagnosis
  diagnosisReason String? // CartAbandonmentReason

  // Customer scoring
  customerRiskScore Float   @default(0)
  cartValue         Decimal @db.Decimal(12, 2)

  // Current offer (if any)
  currentOffer Json?

  // Progress tracking
  stageHistory Json @default("[]") // StageHistoryEntry[]
  metadata     Json @default("{}") // CartSaveAttemptMetadata

  // Timing
  startedAt   DateTime  @default(now())
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  cart          Cart              @relation(fields: [cartId], references: [id], onDelete: Cascade)
  company       Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer      Customer?         @relation(fields: [customerId], references: [id], onDelete: SetNull)
  interventions CartIntervention[]

  @@index([cartId])
  @@index([companyId, status])
  @@index([customerId])
  @@index([status, startedAt])
  @@map("cart_save_attempts")
}

// ═══════════════════════════════════════════════════════════════════════════════
// CART INTERVENTION - Individual recovery intervention records
// ═══════════════════════════════════════════════════════════════════════════════

enum CartInterventionStatus {
  SCHEDULED
  SENT
  DELIVERED
  OPENED
  CLICKED
  CONVERTED
  FAILED
  CANCELLED
}

model CartIntervention {
  id                String @id @default(cuid())
  cartSaveAttemptId String
  cartId            String

  stage    String   // CartSaveStage
  channels String[] // CartSaveChannel[]

  // Content
  content      Json // InterventionContent
  triggersUsed String[]

  // Offer details
  offerCode      String?
  offerType      String?
  offerValue     Float?
  offerExpiresAt DateTime?

  // Delivery tracking
  status      CartInterventionStatus @default(SCHEDULED)
  scheduledAt DateTime
  sentAt      DateTime?
  deliveredAt DateTime?
  openedAt    DateTime?
  clickedAt   DateTime?
  convertedAt DateTime?
  failedAt    DateTime?
  failReason  String?

  // Response tracking
  responseType String? // CartSaveResponseType
  responseAt   DateTime?
  surveyAnswer String? // If DIAGNOSIS_SURVEY stage

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cartSaveAttempt CartSaveAttempt @relation(fields: [cartSaveAttemptId], references: [id], onDelete: Cascade)
  cart            Cart            @relation(fields: [cartId], references: [id], onDelete: Cascade)

  @@index([cartSaveAttemptId])
  @@index([cartId])
  @@index([status, scheduledAt])
  @@index([stage, status])
  @@map("cart_interventions")
}
